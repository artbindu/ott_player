/**************************************************************************** 
 * Copyright (C) 2022, Bitmovin, Inc., All Rights Reserved 
 * 
 * This source code and its use and distribution, is subject to the terms 
 * and conditions of the applicable license agreement. 
 * 
 * Bitmovin Player Version 8.90.0 
 * 
 ****************************************************************************/
(function() {
"use strict";!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t():"function"==typeof define&&define.amd?define([],t):"object"==typeof exports?exports["engine-bitmovin"]=t():(e.bitmovin=e.bitmovin||{},e.bitmovin.player=e.bitmovin.player||{},e.bitmovin.player["engine-bitmovin"]=t())}(self,(function(){return(self.webpackChunkbitmovin_player_name_=self.webpackChunkbitmovin_player_name_||[]).push([[9],{8073:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ContainerFormat=void 0,function(e){e.MP4="mp4",e.TS="ts",e.WEBM="webm"}(t.ContainerFormat||(t.ContainerFormat={}))},47886:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.DrmKidErrorHandler=void 0;var n=i(59534),r=i(22221),o=i(45366),a=i(11917),s=i(28803),u=i(4157),d=function(){function e(e,t){var i=this;this.onDownloadedRepresentationExcludedCallback=t,this.onDrmKidsWithErrorsChanged=function(e,t){if(void 0!==e&&void 0!==t){var n=e.filter((function(e){return!t.includes(e)}));i.maybeExcludeRepresentations(n)}};var r=e.sourceContext.sourceIdentifier;this.store=e.store,this.logger=e.logger,this.sourceStore=e.serviceManager.get(n.ServiceName.SourceStoreService,r),this.manifestService=e.serviceManager.get(n.ServiceName.ManifestService,r),this.unsubscribeFromStore=(0,s.subscribe)(this.sourceStore)(u.getDrmKeyIdsWithErrors,this.onDrmKidsWithErrorsChanged)}return e.prototype.maybeExcludeRepresentations=function(e){var t=p(this.manifestService,e),i=this.store.getState();if(0!==t.length&&void 0!==i){var n=l(c(i),t);this.logger.debug("Excluding representations due to DRM licenses not being available",t),this.manifestService.excludeRepresentations(t),n&&(this.store.dispatch((0,r.clearMetricsHistory)("default",a.MetricType.RequestedRepresentations)),this.onDownloadedRepresentationExcludedCallback())}},e.prototype.trackSegment=function(e){var t=e.getDrmKid();if(void 0!==t){var i=this.sourceStore.getState(),n=e.getRepresentationId(),r=i?(0,u.getDrmKeyIdsWithErrors)(i):[];h(t,n,this.manifestService)&&(f(t,n,this.manifestService),this.maybeExcludeRepresentations(r))}},e.prototype.dispose=function(){this.unsubscribeFromStore()},e}();function c(e){return(0,o.getMetricsHistoryFromInstanceState)(e,"default",a.MetricType.RequestedRepresentations).map((function(e){return e.value}))}function l(e,t){return t.some((function(t){return e.some((function(e){return e.equals(t)}))}))}function p(e,t){return e.getAllRepresentations().filter((function(e){return e.associatedKid&&t.includes(e.associatedKid)})).map((function(e){return e._internalId}))}function f(e,t,i){i.setRepresentationDrmKid(t,e)}function h(e,t,i){return e!==i.getRepresentationDrmKid(t)}t.DrmKidErrorHandler=d},43719:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.HeartbeatService=void 0;var n=i(59534),r=250,o=function(){function e(e,t){this.serviceManager=e,this.mediaPlayerController=t,this.heartbeatTimeoutId=-1}return Object.defineProperty(e.prototype,"streamTimeService",{get:function(){return this.serviceManager.get(n.ServiceName.StreamTimeService)},enumerable:!1,configurable:!0}),e.prototype.resetHeartbeatTimeout=function(){var e=this;clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=window.setTimeout((function(){return e.beat()}),r)},e.prototype.beat=function(){this.resetHeartbeatTimeout(),d(this.mediaPlayerController,this.streamTimeService)},Object.defineProperty(e.prototype,"started",{get:function(){return-1!==this.heartbeatTimeoutId},enumerable:!1,configurable:!0}),e.prototype.start=function(){this.beat()},e.prototype.stop=function(){clearTimeout(this.heartbeatTimeoutId),this.heartbeatTimeoutId=-1},e.prototype.dispose=function(){this.stop()},e}();function a(e){e.shouldClearSubtitleServiceBuffers()&&e.clearSubtitleServiceBuffers()}function s(e){e.isLoadingLastPeriod()?(e.areMediaTypesFinalForPlayingPeriod()?e.maybeStop():e.isAVCompletelyLoaded()&&e.signalEndOfStream(),a(e)):e.switchLoadingPeriod()}function u(e,t){var i=e.getActiveMimeTypes(),n=i.length>0;n&&i.forEach((function(i){e.requestSegmentsForMimeType(i,t.getTimeForNextSegment(i))})),e.areAllLoadersReady()&&(n?a(e):s(e))}function d(e,t){e.shouldSuspendHeartbeat()||u(e,t)}t.HeartbeatService=o},49835:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.checkIfGapSkip=t.MediaPlayer=void 0;var r,o=i(45659),a=i(42702),s=i(59534),u=i(4529),d=i(59574),c=i(49863),l=i(39409),p=i(8833),f=i(22221),h=i(45366),g=i(11917),m=i(38106),S=i(59536),v=i(28803),y=i(46381),T=i(50163),I=i(80815),M=i(89543),b=i(43068),P=i(83024),C=i(43719),R=i(6124),A=i(88269),E=i(64324),x=i(32765),k=i(76725),B=i(48800),L=i(85303),_=i(31998),D=i(66772),w=i(53088),O=i(8144);!function(e){e.Unloaded="unloaded",e.Preparing="preparing",e.Loading="loading",e.Loaded="loaded"}(r||(r={}));var N=Object.freeze({id:"auto",bitrate:null}),F=Object.freeze({id:"auto",bitrate:null,width:null,height:null}),H=function(){function e(e){var t=this;this.timeShiftJumpStart=-1,this.timeShiftEstimatedLiveEdge=-1,this.ignoreNextVideoError=!1,this.ended=!1,this.isDvrWindowExceeded=!1,this.controlPermitted=!0,this.lastPlayIssuer="api",this.lastPauseIssuer="api",this.onSegmentAvailable=function(e){null!=t.relativeCurrentTimeOffset||e.isInit()||(t.relativeCurrentTimeOffset=t.isLive()?t.calcRelativeCurrentTimeOffsetForLive(e):0)},this.onPlaying=function(){t.isLive()&&t.canResumeLatencyControl()&&t.resumeLatencyControl()},this.videoErrorHandler=function(e){t.ignoreNextVideoError?t.ignoreNextVideoError=!1:(t.logger.debug("Caught a video element error: ",e),t.unload(),t.eventHandler.fireError((0,c.createPlayerErrorFromMediaError)(e)))},this.controlLiveLatency=function(){var e=t.liveLatencyService.getStatus(t.liveLatencyMode,t.getCommonBufferLevel());t.liveLatencyMode!==e.mode&&(t.context.eventHandler.dispatchEvent(d.PlayerEvent.LatencyModeChanged,{from:t.liveLatencyMode,to:e.mode}),t.liveLatencyMode=e.mode),e.mode===d.LatencyMode.Suspended||t.playerStateService.seekingOrTimeshifting||(e.requiredAction===t.lowLatencyModule.LiveLatencyControlAction.Seek?t.goToLiveEdge():e.requiredAction===t.lowLatencyModule.LiveLatencyControlAction.PlaybackRate&&t.setPlaybackSpeed(1,e.actionParam,!1))},this.onPlaybackStarted=function(){t.playerStateService.getIsRendererStalling()?(t.logger.debug("Renderer is currently stalled. Waiting for unstalling before ending stall."),t.clearStallEndedSubscription(),t.unsubscribeFromStallEnded=(0,v.subscribe)(t.context.store)((function(e){return(0,S.getPlayerState)(e)}),(function(){return t.endStall()}),(function(e){return!(0,S.getIsRendererStalled)(e)}))):t.endStall()},this.onVideoElementPlay=function(){t.playerStateService.transitionToPlayState(!0,t.lastPlayIssuer)},this.onVideoElementPaused=function(){t.logger.insane("video element signaled pause in state: ".concat(t.playerStateService.playbackState)),t.playerStateService.transitionToPausedState(!0,t.lastPauseIssuer,!0)},this.mapLangObjectToAudioTrack=function(e){return{id:e.id,lang:e.lang,label:e.label,role:e.role,getQualities:function(){return x.MediaPlayerManifestApiFactory.getAudioQualities(t.manifestService,t.getCurrentPlayingPeriodId(),e.id)}}},this.onVideoElementSeeking=function(e){var i=j(t.context,e.time);t.settings.GLOBAL_DISABLE_SEEKING&&!i&&(Math.abs(e.time-t.lastCurrentTimeUpdate)>.05&&(t.logger.debug("Seeking now allowed, seeking back to expected time"),t.context.videoElement.currentTime=t.lastCurrentTimeUpdate))},this.onVideoTimeupdate=function(e){if(!t.ended){var i=0===t.renderer.getCurrentTime(!0),n=t.isPlaying(),r=t.playerStateService.isSeeking(),o=t.isStalled();!n||r||o||i?t.logger.debug("Skipping timeupdate",{isPlaying:n,isSeeking:r,isStalled:o,timeUpdateWithoutBuffer:i,time:e.time}):t.handleTimeChanged(t.getCurrentTime())}},this.onContentPlaybackFinished=function(){t.ended=!0},this.onDvrWindowExceeded=function(){t.playerStateService.isPlaying()?t.handleDvrWindowExceeded():t.isDvrWindowExceeded=!0},this.onError=function(e){3001===e.code&&t.unload()},this.fireAudioTracksAdded=function(){for(var e=t.getCurrentTime(),i=0,n=t.getAvailableAudio();i<n.length;i++){var r=n[i];t.context.eventHandler.dispatchEvent(d.PlayerEvent.AudioAdded,{track:r,time:e})}},this.fireAudioTracksRemoved=function(e){for(var i=0,n=t.getAvailableAudio();i<n.length;i++){var r=n[i];t.context.eventHandler.dispatchEvent(d.PlayerEvent.AudioRemoved,{track:r,time:e})}},this.onPeriodSwitch=function(){t.fireAudioTracksRemoved(t.getCurrentTime())},this.onPlaybackSpeedChanged=function(e){t.isLive()&&(t.canResumeLatencyControl()?t.resumeLatencyControl():t.suspendLatencyControl(!1))},this.context=e,this.logger=e.logger,this.config=e.config,this.settings=e.settings,this.renderer=e.renderer,this.eventHandler=e.eventHandler,this.loadState=r.Unloaded,this.context.store.dispatch((0,f.initializeMetricsForMimeType)("default",this.context.settings)),this.playerController=new k.MediaPlayerController(e,this.onSegmentAvailable),b.ModuleManager.has(P.ModuleName.LowLatency)&&(this.lowLatencyModule=b.ModuleManager.get(P.ModuleName.LowLatency)),this.eventHandler.on(d.PlayerEvent.PeriodSwitch,this.onPeriodSwitch),this.eventHandler.on(d.PlayerEvent.PeriodSwitched,this.fireAudioTracksAdded),this.eventHandler.on(d.PlayerEvent.PlaybackSpeedChanged,this.onPlaybackSpeedChanged),this.unsubscribeStorePlayingListener=(0,v.subscribe)(this.context.store)((function(e){return(0,S.getIsPlaying)((0,S.getPlayerState)(e))}),this.onPlaying,(function(e,t){return e&&!t}))}return e.prototype.createServices=function(e,t){var i=t.serviceManager;this.createSynchronizedTimeService(t),this.createManifestService(t),this.createManifestLoadingService(t,e),this.createManifestUpdateSchedulingService(t);var n=b.ModuleManager.get(P.ModuleName.ABR).AdaptationService;i.set(s.ServiceName.AdaptationService,new n(t)),i.set(s.ServiceName.TimedMetadataService,new L.TimedMetadataService(t)),i.set(s.ServiceName.SegmentService,new B.SegmentService(t));var r=new O.StreamTimeService(i,t.sourceContext.sourceIdentifier);i.set(s.ServiceName.StreamTimeService,r),i.set(s.ServiceName.HeartbeatService,new C.HeartbeatService(i,this.playerController),t.sourceContext.sourceIdentifier),this.createSubtitleService(t),this.createLowLatencyService(t)},e.prototype.createSynchronizedTimeService=function(e){var t=e.serviceManager,i=e.sourceContext.sourceIdentifier;if(b.ModuleManager.has(P.ModuleName.DASH)){var n=b.ModuleManager.get(P.ModuleName.DASH);if(!t.has(s.ServiceName.SynchronizedTimeService,i)){var r=new n.SynchronizedTimeService(e,e.sourceContext);t.set(s.ServiceName.SynchronizedTimeService,r,i)}}},e.prototype.createManifestService=function(e){var t=e.serviceManager,i=e.sourceContext.sourceIdentifier;t.has(s.ServiceName.ManifestService,i)?(this.manifestService=t.get(s.ServiceName.ManifestService,i),this.manifestService.restore()):(this.manifestService=new A.ManifestService(e,e.sourceContext),t.set(s.ServiceName.ManifestService,this.manifestService,i))},e.prototype.createManifestLoadingService=function(e,t){var i=e.serviceManager,n=e.sourceContext.sourceIdentifier;if(!i.has(s.ServiceName.ManifestLoadingService,n)){var r=(0,R.createManifestLoadingService)(t,e,e.sourceContext);i.set(s.ServiceName.ManifestLoadingService,r,n)}},e.prototype.createManifestUpdateSchedulingService=function(e){var t=e.serviceManager,i=e.sourceContext.sourceIdentifier;if(t.has(s.ServiceName.ManifestUpdateSchedulingService,i))t.get(s.ServiceName.ManifestUpdateSchedulingService,i).restore();else{var n=new E.ManifestUpdateScheduler(e,e.sourceContext);t.set(s.ServiceName.ManifestUpdateSchedulingService,n,i)}},e.prototype.createSubtitleService=function(e){var t=e.serviceManager;if(b.ModuleManager.has(P.ModuleName.Subtitles)){var i=b.ModuleManager.get(P.ModuleName.Subtitles).SubtitleService;t.set(s.ServiceName.SubtitleService,new i(e)),this.subtitleService=t.get(s.ServiceName.SubtitleService)}},e.prototype.createLowLatencyService=function(e){var t=e.serviceManager;b.ModuleManager.has(P.ModuleName.LowLatency)&&(t.set(s.ServiceName.LiveLatencyService,new this.lowLatencyModule.LiveLatencyService(e)),this.liveLatencyService=t.get(s.ServiceName.LiveLatencyService))},e.prototype.disposeServices=function(e){var t,i=this.context.serviceManager;[s.ServiceName.LiveLatencyService,s.ServiceName.SubtitleService,s.ServiceName.TimedMetadataService].forEach((function(e){return(0,a.disposeService)(i,e)}));var n=null===(t=this.context.sourceContext)||void 0===t?void 0:t.sourceIdentifier;n&&((0,a.disposeService)(i,s.ServiceName.HeartbeatService,n),e!==l.ADVERTISING_ISSUER_NAME?[s.ServiceName.ManifestService,s.ServiceName.ManifestLoadingService,s.ServiceName.ManifestUpdateSchedulingService,s.ServiceName.SynchronizedTimeService].forEach((function(e){return(0,a.disposeService)(i,e,n)})):(i.get(s.ServiceName.ManifestService,n).suspend(),i.get(s.ServiceName.ManifestUpdateSchedulingService,n).suspend()))},e.prototype.calcRelativeCurrentTimeOffsetForLive=function(e){var t=null!=e.getSegmentInfo().wallClockTime?e.getPlaybackTime()-(0,I.toSeconds)(e.getSegmentInfo().wallClockTime):0;return this.playerController.getSeekableRange().start+t},e.prototype.play=function(e){return this.lastPlayIssuer=e,this.controlPermitted?this.currentSource?this.playerStateService.isPlaying()?(this.logger.debug("Ignoring play call as play was already triggered or we're already playing"),Promise.resolve()):(this.ended=!1,this.isLive()&&(this.isDvrWindowExceeded||this.getMaxTimeShift()>=0)&&(this.goToLiveEdge(),this.isDvrWindowExceeded=!1),this.playerController.start(),this.playerStateService.transitionToPendingPlayState(!1,e),this.renderer.play()):Promise.resolve():Promise.reject("Play control not permitted")},e.prototype.goToLiveEdge=function(){var e=this;this.settings.ENABLE_SEEK_FOR_LIVE?this.playerStateService.isSeeking()||this.playerController.seek(this.getSeekableRange().end,!0,!0):this.playerController.timeShift(0,(function(){return e.onTimeShifted()})).catch((function(){return e.onTimeShiftFailed()}))},e.prototype.canResumeLatencyControl=function(){return Boolean(this.liveLatencyService)&&!this.isPaused()&&0===this.getTimeShift()&&1===this.getPlaybackSpeed()&&!this.playerStateService.isTimeShifting()&&!this.playerStateService.isSeeking()},e.prototype.resumeLatencyControl=function(){this.liveLatencyService.resumeControl()},e.prototype.suspendLatencyControl=function(e){void 0===e&&(e=!0);var t=this.liveLatencyMode===d.LatencyMode.Suspended;this.liveLatencyService&&!t&&(this.liveLatencyService.suspendControl(),e&&this.setPlaybackSpeed(1,1,!1))},e.prototype.getCommonBufferLevel=function(){var e=[this.getBufferLevel(p.BufferType.ForwardDuration,p.MediaType.Audio),this.getBufferLevel(p.BufferType.ForwardDuration,p.MediaType.Video)].map((function(e){return e.level})).filter((function(e){return null!==e}));return 0===e.length?0:Math.min.apply(Math,e)},e.prototype.endStall=function(){this.clearStallEndedSubscription(),this.playerStateService.stallExit(),this.playerStateService.transitionToPlayingState(this.lastPlayIssuer),this.ended=!1},e.prototype.preload=function(){this.loadState!==r.Unloaded&&this.playerController&&this.playerController.start()},e.prototype.pause=function(e){this.controlPermitted&&(this.logger.insane("Pause was called via the API"),this.playerStateService.isInitial()||(this.lastPauseIssuer=e,this.isLive()&&this.liveLatencyService&&this.liveLatencyService.isConfigured()&&(this.suspendLatencyControl(),this.controlLiveLatency()),this.playerStateService.isPaused()||this.playerStateService.isStopped()||this.renderer.pause(),this.playerStateService.transitionToPausedState(this.renderer.isPaused(),e)))},e.prototype.mute=function(e){this.isMuted()||(this.renderer.mute(),this.context.eventHandler.dispatchEvent(d.PlayerEvent.Muted,{issuer:e||"api"}))},e.prototype.unmute=function(e){this.isMuted()&&(this.renderer.unmute(),this.context.eventHandler.dispatchEvent(d.PlayerEvent.Unmuted,{issuer:e||"api"}))},e.prototype.seek=function(e,t){var i,n,r;void 0===t&&(t="");var o=this.config&&this.config.hasOwnProperty("playback")?this.config.playback:{},a=!o.hasOwnProperty("seeking")||o.seeking,s=this.context.store.getState(),u=!!s&&(null!==(r=null===(n=null===(i=(0,S.getPlayerState)(s))||void 0===i?void 0:i.seekingProcess)||void 0===n?void 0:n.isInitial)&&void 0!==r&&r);return!(!(u||!this.settings.GLOBAL_DISABLE_SEEKING&&a)||!this.controlPermitted)&&(this.ended=!1,this.cancelPotentialOngoingTimeShift(),this.playerStateService.transitionToSeekingState(e,t,t!==l.STARTUP_ISSUER_NAME),this.context.store.dispatch((0,m.updateSeekingProcess)({issuer:t,targetTime:e,isInitial:u})),!0)},e.prototype.cancelPotentialOngoingTimeShift=function(){this.playerStateService.isTimeShifting()&&(this.playerController.getTimeShiftHandler().cancel(),this.playerStateService.transitionToTimeShiftedState(!1))},e.prototype.handleTimeChanged=function(e){e!==this.lastCurrentTimeUpdate&&(this.context.eventHandler.dispatchEvent(d.PlayerEvent.TimeChanged,{time:e}),this.lastCurrentTimeUpdate=e,this.isLive()&&this.liveLatencyService&&this.liveLatencyService.isConfigured()&&this.controlLiveLatency())},e.prototype.setVolume=function(e,t){var i=this.renderer.getVolume();this.renderer.setVolume(e),i!==e&&this.context.eventHandler.dispatchEvent(d.PlayerEvent.VolumeChanged,{targetVolume:e,sourceVolume:i,issuer:t||"api"})},e.prototype.setAudioQuality=function(e){var t,i=this.getAvailableAudioQualities(),n=this.getAudioQuality();(t="auto"===e?N:i.find((function(t){return t.id===e})))&&n.id!==t.id&&(this.setFixedRepresentation(p.MediaType.Audio,e),this.context.eventHandler.dispatchEvent(d.PlayerEvent.AudioQualityChanged,{sourceQuality:n,sourceQualityId:n.id,targetQuality:t,targetQualityId:t.id}))},e.prototype.getAudioQuality=function(){var e=this.getInitializedMimeTypeFromMediaType(p.MediaType.Audio),t=this.context.serviceManager.get(s.ServiceName.AdaptationService),i=t.isAuto(e),n=t.getCurrentRepresentationId(e);return i||null===n?N:this.getAvailableAudioQualities().find((function(e){return e.id===n.representationId}))},e.prototype.setFixedRepresentation=function(e,t){var i=this.getInitializedMimeTypeFromMediaType(e);this.context.serviceManager.get(s.ServiceName.AdaptationService).setFixedRepresentation(i,t)},e.prototype.setVideoQuality=function(e){var t,i=this.getAvailableVideoQualities(),n=this.getVideoQuality();(t="auto"===e?F:i.find((function(t){return t.id===e})))&&n.id!==t.id&&(this.context.eventHandler.dispatchEvent(d.PlayerEvent.VideoQualityChanged,{sourceQuality:n,sourceQualityId:n.id,targetQuality:t,targetQualityId:t.id}),this.setFixedRepresentation(p.MediaType.Video,e))},e.prototype.getVideoQuality=function(){var e=this.getInitializedMimeTypeFromMediaType(p.MediaType.Video),t=this.context.serviceManager.get(s.ServiceName.AdaptationService),i=t.isAuto(e),n=t.getCurrentRepresentationId(e);return i||null===n?F:this.getAvailableVideoQualities().find((function(e){return e.id===n.representationId}))},e.prototype.processSourceContext=function(){var e=this.context.sourceContext;e.source&&e.source.options&&e.source.options.headers&&(this.settings.HTTP_HEADERS=e.source.options.headers)},e.prototype.addReducersToSourceStore=function(e){var t=this.getSourceStoreService();if(void 0!==t){if(e.type===p.StreamType.Hls&&b.ModuleManager.has(P.ModuleName.HLS)&&!t.hasReducer("hls")){var i=b.ModuleManager.get(P.ModuleName.HLS);t.addReducer("hls",i.HlsReducer)}Object.keys(D.engineBitmovinSourceReducers).forEach((function(e){var i=D.engineBitmovinSourceReducers[e];void 0!==i&&t.addReducer(e,i)}))}},e.prototype.addRendererEventListeners=function(){this.renderer.on(M.MediaElementEvent.error,this.videoErrorHandler),this.renderer.on(M.MediaElementEvent.timeupdate,this.onVideoTimeupdate),this.renderer.on(M.MediaElementEvent.seeking,this.onVideoElementSeeking),this.renderer.on(M.MediaElementEvent.playing,this.onPlaybackStarted),this.renderer.on(M.MediaElementEvent.play,this.onVideoElementPlay),this.renderer.on(M.MediaElementEvent.pause,this.onVideoElementPaused)},e.prototype.logBitrateBoundarySettings=function(){this.logger.debug("setting bitrate boundaries for audio to "+this.settings.MIN_SELECTABLE_AUDIO_BITRATE+" - "+this.settings.MAX_SELECTABLE_AUDIO_BITRATE),this.logger.debug("setting bitrate boundaries for video to "+this.settings.MIN_SELECTABLE_VIDEO_BITRATE+" - "+this.settings.MAX_SELECTABLE_VIDEO_BITRATE)},e.prototype.loadInternal=function(e,t){var i,n=this;return this.loadState===r.Unloaded?Promise.reject("Unload during load"):(this.createServices(e,this.context),this.context.sourceContext.source=e.config,(null===(i=this.context.videoElement)||void 0===i?void 0:i.eventHandler)&&this.context.videoElement.eventHandler.reset(),this.currentSource=e,this.ended=!1,this.isDvrWindowExceeded=!1,this.context.store.dispatch((0,m.updateSeekingProcess)({isInitial:!0})),this.logBitrateBoundarySettings(),this.liveLatencyService&&(this.liveLatencyMode=d.LatencyMode.Suspended,this.liveLatencyService.reset()),this.addRendererEventListeners(),this.settings.GLOBAL_DISABLE_SEEKING=t||!1,this.loadState=r.Loading,this.playerController.init(e).then((function(){n.loadState=r.Loaded})))},e.prototype.prepareLoad=function(){var e=this.context.serviceManager.get(s.ServiceName.PlayerStateService);e&&(this.playerStateService=e);var t=Promise.resolve();return this.loadState===r.Loading&&(t=this.unload()),this.playerStateService.reset(),this.loadState=r.Preparing,t},e.prototype.load=function(e,t,i){var n=this;return"dash"!==e.type&&"hls"!==e.type&&"smooth"!==e.type?Promise.reject("invalid source"):(this.addReducersToSourceStore(e),this.processSourceContext(),this.unsubscribeFromStoreStoppedListener=(0,v.subscribe)(this.context.store)((function(e){return(0,S.getIsStopped)((0,S.getPlayerState)(e))}),this.onContentPlaybackFinished,(function(e){return!0===e})),this.eventHandler.on(d.PlayerEvent.DVRWindowExceeded,this.onDvrWindowExceeded,!0),this.eventHandler.on(d.PlayerEvent.Error,this.onError,!0),this.renderer.ready().then((function(){return n.loadInternal(e,i)})))},e.prototype.getSourceStoreService=function(){return this.context.serviceManager.get(s.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier)},e.prototype.unload=function(e){var t=this;if(this.clearStallEndedSubscription(),this.loadState===r.Unloaded)return Promise.resolve();var i=this.loadState===r.Loaded;this.ended=!1,this.loadState=r.Unloaded,this.ignoreNextVideoError=!0,this.relativeCurrentTimeOffset=null,this.renderer.off(M.MediaElementEvent.error,this.videoErrorHandler),this.renderer.off(M.MediaElementEvent.timeupdate,this.onVideoTimeupdate),this.renderer.off(M.MediaElementEvent.seeking,this.onVideoElementSeeking),this.renderer.off(M.MediaElementEvent.playing,this.onPlaybackStarted),this.renderer.off(M.MediaElementEvent.play,this.onVideoElementPlay),this.renderer.off(M.MediaElementEvent.pause,this.onVideoElementPaused),this.unsubscribeFromStoreStoppedListener(),this.eventHandler.off(d.PlayerEvent.DVRWindowExceeded,this.onDvrWindowExceeded),this.eventHandler.off(d.PlayerEvent.Error,this.onError),this.playerStateService.isPlaying()&&this.renderer.pause(),this.playerStateService.reset();var n=this.context.sourceContext.sourceIdentifier;return this.context.serviceManager.has(s.ServiceName.SynchronizedTimeService,n)&&!U(e)&&this.context.serviceManager.get(s.ServiceName.SynchronizedTimeService,n).reset(),(this.playerController?this.playerController.terminate():Promise.resolve()).then((function(){t.currentSource=void 0,t.disposeServices(e),U(e)||t.getSourceStoreService().dispatch((0,_.clearActiveTracksAction)()),i&&t.eventHandler.dispatchEvent(d.PlayerEvent.SourceUnloaded)}))},e.prototype.isReady=function(){return this.playerController.isInitialized()},e.prototype.isPlaying=function(){return this.playerStateService.isPlaying()},e.prototype.isPaused=function(){return this.playerStateService.isPaused()},e.prototype.hasEnded=function(){return this.ended},e.prototype.isMuted=function(){return this.renderer.isMuted()},e.prototype.isStalled=function(){return this.playerStateService.isStalled},e.prototype.isLive=function(){return this.manifestService.isLive()},e.prototype.getVolume=function(){return this.renderer.getVolume()},e.prototype.getCurrentTime=function(e){return void 0===e&&(e=p.TimeMode.AbsoluteTime),!this.isLive()&&this.hasEnded()?this.getDuration():e===p.TimeMode.RelativeTime?Math.max(0,this.playerController.getCurrentTime()-this.relativeCurrentTimeOffset):this.playerController.getCurrentTime()},e.prototype.getDuration=function(){return this.manifestService.getDuration()},e.prototype.getAvailableVideoQualities=function(){return this.isReady()?this.manifestService.getVideoRepresentations(this.getCurrentPlayingPeriodId()):[]},e.prototype.getAvailableSegments=function(){return this.isReady()?this.playerController.getAvailableSegments():{}},e.prototype.getAvailableAudioQualities=function(){var e=this.getAudio();if(!this.isReady()||!e)return[];var t=this.manifestService.getAudioRepresentations(this.getCurrentPlayingPeriodId());return t[e.id]?t[e.id]:[]},e.prototype.getDroppedVideoFrames=function(){return this.renderer.getDroppedVideoFrames()},e.prototype.setTargetBufferLevel=function(e,t,i){this.context.bufferSettings.setTargetLevel(e,t,i)},e.prototype.getBufferLevel=function(e,t){var i={level:null,targetLevel:this.context.bufferSettings.getTargetLevel(e,t),type:e,media:t},n=this.renderer.getCurrentTime(),r=(0,h.getMetricsState)(this.context.store.getState()),o=Object.keys(r).find((function(e){return T.MimeTypeHelper.isVideo(e)})),a=Object.keys(r).find((function(e){return T.MimeTypeHelper.isAudio(e)}));return t===p.MediaType.Video&&o?i.level=this.playerController.getBufferLevel(o,n,e):t===p.MediaType.Audio&&a&&(i.level=this.playerController.getBufferLevel(a,n,e)),i},e.prototype.getTotalStalledTime=function(){var e=(0,h.getMetricsState)(this.context.store.getState());for(var t in e)if(e[t]){var i=(0,h.getMetricsLastEntry)(e,t,g.MetricType.StalledSeconds);if(i&&i.value&&!isNaN(i.value))return Math.round(100*i.value)/100}return 0},e.prototype.getInitializedMimeTypeFromMediaType=function(e){var t=(0,h.getMetricsState)(this.context.store.getState());return Object.keys(t).find((function(t){return t.includes(e)}))},e.prototype.getDownloadedData=function(e){var t=this.getInitializedMimeTypeFromMediaType(e),i=n({},this.getCurrentAdaptationSet(t)),r=n({},this.getCurrentRepresentation(t));return r.id&&(r.id=""+r.id),void 0===r.width&&void 0!==i.width&&(r.width=i.width),r.width=parseInt(""+r.width),void 0===r.height&&void 0!==i.height&&(r.height=i.height),r.height=parseInt(""+r.height),void 0===r.bitrate&&void 0!==i.bitrate&&(r.bitrate=i.bitrate),r.bitrate=parseInt(""+r.bitrate),r.isAuto=this.context.serviceManager.get(s.ServiceName.AdaptationService).isAuto(t),r},e.prototype.getCurrentRepresentation=function(e){if(this.playerController.hasStarted()){var t=(0,h.getMetricsState)(this.context.store.getState());if(t[e])return(0,h.getMetricsLastEntry)(t,e,g.MetricType.DownloadedRepresentation).value}return{}},e.prototype.getCurrentAdaptationSet=function(e){if(this.playerController.hasStarted()){var t=(0,h.getMetricsState)(this.context.store.getState());if(t[e])return(0,h.getMetricsLastEntry)(t,e,g.MetricType.DownloadedAdaptationSet).value}return{}},e.prototype.getDownloadedVideoData=function(){var e=this.getDownloadedData(p.MediaType.Video),t=!0;return e.hasOwnProperty("isAuto")&&(t=e.isAuto),e&&(e.bitrate||e.id)?{id:e.id,bitrate:e.bitrate,height:e.height,width:e.width,isAuto:t}:{id:"",bitrate:0,height:0,width:0,isAuto:!0}},e.prototype.getDownloadedAudioData=function(){var e=this.getDownloadedData(p.MediaType.Audio),t=!0;return e.hasOwnProperty("isAuto")&&(t=e.isAuto),e&&(e.bitrate||e.id)?{id:e.id,bitrate:e.bitrate,isAuto:t}:{id:"",bitrate:0,isAuto:!0}},e.prototype.getPlaybackVideoData=function(){var e=this.playerController.getPlaybackRepresentation(p.MediaType.Video)||{},t=isNaN(e._height)?0:Number(e._height),i=isNaN(e._width)?0:Number(e._width),n={id:e._id+"",bitrate:Number(e._bandwidth)||0,height:t,width:i,uid:e.uid};return e._codecs&&(n.codec=y.CodecStringHelper.extractCodecStrings(e._codecs).video),n},e.prototype.getPlaybackAudioData=function(){var e=this.playerController.getPlaybackRepresentation(p.MediaType.Audio)||{},t={id:e._id+"",bitrate:Number(e._bandwidth)};return e._codecs&&(t.codec=y.CodecStringHelper.extractCodecStrings(e._codecs).audio),t},e.prototype.setQueryParameters=function(e){this.settings.QUERY_PARAMETERS=e},e.prototype.clearQueryParameters=function(){this.settings.QUERY_PARAMETERS=void 0},e.prototype.restoreAfterTimeShift=function(e){this.playerStateService&&(this.playerStateService.isTimeShifting()&&(this.playerStateService.transitionToTimeShiftedState(e),this.timeShiftEstimatedLiveEdge=-1,this.timeShiftJumpStart=-1),this.isLive()&&(this.canResumeLatencyControl()?this.resumeLatencyControl():this.suspendLatencyControl()))},e.prototype.onTimeShiftFailed=function(){this.restoreAfterTimeShift(!1)},e.prototype.onTimeShifted=function(e){this.restoreAfterTimeShift(e!==l.STARTUP_ISSUER_NAME)},e.prototype.getMaxTimeShift=function(){if(this.isLive()&&this.isReady())return this.config.playback&&!1===this.config.playback.timeShift?0:this.playerController.getMaxTimeShift()},e.prototype.timeShift=function(e,t){var i=this;this.isReady()&&this.getMaxTimeShift()<=0&&(-1===this.timeShiftJumpStart&&(this.timeShiftJumpStart=this.getCurrentTime(),0===this.timeShiftJumpStart&&(this.timeShiftJumpStart=this.playerController.getTimeShiftLiveEdge())),this.playerController.timeShift(e,(function(){return i.onTimeShifted(t)})).catch((function(){return i.onTimeShiftFailed()})),-1===this.timeShiftEstimatedLiveEdge&&(this.timeShiftEstimatedLiveEdge=this.playerController.getTimeShiftLiveEdge()),this.playerStateService.transitionToTimeShiftingState(this.timeShiftJumpStart,this.timeShiftEstimatedLiveEdge+e,t||"api",t!==l.STARTUP_ISSUER_NAME))},e.prototype.getTimeShift=function(){return this.isReady()?this.playerController.getTimeShift():0},e.prototype.addSubtitle=function(e){var t=this;return this.isReady()&&this.subtitleService?Promise.resolve(void 0).then((function(){t.subtitleService.addExternalSubtitle(e)})):Promise.reject(void 0)},e.prototype.removeSubtitle=function(e){this.isReady()&&this.subtitleService&&this.subtitleService.removeSubtitle(e)},e.prototype.enableSubtitle=function(e){return this.isReady()&&this.subtitleService?this.subtitleService.enableSubtitle(e):Promise.resolve(!1)},e.prototype.disableSubtitle=function(e){return this.isReady()&&this.subtitleService?this.subtitleService.disableSubtitle(e):Promise.resolve(!1)},e.prototype.listSubtitles=function(){return this.isReady()&&this.subtitleService&&this.playerController?this.subtitleService.getAvailableSubtitles(this.getCurrentPlayingPeriodId()):[]},e.prototype.setAudio=function(e){var t=this;if(this.isReady()&&this.playerController&&"string"==typeof e){var i=this.getAudio();if(i&&i.id===String(e))return;this.playerController.setAudio(e).then((function(){var e=t.getAudio();e&&i&&e.id!==i.id&&t.context.eventHandler.dispatchEvent(d.PlayerEvent.AudioChanged,{targetAudio:e,sourceAudio:i,time:t.renderer.getCurrentTime()})})).catch((function(e){t.logger.debug("setAudio failed for lang ",e)}))}},e.prototype.getAvailableAudio=function(){return this.isReady()&&this.playerController?this.playerController.getAvailableAudio(this.getCurrentPlayingPeriodId()).map(this.mapLangObjectToAudioTrack):[]},e.prototype.getAudio=function(){if(this.isReady()&&this.playerController){var e=this.playerController.getAudio();if(e)return this.mapLangObjectToAudioTrack(e)}return null},e.prototype.getManifest=function(){var e=this.manifestService.getManifest();if(e)return e._isHls?this.getHlsManifest():e.originalDashManifest},e.prototype.getHlsManifest=function(){return b.ModuleManager.get(P.ModuleName.HLS).selectors.getHlsState(this.getSourceStoreService().getState()).masterPlaylist.string},e.prototype.getBufferedRanges=function(){var e=this.playerController.getBufferedRanges(!0);return o.BufferRangeHelper.getCommonBufferedRanges(e).map((function(e){return{start:e.getStart(),end:e.getEnd()}}))},e.prototype.getSnapshot=function(e,t){if(this.isPlaying()||this.isPaused())return this.renderer.getSnapshotData(e,t)},e.prototype.setPlaybackSpeed=function(e,t,i){void 0===t&&(t=1),void 0===i&&(i=!0),this.renderer.setPlaybackSpeed(e*t),this.playerStateService.setPlaybackSpeed(e,t,i)},e.prototype.getPlaybackSpeed=function(){return this.playerStateService.playbackSpeed},e.prototype.permitControl=function(e){this.controlPermitted=e},e.prototype.getSeekableRange=function(){return this.isLive()&&!this.settings.ENABLE_SEEK_FOR_LIVE||!this.playerController?{start:-1,end:-1}:this.playerController.getSeekableRange()},e.prototype.createManifestApi=function(){return x.MediaPlayerManifestApiFactory.create(this,this.context)},e.prototype.handleDvrWindowExceeded=function(){var e=this.playerController.getTimeShiftHandler(),t=this.getMaxTimeShift()+e.getMinSegmentDuration(),i=e.calculatePlaybackTimeForTimeShiftOffset(t),n=e.isTimeInBufferedRange(i);this.context.logger.debug("Handling DVRWindowExceeded - TimeShifting to ".concat(n?t:"live edge")),this.timeShift(n?t:0)},e.prototype.getLatency=function(){return this.liveLatencyService.getLatency()},e.prototype.setTargetLatency=function(e){var t=Math.abs(this.manifestService.getTimeShiftBufferDepthSeconds());e>t&&(e=t,this.logger.debug("Tried to set target latency outside DVR window, corrected to lower bound",t)),this.context.eventHandler.dispatchEvent(d.PlayerEvent.TargetLatencyChanged,{from:this.liveLatencyService.getTargetLatency(),to:e}),this.liveLatencyService.setTargetLatency(e)},e.prototype.getTargetLatency=function(){return this.liveLatencyService.getTargetLatency()},e.prototype.setCatchupConfig=function(e){this.liveLatencyService.setCatchupConfig(e)},e.prototype.getCatchupConfig=function(){return this.liveLatencyService.getCatchupConfig()},e.prototype.setFallbackConfig=function(e){this.liveLatencyService.setFallbackConfig(e)},e.prototype.getFallbackConfig=function(){return this.liveLatencyService.getFallbackConfig()},e.prototype.release=function(e){var t=this;return this.eventHandler.off(d.PlayerEvent.PeriodSwitch,this.onPeriodSwitch),this.eventHandler.off(d.PlayerEvent.PeriodSwitched,this.fireAudioTracksAdded),this.eventHandler.off(d.PlayerEvent.PlaybackSpeedChanged,this.onPlaybackSpeedChanged),this.unsubscribeStorePlayingListener(),this.unload(e).then((function(){return t.playerStateService=null,t.playerController=(0,u.dispose)(t.playerController),t.disposeServices(e),t.renderer.release().then((function(){return t.renderer=null}))}))},e.prototype.clearStallEndedSubscription=function(){this.unsubscribeFromStallEnded&&(this.unsubscribeFromStallEnded(),this.unsubscribeFromStallEnded=void 0)},e.prototype.getCurrentPlayingPeriodId=function(){return(0,w.getPlayingPeriodId)(this.getSourceStoreService().getState())},e.prototype.updateCallback=function(e){},e.prototype.onFullscreenEnter=function(){},e.prototype.onFullscreenExit=function(){},e.prototype.isAirplayAvailable=function(){return!1},e.prototype.isAirplayActive=function(){return!1},e.prototype.showAirplayTargetPicker=function(){},e}();function U(e){return e===l.ADVERTISING_ISSUER_NAME||e===l.ADVERTISING_RESTORE_ISSUER_NAME}function j(e,t){if(!b.ModuleManager.has(P.ModuleName.RendererMse))return!1;for(var i=b.ModuleManager.get(P.ModuleName.RendererMse).Ranges,n=i.findGaps(e.videoElement.buffered),r=.1,o=!1,a=0;a<n.length;a++){var s=n.end(a)+i.TIME_FUDGE_FACTOR;Math.abs(s-t)<=r&&(o=!0)}return o}t.MediaPlayer=H,t.checkIfGapSkip=j},76725:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.isBufferChangeRequired=t.MediaPlayerController=void 0;var n=i(59534),r=i(4529),o=i(59574),a=i(39409),s=i(8833),u=i(22221),d=i(38106),c=i(59536),l=i(49916),p=i(43587),f=i(28803),h=i(46381),g=i(50163),m=i(89543),S=i(43068),v=i(83024),y=i(58400),T=i(47886),I=i(43233),M=i(94112),b=i(97383),P=i(92977),C=i(84493),R=i(31998),A=i(96400),E=i(53088),x=i(45110),k=i(76060),B=i(5258),L=i(45933),_=function(){function e(e,t){var i=this;this.segmentControllerMap={},this.onSegmentAvailable=function(e){if(i.clearBuffersPromise)w(e,i.getSourceStore());else{if(i.drmKidErrorHandler.trackSegment(e),i.shouldDropSegment(e))return i.context.logger.debug("Dropping segment ".concat(e.getUrl())),void w(e,i.getSourceStore());if(!e.isInit()){var t=e.getMimeType(),n=i.getTimestampOffset(t),r=i.segmentControllerMap[t];r&&i.isAVMultiplexed(r)&&i.addRequiredMediaTypesForMuxedContent(e.getPeriodId()),i.bufferController.updateMediaType(e.getPeriodId(),{mimeType:t,timestampOffset:n,codec:e.getCodec()})}i.bufferController.addSegment(e).then((function(){i.heartbeatService&&i.heartbeatService.beat()})).catch((function(e){i.logger&&i.logger.debug(e)})),i.segmentAvailableCallback(e)}},this.endStallAtGap=function(){var e=i.bufferController.getBufferedRangesMap(i.periodSwitchTracker.getCurrentPlayingPeriodId()),t=Math.max.apply(Math,Object.values(e).filter((function(e){return e.length>0})).map((function(e){return e[e.length-1].start})));i.seek(t,!1,!0)},this.mpdAvailableHandler=function(){var e;i.applyManifestTimings(),i.initialized&&i.updatePeriodInformation(),i.handleDroppedOutPeriods(),i.initializeThumbnails(),i.initialized?i.getAllSegmentControllers().forEach((function(e){return e.updateMpd()})):i.finishInit(),null===(e=i.timeshiftHandler)||void 0===e||e.onManifestUpdate(),i.context.serviceManager.get(n.ServiceName.TimedMetadataService).parseEventStream()},this.onPeriodSwitched=function(){(i.hasStreamEnded()||i.isInitialized()&&!i.playerStateService.isPlaying())&&i.start()},this.onSegmentRequestFinished=function(e){var t=408;if(e){if(e.success||e.httpStatus===t){var n=i.segmentControllerMap[e.mimeType];n&&i.updateAdaptationLogicData(e,n)}e.success||i.heartbeatService.beat()}},this.firePlaybackFinishedEvent=function(){i.getAllSegmentControllers().every((function(e){var t=i.streamTimeService.getTimeForNextSegment(e.getMimeType());return e.hasNext(t)}))?i.logger.debug("ignoring ended event in firePlaybackFinishedEvent as there are more segments available"):i.manifestService.isLastPeriod(i.periodSwitchTracker.getCurrentPlayingPeriodId())?i.bufferController.hasFutureBufferBlockData()||(i.stop(),i.logger.debug("Stopping buffer controller"),i.bufferController.stop(!0),i.playerStateService.transitionToStoppedState()):i.logger.debug("ignoring ended event in firePlaybackFinishedEvent as there is a future period")},this.context=e,this.logger=e.logger,this.settings=e.settings,this.bufferSettings=e.bufferSettings,this.eventHandler=e.eventHandler,this.renderer=e.renderer,this.segmentAvailableCallback=t,this.initialized=!1,this.initPromise=null,this.mimeTypes={},this.seekCounter=0,this.eosSignaled=!1,this.isSwitchingAudioTrack=!1}return e.prototype.addRequiredMediaTypesForMuxedContent=function(e){this.bufferController.addRequiredMediaType(e,"video/mp4"),this.bufferController.addRequiredMediaType(e,"audio/mp4")},e.prototype.getTimestampOffset=function(e){var t,i=this,n=this.segmentControllerMap[e];return!n&&g.MimeTypeHelper.isAV(e)&&(n=Object.keys(this.segmentControllerMap).filter((function(e){return g.MimeTypeHelper.isAV(e)})).map((function(e){return i.segmentControllerMap[e]})).filter((function(e){return i.isAVMultiplexed(e)})).shift()),null!==(t=null==n?void 0:n.getMPDHandler().getTimestampOffset())&&void 0!==t?t:0},e.prototype.restorePlaybackPositionAfterDownloadedRepresentationWasExcluded=function(){var e=this,t=this.manifestService.isLive(),i=t?this.getTimeShift():this.renderer.getCurrentTime();t?this.timeShift(i,(function(){}),!0).catch((function(t){return e.context.logger.debug("TimeShift failed",t)})):this.seek(i,!1,!1,!0)},e.prototype.onDownloadedRepresentationExcluded=function(){this.restorePlaybackPositionAfterDownloadedRepresentationWasExcluded(),this.context.logger.debug("manifest update interrupted by DRM key status change")},e.prototype.shouldDropSegment=function(e){var t=g.MimeTypeHelper.isSubtitle(e.getMimeType()),i=this.context.sourceContext.technology.streaming===s.StreamType.Hls,n=(0,p.getStartTimeOffset)(this.getSourceStore().getState())+this.manifestService.getDuration(),r=this.isVod()&&e.getPlaybackTime()>=n,o=this.eosSignaled||r,a=this.manifestService.isRepresentationExcluded(e.getRepresentationId());return!t&&!i&&o||a},e.prototype.getSourceStore=function(){return this.context.serviceManager.get(n.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier)},e.prototype.isAVMultiplexed=function(e){var t=h.CodecStringHelper.extractCodecStrings(e.getCodecs());return Boolean(t.video&&t.audio)},e.prototype.getMaxTimeShift=function(){return this.getTimeShiftHandler().getMaxTimeShift()},e.prototype.removeEventHandlers=function(){this.eventHandler.off(o.PlayerEvent.SegmentRequestFinished,this.onSegmentRequestFinished)},e.prototype.subscribeToSeekProcess=function(){var e=this,t=this.context.store;!this.unsubscribeFromSeekProcess&&t&&(this.unsubscribeFromSeekProcess=(0,f.subscribe)(t)((function(e){if(e)return(0,c.getPlayerState)(e).seekingProcess}),(function(t,i){return t&&i&&e.onSeekProcessChange(t,i)})))},e.prototype.subscribeToManifestChanges=function(){var e=this.getSourceStore();!this.unsubscribeFromManifestStore&&e&&(this.unsubscribeFromManifestStore=(0,f.subscribe)(e)(A.getManifest,this.mpdAvailableHandler,(function(e,t){return e.isInitialized&&!t.isInitialized})))},e.prototype.unsubscribeFromManifestChanges=function(){this.unsubscribeFromManifestStore&&(this.unsubscribeFromManifestStore(),this.unsubscribeFromManifestStore=null)},e.prototype.subscribeToPlayingTracksChanges=function(){var e=this.getSourceStore();!this.unsubscribeFromPlayingTracksStore&&e&&(this.unsubscribeFromPlayingTracksStore=(0,f.subscribe)(e)(E.getPlayingTracksState,this.onPeriodSwitched,E.wasSwitchingToPeriodIdReset))},e.prototype.unsubscribeFromPlayingTracksChanges=function(){this.unsubscribeFromPlayingTracksStore&&(this.unsubscribeFromPlayingTracksStore(),this.unsubscribeFromPlayingTracksStore=void 0)},e.prototype.setupControllerForAdaptationSet=function(e){var t,i=(0,I.getMimeTypeForAdaptationSet)(e);if(g.MimeTypeHelper.isAV(i)){this.context.store.dispatch((0,u.initializeMetricsForMimeType)(i,this.context.settings)),this.getSourceStore().dispatch((0,R.setMediaTypeAction)(e._internalId,(0,b.resolveMediaTypes)(e))),this.mimeTypes[i]=(0,I.getCodecsFromAdaptationSet)(e);var n=this.periodSwitchTracker.getCurrentPlayingPeriodId();this.segmentControllerMap[i]=new P.SegmentController(this.context,this.onSegmentAvailable,i,this.mimeTypes[i],e.isTransmuxingRequired,this.manifestLoader,null!==(t=e._periodId)&&void 0!==t?t:n,this.getSourceStore()),n&&this.renderer.storeDrmInitDataFromManifest(e),this.context.segmentInfoService&&this.context.segmentInfoService.setSegmentControllers(Object.values(this.segmentControllerMap))}},e.prototype.updatePeriodForTimeshift=function(e,t){var i=this.periodSwitchTracker.getCurrentPlayingPeriodId();i||(this.periodSwitchTracker.setCurrentPlayingPeriodId(e),this.bufferController.setInitialPeriod(e)),this.periodSwitchTracker.getCurrentLoadingPeriodId()!==e&&this.switchLoadingPeriodForAllMedia(e),t&&i!==e&&(this.context.logger.debug("Updating current playing period to ".concat(e)),this.periodSwitchTracker.setCurrentPlayingPeriodId(e))},e.prototype.updateVideoAndAudioMediaTypes=function(e){var t=e.AdaptationSet.find((function(e){return g.MimeTypeHelper.isVideo(e._mimeType)}));t&&this.bufferController.addRequiredMediaType(e._id,t._mimeType);var i=e.AdaptationSet.find((function(e){return g.MimeTypeHelper.isAudio(e._mimeType)}));i&&this.bufferController.addRequiredMediaType(e._id,i._mimeType)},e.prototype.updateSubtitleMediaTypes=function(e){var t=this;e.AdaptationSet.filter((function(e){return g.MimeTypeHelper.isSubtitle(e._mimeType)})).forEach((function(i){t.bufferController.addRequiredMediaType(e._id,i._mimeType)}))},e.prototype.updateMediaTypes=function(e){this.updateVideoAndAudioMediaTypes(e),this.updateSubtitleMediaTypes(e)},e.prototype.updatePeriodInformation=function(){var e=this;this.manifestService.getAllPeriods().forEach((function(t){e.updateMediaTypes(t),e.bufferController.checkIfEndOfBufferReached(e.settings.END_OF_BUFFER_TOLERANCE)}))},e.prototype.finishInit=function(){var e=this;return this.initPromise?this.initPromise:!0===this.initialized||null===this.manifestService.getManifest()?this.initPromise=Promise.resolve():(this.disposeSegmentControllers(),this.mimeTypes={},this.initPromise=this.renderer.ready().then((function(){return e.initializeDependents()})))},e.prototype.disposeSegmentControllers=function(){var e=this;this.segmentControllerMap&&(Object.keys(this.segmentControllerMap).forEach((function(t){return e.segmentControllerMap[t].dispose()})),this.segmentControllerMap={})},e.prototype.createTransmuxer=function(){var e=this;if(S.ModuleManager.has(v.ModuleName.ContainerTS)){var t=S.ModuleManager.get(v.ModuleName.ContainerTS);this.getAllSegmentControllers().filter((function(e){return e.isTransmuxerRequired()})).forEach((function(i){e.transmuxer=e.transmuxer||new t.WebWorkerTransmuxer(e.context,e.hasSeparateAudioPlaylist()),i.setTransmuxer(e.transmuxer)})),this.subtitleService&&this.subtitleService.setTransmuxer(this.transmuxer)}},e.prototype.hasSeparateAudioPlaylist=function(){return this.getAllSegmentControllers().some((function(e){return g.MimeTypeHelper.isAudio(e.getMimeType())}))},e.prototype.initializeDependents=function(){this.periodSwitchTracker.setInitialPeriod(),this.initializeBufferController(),this.updatePeriodInformation();var e=this.periodSwitchTracker.getCurrentPlayingPeriod()||this.manifestService.getFirstPeriod();e&&this.initializeSegmentController(e),this.enableForcedSubtitles(),this.createTransmuxer(),this.initialized=!0},e.prototype.enableForcedSubtitles=function(){var e=this.getAudioSegmentController();if(this.subtitleService&&e){var t=e.getCurrentLangObj().lang;this.subtitleService.enableForcedSubtitle(t)}},e.prototype.initializeSegmentController=function(e){var t,i=this;(null!==(t=null==e?void 0:e.AdaptationSet)&&void 0!==t?t:[]).forEach((function(e){return i.createSegmentControllerIfMediaTypeIsMissing(e)}))},e.prototype.createSegmentControllerIfMediaTypeIsMissing=function(e){var t=(0,I.getMimeTypeForAdaptationSet)(e);(0,g.isMediaTypeContained)(this.mimeTypes,t)||this.setupControllerForAdaptationSet(e)},e.prototype.initializeBufferController=function(){this.bufferController=new y.BufferController(this.context,this.endStallAtGap,this.manifestService.getTotalDuration(),this.periodSwitchTracker.getCurrentPlayingPeriodId())},e.prototype.getBufferLevel=function(e,t,i,n){return void 0===n&&(n=!0),this.bufferController?this.bufferController.getOverallBufferLevel(e,t,i,n):0},e.prototype.handleDroppedOutPeriods=function(){var e=this;this.periodSwitchTracker.shouldHandleDroppedOutPeriod()&&(this.periodSwitchTracker.isPlayingPeriodDroppedOut()?(this.logger.debug("Playing period dropped out of the manifest, timeshifting to current position"),this.switchLoadingPeriodForAllMedia(this.manifestService.getPeriodIdForTime(this.getCurrentTime())),this.timeShift(this.getTimeShift()).catch((function(t){return e.context.logger.debug("TimeShift failed",t)}))):this.periodSwitchTracker.isLoadingPeriodDroppedOut()&&(this.logger.debug("Current loading period (".concat(this.periodSwitchTracker.getCurrentLoadingPeriodId(),") ")+"dropped out of the manifest, switching to first available one"),this.getAllSegmentControllers().forEach((function(e){return e.invalidateOngoingRequests()})),this.switchLoadingPeriodForAllMedia(this.manifestService.getFirstPeriod()._id)))},e.prototype.initializeThumbnails=function(){var e=this;this.context.serviceManager.maybeCall(n.ServiceName.ThumbnailService,(function(t){e.context.sourceContext.source&&e.context.sourceContext.source.thumbnailTrack||t.addThumbnails(e.manifestService.getAllDashThumbnailSources())}))},e.prototype.applyManifestTimings=function(){var e=this.manifestService.isLive(),t=this.context.serviceManager.get(n.ServiceName.StartOffsetService),i=this.manifestService.hasSuggestedStartPosition();if(e){var r=this.manifestService.getTimeShiftBufferDepthSeconds();0!==r&&(this.metadataParsedService.expirationTimeInSeconds=r),i&&(t.manifestStartOffset=this.manifestService.getLiveStartOffset(),this.adjustMaximumBufferLevel())}else i&&(t.manifestStartOffset=this.manifestService.getVodStartOffset())},e.prototype.adjustMaximumBufferLevel=function(){var e=Math.abs(this.manifestService.getLiveStartOffset(!1));e=e>0?e:this.manifestService.getMaxSegmentDuration();var t=Math.min(e,this.bufferSettings.getForwardTargetLevel(s.MediaType.Video)),i=Math.min(e,this.bufferSettings.getForwardTargetLevel(s.MediaType.Audio));this.bufferSettings.setMaximumBufferLevel(s.BufferType.ForwardDuration,t,s.MediaType.Video),this.bufferSettings.setMaximumBufferLevel(s.BufferType.ForwardDuration,i,s.MediaType.Audio)},e.prototype.terminate=function(){var e=this;this.logger.debug("stopping playback"),this.stop(),this.getAllSegmentControllers().forEach((function(e){return e.stop()})),this.bufferController&&this.bufferController.stop(!0),this.transmuxer=(0,r.dispose)(this.transmuxer),this.timeshiftHandler=(0,r.dispose)(this.timeshiftHandler),this.drmKidErrorHandler=(0,r.dispose)(this.drmKidErrorHandler),(0,r.dispose)(this.periodSwitchTracker),this.cachedSeekableRange=null,this.renderer.off(m.MediaElementEvent.ended,this.firePlaybackFinishedEvent);var t=this.renderer.shutdown().catch((function(t){return e.logger.debug("Got an error on shutdown",{message:t.message}),Promise.resolve()}));return this.removeEventHandlers(),this.unsubscribeFromPlayingTracksChanges(),this.initialized=!1,this.periodSwitchTracker.setCurrentPlayingPeriodId(null),this.mimeTypes=null,this.context.store.dispatch((0,l.resetDrmKidErrors)()),this.manifestService.resetExcludedRepresentations(),this.disposeSegmentControllers(),t},e.prototype.dispose=function(){this.timeshiftHandler=(0,r.dispose)(this.timeshiftHandler),this.bufferController=(0,r.dispose)(this.bufferController),(0,r.dispose)(this.periodSwitchTracker);try{this.removeEventHandlers()}catch(e){}this.unsubscribeFromManifestChanges(),this.unsubscribeFromPlayingTracksChanges(),this.disposeSegmentControllers(),this.unsubscribeFromSeekProcess&&this.unsubscribeFromSeekProcess(),this.subtitleService=null,this.heartbeatService=null,this.streamTimeService=null,this.segmentControllerMap=null,this.settings=null,this.bufferSettings=null,this.eventHandler=null,this.renderer=null,this.mimeTypes=null,this.sourceType=null},e.prototype.acquireServices=function(){var e=this.context.sourceContext.sourceIdentifier;this.manifestService=this.context.serviceManager.get(n.ServiceName.ManifestService,e),this.playerStateService=this.context.serviceManager.get(n.ServiceName.PlayerStateService),this.subtitleService=this.context.serviceManager.get(n.ServiceName.SubtitleService),this.metadataParsedService=this.context.serviceManager.get(n.ServiceName.MetadataParsedService),this.manifestLoader=this.context.serviceManager.get(n.ServiceName.ManifestLoadingService,e),this.heartbeatService=this.context.serviceManager.get(n.ServiceName.HeartbeatService,e),this.streamTimeService=this.context.serviceManager.get(n.ServiceName.StreamTimeService),this.manifestUpdateScheduler=this.context.serviceManager.get(n.ServiceName.ManifestUpdateSchedulingService,e)},e.prototype.init=function(e){var t=this,i=this.getSourceStore();return this.periodSwitchTracker=new C.PeriodSwitchTracker(this.context),this.subscribeToPlayingTracksChanges(),this.subscribeToSeekProcess(),this.isAudioCatchingUp=!1,this.context.store.dispatch((0,l.resetDrmKidErrors)()),this.acquireServices(),i&&!this.drmKidErrorHandler&&(this.drmKidErrorHandler=new T.DrmKidErrorHandler(this.context,(function(){return t.onDownloadedRepresentationExcluded()}))),this.sourceType=e.type,this.renderer.on(m.MediaElementEvent.ended,this.firePlaybackFinishedEvent),this.manifestUpdateScheduler.isInitiated()?(this.subscribeToManifestChanges(),this.mpdAvailableHandler(),Promise.resolve()):this.manifestUpdateScheduler.init(e.url.toString()).then((function(){t.subscribeToManifestChanges(),t.mpdAvailableHandler()}))},e.prototype.stop=function(){this.logger.debug("Stopping main timer"),this.heartbeatService.stop(),this.initPromise=null,this.eventHandler.off(o.PlayerEvent.SegmentRequestFinished,this.onSegmentRequestFinished),this.unsubscribeFromManifestChanges()},e.prototype.isOneLoaderReady=function(){return this.getAllSegmentControllers().some((function(e){return e.canLoad()}))},e.prototype.areAllLoadersReady=function(){return this.getAllSegmentControllers().every((function(e){return e.canLoad()}))},e.prototype.isVod=function(){return!this.manifestService.isLive()},e.prototype.shouldStopDownloadWhenPaused=function(){return this.playerStateService.isPaused()&&this.settings.STOP_DOWNLOAD_ON_PAUSE&&this.manifestService.isLive()},e.prototype.shouldWaitForOtherMimeTypeDownload=function(e){var t=Object.keys(this.segmentControllerMap).find((function(t){return g.MimeTypeHelper.isAV(t)&&e!==t}));if(!t)return!1;if(this.isAudioCatchingUp)return g.MimeTypeHelper.isAudio(t);var i=this.segmentControllerMap[t],n=this.streamTimeService.getTimeForNextSegment(t);if(t&&!i.hasDownloadError&&i.hasNext(n)){var r=this.getBufferRelevantTime(),o=this.getCurrentForwardBuffer(e,r),a=this.getCurrentForwardBuffer(t,r),s=this.hasReachedTargetBufferLevel(t,a);return o>a&&!s}return i.getCurrentPeriodId()!==this.segmentControllerMap[e].getCurrentPeriodId()},e.prototype.hasReachedTargetBufferLevel=function(e,t){var i=g.MimeTypeHelper.getMediaType(e);return t>=this.bufferSettings.getForwardTargetLevel(i)},e.prototype.shouldEndOfStreamBeSignaled=function(){var e=this,t=this.getAllSegmentControllers(),i=this.bufferController.hasPendingSegments(),n=t.map((function(e){return e.getMimeType()})),r=t.some((function(e){return e.hasPendingSegments()})),o=n.some((function(t){return e.renderer.isDataBeingAppended(t)}));return!r&&!i&&!o},e.prototype.shouldSuspendHeartbeat=function(){return!this.isOneLoaderReady()||this.shouldStopDownloadWhenPaused()||Boolean(this.clearBuffersPromise)||this.isSwitchingAudioTrack},e.prototype.getActiveSegmentControllers=function(){var e=this;return this.getAllSegmentControllers().filter((function(t){return e.isSegmentControllerActive(t)}))},e.prototype.isSegmentControllerActive=function(e){var t=this.periodSwitchTracker.getCurrentLoadingPeriodId(),i=this.streamTimeService.getTimeForNextSegment(e.getMimeType());return e.canLoad()&&(e.hasNext(i)||e.hasPendingSegments(t))&&!this.shouldWaitForOtherMimeTypeDownload(e.getMimeType())},e.prototype.getActiveMimeTypes=function(){return this.getActiveSegmentControllers().map((function(e){return e.getMimeType()}))},e.prototype.getSegmentControllersForMimeType=function(e){return this.getAllSegmentControllers().filter((function(t){return e===t.getMimeType()}))},e.prototype.requestSegmentsForMimeType=function(e,t){var i=this;this.getSegmentControllersForMimeType(e).forEach((function(e){return i.getNextSegment(e,t)}))},e.prototype.shouldClearSubtitleServiceBuffers=function(){return Boolean(this.subtitleService&&!this.playerStateService.seekingOrTimeshifting)},e.prototype.clearSubtitleServiceBuffers=function(){var e=10;this.subtitleService.clearBuffersUntil(this.renderer.getCurrentTime()-e)},e.prototype.areMediaTypesFinalForPlayingPeriod=function(){return this.bufferController.areBufferBlockMediaTypesFinal(this.periodSwitchTracker.getCurrentPlayingPeriodId())},e.prototype.maybeStop=function(){var e=this.manifestService.isManifestFinalized(),t=this.manifestService.isLastPeriod(this.periodSwitchTracker.getCurrentLoadingPeriodId());e&&t&&(this.bufferController.stop(!1),this.shouldEndOfStreamBeSignaled()&&(this.signalEndOfStream(),this.stop()))},e.prototype.getNextSegment=function(e,t){if(e.canLoad()){var i=g.MimeTypeHelper.getMediaType(e.getMimeType()),r=this.bufferSettings.getForwardTargetLevel(i),o=this.getCurrentForwardBuffer(e.getMimeType(),this.getBufferRelevantTime());o>=r||(this.context.serviceManager.get(n.ServiceName.AdaptationService).addSample(e.getMimeType(),{bufferTargetLevel:r,bufferLevel:o}),e.hasNext(t)&&e.getNext(t))}},e.prototype.getBufferRelevantTime=function(){return this.playerStateService.seekingOrTimeshifting?this.playerStateService.targetPlaybackTime:this.renderer.getCurrentTime()},e.prototype.getCurrentForwardBuffer=function(e,t){return this.getBufferLevel(e,t,s.BufferType.ForwardDuration)},e.prototype.isLoadingLastPeriod=function(){return this.periodSwitchTracker.isLoadingLastPeriod()},e.prototype.switchLoadingPeriod=function(){if(this.isAudioCatchingUp){var e=this.getAudioSegmentController(),t=e.getCurrentPeriodId(),i=this.manifestService.getNextPeriod(t)._id;this.switchLoadingPeriodForAudio(i),e.getCurrentPeriodId()===this.periodSwitchTracker.getCurrentLoadingPeriodId()&&(e.isTransmuxerRequired()&&e.getTransmuxer()&&(e.getTransmuxer().dispose(),e.setTransmuxer(this.transmuxer)),this.isAudioCatchingUp=!1,this.logger.debug("The audio SegmentController caught up to the overall loading period again."))}else{var n=this.manifestService.getNextPeriod(this.periodSwitchTracker.getCurrentLoadingPeriodId());n&&this.switchLoadingPeriodForAllMedia(n._id)}},e.prototype.switchLoadingPeriodForAllMedia=function(e){var t=this;e!==this.periodSwitchTracker.getCurrentLoadingPeriodId()&&(this.isAudioCatchingUp=!1,this.prepareLoadingPeriodSwitch(e),this.getAllSegmentControllers().filter((function(t){return t.getCurrentPeriodId()!==e})).forEach((function(i){i.switchPeriod(e),t.renderer.storeDrmInitDataFromManifest(i.getAdaptationSetForPeriodId(e))})),this.periodSwitchTracker.setCurrentLoadingPeriodId(e))},e.prototype.prepareLoadingPeriodSwitch=function(e){var t,i,n=this;(null!==(i=null===(t=this.manifestService.getPeriod(new M.PeriodId(e)))||void 0===t?void 0:t.AdaptationSet)&&void 0!==i?i:[]).forEach((function(e){return n.createSegmentControllerIfMediaTypeIsMissing(e)})),this.resetTransmuxer()},e.prototype.switchLoadingPeriodForAudio=function(e){var t=this.getAudioSegmentController(),i=t.getCurrentPeriodId();t.resetTransmuxer(),t.switchPeriod(e),this.logger.debug("Switched audio loading period from ".concat(i," to ").concat(e))},e.prototype.isAVCompletelyLoaded=function(){var e=this.getAllSegmentControllers().some((function(e){return e.hasPendingSegments()}))||this.bufferController.hasPendingSegments();return this.manifestService.isManifestFinalized()&&!e},e.prototype.getBufferedRanges=function(e){return void 0===e&&(e=!1),this.bufferController.getBufferedRangesMap(this.periodSwitchTracker.getCurrentPlayingPeriodId(),e)},e.prototype.resetTransmuxer=function(){this.transmuxer&&(this.transmuxer.dispose(),this.transmuxer=null),this.createTransmuxer()},e.prototype.restartBufferController=function(){this.bufferController.hasStopped()&&this.bufferController.restart()},e.prototype.shouldBuffersBeCleared=function(e,t,i){var n=e<this.renderer.getCurrentTime()&&this.context.settings.CLEAR_BUFFERS_ON_SEEKING_BACKWARDS;return!t&&(!this.bufferController.isInBufferedRange(e)||n)||i},e.prototype.onSeekProcessChange=function(e,t){var i;if(-1===e.targetTime&&t.targetTime>=0)null===(i=this.playerStateService)||void 0===i||i.transitionToSeekedState(t.issuer!==a.STARTUP_ISSUER_NAME);else{var n=e.targetTime!==t.targetTime,r=e.targetTime>=0;n&&r&&this.seek(e.targetTime,e.issuer===a.STARTUP_ISSUER_NAME)}},e.prototype.seek=function(e,t,i,n){var r=this;if(void 0===t&&(t=!1),void 0===i&&(i=!1),void 0===n&&(n=!1),this.bufferController){this.restartBufferController(),this.seekCounter++;var o,a,s=this.seekCounter,u=this.manifestService.getPeriodIdForTime(e);this.ensureInitialPeriod(u),this.logger.debug("seek from current period (".concat(this.periodSwitchTracker.getCurrentPlayingPeriodId(),") to target period ")+"(".concat(u,") - seek time in period is: ").concat(e)),this.bufferController.readyToSeek().then((function(){if(a=r.shouldBuffersBeCleared(e,i,n),o=r.periodSwitchTracker.getCurrentLoadingPeriodId()!==u&&a,a&&r.bufferController.isBufferAvailable())return r.clearBuffersPromise=r.clearBuffersOnSeek(),r.clearBuffersPromise})).then((function(){return r.clearBuffersPromise=null,r.initialized?(r.getAllSegmentControllers().forEach((function(e){return e.setAdaptionLogicStartupPhase()})),o&&r.switchLoadingPeriodForAllMedia(u),a&&r.getAllSegmentControllers().forEach((function(t){return t.seekTo(e)})),(t?Promise.resolve():r.start()).then((function(){r.bufferController.setCurrentTime(e).then((function(t){r.seekCounter===s?(r.logger.debug("Successfully seeked to ".concat(t)),r.context.store.dispatch((0,d.updateSeekingProcess)({targetTime:-1,issuer:"",isInitial:!1}))):O(r.context.store)&&r.context.logger.debug("Seek to ".concat(e," has finished but a newer operation has been started"))})).catch((function(e){r.logger.debug("Failed to set currentTime on seek",e)}))}))):(r.logger.debug("Aborting seek as MediaPlayerController has been terminated!"),Promise.resolve())}))}},e.prototype.ensureInitialPeriod=function(e){var t=this;void 0===this.periodSwitchTracker.getCurrentPlayingPeriodId()&&(this.logger.debug("current period is undefined, using seek target period "+e),this.periodSwitchTracker.setCurrentPlayingPeriodId(e),this.resetTransmuxer(),this.getAllSegmentControllers().forEach((function(e){e.switchPeriod(t.periodSwitchTracker.getCurrentPlayingPeriodId()),g.MimeTypeHelper.isAV(e.getMimeType())&&t.renderer.storeDrmInitDataFromManifest(e.getCurrentAdaptationSet())})),this.periodSwitchTracker.setCurrentLoadingPeriodId(this.periodSwitchTracker.getCurrentPlayingPeriodId()),this.bufferController.setInitialPeriod(e))},e.prototype.clearBuffersOnSeek=function(){var e=this;return this.eosSignaled=!1,this.getAllSegmentControllers().forEach((function(e){return e.cancelLoading()})),this.bufferController.setEndOfStream(!1).then((function(){return e.bufferController.clearBuffers()})).catch((function(){e.logger.debug("Failed to clear buffers on seek, carrying on regardless")}))},e.prototype.getAllSegmentControllers=function(){return Object.values(this.segmentControllerMap||{})},e.prototype.getAudioSegmentController=function(){return this.getAllSegmentControllers().find((function(e){return g.MimeTypeHelper.isAudio(e.getMimeType())}))},e.prototype.updateAdaptationLogicData=function(e,t){var i=g.MimeTypeHelper.getMediaType(t.getMimeType()),r=this.getBufferLevel(t.getMimeType(),this.renderer.getCurrentTime(),s.BufferType.ForwardDuration),o=this.bufferSettings.getForwardTargetLevel(i),a=e.duration/e.downloadTime;e.isInit||this.context.serviceManager.get(n.ServiceName.AdaptationService).addSample(t.getMimeType(),{bufferTargetLevel:o,bufferLevel:r,downloadRate:a})},e.prototype.signalEndOfStream=function(e){void 0===e&&(e=!0),this.isVod()&&(this.eosSignaled||(this.eosSignaled=!0,this.bufferController.setEndOfStream(!0),e&&this.stop()),this.bufferController.isStarted()&&this.bufferController.stop())},e.prototype.start=function(){var e=this;return this.hasStarted()?Promise.resolve():this.finishInit().then((function(){e.bufferController.hasStreamEnded()&&(e.seek((0,p.getStartTimeOffset)(e.getSourceStore().getState())),e.getAllSegmentControllers().forEach((function(e){return e.resetTransmuxer()}))),e.bufferController.isStarted()||e.bufferController.restart(),e.getAllSegmentControllers().filter((function(e){return g.MimeTypeHelper.isAV(e.getMimeType())})).forEach((function(t){return e.renderer.storeDrmInitDataFromManifest(t.getCurrentAdaptationSet())})),e.logger.debug("Starting main timer"),e.eosSignaled=!1,e.heartbeatService.start(),e.subscribeToManifestChanges(),e.eventHandler.on(o.PlayerEvent.SegmentRequestFinished,e.onSegmentRequestFinished)}))},e.prototype.clearBuffers=function(e){var t=this;return Promise.all(e.map((function(e){return t.bufferController.clearCacheForMimeType(e),t.bufferController.clearBuffer(e)}))).then((function(){}))},e.prototype.recoverFromImpreciseTimeShiftAfterAudioTrackSwitch=function(e){var t=this;this.manifestService.isLive()&&!this.settings.ENABLE_SEEK_FOR_LIVE&&this.renderer.setCurrentTime(e).catch((function(){return t.logger.debug("Could not set currentTime")}))},e.prototype.restorePlaybackPositionAfterAudioTrackSwitch=function(e,t){var i=this;return this.bufferController.setEndOfStream(!1).then((function(){var n=i.clearBuffers(e.getSourceBufferTypes());return e.getCurrentPeriodId()!==i.periodSwitchTracker.getCurrentPlayingPeriodId()?i.prepareControllerForAudioTrackChange(e):e.getCurrentPeriodId()!==i.periodSwitchTracker.getCurrentLoadingPeriodId()&&i.periodSwitchTracker.setCurrentLoadingPeriodId(e.getCurrentPeriodId()),e.setAdaptionLogicStartupPhase(),e.seekTo(t),i.start().catch((function(){return i.logger.debug("Could not restart stopped MPC after audio track switch")})),n.then((function(){return i.recoverFromImpreciseTimeShiftAfterAudioTrackSwitch(t)})).catch((function(e){return i.logger.debug("Failed to set currentTime on audio track switch",e)}))}))},e.prototype.isHlsManifestLoader=function(e){return"hls"===this.sourceType},e.prototype.setAudio=function(e){var t=this.getAvailableAudio(this.periodSwitchTracker.getCurrentPlayingPeriodId()).find((function(t){return t.id===e})),i=this.getAudio();return this.initialized&&t?i&&i.id===e?Promise.reject(i):this.switchAudioTrack(t):Promise.reject(null)},e.prototype.updateAdaptationSet=function(e,t,i){var n=this;return g.MimeTypeHelper.isAudio(t)&&this.isHlsManifestLoader(this.manifestLoader)?this.manifestLoader.updateAdaptationSet(i).then((function(){return n.getAllSegmentControllers().forEach((function(e){return e.updateMpd()}))})).then((function(){return e})):Promise.resolve(e)},e.prototype.switchAudioTrack=function(e){var t=this;this.isSwitchingAudioTrack=!0;var i=Object.keys(this.segmentControllerMap),n=i.find(g.MimeTypeHelper.isAudio)||i.find(g.MimeTypeHelper.isVideo),r=this.segmentControllerMap[n].getCurrentAdaptationSet(),o=this.manifestService.getAdaptationSet(e.adaptationSetId);return r&&o&&n?this.maybeChangeAudioBufferType(r,o,n).then((function(i){return t.updateAdaptationSet(i,n,e.id)})).then((function(i){return t.updateRelevantSegmentControllers(i,e)})).finally((function(){return t.isSwitchingAudioTrack=!1})):Promise.reject("Did not find matching adaptation set")},e.prototype.maybeChangeAudioBufferType=function(e,t,i){var n,r=this,o=!(0,L.hasContentProtection)(e.ContentProtection,t.ContentProtection);if(!D(t,e)&&!o)return Promise.resolve(((n={})[t._mimeType]="",n));var a=Object.keys(this.segmentControllerMap).find(g.MimeTypeHelper.isVideo);return this.recreateCurrentSegmentController(i,t).then((function(){return o&&a?r.clearBuffersAndSeek(a):Promise.resolve()})).then((function(){return r.bufferController.changeBufferType(t._mimeType,r.mimeTypes[t._mimeType])}))},e.prototype.clearBuffersAndSeek=function(e){var t=this;return this.clearBuffers([e]).then((function(){var i;t.segmentControllerMap[e].seekTo(t.renderer.getCurrentTime()),null===(i=t.timeshiftHandler)||void 0===i||i.updateSegmentControllers(t.segmentControllerMap)}))},e.prototype.recreateCurrentSegmentController=function(e,t){var i=this,n=this.segmentControllerMap[e],r=n.getCurrentAdaptationSet()._internalId;return this.getSourceStore().dispatch((0,R.removeActiveTrackAction)(r)),n.dispose(),this.clearBuffers([e]).then((function(){var n;return delete i.segmentControllerMap[e],delete i.mimeTypes[e],i.setupControllerForAdaptationSet(t),null===(n=i.timeshiftHandler)||void 0===n||n.updateSegmentControllers(i.segmentControllerMap),t._mimeType}))},e.prototype.updateRelevantSegmentControllers=function(e,t){var i=this;return Promise.all(Object.keys(e).map((function(e){return i.updateSegmentController(t,e)}))).then((function(){}))},e.prototype.updateSegmentController=function(e,t){if(this.subtitleService&&this.subtitleService.enableForcedSubtitle(e.lang),this.segmentControllerMap[t].setCurrentLangObj(e),this.segmentControllerMap[t].cancelLoading(),this.hasStarted()||this.eosSignaled){var i=this.getBufferRelevantTime();return this.restorePlaybackPositionAfterAudioTrackSwitch(this.segmentControllerMap[t],i)}return Promise.resolve()},e.prototype.getAudio=function(){if(this.initialized){var e=void 0,t=Object.keys(this.segmentControllerMap).find((function(e){return g.MimeTypeHelper.isAudio(e)}));if(t&&(e=this.segmentControllerMap[t].getCurrentLangObj()),!e){var i=Object.keys(this.segmentControllerMap).find((function(e){return g.MimeTypeHelper.isVideo(e)}));if(i&&this.segmentControllerMap[i].getSourceBufferTypes()){var n=this.segmentControllerMap[i];if(n.getSourceBufferTypes().some((function(e){return g.MimeTypeHelper.isAudio(e)}))){var r=n.getCurrentAdaptationSet()._internalId;e=this.getAvailableAudio(this.periodSwitchTracker.getCurrentPlayingPeriodId()).find((function(e){return e.adaptationSetId===r}))||n.getCurrentLangObj()}}}return e||null}return null},e.prototype.prepareControllerForAudioTrackChange=function(e){if(this.isAVMultiplexed(e))this.switchLoadingPeriodForAllMedia(this.periodSwitchTracker.getCurrentPlayingPeriodId());else{if(this.logger.debug("audio needs to load previous period(s) and catch up to the overall loading period"),e.isTransmuxerRequired()){var t=S.ModuleManager.get(v.ModuleName.ContainerTS);e.setTransmuxer(new t.WebWorkerTransmuxer(this.context,this.hasSeparateAudioPlaylist()))}this.isAudioCatchingUp=!0,this.switchLoadingPeriodForAudio(this.periodSwitchTracker.getCurrentPlayingPeriodId())}},e.prototype.getPlaybackRepresentation=function(e){for(var t in this.segmentControllerMap)if(this.segmentControllerMap[t]&&t.includes(e))return this.context.serviceManager.get(n.ServiceName.TimedMetadataService).getPlaybackRepresentation(t);return null},e.prototype.getTimeShift=function(){return this.getTimeShiftHandler().getTimeShift()},e.prototype.getTimeShiftLiveEdge=function(){return this.manifestService.isLive()?this.getTimeShiftHandler().getTimeShiftLiveEdge():0},e.prototype.getTimeShiftHandler=function(){return this.timeshiftHandler||(this.timeshiftHandler=new B.TimeShiftHandler(this.context,this,this.bufferController,this.segmentControllerMap)),this.timeshiftHandler},e.prototype.timeShift=function(e,t,i){return void 0===i&&(i=!1),this.getTimeShiftHandler().timeShift(e,t,i)},e.prototype.getAvailableAudio=function(e){return this.manifestService.getAvailableAudio(e)},e.prototype.hasStreamEnded=function(){return!!this.bufferController&&this.bufferController.hasStreamEnded()},e.prototype.getCurrentTime=function(){return this.renderer.getCurrentTime()},e.prototype.getSeekableRange=function(){if(this.manifestService.isLive()){if(this.playerStateService.seekingOrTimeshifting&&this.cachedSeekableRange)return this.cachedSeekableRange;var e=this.getTimeShiftLiveEdge(),t=e+this.getMaxTimeShift();return this.cachedSeekableRange={start:t,end:e}}var i=this.getAllSegmentControllers().find((function(e){return g.MimeTypeHelper.isAV(e.getMimeType())}));return i?i.getMPDHandler().getSeekableRange():{start:-1,end:-1}},e.prototype.getAvailableSegments=function(){var e=this,t={};return Object.keys(this.segmentControllerMap).forEach((function(i){t[i]=e.segmentControllerMap[i].getSegmentInfos()})),t},e.prototype.isInitialized=function(){return this.initialized},e.prototype.hasStarted=function(){var e,t;return null!==(t=null===(e=this.heartbeatService)||void 0===e?void 0:e.started)&&void 0!==t&&t},e}();function D(e,t){return!(0,L.areAudioMimeCodecsCompatible)({mimeType:e._mimeType,codec:(0,I.getCodecsFromAdaptationSet)(e)},{mimeType:t._mimeType,codec:(0,I.getCodecsFromAdaptationSet)(t)})}function w(e,t){var i=e.getPlaybackTimeRange();i&&t.dispatch((0,x.removeStreamTimeRange)((0,k.getTrackIdentifier)(e.getSegmentInfo()),i,k.StreamTimeRangeType.Loading))}function O(e){var t=e.getState();if(!t)return!1;var i=(0,c.getPlayerState)(t).seekingProcess.issuer;return i!==a.STARTUP_ISSUER_NAME&&""!==i}t.MediaPlayerController=_,t.isBufferChangeRequired=D},97383:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.resolveMediaTypes=void 0;var n=i(46381),r=i(43233);function o(e){return(0,r.getCodecsFromAdaptationSet)(e).split(",").map((function(e){return(0,n.getMediaTypeFromCodec)(e)}))}t.resolveMediaTypes=o},81201:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MseModuleDefinition=void 0;var n=i(1520),r=i(86705),o=i(83024),a=i(8073),s=i(71278),u=i(51186),d=i(43233),c=i(63080),l=i(49835),p=i(30828),f=i(27999),h=i(92977),g=i(88784),m=i(59266),S=i(87384),v=i(27005),y=i(31998),T=i(51017),I=i(53088),M=i(26147),b=i(45110),P=i(76060),C=i(72766),R={removeStreamTimeRange:b.removeStreamTimeRange,removeLoadedRange:n.removeLoadedRange,addLoadedRange:n.addLoadedRange,resetLoadedRanges:n.resetLoadedRanges,resetStreamTimeline:b.resetStreamTimeline,removeActiveTrackAction:y.removeActiveTrackAction,setRepresentationIdAction:y.setRepresentationIdAction,setMediaTypeAction:y.setMediaTypeAction},A={getBufferState:r.getBufferState,getPlayingPeriodId:I.getPlayingPeriodId,getContainerFormat:T.getContainerFormat,getLoadedRangesForMimeType:r.getLoadedRangesForMimeType,getSegmentInfos:M.getSegmentInfos},E={containerFormat:a.ContainerFormat,streamTimeRangeType:P.StreamTimeRangeType};t.MseModuleDefinition={name:o.ModuleName.EngineBitmovin,module:{MediaPlayer:l.MediaPlayer,SegmentController:h.SegmentController,technologyChecker:new C.TechnologyChecker,Stream:v.Stream,FetchController:f.FetchController,SegmentInfoService:g.SegmentInfoService,SegmentPrefetchingService:S.SegmentPrefetchingService,AdRestorationOptimizationService:p.AdRestorationOptimizationService,ManifestCachingService:u.ManifestCachingService,SegmentListMPDHandler:m.SegmentListMPDHandler,actions:R,selectors:A,mseModuleTypes:E,AdaptationSetId:s.AdaptationSetId,RepresentationId:c.RepresentationId,getTrackIdentifier:P.getTrackIdentifier,getCodecsFromAdaptationSet:d.getCodecsFromAdaptationSet,getMimeTypeForAdaptationSet:d.getMimeTypeForAdaptationSet}},t.default=t.MseModuleDefinition},84493:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.PeriodSwitchTracker=void 0;var n=i(59534),r=i(59574),o=i(28803),a=i(80815),s=i(52038),u=i(53088),d=function(){function e(e){var t=this;this.finishPeriodSwitch=function(e,i){var n=i.switchingToPeriodId,o=t.getCurrentPlayingPeriodId();t.setCurrentPlayingPeriodId(n);var a=t.getCurrentPlayingPeriod();a&&a.AdaptationSet.forEach((function(e){return t.context.renderer.storeDrmInitDataFromManifest(e)})),t.logger.debug("Successfully switched from Period ".concat(o," to Period ").concat(n)),t.context.eventHandler.dispatchEvent(r.PlayerEvent.PeriodSwitched,{sourcePeriod:{periodId:o},targetPeriod:{periodId:n}})},this.context=e,this.logger=e.logger,this.eventHandler=e.eventHandler,this.subscribeToPlayingTracksChanges()}return e.prototype.getManifestService=function(){return this.context.serviceManager.get(n.ServiceName.ManifestService,this.context.sourceContext.sourceIdentifier)},e.prototype.getCurrentPlayingPeriod=function(){return this.getManifestService().findPeriod(this.getCurrentPlayingPeriodId())},e.prototype.subscribeToPlayingTracksChanges=function(){var e=this.getSourceStore();!this.unsubscribeFromPlayingTracksStore&&e&&(this.unsubscribeFromPlayingTracksStore=(0,o.subscribe)(e)(u.getPlayingTracksState,this.finishPeriodSwitch,u.wasSwitchingToPeriodIdReset))},e.prototype.unsubscribeFromPlayingTracksChanges=function(){this.unsubscribeFromPlayingTracksStore&&(this.unsubscribeFromPlayingTracksStore(),this.unsubscribeFromPlayingTracksStore=void 0)},e.prototype.getSourceStore=function(){return this.context.serviceManager.get(n.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier)},e.prototype.getCurrentLoadingPeriodId=function(){return this.currentLoadingPeriodId},e.prototype.setCurrentLoadingPeriodId=function(e){this.currentLoadingPeriodId=e},e.prototype.getCurrentPlayingPeriodId=function(){return(0,u.getPlayingPeriodId)(this.getSourceStore().getState())},e.prototype.setCurrentPlayingPeriodId=function(e){this.getSourceStore().dispatch((0,s.setPlayingPeriodId)(e))},e.prototype.resetPeriodIds=function(){this.setCurrentPlayingPeriodId(null),this.setCurrentLoadingPeriodId(void 0)},e.prototype.shouldHandleDroppedOutPeriod=function(){return!(null==this.getCurrentPlayingPeriodId()&&null==this.currentLoadingPeriodId)},e.prototype.isPeriodDroppedOut=function(e){return!this.getManifestService().getAllPeriods().map((function(e){return e._id})).includes(e)},e.prototype.isPlayingPeriodDroppedOut=function(){return this.isPeriodDroppedOut(this.getCurrentPlayingPeriodId())},e.prototype.isLoadingPeriodDroppedOut=function(){return this.isPeriodDroppedOut(this.currentLoadingPeriodId)},e.prototype.isLoadingLastPeriod=function(){return this.getManifestService().isLastPeriod(this.currentLoadingPeriodId)},e.prototype.setInitialPeriod=function(){var e=this.getManifestService().isLive()?this.getInitialPeriodForLive():this.getInitialPeriodForVod();this.currentLoadingPeriodId=e,this.setCurrentPlayingPeriodId(this.currentLoadingPeriodId),this.logger.debug("setting initial period to ".concat(this.currentLoadingPeriodId))},e.prototype.getInitialPeriodForLive=function(){var e=(0,a.toSeconds)(Date.now())-this.getManifestService().getDesiredDistanceToLiveEdge();return this.getManifestService().getPeriodIdForTime(e)},e.prototype.getInitialPeriodForVod=function(){var e=this.context.serviceManager.get(n.ServiceName.StartOffsetService).getStartOffset(this.context.sourceContext.source);return this.getManifestService().getPeriodIdForTime(e)},e.prototype.dispose=function(){this.unsubscribeFromPlayingTracksChanges()},e}();t.PeriodSwitchTracker=d},27752:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createSegmentParser=void 0;var n=i(43068),r=i(83024),o=i(8073);function a(e,t){if(t===o.ContainerFormat.MP4&&n.ModuleManager.has(r.ModuleName.ContainerMP4)){var i=n.ModuleManager.get(r.ModuleName.ContainerMP4);return new i.MP4Parser(e,new i.MP4EncryptionParser(e))}if(t===o.ContainerFormat.WEBM&&n.ModuleManager.has(r.ModuleName.ContainerWebM))return new(0,n.ModuleManager.get(r.ModuleName.ContainerWebM).WebMParser)}t.createSegmentParser=a},8144:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.StreamTimeService=void 0;var n=i(59534),r=i(12391),o=i(76060),a=function(){function e(e,t){this.serviceManager=e,this.sourceIdentifier=t}return Object.defineProperty(e.prototype,"sourceState",{get:function(){return this.serviceManager.get(n.ServiceName.SourceStoreService,this.sourceIdentifier).getState()},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"streamTimelineState",{get:function(){var e;return null===(e=this.sourceState)||void 0===e?void 0:e.streamTimeline},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"bufferState",{get:function(){var e;return null===(e=this.sourceState)||void 0===e?void 0:e.buffer},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"playerStateService",{get:function(){return this.serviceManager.get(n.ServiceName.PlayerStateService)},enumerable:!1,configurable:!0}),e.prototype.getTimeForNextSegment=function(e){var t,i,n,o=(0,r.findFromEnd)(this.streamTimelineState[e]||[],s),a=this.bufferState[e],u=[o,(null===(t=null==a?void 0:a.loadedRanges)||void 0===t?void 0:t[a.loadedRanges.length-1])||(null===(i=null==a?void 0:a.rendererRanges)||void 0===i?void 0:i[a.rendererRanges.length-1])].filter((function(e){return e})).map((function(e){return e.end})),d=Math.max.apply(Math,u);return isFinite(d)?d:(null===(n=this.playerStateService)||void 0===n?void 0:n.seekingOrTimeshifting)?this.playerStateService.targetPlaybackTime:0},e.prototype.dispose=function(){},e}();function s(e){return[o.StreamTimeRangeType.Loading,o.StreamTimeRangeType.Failed].includes(e.type)}t.StreamTimeService=a},72766:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TechnologyChecker=void 0;var n=i(43068),r=i(83024),o=function(){function e(){}return e.prototype.getSupportedTechnologies=function(){return n.ModuleManager.has(r.ModuleName.RendererMse)?n.ModuleManager.get(r.ModuleName.RendererMse).technologyChecker.getSupportedTechnologies():[]},e}();t.TechnologyChecker=o},5258:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TimeShiftHandler=void 0;var n=i(59534),r=i(59574),o=i(80815),a=i(43068),s=i(83024),u=i(59266),d=i(45110),c=i(76060),l=function(){function e(e,t,i,r){var o=this;this.onSeek=function(){o.updateInitialTimeShiftContext(!0)},this.onSeeked=function(){var e=o.context.renderer.getCurrentTime(!0),t=e-o.getTimeShiftLiveEdge();o.updateTimeShiftStateAfterSeek(t,e)},this.context=e,this.mediaPlayerController=t,this.bufferController=i,this.segmentControllers=Object.keys(r).map((function(e){return r[e]})),this.manifestService=e.serviceManager.get(n.ServiceName.ManifestService,e.sourceContext.sourceIdentifier),this.logger=e.logger,this.eventHandler=e.eventHandler,this.timeShiftCounter=0,this.sourceIdentifier=e.sourceContext.sourceIdentifier,this.setupEventHandlers()}return e.prototype.calculateLiveEdgeInVideoTime=function(){var e;if(this.initialTimeShiftContext&&!this.initialTimeShiftContext.isOngoing){var t=(0,o.toSeconds)(Date.now()-this.initialTimeShiftContext.timestamp);e=this.initialTimeShiftContext.liveEdge+t}else e=this.calculateMpdHandlerLiveEdge();return isFinite(e)||(e=(0,o.toSeconds)(Date.now()-this.manifestService.getAvailabilityStartTime())),e},e.prototype.calculateMpdHandlerLiveEdge=function(){return this.segmentControllers.map((function(e){return e.getLiveEdgeTime()})).reduce((function(e,t){return t<e&&t>=0?t:e}),1/0)},e.prototype.updateSegmentControllers=function(e){this.segmentControllers=Object.values(e)},e.prototype.getMaxTimeShift=function(){if(this.manifestService.getManifest()){var e=this.manifestService.getTimeShiftBufferDepthSeconds();return Math.min(e+this.manifestService.getDesiredDistanceToLiveEdge(),0)}return 0},e.prototype.getTimeShiftLiveEdge=function(){return this.calculateLiveEdgeInVideoTime()-this.manifestService.getDesiredDistanceToLiveEdge()},e.prototype.getTimeShift=function(){var e=this.getActualTimeShift();if(this.lastTimeShiftStatus){var t=(0,o.toSeconds)(Date.now()-this.lastTimeShiftStatus.completionDate)-(this.mediaPlayerController.getCurrentTime()-this.lastTimeShiftStatus.reachedTime);if(Math.abs(t)<this.context.settings.ACCEPTABLE_TIMESHIFT_INACCURACY)return this.lastTimeShiftStatus.offset}var i=this.getMaxTimeShift();return e<i&&(e=i),e>0&&(e=0),e},e.prototype.getActualTimeShift=function(){return!this.initialTimeShiftContext||this.initialTimeShiftContext.isOngoing?0:this.getReferenceCurrentTime()-this.getTimeShiftLiveEdge()},e.prototype.getReferenceCurrentTime=function(){var e,t=this.mediaPlayerController.getCurrentTime(),i=null===(e=this.context.serviceManager)||void 0===e?void 0:e.get(n.ServiceName.PlayerStateService);if(!t&&(null==i?void 0:i.seekingOrTimeshifting)){var r=i.targetPlaybackTime;if(r>-1)return r}return t},e.prototype.adjustTargetTime=function(e){var t=this.manifestService.getPeriodIdForTime(e),i=!this.manifestService.isLastPeriod(t),n=this.manifestService.isTimeNearPeriodEnd(e,this.context.settings.END_OF_BUFFER_TOLERANCE);if(i&&n){var r=this.manifestService.getNextPeriod(t);this.logger.debug("Timeshift target too close to end of period ".concat(t,", adjusting target from ").concat(e)+" to ".concat(r.start,", i.e. next period's start.")),e=r.start}return e},e.prototype.timeShift=function(e,t,i){var n=this;void 0===i&&(i=!1),this.initialTimeShiftContext||this.adjustTargetBufferLevel(this.calculateAvailableBufferLength()),e=Math.max(this.getMaxTimeShift(),e);var r=this.mediaPlayerController.getCurrentTime(),o=this.calculatePlaybackTimeForTimeShiftOffset(e),a=this.manifestService.getPeriodIdForTime(o);this.timeShiftCounter++;var s=this.timeShiftCounter,u=i||this.bufferController.shouldBuffersBeCleared(o);return this.logger.debug("Performing timeShift to offset ".concat(e,", time: ").concat(r," -> ").concat(o,", period: ").concat(a)),this.bufferController.setTimeshiftCancelState(!1),this.mediaPlayerController.updatePeriodForTimeshift(a,!this.initialTimeShiftContext),this.initialTimeShiftContext&&this.maybeResetTransmuxerForPtsRollover(o),u&&this.segmentControllers.forEach((function(e){return e.seekTo(o)})),this.updateInitialTimeShiftContext(!0),this.bufferController.setCurrentTime(o,a,!0,i).then((function(i){n.logger.debug("Successful timeShift to ".concat(i,", hit target time with a diff of ").concat(i-o)),n.updateInitialTimeShiftContext(!1),n.lastTimeShiftStatus={offset:e,completionDate:Date.now(),reachedTime:i},n.timeShiftCounter===s&&t?t():t&&n.context.logger.debug("Timeshift to ".concat(e," has finished but a newer operation has been started"))})).catch((function(e){n.logger.debug("Failed to set currentTime on timeShift",e)})).finally((function(){return n.bufferController.setTimeshiftCancelState(!1)}))},e.prototype.maybeResetTransmuxerForPtsRollover=function(e){var t;if(this.manifestService.isHlsManifest()){var i=this.context.serviceManager.get(n.ServiceName.SourceStoreService,this.sourceIdentifier);p(null===(t=a.ModuleManager.get(s.ModuleName.HLS))||void 0===t?void 0:t.selectors.getHlsState(null==i?void 0:i.getState()),e)&&(this.context.logger.debug("Resetting transmuxer because target is beyond a timestamp rollover"),this.mediaPlayerController.resetTransmuxer())}},e.prototype.cancel=function(){this.context.logger.debug("Cancelling ongoing time shift operation..."),this.bufferController.setTimeshiftCancelState(!0)},e.prototype.calculatePlaybackTimeForTimeShiftOffset=function(e){var t=this.manifestService.getDesiredDistanceToLiveEdge(),i=this.calculateLiveEdgeInVideoTime()+(e-t);return this.manifestService.hasMultiplePeriods()&&(i=this.adjustTargetTime(i)),i},e.prototype.onManifestUpdate=function(){if(this.manifestService.isLive()){var e=this.getActualTimeShift(),t=this.calculateAvailableBufferLength(),i=this.getMaxTimeShift()-t.minSegmentDuration;this.adjustTargetBufferLevel(t),e<i&&this.context.eventHandler.dispatchEvent(r.PlayerEvent.DVRWindowExceeded),this.removeDroppedOutFailedBufferRanges()}},e.prototype.removeDroppedOutFailedBufferRanges=function(){var e=this;this.context.serviceManager.maybeCall(n.ServiceName.SourceStoreService,(function(t){var i,n=e.manifestService.getTimeShiftBufferDepthSeconds(),r=e.calculateLiveEdgeInVideoTime()+n,o=null===(i=t.getState())||void 0===i?void 0:i.streamTimeline;void 0!==o&&Object.keys(o).forEach((function(e){t.dispatch((0,d.removeStreamTimeRange)(e,{start:0,end:r},c.StreamTimeRangeType.Failed))}))}))},e.prototype.isTimeInBufferedRange=function(e){return this.bufferController.isTimeInBufferedRange(e)},e.prototype.getMinSegmentDuration=function(){return this.segmentControllers.reduce((function(e,t){return Math.min(e,t.getMPDHandler().getSegmentDuration())}),1/0)},e.prototype.calculateAvailableBufferLength=function(){var e=this,t=this.segmentControllers.map((function(e){return e.getMPDHandler()})),i=this.getMinSegmentDuration(),n=Math.max.apply(Math,t.map((function(t){return t instanceof u.SegmentListMPDHandler?t.getSegmentDuration()*e.context.settings.LIVE_SEGMENT_LIST_START_INDEX_OFFSET:0})));return{minSegmentDuration:i,bufferDepth:Math.min.apply(Math,t.map((function(e){return Math.abs(e.getActualTimeShiftBufferDepth())})))-n}},e.prototype.adjustTargetBufferLevel=function(e){this.context.bufferSettings.setStreamBoundary({minimumBufferLength:e.minSegmentDuration,streamDuration:e.bufferDepth})},e.prototype.updateTimeShiftStateAfterSeek=function(e,t){this.lastTimeShiftStatus={completionDate:Date.now(),reachedTime:t,offset:e},this.updateInitialTimeShiftContext(!1)},e.prototype.updateInitialTimeShiftContext=function(e){(!this.initialTimeShiftContext||!e&&this.initialTimeShiftContext.isOngoing)&&(this.initialTimeShiftContext={timestamp:Date.now(),liveEdge:this.calculateLiveEdgeInVideoTime(),isOngoing:e})},e.prototype.setupEventHandlers=function(){this.eventHandler.on(r.PlayerEvent.Seek,this.onSeek,!0),this.eventHandler.on(r.PlayerEvent.Seeked,this.onSeeked,!0)},e.prototype.removeEventHandlers=function(){this.eventHandler.off(r.PlayerEvent.Seek,this.onSeek),this.eventHandler.off(r.PlayerEvent.Seeked,this.onSeeked)},e.prototype.dispose=function(){this.removeEventHandlers(),this.bufferController.setTimeshiftCancelState(!0)},e}();function p(e,t){var i,n,r=null!==(n=null===(i=null==e?void 0:e.timestampRolloverPositions)||void 0===i?void 0:i.next)&&void 0!==n?n:-1;return-1!==r&&(t>=r||t<=e.timestampRolloverPositions.previous)}t.TimeShiftHandler=l},8470:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.BufferBlock=t.EncryptionState=void 0;var n=i(50163),r=i(11629);!function(e){e.Encrypted="encrypted",e.Clear="clear"}(t.EncryptionState||(t.EncryptionState={}));var o=function(){function e(e){this.id=e,this.cachedSegments=[],this.blockStateMap=new Map}return e.prototype.addSegment=function(e){var t=e.getMimeType();e.isInit()&&this.removeLastInitSegment(t),void 0===this.periodId&&(this.periodId=e.getPeriodId());var i=e.isInit()?0:e.getDuration();this.cachedSegments.push({segment:e}),e.isInit()||(this.setMaxSegmentDuration(t,Math.max(i,this.getMaxSegmentDuration(t))),this.updatePlaybackTimeRange(e,t)),e.setBufferBlockId(this.id),this.updateMediaTypes(e)},e.prototype.setSegregationCriteria=function(e,t){this.blockStateMap.has(t)||this.initializeBlockStateMapForMimeType(t),this.getBlockState(t).segregationCriteria=e},e.prototype.initializeBlockStateMapForMimeType=function(e){var t={};return this.blockStateMap.set(e,t),t},e.prototype.updateMediaTypeForMimeType=function(e){var t=this.getBlockState(e.mimeType)||this.initializeBlockStateMapForMimeType(e.mimeType);t.mediaType?(a(e,"codec",(function(e){t.mediaType.codec=e})),a(e,"timestampOffset",(function(e){t.mediaType.timestampOffset=e})),a(e,"timescale",(function(e){t.mediaType.timescale=e}))):t.mediaType=e},e.prototype.getSegregationCriteria=function(e){var t;return null===(t=this.getBlockState(e))||void 0===t?void 0:t.segregationCriteria},e.prototype.updateMediaTypes=function(e){var t=e.getMimeType(),i=this.getMediaType(t);i?(null===i.codec&&(i.codec=e.getCodec()),null==i.timescale&&(i.timescale=e.getTimescale())):(this.blockStateMap.has(t)||this.blockStateMap.set(t,{}),this.getBlockState(t).mediaType={mimeType:t,codec:e.getCodec(),timestampOffset:0,timescale:e.getTimescale()})},e.prototype.getMediaType=function(e){var t,i;return null!==(i=null===(t=this.getBlockState(e))||void 0===t?void 0:t.mediaType)&&void 0!==i?i:null},e.prototype.addMediaType=function(e){n.MimeTypeHelper.isAV(e.mimeType)&&!this.getMediaType(e.mimeType)&&(this.blockStateMap.has(e.mimeType)||this.initializeBlockStateMapForMimeType(e.mimeType),this.getBlockState(e.mimeType).mediaType=e)},e.prototype.removeMediaType=function(e){this.clearSegments(e),this.blockStateMap.delete(e)},e.prototype.hasMediaType=function(e){var t,i;return null!==(i=null===(t=this.blockStateMap)||void 0===t?void 0:t.has(e))&&void 0!==i&&i},e.prototype.getMediaTypes=function(){return(0,r.getValues)(this.blockStateMap).map((function(e){return e.mediaType}))},e.prototype.getMediaTypesWithoutSubs=function(){return this.getMediaTypes().filter((function(e){return n.MimeTypeHelper.isAV(e.mimeType)}))},e.prototype.removeSegment=function(e){var t=this.cachedSegments.findIndex((function(t){return t.segment===e}));t>-1&&this.cachedSegments.splice(t,1)},e.prototype.clearSegments=function(e){this.cachedSegments=this.cachedSegments.filter((function(t){return t.segment.getMimeType()!==e}))},e.prototype.getPrecedingSegments=function(e,t){var i=[];return this.cachedSegments.forEach((function(n){var r=n.segment,o=r.isInit(),a=r.getMimeType()!==e;!o&&!a&&r.getPlaybackTime()+r.getDuration()<t&&i.push(r)})),i},e.prototype.updatePlaybackTimeRange=function(e,t){var i=this.getPlaybackTimeRange(t),n=e.getPlaybackTime(),r=n+e.getDuration();i?(n<i.start&&(i.start=n),r>i.end&&(i.end=r)):this.getBlockState(t).playbackTimeRange={start:n,end:r}},e.prototype.getPlaybackTimeRange=function(e){var t,i;return null!==(i=null===(t=this.getBlockState(e))||void 0===t?void 0:t.playbackTimeRange)&&void 0!==i?i:null},e.prototype.getId=function(){return this.id},e.prototype.getPeriodId=function(){return this.periodId},e.prototype.getMinCommonStartTime=function(){return(0,r.getValues)(this.blockStateMap).filter((function(e){return e.playbackTimeRange})).map((function(e){return e.playbackTimeRange})).reduce((function(e,t){return Math.max(t.start,e)}),-1/0)},e.prototype.getCommonPlaybackTimeRanges=function(){return(0,r.getValues)(this.blockStateMap).filter((function(e){return e.playbackTimeRange})).map((function(e){return e.playbackTimeRange})).reduce((function(e,t){return{start:Math.max(t.start,e.start),end:Math.min(t.end,e.end)}}),{start:-1/0,end:1/0})},e.prototype.setMaxSegmentDuration=function(e,t){this.blockStateMap.has(e)||this.initializeBlockStateMapForMimeType(e),this.getBlockState(e).maxSegmentDuration=t},e.prototype.getMaxSegmentDuration=function(e){var t;return(null===(t=this.getBlockState(e))||void 0===t?void 0:t.maxSegmentDuration)||0},e.prototype.hasMaxSegmentDuration=function(e){var t;return null!=(null===(t=this.getBlockState(e))||void 0===t?void 0:t.maxSegmentDuration)},e.prototype.hasMaxSegmentDurations=function(){return Boolean((0,r.getValues)(this.blockStateMap).map((function(e){return e.maxSegmentDuration})).find((function(e){return e>=0})))},e.prototype.getMinMaxSegmentDuration=function(){var e=Number.MAX_VALUE;return(0,r.getValues)(this.blockStateMap).map((function(e){return e.maxSegmentDuration})).forEach((function(t){return e=t<e?t:e})),e},e.prototype.getAllSegmentsForMimeType=function(e){return this.getAllSegments().filter((function(t){return t.getMimeType()===e}))},e.prototype.getAllSegments=function(){return this.cachedSegments.map((function(e){return e.segment}))},e.prototype.hasDataSegments=function(e){return this.cachedSegments.some((function(t){return!t.segment.isInit()&&t.segment.getMimeType()===e}))},e.prototype.hasSegments=function(){return this.getAllSegments().length>0},e.prototype.getNextSegment=function(){var e=this.cachedSegments.filter((function(e){return!e.pendingRemoval}));if(0===e.length)return null;var t=e.find((function(t){return e.filter((function(e){return t.segment.getMimeType()===e.segment.getMimeType()})).some((function(e){return!e.segment.isInit()}))}));return t?(t.pendingRemoval=!0,t.segment):null},e.prototype.removeLastInitSegment=function(e){var t=this.getAllSegmentsForMimeType(e);if(t.length>0){var i=t[t.length-1];i.isInit()&&this.removeSegment(i)}},e.prototype.getBlockState=function(e){return this.blockStateMap.get(e)},Object.defineProperty(e.prototype,"mediaTypes",{get:function(){var e={};return this.blockStateMap.forEach((function(t,i){e[i]=t.mediaType})),e},enumerable:!1,configurable:!0}),e}();function a(e,t,i){e.hasOwnProperty(t)&&i(e[t])}t.BufferBlock=o},76812:function(e,t){function i(e,t){return!(!e||!t)&&e===t}Object.defineProperty(t,"__esModule",{value:!0}),t.areBufferBlocksEqual=void 0,t.areBufferBlocksEqual=i},58400:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.BufferController=void 0;var r=i(45659),o=i(36166),a=i(85739),s=i(59534),u=i(4529),d=i(59574),c=i(8833),l=i(73882),p=i(22221),f=i(45366),h=i(11917),g=i(59536),m=i(1520),S=i(86705),v=i(99999),y=i(28803),T=i(38827),I=i(81028),M=i(50163),b=i(80815),P=i(89199),C=i(89543),R=i(43068),A=i(83024),E=i(76469),x=i(96400),k=i(52038),B=i(53088),L=i(94800),_=i(4157),D=i(45110),w=i(81040),O=i(76060),N=i(99538),F=i(55579),H=i(8470),U=i(11199),j=i(96733),q=i(6862),V=i(39972),z=i(56727),K="The targeted buffer BufferBlock is no longer available",W=function(){function e(e,t,i,n){var r=this;this.currentRendererMediaTypes=[],this.currentBufferBlockSwitchPromise=null,this.startupPlaybackTime=null,this.isAlreadyStarted=!1,this.isStartup=!0,this.isClearingBuffers=!1,this.finishPlayback=!1,this.hasStreamEndedInternal=!1,this.activeInitSegments={},this.bufferMaxSizeChangedSubscriptionMap={},this.isTimeshiftCancelled=!1,this.updateTotalDuration=function(){r.totalDuration=r.manifestService.getTotalDuration(),r.totalDuration>(r.renderer.getDuration()||0)&&r.setDurationOnRenderer()},this.setDurationOnRenderer=function(){r.finishPlayback||r.renderer.setDuration(r.totalDuration)},this.onRendererSetupFailed=function(e){r.context.logger.debug("Renderer setup failed with",e)},this.onBufferChanged=function(e){var t=r.getRendererRangesFromStore(e)[0];t&&r.bufferStartTimes.set(e,t.start)},this.onVideoElementTimeUpdate=function(){var e,t=r.context.serviceManager.get(s.ServiceName.PlayerStateService),i=Date.now()-r.lastBufferClearingTimestamp>r.minimalBackwardBufferClearingInterval,n=null!==(e=null==t?void 0:t.seekingOrTimeshifting)&&void 0!==e&&e;!(i&&!n)&&t.isPlaying()||r.checkBackwardBufferLevel(),r.checkIfEndOfBufferReached(r.settings.END_OF_BUFFER_TOLERANCE)},this.onTimeNotAdvancing=function(){var e=r.settings.END_OF_BUFFER_RECOVERY_TOLERANCE,t=r.segmentStore.getBufferBlock(r.currentPlayingBufferBlockId);r.isAtEndOfBufferBlock()&&t&&(e=r.segmentStore.getSmallestMaxSegmentDuration(t)),r.checkIfEndOfBufferReached(e)},this.onVideoElementEnded=function(){if(!r.isSwitchingBufferBlock&&Boolean(r.segmentStore.getNextBufferBlock(r.currentPlayingBufferBlockId))){var e=r.renderer.getCurrentTime(!0);r.tryToSwitchBufferBlock(e)}},this.onVideoElementStalled=function(){r.checkIfEndOfBufferReached(r.settings.END_OF_BUFFER_RECOVERY_TOLERANCE)},this.context=e,this.logger=e.logger,this.settings=e.settings,this.bufferSettings=e.bufferSettings,this.eventHandler=e.eventHandler,this.renderer=e.renderer,this.manifestService=e.serviceManager.get(s.ServiceName.ManifestService,e.sourceContext.sourceIdentifier),this.segmentStore=new V.SegmentStore,this.endStallAtGapCallback=t,this.bufferStallingService=new j.BufferStallingService(this.getPlayerStateService(),this.logger,this.context.renderer),this.currentPlayingPeriodId=n,this.lastPlayingPeriodId=null,this.totalDuration=i,this.seekTarget=null,this.delayedBufferBlockSwitchContext=null,this.currentPlayingBufferBlockId=V.INITIAL_BUFFER_BLOCK_ID,this.isSwitchingBufferBlock=!1,this.bufferStartTimes=new Map,this.dataSegmentsPushedMap=new Map,this.isEndOfStreamReached=!1,this.lastBufferClearingTimestamp=0,this.minimalBackwardBufferClearingInterval=(0,b.toMilliSeconds)(this.context.settings.MINIMAL_BACKWARD_BUFFER_CLEARING_INTERVAL),this.discontinuitySequenceNumbers=new Map,this.currentBufferBlockDeferredReject=new q.DeferredReject,this.drmConfigValidPromise=Promise.resolve(null),this.bufferRangesCache=new U.BufferRangesCache(this.context,this.segmentStore),this.susbscribeToPlaybackStoppedStateChange(),this.renderer.ready().then((function(){r.setDurationOnRenderer(),r.shouldSendLicenseRequestsImmediately()&&r.setupDRM()})).catch(this.onRendererSetupFailed)}return e.prototype.susbscribeToPlaybackStoppedStateChange=function(){var e=this,t=this.context.store;void 0!==t&&(this.unsubscribeFromStoreStoppedListener=(0,y.subscribe)(t)((function(e){return e&&(0,g.getIsStopped)((0,g.getPlayerState)(e))}),(function(){return e.hasStreamEndedInternal=!0}),(function(e){return!0===e})))},Object.defineProperty(e.prototype,"isCurrentlyStalled",{get:function(){return this.bufferStallingService.isRendererStalling()},enumerable:!1,configurable:!0}),e.prototype.shouldSendLicenseRequestsImmediately=function(){var e,t;return Boolean(null===(t=(0,_.getDrmState)(null===(e=this.getSourceStore())||void 0===e?void 0:e.getState()))||void 0===t?void 0:t.immediateLicenseRequest)},e.prototype.createSourceBuffers=function(e){var t=this,i=Promise.resolve();return this.bufferCreationDeferred=new I.Deferred,this.isStartup||(i=this.renderer.shutdown(!0)),this.activeInitSegments={},this.bufferCreationDeferred.resolve(i.then((function(){return t.renderer.ready()})).then((function(){return t.setDurationOnRenderer(),t.clearBufferMaxSizeChangedSubscription(),e.forEach((function(e){var i=e.mimeType;t.addMimeTypeAndCodec(i,e.codec)||(t.logger.debug("Could not create source buffer for ".concat(i)),t.context.store.dispatch((0,p.removeMetricsForMimeType)(i))),t.subscribeToBufferMaxSizeChanged(i)})),t.currentRendererMediaTypes=e.filter((function(e){return M.MimeTypeHelper.isAV(e.mimeType)})),t.setupDRM(),Promise.resolve(t.currentRendererMediaTypes.length)}))),this.bufferCreationDeferred.promise.catch((function(e){return t.logger.warn(e)})).then((function(){t.bufferCreationDeferred=null})),this.bufferCreationDeferred.promise},e.prototype.subscribeToBufferMaxSizeChanged=function(e){var t=this,i=this.getSourceStore();i&&(this.bufferMaxSizeChangedSubscriptionMap[e]=i.subscribe((function(){return t.adjustMaxBufferLevels(e)}),(0,S.hasBufferMaxSizeChanged)(e)))},e.prototype.unsubscribeFromBufferMaxSizeChanged=function(e){var t=this.bufferMaxSizeChangedSubscriptionMap[e];t&&(t(),delete this.bufferMaxSizeChangedSubscriptionMap[e])},e.prototype.setupDRM=function(){var e,t=this,i=(0,_.getDrmState)(null===(e=this.getSourceStore())||void 0===e?void 0:e.getState());if(void 0!==i&&Object.keys(i).length>0){var r=n(n({},this.context.sourceContext.source),{drm:i}),o=this.manifestService.getDRMCapabilitiesForPeriod(this.currentPlayingPeriodId);Object.keys(l.KeySystemMap).some((function(e){return r.drm.hasOwnProperty(e)}))&&(this.drmConfigValidPromise=this.renderer.setDrmConfig(i,o),this.drmConfigValidPromise.catch((function(){t.logger.warn("Could not initialize renderer with given DRM config")})))}},e.prototype.getSourceStore=function(){var e;return null===(e=this.context.serviceManager)||void 0===e?void 0:e.get(s.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier)},e.prototype.tryToSwitchBufferBlockAfterBufferClear=function(){var e=this;return this.timeshiftBufferClearingPromise?this.timeshiftBufferClearingPromise.catch((function(){return e.timeshiftBufferClearingPromise=void 0,e.isTimeshiftCancelled=!0,Promise.reject("Failed to clear buffer on timeshift, stopping segment cache processing")})).then((function(t){return e.timeshiftBufferClearingPromise=void 0,e.isTimeshiftCancelled?(e.isTimeshiftCancelled=!1,Promise.reject("Timeshift cancelled, stopping segment cache processing")):e.tryToSwitchBufferBlock(t)})):Promise.resolve()},e.prototype.addSegment=function(e){var t=this;if(!this.segmentStore)return Promise.reject("Skipping segment processing, segment store is already disposed");this.logger.insane("adding segment to cache for period ".concat(e.getPeriodId()," with playback time ").concat(e.getPlaybackTime(),"\n      and mime type ").concat(e.getMimeType())),this.segmentStore.addSegment(e),this.subscribeToManifestChange();var i=(0,O.getTrackIdentifier)(e.getSegmentInfo()),n=this.getSourceStore(),r=e.getPlaybackTimeRange();r&&(null==n||n.dispatch((0,D.removeStreamTimeRange)(i,r,O.StreamTimeRangeType.Loading))),null==n||n.dispatch((0,m.addLoadedRange)(i,(0,L.segmentToBufferBlockTimeRange)(e)));var o=this.segmentStore.getBufferBlockForSegment(e);if(this.areBufferBlockMediaTypesFinal(e.getPeriodId())){if(this.delayedBufferBlockSwitchContext&&!this.segmentStore.canSwitchToBufferBlock(this.delayedBufferBlockSwitchContext.time,o))return Promise.resolve();var a=Promise.resolve();if(this.timeshiftBufferClearingPromise)a=this.tryToSwitchBufferBlockAfterBufferClear();else if(this.delayedBufferBlockSwitchContext)a=this.tryToSwitchBufferBlock(this.delayedBufferBlockSwitchContext.time);else if(this.isSwitchingBufferBlock||this.isBufferAvailable()||this.bufferCreationDeferred)this.bufferCreationDeferred&&(a=this.bufferCreationDeferred.promise);else{var s=o.getMediaTypes();a=this.createSourceBuffers(s)}return a.then((function(){return t.renderer?t.renderer.ready():Promise.reject("Stopping queue processing, renderer is not available")})).then((function(){return t.processSegmentCache()}))}return Promise.resolve()},e.prototype.removePrecedingSegmentsFromStore=function(e,t){var i=this;this.segmentStore&&this.segmentStore.getPrecedingSegments(e,t).forEach((function(e){var t;i.segmentStore.removeSegment(e),null===(t=i.getSourceStore())||void 0===t||t.dispatch((0,m.removeLoadedRange)(e.getMimeType(),(0,L.segmentToBufferBlockTimeRange)(e)))}))},e.prototype.clearBackwardBuffer=function(e,t){var i=this,n=M.MimeTypeHelper.isAudio(e)?c.MediaType.Audio:c.MediaType.Video,r=this.bufferSettings.getBackwardTargetLevel(n),o=this.segmentStore.getBufferBlock(this.currentPlayingBufferBlockId);if(this.removePrecedingSegmentsFromStore(e,t-r),!o||!o.hasMaxSegmentDuration(e))return Promise.resolve();var a=o.getMaxSegmentDuration(e)+1,s=t-Math.max(a,r);return s<this.bufferStartTimes.get(e)?Promise.resolve():(this.lastBufferClearingTimestamp=Date.now(),this.renderer.removeData(e,0,s).catch((function(t){return i.logger.debug("Error clearing ".concat(e," backward buffer:"),t)})))},e.prototype.getRendererRangesFromStore=function(e){var t,i=(0,S.getBufferState)(null===(t=this.getSourceStore())||void 0===t?void 0:t.getState());return void 0===i?[]:(0,S.getRendererBufferedRanges)(i,e)},e.prototype.checkBackwardBufferLevel=function(){var e=this;if(!this.isEndOfStreamReached&&!this.isSwitchingBufferBlock){var t=this.renderer.getCurrentTime(),i=this.segmentStore.getBufferBlock(this.currentPlayingBufferBlockId),n=this.segmentStore.getSmallestMaxSegmentDuration(i);n>0&&(this.minimalBackwardBufferClearingInterval=(0,b.toMilliSeconds)(n/2)),this.bufferStartTimes.forEach((function(i,n){var r=M.MimeTypeHelper.isAudio(n)?c.MediaType.Audio:c.MediaType.Video,o=e.bufferSettings.getBackwardTargetLevel(r);t-o>i&&e.clearBackwardBuffer(n,t).catch((function(t){e.context.logger.debug("Could not clear backward buffer",t)}))}))}},e.prototype.setEndOfStream=function(e){return e&&this.suspendEosSignalling||!this.renderer?(this.logger.debug("Skipping setting EOS"),Promise.resolve()):(this.isEndOfStreamReached=e,this.renderer.setEndOfStream(e))},e.prototype.adjustMaxBufferLevels=function(e){var t,i=(0,S.getBufferState)(null===(t=this.getSourceStore())||void 0===t?void 0:t.getState()),n=void 0!==i?(0,S.getBufferMaxSize)(i,e):S.DefaultBufferMaxSize;if(this.logger.debug("Exceeded quota for ".concat(e," with ").concat(n," seconds of data in the buffers")),!this.context.settings.NO_QUOTA_EXCEEDED_ADJUSTMENT){var r=this.renderer.getCurrentTime(),o=this.segmentStore.getSmallestSafeBufferSize(r,e);this.bufferSettings.adjustMaxBufferLevels(o,e,n)}},e.prototype.getLowestPlaybackTimeForAllSegments=function(e){return e.filter((function(e){return!e.isInit()})).map((function(e){return e.getPlaybackTime()})).reduce((function(e,t){return Math.min(t,e)}),0)},e.prototype.updateTimestampOffsetForNegativePlaybackTime=function(){var e=this.segmentStore.getBufferBlock(this.currentPlayingBufferBlockId),t=this.segmentStore.getAllSegmentsFromBufferBlock(e).toArray(),i=this.getLowestPlaybackTimeForAllSegments(t);i<0&&(this.eventHandler.dispatchEvent(d.PlayerEvent.Warning,new N.PlayerWarning(F.WarningCode.PLAYBACK_NEGATIVE_DECODING_TIMESTAMP_ENCOUNTERED)),this.logger.debug("Encountered negative DTS ".concat(i,", attempting to correct PTO...")),this.currentRendererMediaTypes.forEach((function(e){null!=e.timestampOffset&&(e.timestampOffset+=i,t.filter((function(t){return t.getMimeType()===e.mimeType})).forEach((function(t){return t.setPresentationTimeOffset(e.timestampOffset)})))})))},e.prototype.processSegmentCache=function(){var e=this;return this.isStartup?this.isStartupThresholdReached()?(this.updateTimestampOffsetForNegativePlaybackTime(),this.updateTimestampOffsets(),this.pushSegmentsToRenderer(1/0).then((function(){return e.endStartupPhase()}))):Promise.resolve():this.pushSegmentsToRenderer(1/0)},e.prototype.getBufferedRangesMap=function(e,t){var i;void 0===e&&(e=this.currentPlayingPeriodId),void 0===t&&(t=!0);var n=(0,S.getBufferState)(null===(i=this.getSourceStore())||void 0===i?void 0:i.getState());return e&&void 0!==n?t?this.bufferRangesCache.getRanges(n):(0,S.getRendererBufferRangesMap)(this.segmentStore,n)(e,this.currentPlayingBufferBlockId):{}},e.prototype.addSegmentsFromCacheToRenderer=function(e,t){var i=this;if(!this.segmentStore)return Promise.resolve();var n=this.segmentStore.getAllSegmentsFromBufferBlock(e),o=n.hasNext()&&n.next();return o?(this.segmentStore.removeSegment(o),o.getPeriodId()!==this.currentPlayingPeriodId&&(this.context.store.dispatch((0,k.periodSwitchStarted)(o.getPeriodId())),this.eventHandler.dispatchEvent(d.PlayerEvent.PeriodSwitch,{sourcePeriod:{periodId:this.currentPlayingPeriodId},targetPeriod:{periodId:o.getPeriodId()}})),this.addDataSegmentToRenderer(o).catch((function(e){i.logger.warn("Could not add segment to renderer mimeType: ".concat(o.getMimeType(),",\n        playbackTime: ").concat(o.getPlaybackTime()),e)})).then((function(){var n;o.isInit()||null===(n=i.getSourceStore())||void 0===n||n.dispatch((0,m.removeLoadedRange)(o.getMimeType(),(0,L.segmentToBufferBlockTimeRange)(o))),i.dataSegmentsPushedMap.set(o.getMimeType(),!o.isInit());var a=r.BufferRangeHelper.getTotalCommonBufferLength(i.getBufferedRangesMap(i.currentPlayingPeriodId));return i.currentPlayingPeriodId=o.getPeriodId(),!i.isSwitchingBufferBlock||a<t?i.addSegmentsFromCacheToRenderer(e,t):Promise.resolve()}))):Promise.resolve()},e.prototype.dispatchFinishPeriodSwitch=function(){var e;this.currentPlayingPeriodId!==this.lastPlayingPeriodId&&(this.lastPlayingPeriodId&&(null===(e=this.context.store)||void 0===e||e.dispatch((0,k.periodSwitchFinished)(this.currentPlayingPeriodId))),this.lastPlayingPeriodId=this.currentPlayingPeriodId)},e.prototype.hasFinishedLoadingPeriod=function(e){var t,i,n=this.hasStopped(),r=null===(t=this.segmentStore)||void 0===t?void 0:t.isLoadingNextBufferBlock(this.currentPlayingBufferBlockId),o=null===(i=this.segmentStore)||void 0===i?void 0:i.hasSegmentsForBufferBlock(e);return(r||n)&&!o},e.prototype.pushSegmentsToRenderer=function(e){var t=this,i=this.segmentStore.getBufferBlock(this.currentPlayingBufferBlockId);return this.suspendEosSignalling=!0,this.addSegmentsFromCacheToRenderer(i,e).then((function(){t.suspendEosSignalling=!1,t.isRestartThresholdReached()&&!t.isClearingBuffers&&t.endStalling(),t.hasFinishedLoadingPeriod(i)?(t.logger.debug("Finished loading Period: ".concat(t.currentPlayingPeriodId,", signaling EOS")),t.hasTemporarilyReopenedMsePriorToBufferBlockSwitch?t.logger.debug("Skipped EOS signaling as a BufferBlock switch is just being executed"):t.currentBufferBlockSwitchPromise&&t.isSwitchingBufferBlock?(t.logger.debug("delaying EOS signal until ongoing period switch is completed"),t.currentBufferBlockSwitchPromise.then((function(){t.setEndOfStream(!0).then((function(){return t.dispatchFinishPeriodSwitch()}))}))):t.setEndOfStream(!0).then((function(){return t.dispatchFinishPeriodSwitch()}))):t.dispatchFinishPeriodSwitch()}))},e.prototype.updateTimestampOffsets=function(){var e=this;this.currentRendererMediaTypes.forEach((function(t){e.renderer.setTimestampOffset(t.mimeType,-t.timestampOffset)}))},e.prototype.checkIfEndOfBufferReached=function(e){var t=this.renderer.getEndOfBufferTime();if(void 0===t)this.renderer.isPaused()||this.startStalling();else{var i=t-e,n=this.renderer.getCurrentTime(!0);this.shouldHandleEndOfBuffer(n,i)&&this.handleEndOfBuffer(n)}},e.prototype.shouldHandleEndOfBuffer=function(e,t){return!this.isSwitchingBufferBlock&&(t<=e||this.manifestService.isLive()&&0===e)},e.prototype.resetCurrentTimeOnSegment=function(){var e,t=!0;this.dataSegmentsPushedMap.forEach((function(i,n){M.MimeTypeHelper.isVideo(n)&&(t=i,e=n)})),t||(this.context.videoElement.currentTime=this.context.videoElement.currentTime,this.dataSegmentsPushedMap.set(e,!0))},e.prototype.handleEndOfBuffer=function(e){var t=this.isAtEndOfBufferBlock(),i=this.segmentStore.getNextBufferBlock(this.currentPlayingBufferBlockId),n=Boolean(i);if(t&&n&&this.areBufferBlockMediaTypesFinal(i.getPeriodId())){var r=i.getMinCommonStartTime(),o=isFinite(r)&&r>=e?r:e;this.tryToSwitchBufferBlock(o)}else this.getRemainingTime()>0&&!this.finishPlayback&&(this.startStalling(),this.resetCurrentTimeOnSegment())},e.prototype.isAtEndOfBufferBlock=function(){var e=this.segmentStore.getBufferBlock(this.currentPlayingBufferBlockId);return!e.getNextSegment()||!!this.segmentStore&&this.segmentStore.isLoadingNextBufferBlock(e.getId())},e.prototype.readyToSeek=function(){return this.currentBufferBlockSwitchPromise?(this.logger.debug("Awaiting ongoing buffer block switch before seek"),this.currentBufferBlockSwitchPromise.then((function(){})).catch((function(){}))):Promise.resolve()},e.prototype.shouldBuffersBeCleared=function(e){var t=this.renderer.getCurrentTime();return!this.isTimeInBufferedRange(e)||e<t},e.prototype.isTimeInBufferedRange=function(e){var t,i=null===(t=this.getSourceStore())||void 0===t?void 0:t.getState();if(!i)return!1;var n=this.getBufferedRangesMap((0,B.getPlayingPeriodId)(i),!0);return r.BufferRangeHelper.isInBufferedRange(n,e)},e.prototype.maybeClearBuffers=function(e,t){return void 0===t&&(t=!1),t||this.shouldBuffersBeCleared(e)?this.clearBuffersOnTimeshift():Promise.resolve()},e.prototype.setTimeshiftCancelState=function(e){this.isTimeshiftCancelled=e},e.prototype.clearBuffersOnTimeshift=function(){var e=this;return this.context.logger.debug("Clearing buffer on timeshift"),this.setEndOfStream(!1).then((function(){return e.clearBuffers()})).then((function(){return e.isTimeshiftCancelled?(e.isTimeshiftCancelled=!1,Promise.reject("cancelled timeshift")):Promise.resolve()}))},e.prototype.setCurrentTime=function(e,t,i,n){var r=this;void 0===i&&(i=!1),void 0===n&&(n=!1);var o=t||this.manifestService.getPeriodIdForTime(e),a=this.segmentStore.getBufferBlockForPlaybackTime(e),s=this.segmentStore.getBufferBlock(this.currentPlayingBufferBlockId),u=Boolean(!a||a.getId()!==s.getId());if(this.isStartup&&(this.currentPlayingPeriodId=o),this.seekTarget=e,this.isStartup||this.isInBufferedRange(e,o)||this.startStalling(),i&&this.isBufferAvailable()){var d=this.timeshiftBufferClearingPromise||Promise.resolve();this.timeshiftBufferClearingPromise=d.then((function(){return r.maybeClearBuffers(e,n)})).then((function(){return e}))}return u?a?this.tryToSwitchBufferBlock(e):this.delayBufferBlockSwitch(e):(this.delayedBufferBlockSwitchContext=null,this.renderer.setCurrentTime(e).then((function(e){return r.endStallingAfterSeek(e)})))},e.prototype.endStallingAfterSeek=function(e){return this.seekTarget=null,this.isRestartThresholdReached()?(this.logger.debug("End stalling after seek to ".concat(e)),this.endStalling()):this.logger.debug("Delay ending stall as the restart threshold is not yet reached"),Promise.resolve(e)},e.prototype.bufferBlockSwitchErrorHandler=function(e,t){var i,n,r=(0,P.isNumber)(null===(i=this.delayedBufferBlockSwitchContext)||void 0===i?void 0:i.time)&&(null===(n=this.segmentStore)||void 0===n?void 0:n.canSwitchToBufferBlockForTime(this.delayedBufferBlockSwitchContext.time));return this.logger.debug("Buffer block switch failed",e),this.currentBufferBlockDeferredReject=new q.DeferredReject,r?(this.logger.debug("Trying to continue delayed BufferBlock switch to ".concat(this.delayedBufferBlockSwitchContext.time,"...")),this.tryToSwitchBufferBlock(this.delayedBufferBlockSwitchContext.time)):(this.isSwitchingBufferBlock=!1,Promise.resolve(t))},e.prototype.tryToSwitchBufferBlock=function(e){var t,i,n=this,r=function(){};this.currentBufferBlockDeferredReject&&this.currentBufferBlockDeferredReject.reject("BufferBlock switch interrupted by newest one"),this.currentBufferBlockDeferredReject=new q.DeferredReject,this.isSwitchingBufferBlock=!0,null!==this.delayedBufferBlockSwitchContext&&(e=null!=e?e:this.delayedBufferBlockSwitchContext.time,r=this.delayedBufferBlockSwitchContext.deferred.resolve);var o=this.manifestService.getPeriodIdForTime(e),a=null===(t=this.segmentStore)||void 0===t?void 0:t.getTargetBufferBlock(e,o);if(!(null===(i=this.segmentStore)||void 0===i?void 0:i.canSwitchToBufferBlock(e,a)))return this.delayBufferBlockSwitch(e);this.hasTemporarilyReopenedMsePriorToBufferBlockSwitch=!0;var s=this.timeshiftBufferClearingPromise||Promise.resolve();return this.currentBufferBlockSwitchPromise=s.then((function(){return n.setEndOfStream(!1)})).then((function(){return n.delayedBufferBlockSwitchContext=null})).then((function(){return n.currentBufferBlockDeferredReject.next((function(){return n.clearRendererBuffers()}))})).then((function(){return n.currentBufferBlockDeferredReject.next((function(){return n.switchOrRestoreBufferBlock(o,a,e)}))})).then((function(e){return n.hasTemporarilyReopenedMsePriorToBufferBlockSwitch=!1,n.currentBufferBlockDeferredReject=new q.DeferredReject,r(e),e})).catch((function(t){return n.bufferBlockSwitchErrorHandler(t,e)})).finally((function(){return n.currentBufferBlockSwitchPromise=null}))},e.prototype.switchOrRestoreBufferBlock=function(e,t,i){return(0,T.isTizen2017)()||this.segmentStore.shouldSwitchBufferBlock(e,t,this.currentPlayingBufferBlockId)?this.switchBufferBlock(i,t):this.restorePlayback(i,t)},e.prototype.delayBufferBlockSwitch=function(e){this.isSwitchingBufferBlock&&this.currentBufferBlockDeferredReject&&this.currentBufferBlockDeferredReject.reject("BufferBlock switch interrupted by newest one");var t=this.segmentStore.getAvailablePositionForTime(e,this.renderer.getCurrentTime());return this.delayedBufferBlockSwitchContext&&this.delayedBufferBlockSwitchContext.time===e||(this.delayedBufferBlockSwitchContext&&this.delayedBufferBlockSwitchContext.time!==e&&this.delayedBufferBlockSwitchContext.deferred.reject(),this.delayedBufferBlockSwitchContext={time:t,deferred:new I.Deferred}),this.delayedBufferBlockSwitchContext.deferred.promise},e.prototype.restorePlayback=function(e,t){var i=this;return this.updateTimestampOffsets(),this.isEndOfStreamReached=!1,this.currentPlayingBufferBlockId=t.getId(),this.segmentStore.deleteOldBufferBlocks(t.getId()),this.hasTemporarilyReopenedMsePriorToBufferBlockSwitch=!1,this.segmentStore.getBufferBlock(t.getId())?this.currentBufferBlockDeferredReject.next((function(){return i.pushSegmentsToRenderer(1/0)})).then((function(){return i.currentBufferBlockDeferredReject.next((function(){return i.setCurrentTimeOnRenderer(e)}))})).then((function(e){return i.isSwitchingBufferBlock=!1,i.resumePlaybackIfNotStalledOrPaused(),i.endStallingAfterSeek(e)})):(this.logger.debug("Target BufferBlock is no longer available, cancelling BufferBlock switch..."),Promise.reject(K))},e.prototype.resumePlaybackIfNotStalledOrPaused=function(){var e=this,t=this.getPlayerStateService().isPaused();this.isCurrentlyStalled||t||this.renderer.play().catch((function(t){e.logger.debug("play call failed with reason: ".concat(t))}))},e.prototype.shouldRecreateSourceBuffers=function(e,t){var i,n=null===(i=this.segmentStore)||void 0===i?void 0:i.getBufferBlock(this.currentPlayingBufferBlockId);if(!n)return!0;var r=n.getPeriodId()===e.getPeriodId(),o=this.currentRendererMediaTypes.length===t.length,a=!(r||o)||!(0,z.canReuseSourceBuffer)(n,e,t);return this.allowUserToOverwriteBufferRecreationDecision(a,n,e)},e.prototype.allowUserToOverwriteBufferRecreationDecision=function(e,t,i){var n,r,o=null===(n=this.context)||void 0===n?void 0:n.sourceContext.source,a=null===(r=null==o?void 0:o.options)||void 0===r?void 0:r.shouldRecreateSourceBuffersOnPeriodSwitch;if(!a)return e;var s=Q(t),u=Q(i),d=a(s,u,e);return"boolean"==typeof d?(this.logger.debug("User overwrote default SourceBuffer recreation strategy from ".concat(e," to ").concat(d)+" for the switch from ".concat(s.periodId," to ").concat(u.periodId,".")),d):e},e.prototype.switchBufferBlock=function(e,t){var i=this;this.logger.debug("Switching buffer block for time ".concat(e));var n=t.getMediaTypesWithoutSubs(),r=this.maybeRecreateSourceBuffers(t,n);return this.currentRendererMediaTypes=n,this.currentBufferBlockDeferredReject.next((function(){return r})).then((function(){return i.currentBufferBlockDeferredReject.next((function(){return i.restorePlayback(e,t)}))})).then((function(e){return i.currentBufferBlockDeferredReject.next((function(){return i.pushSegmentsToRenderer(1/0).catch((function(){return i.context.logger.debug("Could not push segment into renderer")}))})).then((function(){return e}))}))},e.prototype.maybeRecreateSourceBuffers=function(e,t){return this.shouldRecreateSourceBuffers(e,t)?(this.logger.debug("recreating the buffers with types",t),this.createSourceBuffers(t)):Promise.resolve(0)},e.prototype.setCurrentTimeOnRenderer=function(e){var t=this,i=this.delayedBufferBlockSwitchContext;return this.delayedBufferBlockSwitchContext=null,this.currentBufferBlockDeferredReject.next((function(){return t.renderer.setCurrentTime(e)})).then((function(e){return i&&i.deferred&&i.deferred.resolve(e),e}))},e.prototype.addMimeTypeAndCodec=function(e,t,i){if(void 0===i&&(i=!1),!M.MimeTypeHelper.isAV(e))return!0;var n=this.renderer.addBuffer(e,t);if(n){var r=(0,f.getMetricsState)(this.context.store.getState());this.subscribeToBufferChanges(),r[e]||this.context.store.dispatch((0,p.initializeMetricsForMimeType)(e,this.context.settings)),i||this.context.store.dispatch((0,p.addMetricsValue)(e,h.MetricType.StalledSeconds,0))}return n},e.prototype.setInitialPeriod=function(e){this.currentPlayingPeriodId=e},e.prototype.getLowestBufferLevel=function(e,t){var i=this;if(!this.isBufferAvailable())return 0;var n=this.currentRendererMediaTypes.map((function(e){return e.mimeType})).map((function(n){return i.getOverallBufferLevel(n,e,c.BufferType.ForwardDuration,t)}));return n.length>0?Math.min.apply(Math,n):0},e.prototype.isStartupThresholdReached=function(){var e=Math.abs(this.manifestService.getTimeShiftBufferDepthSeconds()),t=this.bufferSettings.getForwardTargetLevel();0!==e&&(t=Math.min(t,e));var i=Math.min(this.settings.STARTUP_THRESHOLD,t-this.settings.STARTUP_THRESHOLD_DELTA),n=this.getLowestBufferLevel();return n>=i||n>=this.getRemainingTime()},e.prototype.getInitialPlaybackTime=function(){if(this.startupPlaybackTime)return this.startupPlaybackTime;var e=this.getCurrentTimeRespectingTarget();if(!this.isBufferAvailable())return e;if(this.isInBufferedRange(e))return this.startupPlaybackTime=e;var t=this.currentRendererMediaTypes.map((function(e){return e.mimeType})),i=this.segmentStore.getPlaybackTimesForBufferBlock(this.currentPlayingBufferBlockId,t);return i.some((function(e){return!isFinite(e)}))?e:this.startupPlaybackTime=Math.max.apply(Math,i)},e.prototype.getRemainingTime=function(){return this.manifestService.isLive()?1/0:this.renderer.getDuration()-this.getCurrentTimeRespectingTarget()},e.prototype.endStartupPhase=function(){if(this.isStartup){var e=Date.now(),t=(0,f.getMetricsState)(this.context.store.getState()),i=(0,f.getMetricsLastEntry)(t,"default",h.MetricType.StartTime).value,n=(0,b.toSeconds)(e-i);this.context.store.dispatch((0,p.addMetricsValue)("default",h.MetricType.StartupTimeSeconds,n)),isNaN(n)||this.logger.debug("start up time: ".concat(n)),this.isStartup=!1,this.endStalling()}},e.prototype.resetCurrentTimeInBufferedRange=function(e){var t=this.renderer.getCurrentTime(!0);e.isInit()&&M.MimeTypeHelper.isVideo(e.getMimeType())&&this.isCurrentlyStalled&&r.BufferRangeHelper.isInBufferedRange(this.getBufferedRangesMap(this.manifestService.getPeriodIdForTime(t)),t)&&(this.context.videoElement.currentTime=this.context.videoElement.currentTime)},e.prototype.processDrmInitData=function(e){var t=this;e.getDrmInitData().filter((function(e){var t;return(null===(t=e.kid)||void 0===t?void 0:t.length)>0})).forEach((function(i){return t.manifestService.setRepresentationDrmKid(e.getRepresentationId(),i.kid[0])}))},e.prototype.addDataSegmentToRenderer=function(e){var t=this,i=M.MimeTypeHelper.extractContentType(e.getMimeType());if(this.activeInitSegments[i]!==e.getInitSegment()){var n=e.getInitSegment();return this.activeInitSegments[i]=n,Promise.all([n,e].map((function(e){return t.addSegmentToRenderer(e)}))).then()}return this.addSegmentToRenderer(e)},e.prototype.addSegmentToRenderer=function(e){var t=this;return e.hasDrmInitData()&&this.processDrmInitData(e),this.drmConfigValidPromise.catch((function(i){if(e.isEncrypted())throw t.context.eventHandler.fireError(G(i)),"DRMConfig failure";t.logger.debug("Problem ensuring segment, error:",i)})).then((function(){return t.resetCurrentTimeInBufferedRange(e),t.maybeSetTimestampOffsetOnDiscontinuity(e),t.renderer.appendData(e).catch((function(e){t.logger.debug("could not append data to renderer",e)}))}))},e.prototype.maybeSetTimestampOffsetOnDiscontinuity=function(e){if(!e.isInit()){var t=e.getSegmentInfo().discontinuitySequenceNumber,i=e.getMimeType();if(t!==this.discontinuitySequenceNumbers.get(i)){var n=e.getPresentationTimeOffset();if(isFinite(n)){this.renderer.setTimestampOffset(i,-n);var r=this.currentRendererMediaTypes.find((function(e){return e.mimeType===i}));r&&(r.timestampOffset=n,this.updateMediaType(e.getPeriodId(),r))}this.discontinuitySequenceNumbers.set(i,t)}}},e.prototype.isRestartThresholdReached=function(){if(!this.bufferSettings)return!1;var e=this.settings.RESTART_THRESHOLD;(0,T.isWebOS)()&&(e=Math.max(e,1.5));var t=this.bufferSettings.getForwardTargetLevel(),i=Math.min(e,t-this.settings.RESTART_THRESHOLD_DELTA,this.getRemainingTime());return this.getLowestBufferLevel()>=i},e.prototype.isAllowedToStall=function(){return!this.isStartup&&!this.isSwitchingBufferBlock},e.prototype.startStalling=function(){this.isAllowedToStall()&&this.bufferStallingService.startStalling()},e.prototype.getPlayerStateService=function(){return this.context.serviceManager.get(s.ServiceName.PlayerStateService)},e.prototype.isEndingStallAtGap=function(){var e=this.getCurrentTimeRespectingTarget(),t=this.getLowestBufferLevel(e,!1),i=this.getLowestBufferLevel(e,!0),n=t>=this.settings.RESTART_THRESHOLD,r=t>=this.getRemainingTime()||this.finishPlayback,o=i>t,a=this.getPlayerStateService().seekingOrTimeshifting;return!n&&!r&&!a&&o&&this.bufferStallingService.isRendererStalling()},e.prototype.endStalling=function(){if(!this.isSwitchingBufferBlock)return this.isEndingStallAtGap()?(this.logger.debug("Ending stall at the gap"),void this.endStallAtGapCallback()):void this.bufferStallingService.endStalling();this.logger.debug("Ending stall was aborted due to buffer block switching")},e.prototype.getCurrentTimeRespectingTarget=function(){return null!=this.seekTarget?this.seekTarget:this.renderer.getCurrentTime()},e.prototype.getCurrentPlayingBufferBlockId=function(){return this.segmentStore.getCurrentBufferBlockId()},e.prototype.hasPendingSegments=function(e){return e=e||this.getCurrentPlayingBufferBlockId(),this.segmentStore.getFutureBufferBlocks(e).some((function(e){return e.hasSegments()}))},e.prototype.getOverallBufferLevel=function(e,t,i,n){void 0===t&&(t=this.renderer.getCurrentTime()),void 0===i&&(i=c.BufferType.ForwardDuration),void 0===n&&(n=!0),this.isStartup&&(t=this.getInitialPlaybackTime());var o=this.getBufferedRangesMap(this.currentPlayingPeriodId)[e];return o&&0!==o.length?(o=n?r.BufferRangeHelper.mergeRanges(o.concat(r.BufferRangeHelper.findGapsInRanges(o)),this.settings.GAP_TOLERANCE):o.filter((function(e){return e.start<=t&&t<=e.end})),r.BufferRangeHelper.getBufferLevel(o,t,i)):0},e.prototype.hasFutureCommonBuffer=function(e){return void 0===e&&(e=this.renderer.getCurrentTime()),r.BufferRangeHelper.getCommonBufferedRanges(this.getBufferedRangesMap(this.currentPlayingPeriodId)).some((function(t){return t.getEnd()>e}))},e.prototype.hasFutureBufferBlockData=function(){return Boolean(this.segmentStore.getNextBufferBlock(this.currentPlayingBufferBlockId))||this.isSwitchingBufferBlock},e.prototype.isInBufferedRange=function(e,t){var i=t||this.manifestService.getPeriodIdForTime(e);return r.BufferRangeHelper.isInBufferedRange(this.getBufferedRangesMap(i),e)},e.prototype.isStarted=function(){return this.isAlreadyStarted},e.prototype.hasStreamEnded=function(){return this.hasStreamEndedInternal},e.prototype.unsubscribeFromBufferChanges=function(){void 0!==this.unsubscribeFromRendererBufferChanges&&(this.unsubscribeFromRendererBufferChanges(),this.unsubscribeFromRendererBufferChanges=void 0)},e.prototype.subscribeToBufferChanges=function(){var e=this;this.unsubscribeFromBufferChanges();var t=this.getSourceStore();void 0!==t&&(this.unsubscribeFromRendererBufferChanges=(0,v.subscribeToRendererBufferChanges)(t,(function(t){return e.onBufferChanged(t)})))},e.prototype.subscribeToManifestChange=function(){var e;if(!this.unsubscribeFromManifestChange){var t=this.getSourceStore();if(void 0!==t)void 0!==(null===(e=t.getState())||void 0===e?void 0:e.manifest)&&(this.unsubscribeFromManifestChange=(0,y.subscribe)(t)(x.getManifest,this.updateTotalDuration))}},e.prototype.stop=function(e){void 0===e&&(e=!1),this.finishPlayback=!0,this.isAlreadyStarted=!1,this.isStartup=!1,e?(this.renderer.end(),this.hasStreamEndedInternal=!0,this.logger.debug("stopped playback"),this.renderer.off(C.MediaElementEvent.stalled,this.onVideoElementStalled),this.renderer.off(C.MediaElementEvent.waiting,this.onVideoElementStalled),this.renderer.off(C.MediaElementEvent.ended,this.onVideoElementEnded),this.renderer.off(C.MediaElementEvent.timeupdate,this.onVideoElementTimeUpdate),this.renderer.off(C.MediaElementEvent.currenttimenotadvancing,this.onTimeNotAdvancing),this.unsubscribeFromBufferChanges(),this.unsubscribeFromManifestChange&&(this.unsubscribeFromManifestChange(),this.unsubscribeFromManifestChange=void 0),void 0!==this.unsubscribeFromStoreStoppedListener&&(this.unsubscribeFromStoreStoppedListener(),this.unsubscribeFromStoreStoppedListener=void 0),this.clearBufferMaxSizeChangedSubscription(),this.dataSegmentsPushedMap.clear()):this.endStalling()},e.prototype.hasStopped=function(){return this.finishPlayback},e.prototype.clearBufferMaxSizeChangedSubscription=function(){var e=this;Object.keys(this.bufferMaxSizeChangedSubscriptionMap).forEach((function(t){return e.unsubscribeFromBufferMaxSizeChanged(t)}))},e.prototype.restart=function(){this.finishPlayback=!1,this.isAlreadyStarted||(this.isAlreadyStarted=!0,this.renderer.on(C.MediaElementEvent.stalled,this.onVideoElementStalled),this.renderer.on(C.MediaElementEvent.waiting,this.onVideoElementStalled),this.renderer.on(C.MediaElementEvent.ended,this.onVideoElementEnded),this.renderer.on(C.MediaElementEvent.timeupdate,this.onVideoElementTimeUpdate),this.renderer.on(C.MediaElementEvent.currenttimenotadvancing,this.onTimeNotAdvancing),this.subscribeToBufferChanges()),this.hasStreamEndedInternal=!1},e.prototype.dispose=function(){var e;this.stop(!0),this.renderer=null,this.eventHandler=null,this.settings=null,this.bufferSettings=null,this.eventHandler=null,this.segmentStore=void 0,this.activeInitSegments=null,null===(e=this.getSourceStore())||void 0===e||e.dispatch((0,m.resetLoadedRanges)()),this.bufferRangesCache.dispose(),this.currentRendererMediaTypes=[],this.clearBufferMaxSizeChangedSubscription(),this.drmConfigValidPromise=null,this.bufferStallingService=(0,u.dispose)(this.bufferStallingService)},e.prototype.changeBufferType=function(e,t){var i,n,r=this,o=this.currentRendererMediaTypes.find((function(t){return M.MimeTypeHelper.getMediaType(t.mimeType)===M.MimeTypeHelper.getMediaType(e)}));return o&&(this.currentRendererMediaTypes.splice(this.currentRendererMediaTypes.indexOf(o),1),this.currentRendererMediaTypes.push({mimeType:e,codec:t,timestampOffset:0}),this.unsubscribeFromBufferMaxSizeChanged(o.mimeType),null===(n=this.getSourceStore())||void 0===n||n.dispatch((0,m.resetLoadedRanges)(o.mimeType))),this.subscribeToBufferMaxSizeChanged(e),this.segmentStore.changeMediaType(e,null==o?void 0:o.mimeType),this.bufferStartTimes.delete(null==o?void 0:o.mimeType),this.activeInitSegments={},o?this.renderer.changeBufferType(e,t).finally((function(){return r.subscribeToBufferChanges()})):Promise.resolve(((i={})[e]=t,i))},e.prototype.addRequiredMediaType=function(e,t){this.segmentStore.addRequiredMediaType(e,t)},e.prototype.updateMediaType=function(e,t){this.segmentStore.updateMediaType(e,t)},e.prototype.areBufferBlockMediaTypesFinal=function(e){var t,i;return null!==(i=null===(t=this.segmentStore)||void 0===t?void 0:t.areBufferBlockMediaTypesFinal(e))&&void 0!==i&&i},e.prototype.clearCacheForMimeType=function(e){var t;null===(t=this.getSourceStore())||void 0===t||t.dispatch((0,m.resetLoadedRanges)(e)),this.segmentStore.clearSegments(e)},e.prototype.clearCache=function(){var e,t=this;Object.keys((0,w.getStreamTimeline)(null===(e=this.getSourceStore())||void 0===e?void 0:e.getState())).filter((function(e){return M.MimeTypeHelper.isAV(e)})).forEach((function(e){return t.clearCacheForMimeType(e)}))},e.prototype.clearBuffers=function(){var e=this;this.isClearingBuffers=!0,this.startStalling(),this.clearCache();var t=this.clearRendererBuffers();return t.finally((function(){return e.isClearingBuffers=!1})),t},e.prototype.clearRendererBuffers=function(){var e=this;if(!this.isBufferAvailable())return Promise.resolve();var t=this.currentRendererMediaTypes.map((function(t){return e.clearBuffer(t.mimeType)}));return Promise.all(t).then((function(){}))},e.prototype.clearBuffer=function(e){var t=this;return this.renderer.removeData(e).catch((function(i){return t.logger.debug("Error clearing ".concat(e," buffer:"),i)}))},e.prototype.isBufferAvailable=function(){return this.currentRendererMediaTypes.length>0},e}();function G(e){return R.ModuleManager.has(A.ModuleName.DRM)?new a.PlayerError(o.ErrorCode.DRM_NO_KEY_SYSTEM,{reason:e}):new E.PlayerModuleMissingError(A.ModuleName.DRM)}function Q(e){return{periodId:e.getPeriodId(),contentInformation:e.getMediaTypes().map((function(t){return{codec:t.codec,mimeType:t.mimeType,isDrmProtected:e.getSegregationCriteria(t.mimeType).encryption===H.EncryptionState.Encrypted}}))}}t.BufferController=W},11199:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.BufferRangesCache=void 0;var n=i(59534),r=i(86705),o=i(28803),a=i(71705),s=function(){function e(e,t){var i=this;this.context=e,this.segmentStore=t,this.sourceStore=this.getSourceStore(),this.unsubscribeToStoreChange=(0,o.subscribe)(e.store)(a.sourceIdentifiersSelector,(function(){return i.onSourceIdentifierChanged()}),(function(e,t){return!!e.includes(i.context.sourceContext.sourceIdentifier)&&(0,a.hasASourceStoreIdentifierChanged)(e,t)})),this.subscribeToBufferChange(),this.setNewCache((0,r.getBufferState)(this.sourceStore.getState()))}return e.prototype.onSourceIdentifierChanged=function(){this.sourceStore=this.getSourceStore(),this.sourceStore?(this.subscribeToBufferChange(),this.setNewCache((0,r.getBufferState)(this.sourceStore.getState()))):this.unsubscribeToBufferChange()},e.prototype.getSourceStore=function(){return this.context.serviceManager.get(n.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier)},e.prototype.unsubscribeToBufferChange=function(){this.unsubscribeToBufferRangeChange&&this.unsubscribeToBufferRangeChange(),this.unsubscribeToBufferRangeChange=void 0,this.unsubscribeToStoreChange=void 0},e.prototype.subscribeToBufferChange=function(){var e=this;this.unsubscribeToBufferChange(),this.unsubscribeToBufferRangeChange=(0,o.subscribe)(this.sourceStore)((function(e){return(0,r.getBufferState)(e)}),(function(t){return e.setNewCache(t)}),r.hasBufferRangesChanged)},e.prototype.setNewCache=function(e){this.cachedBufferRanges={overallBufferRanges:(0,r.getBufferRangesMap)(this.segmentStore,e,this.context.settings.GAP_TOLERANCE)}},e.prototype.getRanges=function(e){return void 0!==this.unsubscribeToBufferRangeChange&&void 0!==this.cachedBufferRanges&&0!==Object.keys(this.cachedBufferRanges.overallBufferRanges).length||this.setNewCache(e),this.cachedBufferRanges.overallBufferRanges},e.prototype.dispose=function(){this.unsubscribeToBufferChange(),this.unsubscribeToStoreChange&&(this.unsubscribeToStoreChange(),this.unsubscribeToStoreChange=void 0),this.cachedBufferRanges=void 0},e}();t.BufferRangesCache=s},96733:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.BufferStallingService=void 0;var n=i(95212),r=i(15949),o=function(){function e(e,t,i){this.playerStateService=e,this.logger=t,this.renderer=i}return e.prototype.startStalling=function(){this.isRendererStalling()||(this.logger.debug("Stalling playback"),this.logger.insane("Video element stall started in state: ".concat(this.playerStateService.playbackState)),this.playerStateService.setIsRendererStalling(!0),this.playerStateService.isPlaying()&&(this.logger.insane("Call pause on renderer"),this.renderer.pause()))},e.prototype.endStalling=function(){var e=this;this.isRendererStalling()&&(this.logger.debug("Unstalling playback"),this.playerStateService.setIsRendererStalling(!1),[n.PlaybackState.Play,n.PlaybackState.Playing].includes(this.playerStateService.playbackState)&&(!this.playerStateService.seekingOrTimeshifting&&(0,r.getCapabilities)().isChromium&&(this.logger.insane("Resetting current time before unstalling"),this.renderer.setCurrentTime(this.renderer.getCurrentTime())),this.logger.insane("Call play on renderer"),this.renderer.play().catch((function(t){e.logger&&e.logger.insane("Play failed with reason: ".concat(t))}))))},e.prototype.isRendererStalling=function(){return this.playerStateService.getIsRendererStalling()},e.prototype.dispose=function(){this.logger=null,this.playerStateService=null,this.renderer=null},e}();t.BufferStallingService=o},6862:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.DeferredReject=void 0;var i=function(){function e(){this.rejected=!1}return e.prototype.reject=function(e){this.rejected=!0,this.rejectMessage=e},e.prototype.next=function(e){return this.rejected?Promise.reject(this.rejectMessage):e()},e}();t.DeferredReject=i},39972:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentStore=t.INITIAL_BUFFER_BLOCK_ID=void 0;var r=i(86502),o=i(50163),a=i(8470),s=i(76812),u=i(56727);t.INITIAL_BUFFER_BLOCK_ID=0;var d=.01,c=function(){function e(){this.requiredMediaTypes={},this.delayedMediaTypeToUpdate={},this.delayedMediaTypeToSet={};var e=new a.BufferBlock(t.INITIAL_BUFFER_BLOCK_ID);this.requiredMediaTypes={},this.segregation=new u.Segregation(this.requiredMediaTypes),this.bufferBlocks=[e]}return e.prototype.getBufferBlockByPeriodId=function(e){return this.bufferBlocks.find((function(t){return t.getPeriodId()===e}))},e.prototype.hasSegmentsForBufferBlock=function(e){return this.getAllSegmentsFromBufferBlock(e).hasNext()},e.prototype.hasDataSegmentsForBufferBlock=function(e){return Object.keys(e.mediaTypes).filter((function(e){return o.MimeTypeHelper.isAV(e)})).every((function(t){return e.hasDataSegments(t)}))},e.prototype.getTargetBufferBlock=function(e,t){return this.getBufferBlockForPlaybackTime(e)||this.getClosestFutureBufferBlock(e)||this.getBufferBlockByPeriodId(t)},e.prototype.canSwitchToBufferBlock=function(e,t){if(!t)return!1;var i=this.areBufferBlockMediaTypesFinal(t.getPeriodId(),e);return this.hasDataSegmentsForBufferBlock(t)&&i},e.prototype.canSwitchToBufferBlockForTime=function(e){var t=this.getBufferBlockForPlaybackTime(e);return this.canSwitchToBufferBlock(e,t)},e.prototype.areBufferBlockMediaTypesFinal=function(e,t){var i,n=this;if(void 0!==t&&(i=this.getBufferBlockForPlaybackTime(t)),i||(i=this.getBufferBlockByPeriodId(e)),!i||!i.mediaTypes||0===Object.keys(i.mediaTypes).length)return!1;if(void 0===this.requiredMediaTypes[e])return!1;var r=Object.keys(i.mediaTypes);return Object.keys(this.requiredMediaTypes[e]).filter((function(e){return o.MimeTypeHelper.isAV(e)})).every((function(t){var i;return r.includes(t)&&(null===(i=n.requiredMediaTypes[e][t])||void 0===i?void 0:i.codec)}))},e.prototype.addRequiredMediaType=function(e,t){var i=this.getBufferBlockByPeriodId(e);(this.requiredMediaTypes[e]||(this.requiredMediaTypes[e]={}),this.requiredMediaTypes[e][t]||(this.requiredMediaTypes[e][t]={mimeType:t,codec:null,timestampOffset:0}),i)?i.mediaTypes[t]||i.addMediaType({mimeType:t,codec:null,timestampOffset:0}):(this.delayedMediaTypeToSet[e]||(this.delayedMediaTypeToSet[e]={}),this.delayedMediaTypeToSet[e][t]={mimeType:t,codec:null,timestampOffset:0})},e.prototype.changeMediaType=function(e,t){var i=this,n=Object.keys(this.requiredMediaTypes),r=t;n.forEach((function(n){t||(r=Object.keys(i.requiredMediaTypes[n]).find((function(t){return o.MimeTypeHelper.getMediaType(t)===o.MimeTypeHelper.getMediaType(e)}))),i.removeRequiredMediaType(n,r),i.addRequiredMediaType(n,e)}))},e.prototype.removeRequiredMediaType=function(e,t){if(this.requiredMediaTypes[e]){delete this.requiredMediaTypes[e][t];var i=this.getBufferBlockByPeriodId(e);i&&i.removeMediaType(t)}this.delayedMediaTypeToSet[e]&&delete this.delayedMediaTypeToSet[e][t],this.clearSegments(t)},e.prototype.updateRequiredMediaTypes=function(e,t){var i;if(this.requiredMediaTypes[e]){var r=this.requiredMediaTypes[e][t.mimeType];this.requiredMediaTypes[e][t.mimeType]=n(n({},r),t)}else this.requiredMediaTypes[e]=((i={})[t.mimeType]=t,i)},e.prototype.updateMediaType=function(e,t){var i;this.updateRequiredMediaTypes(e,t);var r=this.getBufferBlockByPeriodId(e);(null==r?void 0:r.hasMediaType(t.mimeType))?r.updateMediaTypeForMimeType(t):this.delayedMediaTypeToUpdate[e]=n(n({},this.delayedMediaTypeToUpdate[e]||{}),((i={})[t.mimeType]=t,i))},e.prototype.findBestMatchingBufferBlockForSegment=function(e,t){var i=this;if(1===this.bufferBlocks.length&&this.segregation.canAddSegmentToBufferBlock(e,this.bufferBlocks[0],t))return this.bufferBlocks[0];var n=[],r=[];this.bufferBlocks.forEach((function(o){i.segregation.canAddSegmentToBufferBlock(e,o,t)?n.push(o):r.push(o)}));var o=l(n),a=l(r),s=e.getPlaybackTime(),u=o.find((function(e){var t=f(e.range.start,a),i=p(e.range.end,a);return t<=s&&s<=i}));return null==u?void 0:u.block},e.prototype.addSegment=function(e){var t=this.segregation.getSegregationCriteria(e),i=this.findBestMatchingBufferBlockForSegment(e,t);i||(i=this.createNewBufferBlock(),this.bufferBlocks.push(i)),i.addSegment(e),i.getSegregationCriteria(e.getMimeType())||i.setSegregationCriteria(t,e.getMimeType());var n=e.getPeriodId(),r=e.getMimeType();this.delayedMediaTypeToSet[n]&&this.delayedMediaTypeToSet[n][r]&&(this.addRequiredMediaType(n,r),delete this.delayedMediaTypeToSet[n][r]),this.delayedMediaTypeToUpdate[n]&&this.delayedMediaTypeToUpdate[n][r]&&(this.updateMediaType(n,this.delayedMediaTypeToUpdate[n][r]),delete this.delayedMediaTypeToUpdate[n][r])},e.prototype.getNewBufferBlockId=function(){var e=this.bufferBlocks[this.bufferBlocks.length-1];return e?e.getId()+1:t.INITIAL_BUFFER_BLOCK_ID},e.prototype.createNewBufferBlock=function(){var e=this.getNewBufferBlockId();return new a.BufferBlock(e)},e.prototype.getMediaTypes=function(e){var t=this;return e&&this.requiredMediaTypes[e]?Object.keys(this.requiredMediaTypes[e]).map((function(i){return t.requiredMediaTypes[e][i]})):[]},e.prototype.getAllBufferBlocks=function(){return this.bufferBlocks},e.prototype.getCurrentBufferBlockId=function(){var e,i=this.bufferBlocks[0];return null!==(e=null==i?void 0:i.getId())&&void 0!==e?e:t.INITIAL_BUFFER_BLOCK_ID},e.prototype.deleteOldBufferBlocks=function(e){this.bufferBlocks=this.bufferBlocks.filter((function(t){return t.getId()>=e&&t.getAllSegments().length>0}))},e.prototype.getActiveBufferBlock=function(){var e;return null!==(e=this.getBufferBlock(this.getCurrentBufferBlockId()))&&void 0!==e?e:null},e.prototype.getBufferBlock=function(e){return this.bufferBlocks.find((function(t){return t.getId()===e}))},e.prototype.getBufferBlockForSegment=function(e){return this.getBufferBlock(e.getBufferBlockId())},e.prototype.getBufferBlockForPlaybackTime=function(e){var t=this,i=this.bufferBlocks.filter((function(i){var n=0===e?t.getSmallestMaxSegmentDuration(i)-d:d;return Object.keys(i.mediaTypes).filter((function(e){return o.MimeTypeHelper.isAV(e)})).every((function(t){var r,o;return(null===(r=i.getPlaybackTimeRange(t))||void 0===r?void 0:r.start)<=e+n&&(null===(o=i.getPlaybackTimeRange(t))||void 0===o?void 0:o.end)>=e}))}));return i[i.length-1]},e.prototype.getClosestFutureBufferBlock=function(e){return this.bufferBlocks.filter((function(t){return t.getMinCommonStartTime()>=e})).sort((function(e,t){return e.getMinCommonStartTime()-t.getMinCommonStartTime()}))[0]},e.prototype.getNextSegment=function(){var e,t;return null!==(t=null===(e=this.getActiveBufferBlock())||void 0===e?void 0:e.getNextSegment())&&void 0!==t?t:null},e.prototype.removeSegment=function(e){var t=this.getBufferBlockForSegment(e);t&&t.removeSegment(e)},e.prototype.getAllSegmentsFromBufferBlock=function(e,t){if(!e)return r.EmptyIterator.getInstance();var i=e.getAllSegments();return t?new r.FilterIterator(new r.ArrayIterator(i),(function(e){return e.getMimeType()===t})):new r.ArrayIterator(i)},e.prototype.getNextBufferBlock=function(e){var t=this.bufferBlocks.find((function(t){return t.getId()>e}));return null!=t?t:null},e.prototype.getFutureBufferBlocks=function(e){return this.bufferBlocks.filter((function(t){return t.getId()>=e}))},e.prototype.getPrecedingSegments=function(e,t){return this.bufferBlocks.flatMap((function(i){return i.getPrecedingSegments(e,t)}))},e.prototype.clearSegments=function(e){this.bufferBlocks.forEach((function(t){return t.clearSegments(e)}))},e.prototype.getSmallestMaxSegmentDuration=function(e){return Boolean(e)&&e.hasMaxSegmentDurations()?e.getMinMaxSegmentDuration():-1},e.prototype.getSmallestSafeBufferSize=function(e,t){var i=this.getBufferBlockForPlaybackTime(e);return(null==i?void 0:i.hasMaxSegmentDuration(t))?i.getMaxSegmentDuration(t)+1:1},e.prototype.getAvailablePositionForTime=function(e,t){var i=e;if(t&&e>t){var n=this.getBufferBlockForPlaybackTime(e);n||(n=this.getClosestFutureBufferBlock(e))&&(i=n.getMinCommonStartTime())}return i},e.prototype.getPlaybackTimesForBufferBlock=function(e,t){var i=this,n=this.getBufferBlock(e);return t.map((function(e){var t=new r.FilterIterator(i.getAllSegmentsFromBufferBlock(n,e),(function(e){return!e.isInit()}));return t.hasNext()?t.next().getPlaybackTime():-1/0}))},e.prototype.isLoadingNextBufferBlock=function(e){var t=this.getNextBufferBlock(e);return!!t&&this.hasDataSegmentsForBufferBlock(t)},e.prototype.shouldSwitchBufferBlock=function(e,t,i){var n=e===(null==t?void 0:t.getPeriodId()),r=(0,s.areBufferBlocksEqual)(t,this.getBufferBlock(i));return!n||!r},e}();function l(e){return e.map((function(e){return{range:e.getCommonPlaybackTimeRanges(),block:e}})).sort((function(e,t){return e.range.start-t.range.start}))}function p(e,t){return t.reduce((function(t,i){return i.range.start>=e?Math.min(i.range.start,t):t}),1/0)}function f(e,t){return t.reduce((function(t,i){return i.range.end<=e?Math.max(i.range.start,t):t}),-1/0)}t.SegmentStore=c},56727:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.canReuseSourceBuffer=t.areSegregationCriteriaEqual=t.Segregation=void 0;var n=i(94725),r=i(15949),o=i(38827),a=i(46381),s=i(8470),u=function(){function e(e){this.requiredMediaTypes=e,this.requiredMediaTypes=e}return e.prototype.isRequiredMimeType=function(e,t){return void 0===t.getPeriodId()||Boolean(this.requiredMediaTypes[t.getPeriodId()]&&this.requiredMediaTypes[t.getPeriodId()][e.getMimeType()])},e.prototype.getSegregationCriteria=function(e){var t,i={encryption:c(e),codec:a.CodecStringHelper.extractCodec(e.getCodec()),periodId:e.getPeriodId()};if((0,o.isTizen2016)()){var n=null===(t=e.getSegmentInfo())||void 0===t?void 0:t.discontinuitySequenceNumber;null!=n&&(i.discontinuityNumber=n)}return i},e.prototype.canAddSegmentToBufferBlock=function(e,t,i){var n=e.getMimeType(),r=t.getSegregationCriteria(n),o=this.isRequiredMimeType(e,t);return r?d(i,r):!(r||!o)&&(!t.getPeriodId()||e.getPeriodId()===t.getPeriodId())},e}();function d(e,t){return Object.keys(e).every((function(i){return t&&t[i]===e[i]}))}function c(e){return e.isEncrypted()?s.EncryptionState.Encrypted:s.EncryptionState.Clear}function l(e,t,i){var n=f();return i.every((function(i){var r=i.mimeType;return n.canReuseSourceBuffers(e,t,r)}))}function p(e,t){var i=e.getMediaTypes().find((function(e){return e.mimeType===t}));return i?i.timescale:0}function f(){return(0,r.getCapabilities)().isTizen?S:(0,r.getCapabilities)().isLegacyEdge?y:(0,r.getCapabilities)()[n.CapabilityKey.isEdge]?v:(0,r.getCapabilities)()[n.CapabilityKey.isFirefox]?m:(0,r.getCapabilities)()[n.CapabilityKey.isWebOS]?y:g}function h(e,t,i){return{currentCriteria:e.getSegregationCriteria(i),nextCriteria:t.getSegregationCriteria(i)}}t.Segregation=u,t.areSegregationCriteriaEqual=d,t.canReuseSourceBuffer=l;var g={canReuseSourceBuffers:function(e,t,i){var n=h(e,t,i),r=n.currentCriteria,o=n.nextCriteria,a=(null==r?void 0:r.codec)===(null==o?void 0:o.codec),s=(null==r?void 0:r.encryption)===(null==o?void 0:o.encryption);return a&&s}},m={canReuseSourceBuffers:function(e,t,i){var n=h(e,t,i),r=n.currentCriteria,o=n.nextCriteria;return(null==r?void 0:r.codec)===(null==o?void 0:o.codec)}},S={canReuseSourceBuffers:function(e,t,i){var n=h(e,t,i),r=n.currentCriteria,a=n.nextCriteria,s=r.codec===a.codec&&r.encryption===a.encryption&&r.periodId===a.periodId,u=(0,o.isTizen2016)()&&p(e,i)!==p(t,i);return!((0,o.isTizen2017)()||!s||u)}},v={canReuseSourceBuffers:function(e,t,i){var n=h(e,t,i),r=n.currentCriteria,o=n.nextCriteria,a=(null==r?void 0:r.codec)===(null==o?void 0:o.codec),u=(null==r?void 0:r.encryption)===s.EncryptionState.Clear,d=(null==o?void 0:o.encryption)===s.EncryptionState.Clear;return a&&u&&d}},y={canReuseSourceBuffers:function(e,t,i){return!1}}},38426:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.calculateUpdateDelayInMillis=t.AbstractUpdater=t.REPRESENTATION_UPDATE_CANCEL=void 0;var n=i(81028),r=i(80815);t.REPRESENTATION_UPDATE_CANCEL="CANCEL";var o=2147483647,a=function(){function e(e){var t=this;this.updateCallbacks=e,this.handlePayloadUpdateError=function(e){t.publishErrorResponse(e),t.clearTimeout()},this.processPayload=function(e){t.success(e),t.clearTimeout(),t._isStopped||t.scheduleUpdate()},this._isStopped=!1}return e.prototype.cancel=function(){this._updateDeferred&&(this._updateDeferred.reject(t.REPRESENTATION_UPDATE_CANCEL),this.updateCallbacks.error(t.REPRESENTATION_UPDATE_CANCEL)),this.clearTimeout()},e.prototype.clearTimeout=function(){window.clearTimeout(this.updateTimeoutId),this.updateTimeoutId=null},e.prototype.stop=function(){null!==this.updateTimeoutId&&(this._isStopped=!0,this.cancel())},e.prototype.start=function(){this._isStopped=!1,this.scheduleUpdate()},e.prototype.scheduleUpdate=function(){this.updateTimeoutId||this._isStopped||this.initializeUpdate()},e.prototype.initializeUpdate=function(){var e=this,t=s(this.getLastReloadTimestamp(),this.getReloadIntervalInSeconds());if(!(t>o)){var i=new n.Deferred,r={wasInvalidated:function(){return i!==e._updateDeferred}};i.promise.catch((function(){})),this._updateDeferred=i,this.updateTimeoutId=window.setTimeout((function(){return e.payloadUpdate(r)}),t)}},e.prototype.payloadUpdate=function(e){var t=this;this.update().then(this.processPayload).catch((function(i){e.wasInvalidated()||t.handlePayloadUpdateError(i)}))},e.prototype.publishErrorResponse=function(e){this._updateDeferred.reject(e),this.updateCallbacks.error(e)},e.prototype.success=function(e){this._updateDeferred.resolve(e),this.updateCallbacks.success(e)},Object.defineProperty(e.prototype,"isStopped",{get:function(){return this._isStopped},enumerable:!1,configurable:!0}),e.prototype.getPayload=function(){return this._updateDeferred.promise},e}();function s(e,t){if(isNaN(t))return 0;var i=(0,r.toSeconds)(Date.now()-e);return i>=t?0:(0,r.toMilliSeconds)(t-i)}t.AbstractUpdater=a,t.calculateUpdateDelayInMillis=s},53001:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.findAdaptationSetsForMimeType=t.getPreferredLanguage=t.getHlsDefaultLanguage=t.findAdaptationSetOfMimeType=void 0;var n=i(8833),r=i(50163),o=i(43068),a=i(83024);function s(e,t,i){var r;void 0===i&&(i={});var o=void 0;return e.toLowerCase().includes(n.MediaType.Audio)&&(null===(r=i.playbackConfig)||void 0===r?void 0:r.audioLanguage)&&(o=u(e,t,i.playbackConfig.audioLanguage)),o||(o=d(t,e,i.sourceState,i.langObj,i.periodSwitched)),o}function u(e,t,i){if(i){var n=h(t,e);if(!Array.isArray(i))return p(n,{language:i});for(var r=void 0,o=0,a=i;o<a.length;o++){if(r=p(n,{language:a[o]}))break}return r}}function d(e,t,i,n,r){void 0===r&&(r=!1);var o,a=l(t,i),s=h(e,t);(a&&(o=p(s,a,n,r)),!o&&i)&&(o=p(s,c(t,i),n,r));return o||s[0]}function c(e,t){var i;if(o.ModuleManager.has(a.ModuleName.HLS)){var n=o.ModuleManager.get(a.ModuleName.HLS).selectors,s=n.getHlsState,u=n.getDefaultLanguages,d=s(t),c=d?u(d):void 0;if(c){var l=null===(i=r.MimeTypeHelper.getMediaType(e))||void 0===i?void 0:i.toUpperCase();return l?c[l]:void 0}}}function l(e,t){var i=t&&c(e,t),n={language:navigator.language||navigator.userLanguage||(null==i?void 0:i.language)||void 0};return n.language&&i&&f(n.language,i.language)&&(n.name=i.name),n}function p(e,t,i,n){if(void 0===n&&(n=!1),0!==e.length){var r=void 0;if(i&&(r=g(e,i,n)),r)return r;if(t&&t.language){var o=e.filter((function(e){return!(!Boolean(e._lang)||null==e._lang)&&f(e._lang,t.language)}));return o.find((function(e){return e.Representation.find((function(e){return e._name===t.name}))}))||o[0]}}}function f(e,t){return Boolean((null==e?void 0:e.includes(t))||(null==t?void 0:t.includes(e)))}function h(e,t){return e.AdaptationSet.filter((function(e){return e._mimeType===t||e.Representation.find((function(e){return e._mimeType===t}))}))}function g(e,t,i){var n=e.find((function(e){return e._lang&&t.lang&&e._lang===t.lang})),r=e.find((function(e){return t.adaptationSetId&&e._internalId.equals(t.adaptationSetId)}));return r=r||e.find((function(e){return t.id===e._internalId.adaptationSetId})),i?n||r:r||n}t.findAdaptationSetOfMimeType=s,t.getHlsDefaultLanguage=c,t.getPreferredLanguage=l,t.findAdaptationSetsForMimeType=h},71278:function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.createAdaptationSetIdFromMimeTypeAndIndex=t.AdaptationSetId=void 0;var r=function(e){function t(t,i){var n=e.call(this,t)||this;return n._adaptationSetId=i,n}return n(t,e),Object.defineProperty(t.prototype,"adaptationSetId",{get:function(){return this._adaptationSetId},enumerable:!1,configurable:!0}),t.prototype.equals=function(t){return e.prototype.equals.call(this,t)&&this.adaptationSetId===t.adaptationSetId},t.prototype.key=function(){return e.prototype.key.call(this)+"-"+this.adaptationSetId},t}(i(94112).PeriodId);function o(e,t,i){return new r(e,"".concat(t,"-").concat(i))}t.AdaptationSetId=r,t.createAdaptationSetIdFromMimeTypeAndIndex=o},83576:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getContentTypeFromMimeTypeAndCodecs=t.getMinimumUpdatePeriodInSeconds=t.representationToQuality=t.applyProperties=t.stripUnderscorePrefix=t.MPDExtractor=void 0;var n=i(59534),r=i(8833),o=i(43587),a=i(46381),s=i(22758),u=i(50163),d=i(80815),c=i(29079),l=i(43068),p=i(83024),f=i(10559),h=i(96400),g=function(){function e(e,t){var i=this;this.isLive=function(){return"dynamic"===i.getMpd()._type},this.context=e,this.sourceContext=t,this.settings=e.settings,this.adjustedPeriodStartTimes=!1,this.synchronizedTimeService=e.serviceManager.get(n.ServiceName.SynchronizedTimeService,this.sourceContext.sourceIdentifier),this.sourceStore=e.serviceManager.get(n.ServiceName.SourceStoreService,this.sourceContext.sourceIdentifier)}return e.prototype.getMpd=function(){return(0,h.getManifest)(this.sourceStore.getState())},e.prototype.getPeriods=function(){return this.getMpd().Period},e.prototype.getAdaptationSets=function(e){var t=this.getPeriods().find((function(t){return t._id===e}));return t?t.AdaptationSet:[]},e.prototype.adjustPeriodStartTimes=function(){if(!this.adjustedPeriodStartTimes&&!this.getMpd()._isHls){var e=this.isLive()?(0,d.toSeconds)(this.getAvailabilityStartTime()):(0,o.getStartTimeOffset)(this.sourceStore.getState());this.sourceStore.dispatch((0,f.adjustPeriodStartTimes)(e)),this.adjustedPeriodStartTimes=!0}},e.prototype.getAvailabilityStartTime=function(){return this.isLive()&&this.getMpd()._availabilityStartTime?c.Util.getUtcDate(this.getMpd()._availabilityStartTime).getTime()-this.getTimeDifference():0},e.prototype.getAvailabilityEndTime=function(){if(this.getMpd().hasOwnProperty("_availabilityEndTime")){var e=c.Util.getUtcDate(this.getMpd()._availabilityEndTime).getTime();return new Date(e-this.getTimeDifference())}return null},e.prototype.getTimeDifference=function(){return this.synchronizedTimeService?this.synchronizedTimeService.getTimeDifference():0},e.prototype.getType=function(){return this.getMpd()._type},e.prototype.getDuration=function(){return this.getMpd()._mediaPresentationDuration},e.prototype.getRequestTimestamp=function(){return this.getMpd()._requestTimestamp},e.isValueWithinBounds=function(e,t,i){return!e||e>=t&&e<=i},e.prototype.isAllowedVideoQuality=function(t){var i=e.isValueWithinBounds(t.width,this.settings.MIN_SELECTABLE_VIDEO_WIDTH,this.settings.MAX_SELECTABLE_VIDEO_WIDTH),n=e.isValueWithinBounds(t.height,this.settings.MIN_SELECTABLE_VIDEO_HEIGHT,this.settings.MAX_SELECTABLE_VIDEO_HEIGHT),r=e.isValueWithinBounds(t.bitrate,this.settings.MIN_SELECTABLE_VIDEO_BITRATE,this.settings.MAX_SELECTABLE_VIDEO_BITRATE);return i&&n&&r},e.prototype.isAllowedAudioQuality=function(t){return e.isValueWithinBounds(t.bitrate,this.settings.MIN_SELECTABLE_AUDIO_BITRATE,this.settings.MAX_SELECTABLE_AUDIO_BITRATE)},e.prototype.getAllowedQualities=function(e,t){var i=this;if(!e)return[];var n=t.filter((function(t){return u.MimeTypeHelper.isVideo(e)&&i.isAllowedVideoQuality(t)||u.MimeTypeHelper.isAudio(e)&&i.isAllowedAudioQuality(t)}));return n.length<1&&t.length>0?t:n},e.prototype.getQualityForAdaptationSet=function(e){if(!e)return[];var t=e.Representation.map((function(t){return v(t,e._mimeType,e._codecs)}));return this.settings.EXCLUDE_DISALLOWED_REPRESENTATIONS&&(t=this.getAllowedQualities(e._mimeType,t)),t},e.prototype.getAudioQualities=function(e){var t=this,i=this.getValidPeriodId(e);return this.getAdaptationSets(i).reduce((function(e,i){return i._mimeType&&u.MimeTypeHelper.isAudio(i._mimeType)&&(e[i._internalId.adaptationSetId]=t.getQualityForAdaptationSet(i)),e}),{})},e.prototype.getVideoQualities=function(e){var t=this.getValidPeriodId(e),i=this.getAdaptationSets(t).find((function(e){return e._mimeType&&u.MimeTypeHelper.isVideo(e._mimeType)}));return i?this.getQualityForAdaptationSet(i):[]},e.prototype.getLangObjectFromAdaptationSet=function(e,t,i){var n={id:null,lang:null,adaptationSetId:null,kind:null,label:"off",url:null},r=e._mimeType&&e._mimeType.indexOf(t)>-1,o=i&&e._mimeType.indexOf(i)>-1;return u.MimeTypeHelper.isSubtitle(t)&&(n.kind="subtitle"),e.Role&&e.Role.length>0&&(n.role=e.Role.map((function(e){return S(e,{})}))),(r||o)&&(S(e,n,["_lang","_isFragmented"]),n.lang=n.lang||"und",n.label=e._label||n.lang,n.adaptationSetId=e._internalId,n.id=e._internalId.adaptationSetId),n},e.prototype.toSubtitleTrack=function(e,t,i){var n=this.getLangObjectFromAdaptationSet(e,t,i),r={id:n.id,lang:n.lang,kind:n.kind,isFragmented:n.isFragmented,enabled:!1,label:n.label};return null!=n.role&&(r.role=n.role),r.forced=P(r,e.Representation[0]),r},e.prototype.getAvailableSubtitles=function(e){var t=this,i=0;return e=this.getValidPeriodId(e),this.getAdaptationSets(e).filter((function(e){return u.MimeTypeHelper.isSubtitle(e._mimeType)})).map((function(e){var n=t.toSubtitleTrack(e,"application","text");return n.id||(i++,n.id="sub_".concat(i)),n}))},e.prototype.getClosedCaptionLabels=function(e){return e=this.getValidPeriodId(e),this.getAdaptationSets(e).filter((function(e){return e.ClosedCaptionLabels})).flatMap((function(e){return Object.keys(e.ClosedCaptionLabels).map((function(t){var i=e.ClosedCaptionLabels[t];return{id:t,kind:"captions",lang:i.lang||"unknown",label:i.label||"Captions (".concat(t,")")}}))}))},e.prototype.getAvailableAudio=function(e,t){var i=this;void 0===t&&(t=!0);var n=this.getValidPeriodId(e),o=this.getAdaptationSets(n),a=0,s=o.filter((function(e){return u.MimeTypeHelper.isAudio(e._mimeType)})).map((function(e){var t=i.getLangObjectFromAdaptationSet(e,r.MediaType.Audio);return t&&"off"!==t.label?(t.id||(t.id="audio_"+a,a++),t):null}));if(t){var d=o.find((function(e){return u.MimeTypeHelper.isVideo(e._mimeType)}));if(d&&d.ContentComponent){var c=d.ContentComponent.filter((function(e){return e._contentType===r.MediaType.Audio})).map((function(e){return{id:e._id,lang:e._lang,label:e._id,adaptationSetId:d._internalId}}));s=s.concat(c)}}return s.filter((function(e){return e}))},e.prototype.getAvailableVideo=function(e){var t=this.getValidPeriodId(e),i=this.getAdaptationSets(t).find((function(e){return u.MimeTypeHelper.isVideo(e._mimeType)}));return i?[this.getLangObjectFromAdaptationSet(i,r.MediaType.Video)]:[]},e.getContentProtectionForManifestElement=function(e){var t;return(null===(t=null==e?void 0:e.ContentProtection)||void 0===t?void 0:t.length)&&l.ModuleManager.has(p.ModuleName.DRM)?l.ModuleManager.get(p.ModuleName.DRM).ContentProtectionHelper.parseContentProtectionDescriptors(e.ContentProtection):[]},e.getContentProtectionForAdaptationSet=function(t){for(var i=[],n=0;n<t.Representation.length;n++)i=i.concat(e.getContentProtectionForManifestElement(t.Representation[n]));return i=i.concat(e.getContentProtectionForManifestElement(t))},e.prototype.getTimeShiftBufferDepthSeconds=function(){if(this.isLive()){var e=this.getMpd()._timeShiftBufferDepth,t=(0,d.toSeconds)(Date.now()-this.getAvailabilityStartTime());return e===Number.NEGATIVE_INFINITY?-t:Math.max(e,-t)}return 0},e.getCurrentAndSuccessorPeriod=function(e,t){for(var i=[null,0,null],n=i[0],r=i[1],o=i[2];r<e.length;r++)if(e[r]._id===t){n=e[r],o=e[r+1]||null;break}return[n,o]},e.prototype.getPeriodDuration=function(t,i){i=i||this.getMpd().Period;var n=e.getCurrentAndSuccessorPeriod(i,t),r=n[0],o=n[1];if(r&&r._duration)return s.DurationConverter.getDurationInSec(r._duration);if(r&&r.start&&o&&o.start)return o.start-r.start;if(this.getMpd()._mediaPresentationDuration){var a=s.DurationConverter.getDurationInSec(this.getMpd()._mediaPresentationDuration);if(!isNaN(a))return a}return Number.POSITIVE_INFINITY},e.prototype.getDRMCapabilitiesForPeriod=function(e){e=this.getValidPeriodId(e);var t=this.getMpd().Period.find((function(t){return t._id===e}));return this.getDRMCapabilitiesFromPeriod(t)},e.prototype.getDRMCapabilitiesFromPeriod=function(t){for(var i=[],n=[],r=0,o=t.AdaptationSet;r<o.length;r++){var a=o[r],s=a._mimeType,d=e.getMimeTypeCodecStringForAdaptationSet(a);u.MimeTypeHelper.isVideo(s)?n=n.concat(d):u.MimeTypeHelper.isAudio(s)&&(i=i.concat(d))}return[i,n]},e.prototype.dispose=function(){this.settings=null},e.getMimeTypeCodecStringForAdaptationSet=function(t){for(var i=[],n=0,r=t.Representation;n<r.length;n++){var o=r[n],a=e.getAttributeFromRepresentationOrAdaptationSet("_codecs",o,t),s=t._mimeType;if(t._mimeType&&a){var u=R(s,a);i.push({contentType:u})}}return i},e.getAttributeFromRepresentationOrAdaptationSet=function(e,t,i){return t.hasOwnProperty(e)&&t[e]?t[e]:i.hasOwnProperty(e)&&i[e]?i[e]:null},e.prototype.getValidPeriodId=function(e){var t=this.getPeriods();if(t.find((function(t){return t._id===e})))return e;var i=t[t.length-1]._id;return this.context.logger.debug("Period "+e+" not available - return last period ("+i+")"),i},e.prototype.getEventStreamEvents=function(e){var t=this;return e&&e.EventStream?e.EventStream.filter((function(e){return e.Event})).flatMap((function(i){var n,r=Number(null!==(n=i._timescale)&&void 0!==n?n:1);return t.mapToEventStreamEvent(e.start,i,r)})):[]},e.prototype.mapToEventStreamEvent=function(e,t,i){var n=this;return t.Event.map((function(t){var r={},o=t._presentationTime||0;if(r.startTime=o/i+e,t._duration){var a=t._duration/i;r.endTime=r.startTime+a}else r.endTime=r.startTime;return r.data=n.getEventData(t),r}))},e.prototype.getEventData=function(e){var t,i=/<event[^>]*>(.*)(<\/event>|\/>)/g.exec(e.rawXmlRepresentation);i&&i.length>1&&(t=i[1]);var n={};return Object.getOwnPropertyNames(e).filter((function(e){return!["_presentationTime","_duration","__text"].some((function(t){return t===e}))&&0===e.lastIndexOf("_",0)})).forEach((function(t){n[t.substring(1,t.length)]=e[t]})),{properties:n,content:t}},e}();function m(e){return 0===e.indexOf("_")?e.substring(1):e}function S(e,t,i){return void 0===i&&(i=[]),Object.keys(e).filter((function(e){return 0===i.length||i.indexOf(e)>-1})).forEach((function(i){t[m(i)]=e[i]})),t}function v(e,t,i){if(!e)return null;var n={id:e._id?String(e._id):null,bitrate:e._bandwidth||0},r=a.CodecStringHelper.extractCodecStrings(e._codecs||i);return I(e,t)?y(n,e,r):T(e,t)?M(n,e,r):(n.label=e._label||b(n.bitrate),n)}function y(e,t,i){return i.audio&&(e.codec=i.audio),e.label=t._label||b(e.bitrate),e}function T(e,t){return u.MimeTypeHelper.isVideo(t)}function I(e,t){return u.MimeTypeHelper.isAudio(t)}function M(e,t,i){e.width=t._width||0,e.height=t._height||0,i.video&&(e.codec=i.video),t.hasOwnProperty("_frameRate")&&(e.frameRate=t._frameRate);var n=b(e.bitrate);return e.width&&e.height&&(n="".concat(e.width,"x").concat(e.height,", ").concat(n)),e.label=t._label||n,e}function b(e){return"".concat(Math.round(e/1e3),"kbps")}function P(e,t){return Boolean(e.role&&e.role.some((function(e){return["forced_subtitle"].includes(e.value)})))||Boolean(t._hls&&t._hls.isForced)}function C(e){return null==e._minimumUpdatePeriod?1/0:s.DurationConverter.getDurationInSec(e._minimumUpdatePeriod)}function R(e,t){return"".concat(e,'; codecs="').concat(t,'"')}t.MPDExtractor=g,t.stripUnderscorePrefix=m,t.applyProperties=S,t.representationToQuality=v,t.getMinimumUpdatePeriodInSeconds=C,t.getContentTypeFromMimeTypeAndCodecs=R},51186:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestCachingService=void 0;var n=i(5793),r=function(){function e(){this.cache={}}return e.prototype.set=function(e,t,i){var r=n.URLHelper.toFullUrl(e);o(r,this.cache),this.cache[r][t]=i},e.prototype.setExpire=function(e,t){var i=n.URLHelper.toFullUrl(e);o(i,this.cache),this.cache[i].expire=t},e.prototype.get=function(e,t){var i=n.URLHelper.toFullUrl(t),r=this.cache[i];if(r&&a(r.expire))return r[e];delete this.cache[i]},e.prototype.cacheHttpResponse=function(e,t,i){void 0===i&&(i=1/0),this.set(t,"httpResponse",e),this.setExpire(t,i)},e.prototype.cacheParsedManifest=function(e,t,i){void 0===i&&(i=1/0),this.set(t,"parsedManifest",e),this.setExpire(t,i)},e.prototype.cacheSegmentList=function(e,t,i){void 0===i&&(i=1/0),this.set(t,"segmentList",e),this.setExpire(t,i)},e.prototype.getHttpResponse=function(e){return this.get("httpResponse",e)},e.prototype.getParsedManifest=function(e){return this.get("parsedManifest",e)},e.prototype.getSegmentList=function(e){return this.get("segmentList",e)},e.prototype.clear=function(){this.cache={}},e.prototype.dispose=function(){this.cache=null},e}();function o(e,t){t[e]||(t[e]={})}function a(e){return e>=Date.now()}t.ManifestCachingService=r},6124:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createManifestLoadingService=void 0;var n=i(36166),r=i(85739),o=i(8833),a=i(43068),s=i(83024);function u(e,t,i){switch(e.type){case o.StreamType.Dash:return new(0,a.ModuleManager.get(s.ModuleName.DASH).MPDLoader)(t,i);case o.StreamType.Hls:return new(0,a.ModuleManager.get(s.ModuleName.HLS).M3u8Loader)(t,i);case o.StreamType.Smooth:return new(0,a.ModuleManager.get(s.ModuleName.Smooth).SmoothStreamingLoader)(t,i);default:throw new r.PlayerError(n.ErrorCode.SOURCE_INVALID,{given:e.type,supported:"dash, hls, smooth"},"The provided stream type is not supported by the player.")}}t.createManifestLoadingService=u},43233:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.removeRepresentations=t.getMimeTypeForAdaptationSet=t.getCodecsFromAdaptationSet=t.sortAdaptationSetsByBestCodec=t.orderAdaptationSetsByCodec=void 0;var r=i(50163),o=i(63080);function a(e,t){return(e=n({},e)).Period=e.Period.map((function(e){if(!e.AdaptationSet)return n({},e);var i=s(e.AdaptationSet),r=i.videoSets,o=i.audioSets,a=i.otherSets,d=u(r,t.video),c={};return o.forEach((function(e){var t=e._lang||"none";c[t]=c[t]||[],c[t].push(e)})),Object.keys(c).forEach((function(e){d=d.concat(u(c[e],t.audio))})),n(n({},e),{AdaptationSet:d.concat(a)})})),e}function s(e){return e.reduce((function(e,t){var i=c(t);return r.MimeTypeHelper.isVideo(i)?e.videoSets.push(t):r.MimeTypeHelper.isAudio(i)?e.audioSets.push(t):e.otherSets.push(t),e}),{videoSets:[],audioSets:[],otherSets:[]})}function u(e,t){var i=function(e){for(var i=0;i<t.length;i++)if(0===e.indexOf(t[i]))return i;return t.length+1};return e.sort((function(e,t){return i(d(e))-i(d(t))}))}function d(e){var t;if((null===(t=null==e?void 0:e._codecs)||void 0===t?void 0:t.length)>0)return e._codecs;if(e.Representation&&e.Representation.length>0){var i=e.Representation[e.Representation.length-1];if(i._codecs)return i._codecs}return""}function c(e){if(e._mimeType)return e._mimeType;if(Array.isArray(e.Representation)){var t=e.Representation.find((function(e){return e._mimeType}));if(t)return t._mimeType}return""}function l(e,t){if(!(e.Period&&e.Period.length>0)||0===t.length)return e;var i=e.Period.map((function(e){return p(e,t)})).filter((function(e){return e.AdaptationSet.length>0}));return n(n({},e),{Period:i})}function p(e,t){var i=e.AdaptationSet.map((function(e){return f(e._internalId,e,t)})).filter((function(e){return e.Representation.length>0}));return n(n({},e),{AdaptationSet:i})}function f(e,t,i){var r=t.Representation.filter((function(t){return!i.some((function(i){return i.equals(new o.RepresentationId(e,t._id))}))}));return n(n({},t),{Representation:r})}t.orderAdaptationSetsByCodec=a,t.sortAdaptationSetsByBestCodec=u,t.getCodecsFromAdaptationSet=d,t.getMimeTypeForAdaptationSet=c,t.removeRepresentations=l},88269:function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)},o=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.getCodecOfAdaptationSetMimeType=t.getCodecPriorities=t.getRepresentationById=t.getMatchingRepresentationByBandwidth=t.findLowestPossibleBandwidthFromRepresentations=t.getNearestPeriodForTime=t.iterateAdaptationSets=t.addDrmKidsToRepresentations=t.initializeInternalIds=t.ManifestService=void 0;var a=i(36166),s=i(85739),u=i(59534),d=i(4529),c=i(59574),l=i(49863),p=i(86750),f=i(33240),h=i(49916),g=i(90884),m=i(81349),S=i(96036),v=i(82072),y=i(12391),T=i(46381),I=i(22758),M=i(50163),b=i(80815),P=i(43068),C=i(83024),R=i(10559),A=i(96400),E=i(53001),x=i(71278),k=i(43233),B=i(83576),L=i(94112),_=i(63080),D="Outdated",w=function(e){function t(t,i){var n=e.call(this,{onRestore:function(){return n.onRestore()}})||this;n.context=t,n.lastManifestUpdateId=0,n.dispatchQualityRemovedEvent=function(e){var t=n.getAdaptationSet(e._internalId);if(t){var i=function(t){n.context.eventHandler.dispatchEvent(t,{quality:{id:e._id,bitrate:e._bandwidth}})};M.MimeTypeHelper.isAudio(t._mimeType)?i(c.PlayerEvent.AudioQualityRemoved):M.MimeTypeHelper.isVideo(t._mimeType)&&i(c.PlayerEvent.VideoQualityRemoved)}},n.copyRequiredPropertiesToRepresentations=function(e){(e.Representation||[]).forEach((function(t){e._codecs&&!t._codecs&&(t._codecs=e._codecs),e._width&&!t._width&&(t._width=e._width),e._height&&!t._height&&(t._height=e._height)})),delete e.SegmentTemplate},n.sourceContext=i,n.settings=t.settings,n.excludedRepresentations=[];var r=n.sourceContext.sourceIdentifier;return n.synchronizedTimeService=t.serviceManager.get(u.ServiceName.SynchronizedTimeService,r),n.sourceStore=t.serviceManager.get(u.ServiceName.SourceStoreService,r),n}return n(t,e),Object.defineProperty(t.prototype,"mpdExtractor",{get:function(){return this._mpdExtractor||(this._mpdExtractor=new B.MPDExtractor(this.context,this.sourceContext)),this._mpdExtractor},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"manifest",{get:function(){var e;return(0,A.getManifest)(null===(e=this.sourceStore)||void 0===e?void 0:e.getState())},enumerable:!1,configurable:!0}),t.prototype.setManifest=function(e){this.sourceStore.dispatch((0,R.setManifestAction)(this.preProcessManifest(e)))},t.prototype.updateManifest=function(e){var t=this;this.lastManifestUpdateId++;var i=this.lastManifestUpdateId;return this.synchronizeWithTimeserver(e).then((function(){return t.ensureStillSameOperation(i),t.adjustManifestToKeySystemSupport(e)})).then((function(){t.ensureStillSameOperation(i),t.reinitializeAndUpdateManifest(e)})).catch((function(e){if(e!==D)throw e;t.context.logger.debug("Skipping manifest update, since a newer manifest is available")}))},t.prototype.ensureStillSameOperation=function(e){if(e!==this.lastManifestUpdateId)throw D},t.prototype.adjustManifestToKeySystemSupport=function(e){var t,i,n,r,o=this,a=null!==(n=null===(i=null===(t=this.context.serviceManager)||void 0===t?void 0:t.get(u.ServiceName.DrmService))||void 0===i?void 0:i.getUsedOrEarlyResolvedKeySystemUid())&&void 0!==n?n:null;if(!a||!e.Period||!(null===(r=this.context.serviceManager)||void 0===r?void 0:r.has(u.ServiceName.DrmDetectorService)))return Promise.resolve();var s=this.context.serviceManager.get(u.ServiceName.DrmDetectorService),d=X(e,this.mpdExtractor),c=d.audioCapabilities,l=d.videoCapabilities;return s.getSupportedCapabilities(a,c,l).then((function(t){return Z(e,t,o.context.logger)}))},t.prototype.reinitializeAndUpdateManifest=function(e){if((0,v.isContextAvailable)(this.context)&&this.context.serviceManager){if(this.disposeMpdExtractor(),e.isInitialized=!1,this.setManifest(e),this.isLive()){var t=this.getFirstPeriod(),i=this.isHlsManifest()&&t?t.start:(0,b.toSeconds)(this.getAvailabilityStartTime());this.sourceStore.dispatch((0,g.setStartTimeOffset)(i))}this.mpdExtractor.adjustPeriodStartTimes();var n=this.parseStreamDuration();(0,l.maybeFireDurationChangedEvent)(this.parsedDuration,n,this.context.eventHandler),this.parsedDuration=n,this.setManifestInitialized(!0)}},t.prototype.excludeRepresentations=function(e){var t=this,i=e.map((function(e){return t.getRepresentationById(e)})).filter((function(e){return Boolean(e)}));this.setManifestInitialized(!1),this.excludedRepresentations=y.ArrayHelper.union(this.excludedRepresentations,e),this.sourceStore.dispatch((0,R.removeRepresentationsAction)(this.excludedRepresentations)),this.manifest.Period.length?(this.disposeMpdExtractor(),i.forEach(this.dispatchQualityRemovedEvent),this.setManifestInitialized(!0)):this.context.eventHandler.fireError(new s.PlayerError(a.ErrorCode.SOURCE_ERROR,void 0,"No playable track left"))},t.prototype.isRepresentationExcluded=function(e){return this.excludedRepresentations.some((function(t){return t.equals(e)}))},t.prototype.resetExcludedRepresentations=function(){this.excludedRepresentations=[]},t.prototype.onRestore=function(){this.setPlayerDRM(this.getManifest()),this.sourceStore.dispatch((0,R.setManifestAction)(N(this.getManifest())))},t.getSupplementalProperties=function(e,t){return!e.SupplementalProperty||e.SupplementalProperty.length<=0?null:e.SupplementalProperty.filter((function(e){return e._schemeIdUri===t}))},t.prototype.findMatchingSwitchableAdaptationSets=function(e,t,i){var n=i&&i.length>0;if(!n&&!this.settings.ADAPTATION_SET_SWITCHING_WITHOUT_SUPPLEMENTAL_PROPERTY)return null;var r=[],o=e._group,a=J(e);return n&&i.forEach((function(e){return r.push(e._value)})),this.settings.ADAPTATION_SET_SWITCHING_WITHOUT_SUPPLEMENTAL_PROPERTY&&t.forEach((function(e){r.includes(e._id)||r.push(e._id)})),t.filter((function(t){if(!r.includes(t._id)||t._id===e._id)return!1;var i=t._group===o,n=t._mimeType===e._mimeType,s=J(t)===a,u=t._lang===e._lang;return n&&s&&i&&u}))},t.prototype.getSwitchableAdaptationSets=function(e){var i=this;return e.AdaptationSet?e.AdaptationSet.reduce((function(n,r){var a=t.getSupplementalProperties(r,"urn:mpeg:dash:adaptation-set-switching:2016"),s=i.findMatchingSwitchableAdaptationSets(r,e.AdaptationSet,a);return s&&0!==s.length?y.ArrayHelper.addAndMergeIntersects(n,o([r],s,!0)):n}),[]):[]},t.mergeAdaptationSetProperties=function(e,t,i){var n=e.hasOwnProperty(i),r=t.hasOwnProperty(i);(n||r)&&(n?r||(t[i]=[]):e[i]=[],e[i]=e[i].concat(t[i]))},t.prototype.getAdaptationSetPropertyValues=function(e,t){return e.filter((function(e){return e.hasOwnProperty(t)})).map((function(e){return e[t]}))},t.prototype.updateAdaptationSetMinMaxValues=function(e,t){var i=[e].concat(t),n=this.getAdaptationSetPropertyValues(i,"_minWidth"),r=this.getAdaptationSetPropertyValues(i,"_maxWidth"),o=this.getAdaptationSetPropertyValues(i,"_minHeight"),a=this.getAdaptationSetPropertyValues(i,"_maxHeight"),s=this.getAdaptationSetPropertyValues(i,"_minBandwidth"),u=this.getAdaptationSetPropertyValues(i,"_maxBandwidth");n.length>0&&(e._minWidth=Math.min.apply(null,n)),r.length>0&&(e._maxWidth=Math.max.apply(null,r)),o.length>0&&(e._minHeight=Math.min.apply(null,o)),a.length>0&&(e._maxHeight=Math.max.apply(null,a)),s.length>0&&(e._minBandwidth=Math.min.apply(null,s)),u.length>0&&(e._maxBandwidth=Math.max.apply(null,u))},t.prototype.mergeAdaptationSets=function(e,i){i.forEach(this.copyRequiredPropertiesToRepresentations);var n=i.shift();i.forEach((function(e){["Representation","ContentComponent","ContentProtection","SupplementalProperty"].forEach((function(i){return t.mergeAdaptationSetProperties(n,e,i)}))})),this.updateAdaptationSetMinMaxValues(n,i),e.AdaptationSet=e.AdaptationSet.filter((function(e){return!i.includes(e)}))},t.prototype.mergeSwitchableAdaptationSets=function(e){var t=this;return e.Period.forEach((function(e){t.getSwitchableAdaptationSets(e).forEach((function(i){t.mergeAdaptationSets(e,i)}))})),e},t.getFirstKeyId=function(e){if(!e||0===e.length)return null;var t=e.find((function(e){return"cenc"===e.name}));if(t&&t.defaultKid)return t.defaultKid;var i=e.find((function(e){return e.kids&&e.kids.length>0}));return i?i.kids[0]:null},t.prototype.setRepresentationDrmKid=function(e,t){this.sourceStore.dispatch((0,R.setRepresentationDrmKidAction)(e,t))},t.prototype.getRepresentationDrmKid=function(e){var t;return null===(t=this.getRepresentationById(e))||void 0===t?void 0:t.associatedKid},t.prototype.setManifestInitialized=function(e){this.sourceStore.dispatch((0,R.setManifestInitializedAction)(e))},t.prototype.setPlayerDRM=function(e){var t=this.sourceContext.source.drm,i=O(e),n={};i.length>0&&(n=r({},i[0])),null!=t&&Object.keys(t).length>0&&Object.keys(t).forEach((function(e){n[e]=null!=n[e]?r(r({},n[e]),t[e]):t[e]})),this.addDrmServiceAndSetDrmConfig(n);var o=Object.keys(n).length>0?(0,h.setManifestDrm)(n):(0,h.resetManifestDrm)();this.sourceStore.dispatch(o)},t.prototype.addDrmServiceAndSetDrmConfig=function(e){if(P.ModuleManager.has(C.ModuleName.DRM)&&Object.keys(e).length>0&&!this.context.serviceManager.has(u.ServiceName.DrmService)){var t=P.ModuleManager.get(C.ModuleName.DRM).DrmService;this.context.serviceManager.set(u.ServiceName.DrmService,new t(this.context))}this.context.serviceManager.maybeCall(u.ServiceName.DrmService,(function(t){t.isDrmConfigSet()||t.setDrmConfig(e)}))},t.prototype.getPreviousRepDrmKidAssociation=function(){var e=new Map;return this.getAllRepresentations().filter((function(e){return e._internalId&&e.associatedKid})).forEach((function(t){return e.set(t._internalId.key(),t.associatedKid)})),e},t.prototype.preProcessManifest=function(e){var t=this.getPreviousRepDrmKidAssociation();return e.Period&&e.Period.length>0?(F(e=(0,k.orderAdaptationSetsByCodec)(e,G(this.context.config,this.sourceContext.source))),e=this.mergeSwitchableAdaptationSets(e),P.ModuleManager.has(C.ModuleName.Envivio)&&(e=P.ModuleManager.get(C.ModuleName.Envivio).fixSegmentTimelineLiveStream(e)),this.isSuspended()||this.setPlayerDRM(e),e=N(e),H(e=(0,k.removeRepresentations)(e,this.excludedRepresentations),t),e):(this.context.eventHandler.fireError(new s.PlayerError(a.ErrorCode.SOURCE_ERROR,void 0,"No playable track left")),null)},t.prototype.parseStreamDuration=function(){if(this.mpdExtractor){var e=NaN,t=this.mpdExtractor.getDuration();return t&&(this.cachedDurationString&&this.cachedDurationString===t?e=this.cachedDuration:(e=I.DurationConverter.getDurationInSec(t),this.cachedDurationString=t,this.cachedDuration=e)),isNaN(e)&&this.isLive()?1/0:e}return 0},t.prototype.getDuration=function(){return this.parsedDuration},t.prototype.isLive=function(){return!!this.manifest&&this.mpdExtractor.isLive()},t.prototype.getAvailabilityStartTime=function(){return this.mpdExtractor.getAvailabilityStartTime()},t.prototype.getAvailabilityEndTime=function(){return this.mpdExtractor.getAvailabilityEndTime()},t.prototype.isAvailabilityEndTimeExceeded=function(){var e=this.getAvailabilityEndTime();return e&&Date.now()>e.getTime()},t.prototype.findPeriod=function(e){return Q(this.manifest,e)},t.prototype.getAllPeriods=function(){return this.manifest&&this.manifest.Period?this.manifest.Period:[]},t.prototype.getPeriod=function(e){return e?this.findPeriod(e.periodId):null},t.prototype.isSmoothManifest=function(){return this.manifest.originalFormat&&"smooth"===this.manifest.originalFormat.format},t.prototype.isLanguageAvailable=function(e,t,i){var n=Q(this.manifest,e)||Y(this.manifest);return(0,E.findAdaptationSetsForMimeType)(n,t).some((function(e){var t=e._lang&&i.lang&&e._lang===i.lang,n=i.adaptationSetId&&e._internalId.equals(i.adaptationSetId);return t||n}))},t.prototype.findAdaptationSet=function(e,t,i,n){void 0===n&&(n=!1);var r=Q(this.manifest,e)||Y(this.manifest);if(void 0!==r){var o=this.sourceStore.getState(),a=(0,E.findAdaptationSetOfMimeType)(t,r,{sourceState:o,langObj:i,periodSwitched:n,playbackConfig:this.context.config.playback});return a||this.context.logger.debug("No AdaptationSet found to match mime type "+t),a}},t.prototype.getManifest=function(){return this.manifest},t.prototype.getAvailableAudio=function(e,t){return this.mpdExtractor.getAvailableAudio(e,t)},t.prototype.getAvailableVideo=function(e){return this.mpdExtractor.getAvailableVideo(e)},t.prototype.getAvailableSubtitles=function(e){return this.mpdExtractor.getAvailableSubtitles(e)},t.prototype.getClosedCaptionLabels=function(e){return this.mpdExtractor.getClosedCaptionLabels(e)},t.prototype.getVideoRepresentations=function(e){return this.mpdExtractor.getVideoQualities(e)},t.prototype.getAudioRepresentations=function(e){return this.mpdExtractor.getAudioQualities(e)},t.prototype.getPeriodDuration=function(e,t){return this.mpdExtractor.getPeriodDuration(e,t||this.getManifest().Period)},t.prototype.hasMultiplePeriods=function(){return this.manifest&&this.manifest.Period&&this.manifest.Period.length>1},t.prototype.hasSinglePeriod=function(){return this.manifest&&this.manifest.Period&&1===this.manifest.Period.length},t.prototype.getTimeShiftBufferDepthSeconds=function(){return this.mpdExtractor.getTimeShiftBufferDepthSeconds()},t.prototype.getRequestTimestamp=function(){return this.mpdExtractor.getRequestTimestamp()},t.prototype.getMediaPresentationDuration=function(){var e=I.DurationConverter.getDurationInSec(this.manifest._mediaPresentationDuration);return isNaN(e)?0:e},t.prototype.calculateCumulativePeriodDuration=function(e){for(var t=0,i=0,n=this.manifest.Period;i<n.length;i++){var r=n[i];if(r._id===e)break;t+=this.getPeriodDuration(r._id)}return this.isLive()?(0,b.toSeconds)(Date.now()-this.getAvailabilityStartTime())-t:t},t.prototype.getMinimumUpdatePeriod=function(){return(0,B.getMinimumUpdatePeriodInSeconds)(this.manifest)},t.prototype.getContentProtectionForAdaptationSet=function(e){return B.MPDExtractor.getContentProtectionForAdaptationSet(e)},t.prototype.getLangObjectFromAdaptationSet=function(e,t){return this.mpdExtractor.getLangObjectFromAdaptationSet(e,t)},t.prototype.toSubtitleTrack=function(e,t){return this.mpdExtractor.toSubtitleTrack(e,t)},t.prototype.getDRMCapabilitiesForPeriod=function(e){return this.mpdExtractor.getDRMCapabilitiesForPeriod(e)},t.prototype.hasManifestTypeChanged=function(e){return!(!this.manifest||this.manifest._type===e)&&(this.context.logger.log("Manifest has just changed from "+this.manifest._type+" to "+e),!0)},t.prototype.getPeriodIdForTime=function(e){var t=this.manifest.Period;return 1===t.length?t[0]._id:j(t,e)._id},t.prototype.dispose=function(){this.disposeMpdExtractor(),e.prototype.dispose.call(this)},t.prototype.disposeMpdExtractor=function(){this._mpdExtractor=(0,d.dispose)(this._mpdExtractor)},t.prototype.getTotalDurationFromManifest=function(){var e=this.getFirstPeriod();if(this.cachedDuration&&e&&e.start)return e.start+this.cachedDuration},t.prototype.getTotalDuration=function(){if(this.isLive())return this.getTotalDurationFromManifest()||1/0;var e=this.getLastPeriod();return e?(e.start||e._start&&I.DurationConverter.getDurationInSec(e._start)||0)+this.mpdExtractor.getPeriodDuration(e._id):0},t.prototype.getFirstPeriod=function(){return Y(this.manifest)},t.prototype.getLastPeriod=function(){if(this.manifest.Period&&this.manifest.Period.length>0)return this.manifest.Period[this.manifest.Period.length-1]},t.prototype.isLastPeriod=function(e){var t=this.getLastPeriod();return!!t&&e===t._id},t.prototype.isManifestFinalized=function(){return!this.isLive()},t.prototype.isFirstPeriod=function(e){var t=this.getFirstPeriod();return!!t&&t._id===e},t.prototype.isHlsManifest=function(){return this.getManifest()._isHls},t.prototype.getHlsTags=function(){if(!this.isHlsManifest())return null;var e=P.ModuleManager.get(C.ModuleName.HLS).selectors,t=e.getHlsState;return(0,e.getCustomTags)(t(this.sourceStore.getState()))},t.prototype.isMimeTypePartOfPeriod=function(e,t){var i=this.getPeriod(new L.PeriodId(t));return(i?i.AdaptationSet:[]).some((function(t){return t._mimeType===e}))},t.prototype.getNextPeriod=function(e){if(this.manifest)for(var t=this.findPeriod(e),i=this.manifest.Period.indexOf(t)+1;i<this.manifest.Period.length;i++){var n=this.manifest.Period[i];if(n&&!n.droppedOut)return n}return null},t.prototype.getEventStreamEvents=function(e){return this.mpdExtractor.getEventStreamEvents(e)},t.prototype.hasAdaptationSets=function(e){var t=this.manifest;if(t&&t.Period){var i=t.Period.find((function(t){return t._id===e}));return Boolean(i&&i.AdaptationSet)}return!1},t.prototype.synchronizeWithTimeserver=function(e){var t=this,i=[],n=0;if(this.synchronizedTimeService){var r=this.context.config&&this.context.config.live;return r&&r.synchronization&&r.synchronization.length>0?i=r.synchronization.map((function(e){switch(e.method){case p.LiveSynchronizationMethod.HttpHead:return{schemeIdUri:"urn:mpeg:dash:utc:http-head:2014",value:e.serverUrl};case p.LiveSynchronizationMethod.HttpXsDate:return{schemeIdUri:"urn:mpeg:dash:utc:http-xsdate:2014",value:e.serverUrl};case p.LiveSynchronizationMethod.HttpIso:return{schemeIdUri:"urn:mpeg:dash:utc:http-iso:2014",value:e.serverUrl};default:return t.context.logger.debug("No valid time synchronization configuration entry provided"),null}})).filter((function(e){return null!==e})):e&&e.UTCTiming&&e.UTCTiming.length>0&&(i=i.concat(e.UTCTiming),n=e._downloadTime),this.synchronizedTimeService.synchronizeWithServer(i,n).then((function(e){t.context.logger.debug("successfully synchronized to server time - drift: ".concat((0,b.toSeconds)(e),"s"))})).catch((function(){t.context.logger.debug("Player clock synchronization failed")}))}return Promise.resolve()},t.prototype.getAdaptationSet=function(e){if(!e)return null;var t=this.getPeriod(e);return t&&t.AdaptationSet?t.AdaptationSet.find((function(t){return t._internalId.equals(e)})):null},t.prototype.getRepresentationById=function(e){var t=this.getAdaptationSet(e);return t?K(t.Representation,e):null},t.prototype.representationExists=function(e){return Boolean(this.getRepresentationById(e))},t.prototype.getLowestBandwidthOfAdaptationSet=function(e){return this.findLowestPossibleBandwidth(e,-1/0)},t.prototype.findLowestPossibleBandwidth=function(e,t){void 0===t&&(t=-1/0);var i=this.getAdaptationSet(e);return i?V(i.Representation,t):1/0},t.prototype.getMatchingRepresentationByBandwidth=function(e,t,i){void 0===i&&(i=function(){return!0});var n=this.getAdaptationSet(e);return n?z(n.Representation,t,i):null},t.prototype.getAllRepresentations=function(){return this.getAllPeriods().flatMap((function(e){var t;return(null===(t=e.AdaptationSet)||void 0===t?void 0:t.flatMap((function(e){return e.Representation})))||[]}))},t.prototype.getRepresentation=function(e,t){return this.getRepresentationById(new _.RepresentationId(e,t))},t.prototype.getAllAdaptationSets=function(){return this.getAllPeriods().flatMap((function(e){return e.AdaptationSet}))},t.prototype.getAllImageAdaptationSets=function(){return this.getAllAdaptationSets().filter((function(e){return e._mimeType.includes("image")&&"image"===e._contentType}))},t.prototype.getAllDashThumbnailSources=function(){var e=this;return this.getAllImageAdaptationSets().map((function(t){var i=e.findPeriod(t._internalId.periodId);return{adaptationSet:t,timing:{startTime:i.start,duration:i.duration}}}))},t.prototype.getAdaptationSetIndex=function(e){var t=this.findPeriod(e.periodId);return t&&t.AdaptationSet&&0!==t.AdaptationSet.length?t.AdaptationSet.findIndex((function(t){return t._internalId.equals(e)})):-1},t.prototype.markSegmentAsDownloaded=function(e,t){this.sourceStore.dispatch((0,R.markSegmentAsDownloadedAction)(e,t))},t.prototype.getAvailableBaseURLsForRepresentation=function(e){var t=this.getAdaptationSet(e);if(void 0===e||!t)return[];for(var i=[],n=t.Representation,r=0;r<n.length;r++)if(n[r]._internalId.equals(e)&&n[r].BaseURL&&n[r].BaseURL.length>0){i=n[r].BaseURL;break}var o=[];for(r=0;r<i.length;r++)o.push((0,m.forceReallocation)(i[r].url));return o},t.prototype.findDownloadedHlsRepresentation=function(e){var t=this.getAdaptationSet(e);return t?t.Representation.find((function(e){return e._hls&&Boolean(e._hls.requestTimestamp)})):null},t.prototype.isManifestFetchRequired=function(e){if(!this.isHlsManifest())return!1;var t=Date.now(),i=this.getRepresentationById(e),n=Boolean(i.SegmentList)&&i.SegmentList.length>0&&Boolean(i.SegmentList[0].SegmentURL),r=n?i.SegmentList[0].SegmentURL.length:0,o=!n||r>0,a=t-(i._requestTimestamp||t),s=this.isLive()&&a>=this.getMinimumUpdatePeriod();return!o||s},t.prototype.hasSelfInitialisingSegments=function(){return this.manifest.Period.map((function(e){return e.AdaptationSet})).reduce((function(e,t){return e.concat(t)}),[]).map((function(e){return e.Representation})).reduce((function(e,t){return e.concat(t)}),[]).some((function(e){var t=Boolean(e.SegmentList)&&e.SegmentList.length>0?e.SegmentList:[],i=Boolean(e.SegmentBase)&&e.SegmentBase.length>0,n=Boolean(e.SegmentTemplate)&&e.SegmentTemplate.length>0?e.SegmentTemplate:[];return!(e.init||i||t.some((function(e){return Boolean(e.init)}))||n.some((function(e){return Boolean(e._initialization)})))}))},t.prototype.getAvailabilityTimeComplete=function(e){var t=this.getRepresentationById(e),i=t.SegmentList||t.SegmentBase||t.SegmentTemplate;return!(i&&i[0]&&i[0]._availabilityTimeComplete)||JSON.parse(i[0]._availabilityTimeComplete)},t.prototype.isSegmentInfoLoaded=function(e){var t=this.getRepresentationById(e);return!!t&&!(!t.segmentIndex&&!t.segmentIndexParsingError)},t.prototype.isPrecedingPeriod=function(e,t){if(!(e&&t&&this.manifest&&this.manifest.Period))return!1;var i=this.manifest.Period.findIndex((function(t){return t._id===e})),n=this.manifest.Period.findIndex((function(e){return e._id===t}));return i>=0&&n>=0&&n<i},t.prototype.getMaxSegmentDuration=function(){var e=I.DurationConverter.getDurationInSec(this.manifest._maxSegmentDuration);return isNaN(e)?0:e},t.prototype.getDesiredDistanceToLiveEdge=function(){return Boolean(this.context.config.live&&this.context.config.live.lowLatency)?this.context.config.live.lowLatency.targetLatency:this.context.bufferSettings.getForwardTargetLevel()+this.settings.LIVE_EDGE_DISTANCE},t.prototype.hasSuggestedStartPosition=function(){return this.manifest.hasOwnProperty("_startOffset")},t.prototype.getVodStartOffset=function(){return Math.max(0,Math.min(this.manifest._startOffset,this.getDuration()-this.settings.SEEK_TO_END_OFFSET))},t.prototype.getLiveStartOffset=function(e){void 0===e&&(e=!0);var t=this.manifest._startOffset;return t-=Math.abs(this.getTimeShiftBufferDepthSeconds()),e&&(t+=this.getDesiredDistanceToLiveEdge(),t=Math.min(0,t)),t},t.prototype.getPublishTime=function(){return this.manifest._publishTime},t.prototype.initSegmentStartTimesFromReferenceSegment=function(e){var t=P.ModuleManager.get(C.ModuleName.HLS);this.sourceStore.dispatch(t.actions.initSegmentStartTimesFromReferenceSegment(e))},t.prototype.initializeSegmentStartTimesFromStart=function(e){var t=P.ModuleManager.get(C.ModuleName.HLS),i=t.selectors,n=i.getHlsState,r=i.getPlaylistStartTime,o=i.hasPlaylist,a=n(this.sourceStore.getState());if(o(a,e)){var s=r(a,e);this.sourceStore.dispatch(t.actions.initSegmentStartTimes(e,0,s))}},t.prototype.hasSegmentStartTimeForHlsRepresentation=function(e){var t=P.ModuleManager.get(C.ModuleName.HLS).selectors,i=t.getHlsState;return(0,t.hasSegmentStartTimesForPlaylist)(i(this.sourceStore.getState()),e)},t.prototype.getStartTimeForHlsSegment=function(e,t){var i=P.ModuleManager.get(C.ModuleName.HLS).selectors,n=i.getHlsState;return(0,i.getStartTimeForSegment)(n(this.sourceStore.getState()),e,t)},t.prototype.isTimeNearPeriodEnd=function(e,t){for(var i=this.getAllPeriods(),n=0,r=i;n<r.length;n++){var o=r[n],a=o.start,s=a+this.getPeriodDuration(o._id,i);if(e>=a&&e<=s)return s-e<=t}return!1},t}(S.Suspendable);function O(e){return null==e.Period?[]:e.Period.filter((function(e){return e.AdaptationSet&&e.AdaptationSet.length>0})).reduce((function(e,t){return e.concat(t.AdaptationSet)}),[]).filter((function(e){return e.ContentProtection&&e.ContentProtection.length>0})).flatMap((function(e){return e.ContentProtection})).filter((function(e){return null!=e.laurl&&e.laurl.length>0})).flatMap((function(e){return e.laurl.map((function(t){return r(r({},t),{drmType:f.DRMSchemeIDURIs[e._schemeIdUri]})}))})).filter((function(e){return null!=e.drmType})).map((function(e){var t;return(t={})[e.drmType]={LA_URL:e._licenseUrl},t}))}function N(e){var t;return(e=r({},e)).Period=null===(t=e.Period)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(t,i){var n,o=(0,x.createAdaptationSetIdFromMimeTypeAndIndex)(e._id,t._mimeType,i);return r(r({},t),{_internalId:o,_periodId:e._id,Representation:null===(n=t.Representation)||void 0===n?void 0:n.map((function(e){return r(r({},e),{_internalId:new _.RepresentationId(o,e._id)})}))})}))})})),e}function F(e){if(P.ModuleManager.has(C.ModuleName.DRM)){var t=P.ModuleManager.get(C.ModuleName.DRM).ContentProtectionHelper.getFirstKeyId;U(e,(function(e){for(var i=t(e.ContentProtection),n=0;e.Representation&&n<e.Representation.length;n++){var r=e.Representation[n];(i||r.ContentProtection)&&(r.associatedKid=r.ContentProtection&&t(r.ContentProtection)||i)}}))}}function H(e,t){e.Period.flatMap((function(e){var t;return null!==(t=null==e?void 0:e.AdaptationSet)&&void 0!==t?t:[]})).flatMap((function(e){var t;return null!==(t=null==e?void 0:e.Representation)&&void 0!==t?t:[]})).forEach((function(e){t.has(e._internalId.key())&&(e.associatedKid=t.get(e._internalId.key()))}))}function U(e,t){for(var i=0;e.Period&&i<e.Period.length;i++)for(var n=e.Period[i],r=0;n.AdaptationSet&&r<n.AdaptationSet.length;r++)t(n.AdaptationSet[r])}function j(e,t){if(!e||!e.length)return null;if(t<e[0].start)return e[0];var i=e[e.length-1];return t>=i.start?i:q(e,t)||i}function q(e,t){for(var i=0;i<e.length-1;i++){var n=e[i].start+e[i].duration;if(t>=e[i].start&&t<n)return e[i];if(t>=n&&t<e[i+1].start)return e[i+1]}}function V(e,t){return void 0===t&&(t=-1/0),e.reduce((function(e,i){return i._bandwidth>=t?Math.min(e,i._bandwidth):e}),1/0)}function z(e,t,i){void 0===e&&(e=[]),void 0===i&&(i=function(){return!0});var n=e.filter(i),r=null,o=-1/0;return n.forEach((function(e){e._bandwidth>o&&e._bandwidth<=t&&(o=e._bandwidth,r=e)})),r||n[0]}function K(e,t){return void 0===e&&(e=[]),e.find((function(e){return e._internalId.equals(t)}))}function W(e,t,i){var n=i?"videoCodecPriority":"audioCodecPriority";return(null==t?void 0:t.options)&&t.options[n]?t.options[n]:e.playback&&e.playback[n]?e.playback&&e.playback[n]:[]}function G(e,t){return{video:W(e,t,!0),audio:W(e,t,!1)}}function Q(e,t){return e&&t?e.Period.find((function(e){return e._id===t})):null}function Y(e){return null==e?void 0:e.Period[0]}function J(e){var t=(0,k.getCodecsFromAdaptationSet)(e);if(!t||0===t.length)return null;var i=T.CodecStringHelper.extractCodecStrings(t),n=e._mimeType.split("/")[0];return i[n]?T.CodecStringHelper.extractCodec(i[n]):null}function X(e,t){var i=[],n=[];return e.Period.forEach((function(e){var r=t.getDRMCapabilitiesFromPeriod(e);i=i.concat(r[0]),n=n.concat(r[1])})),{audioCapabilities:i,videoCapabilities:n}}function Z(e,t,i){var n=function(e){return e.contentType},r=t.audioCapabilities.map(n),o=t.videoCapabilities.map(n);e.Period.forEach((function(e){e.AdaptationSet=e.AdaptationSet.filter((function(t){return t.Representation=t.Representation.filter((function(n){var a=e.ContentProtection||t.ContentProtection,s=(null==a?void 0:a.length)>0,u=$(n,r,o);if(s&&!u){var d=(0,B.getContentTypeFromMimeTypeAndCodecs)(n._mimeType,n._codecs);i.debug("Representation not supported by MediaKeySystem (".concat(d))}return!s||u})),!M.MimeTypeHelper.isAV(t._mimeType)||t.Representation.length>0}))}))}function $(e,t,i){var n=e._mimeType,r=e._codecs,o=(0,B.getContentTypeFromMimeTypeAndCodecs)(n,r);return M.MimeTypeHelper.isAudio(n)?t.includes(o):!M.MimeTypeHelper.isVideo(n)||i.includes(o)}t.ManifestService=w,t.initializeInternalIds=N,t.addDrmKidsToRepresentations=F,t.iterateAdaptationSets=U,t.getNearestPeriodForTime=j,t.findLowestPossibleBandwidthFromRepresentations=V,t.getMatchingRepresentationByBandwidth=z,t.getRepresentationById=K,t.getCodecPriorities=G,t.getCodecOfAdaptationSetMimeType=J},64324:function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}(),r=this&&this.__decorate||function(e,t,i,n){var r,o=arguments.length,a=o<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,i):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(e,t,i,n);else for(var s=e.length-1;s>=0;s--)(r=e[s])&&(a=(o<3?r(a):o>3?r(t,i,a):r(t,i))||a);return o>3&&a&&Object.defineProperty(t,i,a),a};Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestUpdateScheduler=void 0;var o=i(59534),a=i(52228),s=i(95212),u=i(28803),d=i(96036),c=i(80815),l=i(10559),p=i(46724),f=i(33704),h=function(e){function t(t,i){var n=e.call(this,{onSuspend:function(){return n.onSuspend()},onRestore:function(){return n.onRestore()}})||this;n.initiated=!1,n.trackUpdaters={},n.selectActiveTracks=function(e){return null==e?void 0:e.activeTracks},n.handleActiveTracksChange=function(e){e&&n.manifestService.isHlsManifest()&&n.updateTracks(e)},n.selectPlaybackState=function(e){return e.player&&e.player.playbackState},n.handlePlaybackStateChange=function(e){e&&(e===s.PlaybackState.Paused?n.stop():e===s.PlaybackState.Playing&&n.start())},n.updatedRepresentation=function(e){n.updateAdaptationSetInManifest(e),n.manifestService.updateManifest(n.manifestService.getManifest()).catch((function(){n.logger.debug("Updating the manifest failed")}))},n.representationUpdateError=function(e){n.logger.debug("Rejection while updating the representation",e)},n.manifestDownloadError=function(){n.logger.debug("Error while loading manifest")},n.context=t,n.sourceContext=i;var r=n.sourceContext.sourceIdentifier;return n.manifestService=t.serviceManager.get(o.ServiceName.ManifestService,r),n.manifestLoader=t.serviceManager.get(o.ServiceName.ManifestLoadingService,r),n.store=t.store,n.sourceStore=t.serviceManager.get(o.ServiceName.SourceStoreService,r),n.eventHandler=t.eventHandler,n.logger=t.logger,n.unsubscribeFromActiveTrackChanges=n.subscribeToActiveTrackChanges(),n.unsubscribeFromPausePlayingChanges=n.subscribeToPausePlayingChanges(t),n}return n(t,e),t.prototype.subscribeToActiveTrackChanges=function(){var e=this;return(0,u.subscribe)(this.sourceStore)((function(t){return e.selectActiveTracks(t)}),this.handleActiveTracksChange)},t.prototype.updateTracks=function(e){this.processNewActiveTrack(e),this.removeDeactivatedTrackUpdaters(e)},t.prototype.processNewActiveTrack=function(e){var t=this;Object.keys(e).filter((function(t){return e[t].selectedRepresentationId})).forEach((function(i){t.updateTrackUpdater(e[i].selectedRepresentationId)}))},t.prototype.removeDeactivatedTrackUpdaters=function(e){var t=this;Object.keys(this.trackUpdaters).filter((function(t){return!Object.keys(e).includes(t)})).forEach((function(e){t.trackUpdaters[e].stop(),delete t.trackUpdaters[e]}))},t.prototype.subscribeToPausePlayingChanges=function(e){return(0,u.subscribe)(this.store)(this.selectPlaybackState,this.handlePlaybackStateChange,(function(){return e.settings.STOP_DOWNLOAD_ON_PAUSE}))},t.prototype.updateTrackUpdater=function(e){var t=this.manifestService.getRepresentationById(e),i=e.adaptationSetId;if(this.trackUpdaters[i]){if(!this.trackUpdaters[i].getRepresentation()._internalId.equals(e)){this.trackUpdaters[i].setRepresentation(t)}}else this.trackUpdaters[t._internalId.adaptationSetId]=this.initializeTrackUpdater(t)},t.prototype.updateLinkedRepresentation=function(e){var t=this.trackUpdaters[e._internalId.adaptationSetId];null==t||t.setRepresentation(e)},t.prototype.initializeTrackUpdater=function(e){var t=new f.RepresentationUpdater(e,this.manifestLoader,{success:this.updatedRepresentation,error:this.representationUpdateError});return t.start(),t},t.prototype.updateAdaptationSetInManifest=function(e){this.sourceStore.dispatch((0,l.updateRepresentationAction)(e))},t.prototype.init=function(e){var t=this;return this.manifestLoader.load(e).then((function(e){return t.manifestService.updateManifest(e).then((function(){t.initiated=!0,t.manifestService.isLive()&&!t.manifestService.isHlsManifest()&&t.scheduleManifestReloading(e)}))}))},t.prototype.scheduleManifestReloading=function(e){var t=this;this.manifestUpdater=new p.ManifestUpdater(this.manifestLoader,e,{success:function(e){return t.manifestService.updateManifest(e)},error:this.manifestDownloadError}),this.manifestUpdater.start()},t.prototype.waitForRepUpdate=function(e){return 0===Object.keys(this.trackUpdaters).length||g(this.manifestService.getRepresentationById(e))?Promise.resolve():this.trackUpdaters[e.adaptationSetId].updateRepresentation().then((function(){}))},t.prototype.stop=function(){Object.values(this.trackUpdaters).forEach((function(e){return e.stop()})),this.manifestUpdater&&this.manifestUpdater.stop()},t.prototype.start=function(){Object.values(this.trackUpdaters).filter((function(e){return e.isStopped})).forEach((function(e){e.start()})),this.manifestUpdater&&this.manifestUpdater.isStopped&&this.manifestUpdater.start()},t.prototype.onSuspend=function(){this.unsubscribeFromPausePlayingChanges()},t.prototype.onRestore=function(){this.unsubscribeFromPausePlayingChanges=this.subscribeToPausePlayingChanges(this.context)},t.prototype.isInitiated=function(){return this.initiated},t.prototype.dispose=function(){this.unsubscribeFromActiveTrackChanges(),this.unsubscribeFromPausePlayingChanges(),this.stop(),this.manifestUpdater=null,this.trackUpdaters=null,e.prototype.dispose.call(this)},r([(0,a.trackPerformance)("ManifestUpdateScheduler.init",!0)],t.prototype,"init",null),t}(d.Suspendable);function g(e){var t;return e._requestTimestamp+(0,c.toMilliSeconds)(null!==(t=e._updateInterval)&&void 0!==t?t:1/0)>Date.now()}t.ManifestUpdateScheduler=h},46724:function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestUpdater=void 0;var r=i(38426),o=i(83576),a=function(e){function t(t,i,n){var r=e.call(this,n)||this;return r.manifestLoader=t,r.manifest=i,r}return n(t,e),t.prototype.getUpdatedManifest=function(){return this.getPayload()},t.prototype.update=function(){var e=this;return this.manifestLoader.load(this.manifest._currentLoadingUrl).then((function(t){return e.manifest=t,t}))},t.prototype.getReloadIntervalInSeconds=function(){return(0,o.getMinimumUpdatePeriodInSeconds)(this.manifest)},t.prototype.getLastReloadTimestamp=function(){return this.manifest._requestTimestamp},t}(r.AbstractUpdater);t.ManifestUpdater=a},32765:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MediaPlayerManifestApiFactory=void 0;var n=i(59534),r=i(59574),o=i(94112),a=function(){function e(){}return e.create=function(t,i){var r=i.serviceManager.get(n.ServiceName.ManifestService,i.sourceContext.sourceIdentifier);return new(function(){function i(){r.isHlsManifest()?this.hls=e.createHlsApi(r):r.isSmoothManifest()||(this.dash=e.createDashApi(t,r))}return i}())},e.createDashApi=function(t,i){return new(function(){function n(){}return n.prototype.getPeriod=function(){var n=i.getPeriodIdForTime(t.getCurrentTime()),r=i.getPeriod(new o.PeriodId(n));return r?e.createPeriodApi(i,r):null},n.prototype.listPeriods=function(){return i.getAllPeriods().map((function(t){return e.createPeriodApi(i,t)}))},n}())},e.createHlsApi=function(t){return new(function(){function i(){this.properties=t.getHlsTags()}return i.prototype.getVideoTracks=function(){return e.getVideoTracks(t,t.getFirstPeriod()._id)},i.prototype.getAudioTracks=function(){return e.getAudioTracks(t,t.getFirstPeriod()._id)},i.prototype.getTextTracks=function(){return e.getTextTracks(t,t.getFirstPeriod()._id)},i}())},e.createPeriodApi=function(t,i){return new(function(){function n(){this.id=i._id,this.properties={},i._id&&(this.properties.id=i._id),i._start&&(this.properties.start=i._start),i._duration&&(this.properties.duration=i._duration)}return n.prototype.getVideoTracks=function(){return e.getVideoTracks(t,this.id)},n.prototype.getAudioTracks=function(){return e.getAudioTracks(t,this.id)},n.prototype.getTextTracks=function(){return e.getTextTracks(t,this.id)},n.prototype.getMetadata=function(){return e.getMetadata(t,this.id)},n}())},e.getAudioTracks=function(t,i){return t.getAvailableAudio(i,!1).map((function(n){var r={id:n.id,label:n.label,lang:n.lang,getQualities:function(){return e.getAudioQualities(t,i,n.id)}};return n.role&&(r.role=n.role),r}))},e.getVideoTracks=function(t,i){return t.getAvailableVideo(i).map((function(n){var r={id:n.id,label:n.label,getQualities:function(){return e.getVideoQualities(t,i)}};return n.role&&(r.role=n.role),r}))},e.getTextTracks=function(e,t){return e.getAvailableSubtitles(t)},e.getMetadata=function(e,t){return e.getEventStreamEvents(e.findPeriod(t)).map((function(e){return{type:r.MetadataType.EVENT_STREAM,payload:e.data,start:e.startTime,end:e.endTime}}))},e.getAudioQualities=function(e,t,i){return e.getAudioRepresentations(t)[i]||[]},e.getVideoQualities=function(e,t){return e.getVideoRepresentations(t)},e}();t.MediaPlayerManifestApiFactory=a},94112:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PeriodId=void 0;var i=function(){function e(e){this._periodId=e}return Object.defineProperty(e.prototype,"periodId",{get:function(){return this._periodId},enumerable:!1,configurable:!0}),e.prototype.equals=function(e){return e&&this.periodId===e.periodId},e.prototype.key=function(){return this.periodId},e}();t.PeriodId=i},63080:function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.RepresentationId=void 0;var r=i(71278),o=function(e){function t(t,i){var n=e.call(this,t.periodId,t.adaptationSetId)||this;return n._representationId=i,n}return n(t,e),Object.defineProperty(t.prototype,"representationId",{get:function(){return this._representationId},enumerable:!1,configurable:!0}),t.prototype.equals=function(t){return e.prototype.equals.call(this,t)&&this.representationId===t.representationId},t.prototype.key=function(){return e.prototype.key.call(this)+"-"+this.representationId},t.from=function(e){return e._representationId&&e._adaptationSetId&&e._periodId?new t(new r.AdaptationSetId(e._periodId,e._adaptationSetId),e._representationId):null},t}(r.AdaptationSetId);t.RepresentationId=o},33704:function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i])},e(t,i)};return function(t,i){if("function"!=typeof i&&null!==i)throw new TypeError("Class extends value "+String(i)+" is not a constructor or null");function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(t,"__esModule",{value:!0}),t.RepresentationUpdater=void 0;var r=i(38426),o=function(e){function t(t,i,n){var r=e.call(this,n)||this;return r.representation=t,r.manifestLoader=i,r}return n(t,e),t.prototype.getRepresentation=function(){return this.representation},t.prototype.setRepresentation=function(e){this.representation._internalId.equals(e._internalId)||this.cancel(),this.representation=e,this.scheduleUpdate()},t.prototype.updateRepresentation=function(){return this.getPayload()},t.prototype.update=function(){var e=this;return this.manifestLoader.updateRepresentation(this.representation).then((function(t){if(e.representation._id!==t._id)throw r.REPRESENTATION_UPDATE_CANCEL;return e.representation=t,t}))},t.prototype.getReloadIntervalInSeconds=function(){var e;return this.representation._requestTimestamp?null!==(e=this.representation._updateInterval)&&void 0!==e?e:1/0:0},t.prototype.getLastReloadTimestamp=function(){return this.representation._requestTimestamp?this.representation._requestTimestamp:0},t}(r.AbstractUpdater);t.RepresentationUpdater=o},30828:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.AdRestorationOptimizationService=void 0;var n=i(59574),r=i(22221),o=i(45366),a=i(82072),s=i(43233),u=i(59534),d=i(17394),c=function(){function e(){var e=this;this.startOptimization=function(){(0,a.isContextAvailable)(e.context)&&e.context.eventHandler.off(n.PlayerEvent.AdStarted,e.startOptimization),e.prefetchContentSegments(e.segmentInfosToPrefetch),e.segmentInfosToPrefetch=[]}}return e.prototype.updatePlayerContext=function(e){this.mimeTypes=[],this.context=e,this.segmentInfoService=e.segmentInfoService,this.segmentPrefetchingService=e.segmentPrefetchingService},e.prototype.optimizeRestorationAfterUpcomingAdBreak=function(){var e,t,i=this,r=null===(t=null===(e=this.getSourceState())||void 0===e?void 0:e.getState())||void 0===t?void 0:t.playback;if(!(0,a.isContextAvailable)(this.context)||!this.segmentInfoService||!r)return Promise.reject("Could not get playback state and/or SegmentInfoService");var o=(0,d.getPlaybackPosition)(r);return isNaN(o)?Promise.reject("Could not get playback position"):this.segmentInfoService.getSegmentInfos(o,this.context.settings.AD_RESTORATION_SEGMENT_PREFETCHING_DURATION).then((function(e){i.addCodecInfo(e),i.segmentInfosToPrefetch=e,(0,a.isContextAvailable)(i.context)&&i.context.eventHandler&&i.context.eventHandler.on(n.PlayerEvent.AdStarted,i.startOptimization)}))},e.prototype.getSourceState=function(){return(0,a.isContextAvailable)(this.context)?this.context.serviceManager.get(u.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier):void 0},e.prototype.addCodecInfo=function(e){var t=(0,a.isContextAvailable)(this.context)?this.context.sourceContext.sourceIdentifier:void 0,i=t?this.context.serviceManager.get(u.ServiceName.ManifestService,t):void 0;i&&e.forEach((function(e){var t=i.getAdaptationSet(e.internalRepresentationId);t&&(e.codecs=(0,s.getCodecsFromAdaptationSet)(t))}))},e.prototype.prefetchContentSegments=function(e){var t;this.mimeTypes=e.reduce((function(e,t){return t.mimeType&&!e.includes(t.mimeType)&&e.push(t.mimeType),e}),[]),this.maybeCreateMetrics(),null===(t=this.segmentPrefetchingService)||void 0===t||t.fetchAll(e)},e.prototype.findMatchingSegmentInfo=function(e,t){var i,n=null===(i=this.segmentPrefetchingService)||void 0===i?void 0:i.getPrefetchedSegments().get(e);if(n)return l(n,(function(e){return e.segmentInfo})).find((function(e){if(!t||null==t.segmentNumber||null==t.startTime||null==t.duration)return!0;var i=t.segmentNumber+1,n=Math.round(t.startTime+t.duration),r=e.segmentNumber===i,o=null!=e.startTime&&Math.round(e.startTime)===n;return r||o}))},e.prototype.hasPrefetchedSegment=function(e,t){var i;if((0,a.isContextAvailable)(this.context)&&this.context.sourceContext.isAd)return!1;var n=e;return"string"==typeof e&&(n=this.findMatchingSegmentInfo(e,t)),!(!n||"string"==typeof n)&&Boolean(null===(i=this.segmentPrefetchingService)||void 0===i?void 0:i.getPrefetchedSegment(n))},e.prototype.getPrefetchedSegment=function(e,t){var i=this;if(!this.segmentPrefetchingService||!e.mimeType)return null;var n=this.segmentPrefetchingService.getPrefetchedSegment(e);return this.segmentPrefetchingService.clearPrefetchingQueue(e.mimeType),n&&(this.segmentPrefetchingService.removePrefetchedSegment(e),this.segmentPrefetchingService.setShouldDownloadBeCancelledCallback(e.mimeType,t),n.finally((function(){i.segmentPrefetchingService&&e.mimeType&&i.segmentPrefetchingService.removeShouldDownloadBeCancelledCallback(e.mimeType)}))),n},e.prototype.getRepresentationForPrefetchedSegment=function(e){var t,i=null===(t=this.segmentPrefetchingService)||void 0===t?void 0:t.getPrefetchedSegments().get(e);if(i)return l(i,(function(e){return e.segmentInfo.internalRepresentationId})).find(Boolean)},e.prototype.maybeCreateMetrics=function(){var e=this;if((0,a.isContextAvailable)(this.context)){var t=this.context.store.getState();if(0!==this.mimeTypes.length&&t){var i=(0,o.getMetricsState)(t);this.mimeTypes.forEach((function(t){i[t]||e.context.store.dispatch((0,r.initializeMetricsForMimeType)(t,e.context.settings))}))}}},e.prototype.dispose=function(){(0,a.isContextAvailable)(this.context)&&this.context.eventHandler.off(n.PlayerEvent.AdStarted,this.startOptimization),this.segmentInfosToPrefetch=[],this.segmentInfoService=void 0,this.segmentPrefetchingService=void 0},e}();function l(e,t){var i=[];return e.forEach((function(e){return i.push(t(e))})),i}t.AdRestorationOptimizationService=c},3072:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.resolveContainerFormat=void 0;var n=i(50163),r=i(43068),o=i(83024),a=i(8073),s=i(92977);function u(e,t,i){return i?d(e,t):c(e)}function d(e,t){var i,s=r.ModuleManager.has(o.ModuleName.ContainerMP4),u=null===(i=r.ModuleManager.get(o.ModuleName.ContainerMP4,!1))||void 0===i?void 0:i.isValidMp4;return s&&u(t)?{source:a.ContainerFormat.MP4,target:a.ContainerFormat.MP4}:n.MimeTypeHelper.isSubtitle(e)?c(e):{source:a.ContainerFormat.TS,target:a.ContainerFormat.MP4}}function c(e){var t=(0,s.extractContainerFormat)(e);return t?{source:t,target:t}:void 0}t.resolveContainerFormat=u},27999:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.FetchController=void 0;var r,o=i(49520),a=i(40237),s=i(41609),u=i(81028),d=i(27005);!function(e){e.User="user",e.Timeout="timeout"}(r||(r={}));var c=function(){function e(e,t,i){var r=this;this.setProgressListener=function(e){r.progressListener=e},this.onProgress=function(e,t){r.progressListener&&(r.timing.progressTimestamp=a.TimingUtil.getHiResTimestamp(),r.progress.loadedBytes=t,r.progress.totalBytes=e,r.progressListener(n({},r.progress)))},this.onSuccess=function(){clearTimeout(r.cancelTimeout)},this.logger=e.logger,this.timeout=i,this.request=t,this.fetching=new u.Deferred,this.bytesReceivedCount=0,this.timing={sendTimestamp:-1,openedTimestamp:-1,headersReceivedTimestamp:-1,progressTimestamp:-1,doneTimestamp:-1},this.abortController=new AbortController,this.progress={totalBytes:-1,loadedBytes:-1,url:t.url,responseTiming:this.timing}}return e.prototype.getResponse=function(){return this.load(this.request),this.fetching.promise},e.prototype.cancel=function(e){void 0===e&&(e=r.User),clearTimeout(this.cancelTimeout),this.cancellationReason=e,this.abortController.abort()},e.prototype.load=function(e){var t=this,i={method:e.method,headers:new Headers(e.headers),credentials:e.credentials,signal:this.abortController?this.abortController.signal:void 0};this.timing.sendTimestamp=a.TimingUtil.getHiResTimestamp(),fetch(e.url,i).then((function(e){if(t.timing.headersReceivedTimestamp=a.TimingUtil.getHiResTimestamp(),t.progressListener(n({},t.progress)),e.ok){var i=t.createHttpResponse(e);i.body=t.readResponse(e),t.fetching.resolve(i)}else t.onError({error:o.RequestError.Failed,response:t.createHttpResponse(e)})})).catch((function(e){t.onError({error:t.getRequestError(e)})})),this.timing.openedTimestamp=a.TimingUtil.getHiResTimestamp(),this.progressListener(n({},this.progress)),this.cancelTimeout=setTimeout((function(){return t.cancel(r.Timeout)}),this.timeout)},e.prototype.getResponseHeaders=function(e){var t={};return e.headers.forEach((function(e,i){return t[i]=e})),t},e.prototype.createHttpResponse=function(e){return{request:this.request,url:e.url,headers:this.getResponseHeaders(e),status:e.status,statusText:e.statusText}},e.prototype.getRequestError=function(e){return e instanceof DOMException&&e.code===e.ABORT_ERR?this.cancellationReason===r.User?o.RequestError.Canceled:o.RequestError.TimedOut:o.RequestError.Failed},e.prototype.readResponse=function(e){var t=this,i=new d.Stream;if(e.body){var n=e.body.getReader(),r=function(){return n.read().then((function(e){var n,o=e.done,s=e.value;return o?(t.timing.doneTimestamp=a.TimingUtil.getHiResTimestamp(),void t.onProgress(t.bytesReceivedCount,0)):s?(t.bytesReceivedCount+=s.length,t.onProgress(t.bytesReceivedCount,s.length),n=s instanceof Uint8Array?s.buffer:s,i.add(n),r()):void 0}))};r().then((function(){i.end(),t.onSuccess()})).catch((function(e){t.logger.debug("Error reading ReadableStream of fetch request:",e),i.abort(t.getRequestError(e))}))}else this.request.responseType===s.HttpResponseType.ARRAYBUFFER&&e.arrayBuffer().then((function(e){i.add(e),i.end(),t.onSuccess()}));return i},e.prototype.onError=function(e){clearTimeout(this.cancelTimeout),this.logger.debug("Error performing fetch:",e.error),this.fetching.reject(e)},e}();t.FetchController=c},7977:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.createInitSegmentProvider=void 0;var n=i(64061);function r(e,t){return new n.UrlInitSegmentProvider(e,t)}t.createInitSegmentProvider=r},66173:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.InitSegmentService=void 0;var n=i(4529),r=i(7977),o=function(){function e(e,t){this.context=e,this.provider=(0,r.createInitSegmentProvider)(e,t)}return e.prototype.getSegment=function(e){return this.provider.getSegment(e)},e.prototype.hasCachedSegment=function(e){return Boolean(this.getCachedSegment(e))},e.prototype.getCachedSegment=function(e){return this.provider.getCachedSegment(e)},e.prototype.removeCachedSegments=function(e){this.provider.removeCachedSegments(e)},e.prototype.dispose=function(){(0,n.dispose)(this.provider)},e}();t.InitSegmentService=o},48287:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.InitSegmentStore=void 0;var i=function(){function e(){this.storedInitSegments=new Map}return e.prototype.handleSegment=function(e){e.isInit()?this.storeInitSegment(e):this.setStoredInitSegment(e)},e.prototype.storeInitSegment=function(e){this.storedInitSegments.set(e.getRepresentationId().key(),e)},e.prototype.setStoredInitSegment=function(e){if(!e.getInitSegment()){var t=this.storedInitSegments.get(e.getRepresentationId().key());null!=t&&e.setInitSegment(t)}},e.prototype.clear=function(){this.storedInitSegments.clear()},e.prototype.dispose=function(){this.clear()},e}();t.InitSegmentStore=i},53140:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.KeyLoader=void 0;var n=i(36166),r=i(85739),o=i(83123),a=i(41609),s=function(){function e(e){this.context=e,this.settings=e.settings,this.sourceIdentifier=e.sourceContext.sourceIdentifier,this.loader=new o.DefaultContentLoader(this.context,{maxRetries:this.settings.MAX_RETRIES,retryDelay:this.settings.RETRY_DELAY,requestType:a.HttpRequestType.KEY_HLS_AES})}return e.prototype.hasWithCredentials=function(){var e=this.context.sourceContext.source&&this.context.sourceContext.source.hasOwnProperty("options")&&this.context.sourceContext.source.options,t=e&&e.hasOwnProperty("withCredentials")&&e.withCredentials,i=e&&e.hasOwnProperty("hlsWithCredentials")&&e.hlsWithCredentials;return Boolean(t)||Boolean(i)},e.prototype.load=function(e){var t=this;return this.loader?this.loader.load(e,a.HttpRequestMethod.GET,a.HttpResponseType.ARRAYBUFFER,void 0,void 0,this.hasWithCredentials()).then((function(e){return e.body})).catch((function(i){return t.context.eventHandler.fireError(new r.PlayerError(n.ErrorCode.DRM_FAILED_LICENSE_REQUEST,{statusCode:i.status,statusText:i.statusText,keyUrl:e},"Failed to load the DRM key: ".concat(i.status," ").concat(i.statusText,"."),t.sourceIdentifier)),Promise.reject(i)})):Promise.reject("Could not load: No loader.")},e.prototype.isLoading=function(){return!!this.loader&&this.loader.isLoading()},e.prototype.dispose=function(){this.loader&&"function"==typeof this.loader.dispose&&this.loader.dispose(),this.loader=void 0,this.settings=void 0},e}();t.KeyLoader=s},49100:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.KeyStore=void 0;var i=20,n=function(){function e(e){void 0===e&&(e=i),this.CAPACITY=e,this.keys=[]}return e.prototype.get=function(e){var t,i=null===(t=this.keys)||void 0===t?void 0:t.find((function(t){return t.uri===e}));return i?i.buffer:null},e.prototype.put=function(e,t){this.keys&&(this.keys.push({uri:e,buffer:t}),this.keys.length>this.CAPACITY&&this.keys.shift())},e.prototype.dispose=function(){this.keys=void 0},e}();t.KeyStore=n},30733:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getLoader=t.getLoaderConfig=void 0;var n=i(83123),r=i(41609),o=i(50163);function a(e,t){var i;return(null===(i=e.config.tweaks)||void 0===i?void 0:i.segmentLoaderArgs)?e.config.tweaks.segmentLoaderArgs:{maxRetries:e.settings.MAX_CDN_RETRIES,requestType:s(t),disableDownloadTimeout:!0,resetRetriesWhenOffline:!0}}function s(e){return o.MimeTypeHelper.isVideo(e)?r.HttpRequestType.MEDIA_VIDEO:o.MimeTypeHelper.isAudio(e)?r.HttpRequestType.MEDIA_AUDIO:o.MimeTypeHelper.isSubtitle(e)?r.HttpRequestType.MEDIA_SUBTITLES:o.MimeTypeHelper.isUnknown(e)?r.HttpRequestType.INTERNAL:r.HttpRequestType.UNKNOWN}function u(e,t){var i,r=null===(i=e.config.tweaks)||void 0===i?void 0:i.segmentLoader;return r&&"function"==typeof r?new r(t):new n.DefaultContentLoader(e,t)}t.getLoaderConfig=a,t.getLoader=u},35675:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentInfoErrors=void 0;var i=function(){function e(){}return e.PERIOD_COMPLETE={code:"PERIOD_COMPLETE"},e.PERIOD_DROPPED_OUT={code:"PERIOD_DROPPED_OUT"},e}();t.SegmentInfoErrors=i},46101:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.MPDHandlerFactory=void 0;var n=i(59534),r=i(43068),o=i(83024),a=i(59266),s=function(){function e(){}return e.createInstance=function(e,t,i,r,o){void 0===r&&(r="0");var a=e.serviceManager.get(n.ServiceName.ManifestService,e.sourceContext.sourceIdentifier);if(!(null==a?void 0:a.hasAdaptationSets(r)))return null;var s=a.findAdaptationSet(r,t,o);if(!s)return e.logger.debug("Did not find adaptation set for mime type [".concat(t,"] in period ").concat(r)),null;var l=s.Representation&&s.Representation[0],p=l&&l.SegmentTemplate?l.SegmentTemplate:s.SegmentTemplate;return a.isSmoothManifest()?u(e,t,i,p):a.isHlsManifest()?d(e,l):c(e,p,l)},e}();function u(e,t,i,n){return n?new(r.ModuleManager.get(o.ModuleName.Smooth).createSmoothSegmentTemplateMPDHandler())(e,t,i):null}function d(e,t){return t.SegmentList?new a.SegmentListMPDHandler(e):null}function c(e,t,i){var n=r.ModuleManager.get(o.ModuleName.DASH);return t&&t[0].SegmentTimeline?new n.SegmentTimelineMPDHandler(e):t?new n.SegmentTemplateMPDHandler(e):i.SegmentList?new a.SegmentListMPDHandler(e):i.SegmentBase?new n.SegmentBaseMPDHandler(e):null}t.MPDHandlerFactory=s},30790:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.areSegmentsIdentical=t.SegmentCache=void 0;var n=i(12391),r=i(93842),o=function(){function e(e){this.maxSize=Math.max(0,e),this.cache=[]}return e.prototype.contains=function(e){return this.cache.some((function(t){return a(e.getSegmentInfo(),t.getSegmentInfo())}))},e.prototype.maintainCacheSize=function(e){this.cache=0!==e?this.cache.slice(-e):[]},e.prototype.add=function(e){this.contains(e)||(this.cache.push(e),this.maintainCacheSize(this.maxSize))},e.prototype.get=function(e){return this.cache.find((function(t){return a(e,t.getSegmentInfo())}))},e.prototype.clear=function(){this.maintainCacheSize(0)},e.prototype.remove=function(e){this.cache=this.cache.filter((0,n.invert)(e))},e.prototype.getCapacity=function(){return this.maxSize},e.prototype.getCachedCount=function(){return this.cache.length},e.prototype.getCachedSegments=function(){return this.cache.slice(0)},e}();function a(e,t){return(e.isInitSegment?["url","periodId","byteRange"]:["url","periodId","byteRange","discontinuitySequenceNumber"]).every((function(i){return"object"==typeof e[i]?(0,r.compareValues)(e[i],t[i]):e[i]===t[i]}))}t.SegmentCache=o,t.areSegmentsIdentical=a},92977:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.extractContainerFormat=t.getSegmentManager=t.isSegmentOfMainStream=t.SegmentController=void 0;var r=i(36166),o=i(85739),a=i(99538),s=i(55579),u=i(59534),d=i(4529),c=i(59574),l=i(66996),p=i(47049),f=i(22221),h=i(45366),g=i(11917),m=i(82072),S=i(50163),v=i(89199),y=i(5793),T=i(43068),I=i(83024),M=i(76469),b=i(8073),P=i(43233),C=i(83576),R=i(97383),A=i(27752),E=i(67013),x=i(31998),k=i(51017),B=i(10559),L=i(53088),_=i(45110),D=i(76060),w=i(3072),O=i(12434),N=i(48287),F=i(46101),H=i(30790),U=i(79568),j=i(28910),q=i(70121),V=i(89617),z=i(26495),K=i(20931),W=9e4,G="SegmentController",Q=function(){function e(e,t,i,n,r,o,d,l){var p=this;this.context=e,this.onDataAvailableCallback=t,this.mimeType=i,this.manifestLoader=o,this.HLSModule=T.ModuleManager.get(I.ModuleName.HLS,!1),this.loadedAdaptationSetIds={},this.loadingDataSegmentInfos=[],this.periodSwitch=!1,this.isBackupStreamSwitchOngoing=!1,this.hasDownloadError=!1,this.invalidateOngoingSegmentInfoRequest=!1,this.disableDownloadCancelingForNextSegment=!1,this.onSegmentInfoError=function(e){var t;if((0,m.isContextAvailable)(p.context)){var i="Error obtaining ".concat(p.mimeType," segment info");(null===(t=p.lastSegmentInfoError)||void 0===t?void 0:t.code)===e.code?p.logger.insane(i,e):p.logger.debug(i,e),p.lastSegmentInfoError=e}},this.handleCancelLoadingError=function(e){p.logger.debug("Error in cancelLoading of segmentLoaderPool ",e)},this.getNext=function(e){var t,i,n=!(null===(t=p.segmentManager)||void 0===t?void 0:t.canLoad())||p.pendingSegmentInfoRequest||p.hasActiveTransmuxingJobs()||p.isBackupStreamSwitchOngoing;p.currentAdaptationSetId&&!n&&(null===(i=p.logger)||void 0===i||i.debug("Getting next ".concat(p.mimeType," segment for time ").concat(e)),p.hasValidSeekTarget?(p.hasJustSwitched=!1,p.hasValidSeekTarget=!1,p.getNextSegmentOfType({type:U.SegmentType.Init,periodId:p.currentPeriodId})):p.periodSwitch?(p.getNextSegmentOfType({type:U.SegmentType.Init,periodId:p.currentPeriodId}),p.periodSwitch=!1):p.getNextSegmentOfType({type:U.SegmentType.Any,periodId:p.currentPeriodId,time:e}))},this.onSegmentLoaded=function(e){var t,i;if(p.isSegmentEmpty(e))return J(e,p.sourceStore),p.logger.debug("Warning: Loaded segment has size 0 bytes, skipping further processing! May cause gap!",e.getUrl()),void(!(null===(t=e.getData())||void 0===t?void 0:t.byteLength)&&p.hlsTimelineTracker&&p.hlsTimelineTracker.reset());if(p.maybeUpdateContainerFormat(e),p.isTransmuxerRequired()){if(!T.ModuleManager.has(I.ModuleName.ContainerTS))return J(e,p.sourceStore),void p.context.eventHandler.fireError(new M.PlayerModuleMissingError(I.ModuleName.ContainerTS));(r=e.getSegmentInfo()).presentationTimeOffset&&isNaN(r.presentationTimeOffset)&&(p.mpdHandler.setTimestampOffset(0),r.presentationTimeOffset=0);var n=r.discontinuitySequenceNumber;void 0!==p.lastDiscoNumber&&n!==p.lastDiscoNumber&&p.resetTransmuxer(),p.lastDiscoNumber=n,p.transmux(e)}else{if(!p.maybeIsSmoothManifest()&&p.isInvalidMp4Segment(e))return J(e,p.sourceStore),void p.eventHandler.dispatchEvent(c.PlayerEvent.Warning,new a.PlayerWarning(s.WarningCode.PLAYBACK_INVALID_DATA_SEGMENT_ENCOUNTERED,"The loaded MP4 segment is invalid, skipping further processing! May cause gap!",{mimeType:e.getMimeType(),segmentUrl:e.getUrl()}));if(p.maybeIsHlsManifest()&&!e.isInit()&&!e.isSelfInit()&&e.getSegmentInfo().init){var r=e.getSegmentInfo(),o=null===(i=p.segmentManager)||void 0===i?void 0:i.getCachedSegment(r.init);o&&e.setInitSegment(o)}var u=!1;p.currentAdaptationSetId&&p.segmentManager&&(u=p.segmentPreProcessor.onSegmentAvailable(e,{id3:[],closedCaptions:[]},p.currentAdaptationSetId,p.segmentManager,p.hasJustSwitched,(function(e){return p.hasJustSwitched=e}))),u||J(e,p.sourceStore),e.getMimeType().indexOf("mp4")>-1&&(p.isLastSegment=e.isLastSegment())}},this.onShouldDownloadBeCancelled=function(e,t){var i,n=Boolean(null===(i=p.adaptationService)||void 0===i?void 0:i.shouldDownloadBeCancelled(p.mimeType,e,t));return p.maybeIsHlsManifest()&&p.hls.possiblyDependentSegments&&n?(p.logger.debug("Download should be cancelled, but this is disabled for segments not starting with key frames"),!1):n};var f=e.sourceContext.sourceIdentifier;if(this.currentPeriodId=d,this.sourceStore=l,this.manifestUpdateScheduler=e.serviceManager.get(u.ServiceName.ManifestUpdateSchedulingService,f),this.segmentUnavailabilityHandler=new E.SegmentUnavailabilityHandler(this.context),this.adaptationService=this.context.serviceManager.get(u.ServiceName.AdaptationService),this.streamTimeService=this.context.serviceManager.get(u.ServiceName.StreamTimeService),this.initSegmentStore=new N.InitSegmentStore,this.hls={isTransmuxingRequired:r&&!this.isSubtitleSegmentController,transmuxer:void 0,possiblyDependentSegments:!1,isAvMuxedTogether:!!n&&n.indexOf(",")>-1,discardNextSegment:!1,muxedAudioTrackIndex:0},this.isContainerFormatKnown()){var h=this.getContainerFormat();this.hls.isTransmuxingRequired=h.source!==h.target}this.init()}return Object.defineProperty(e.prototype,"logger",{get:function(){return this.context.logger},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"settings",{get:function(){return this.context.settings},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"config",{get:function(){return this.context.config},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"eventHandler",{get:function(){return this.context.eventHandler},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"segmentManager",{get:function(){return Z(this.context,this.mimeType,this.segmentParser,this.hls,this.currentLangObj)},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"isSubtitleSegmentController",{get:function(){return S.MimeTypeHelper.isSubtitle(this.mimeType)},enumerable:!1,configurable:!0}),e.prototype.getUserFeedbackForAdaptation=function(e){var t=this,i=this.getAdaptationEventType();if(!i)return null;var n=this.getUserSelectedRepresentation(e.representationId),r=n?this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return t.currentAdaptationSetId&&e.getRepresentation(t.currentAdaptationSetId,n)}),null,this.context.sourceContext.sourceIdentifier):null;return r?(this.logger.debug("user has overridden adaptation suggestion! suggested: ".concat(e.representationId,", user: ")+"".concat(n)),this.eventHandler.dispatchEvent(i,{representationID:r._internalId.representationId}),r._internalId):(this.eventHandler.dispatchEvent(i,{representationID:e.representationId}),null)},e.prototype.getUserSelectedRepresentation=function(e){var t,i=this.getAdaptationCallbackFn();if(!i)return null;var n=this.maybeGetAdaptationSet(this.currentAdaptationSetId),r=null!==(t=null==n?void 0:n.Representation.map((function(e){return{bandwidth:e._bandwidth,id:e._id}})))&&void 0!==t?t:[];return i({suggested:e,isAd:this.context.sourceContext.isAd,representations:r})},e.prototype.getAdaptationEventType=function(){return S.MimeTypeHelper.isAudio(this.mimeType)?c.PlayerEvent.AudioAdaptation:S.MimeTypeHelper.isVideo(this.mimeType)?c.PlayerEvent.VideoAdaptation:null},e.prototype.getAdaptationCallbackFn=function(){var e,t;return S.MimeTypeHelper.isAudio(this.mimeType)?null===(e=this.config.adaptation)||void 0===e?void 0:e.onAudioAdaptation:S.MimeTypeHelper.isVideo(this.mimeType)?null===(t=this.config.adaptation)||void 0===t?void 0:t.onVideoAdaptation:void 0},e.prototype.getPrefetchedRepresentationId=function(){var e;if(null===(e=this.context.adRestorationOptimizationService)||void 0===e?void 0:e.hasPrefetchedSegment(this.mimeType,this.lastSegmentInfo))return this.context.adRestorationOptimizationService.getRepresentationForPrefetchedSegment(this.mimeType)},e.prototype.selectRepresentation=function(e,t){var i=this.getPrefetchedRepresentationId();if(i)return i;var n=!1,r=this.sourceStore.getState();r&&(n=Boolean((0,p.getPreferredBitrate)((0,p.getAdaptationState)(r),this.mimeType)));var o=this.getSuggestedRepresentationId(e,n,t);return this.chooseRepresentationId(o)},e.prototype.chooseRepresentationId=function(e){var t,i,n=e?this.getUserFeedbackForAdaptation(e):void 0;if(n)return this.disableDownloadCancelingForNextSegment=!0,n;var r=null===(i=null===(t=this.getCurrentAdaptationSet())||void 0===t?void 0:t.Representation[0])||void 0===i?void 0:i._internalId;return e||r||this.currentRepresentationId},e.prototype.getSuggestedRepresentationId=function(e,t,i){var n,r,o;if(this.periodSwitch||!this.hasJustSwitched||void 0===this.currentRepresentationId){var a={hlsDependentSegments:this.hls.possiblyDependentSegments,segmentDuration:this.mpdHandler.getSegmentDuration(),segmentNumber:e};o=null===(n=this.adaptationService)||void 0===n?void 0:n.selectRepresentation(this.mimeType,a,null===(r=this.getCurrentAdaptationSet())||void 0===r?void 0:r.Representation)}else o=this.currentRepresentationId;return(null==i?void 0:i.periodId)===this.getCurrentPeriodId()&&!t&&(o=i),o},e.prototype.switchRepresentation=function(e){var t=this.currentRepresentationId?this.currentRepresentationId.representationId:null;this.logger.debug("switching representation from ".concat(t," to ").concat(e.representationId," (").concat(this.mimeType,")")),this.mpdHandler.setRepresentationId(e),this.currentRepresentationId=e,this.hasJustSwitched=!0},e.prototype.hasRequestedInitSegment=function(e){var t=this.context.store.getState();return!!t&&(0,h.getMetricsHistoryFromInstanceState)(t,this.mimeType,g.MetricType.CachedInitSegments).map((function(e){var t;return null===(t=null==e?void 0:e.value)||void 0===t?void 0:t.internalRepId})).filter(Boolean).some((function(t){return t.equals(e)}))},e.prototype.isInitSegmentNeeded=function(e,t,i){return e.type===U.SegmentType.Init||t||this.maybeIsHlsManifest()||!this.hasRequestedInitSegment(i)},e.prototype.invalidateOngoingRequests=function(){this.invalidateOngoingSegmentInfoRequest=!0},e.prototype.fireQualityChangeEvent=function(e,t){var i,n=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(t){return t.getRepresentationById(e)}),null,this.context.sourceContext.sourceIdentifier),r=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getRepresentationById(t)}),null,this.context.sourceContext.sourceIdentifier),o=n?(0,C.representationToQuality)(n,this.mimeType):void 0,a=r?(0,C.representationToQuality)(r,this.mimeType):void 0;if(a){var s={targetQuality:a,targetQualityId:a.id,sourceQuality:o,sourceQualityId:null!==(i=null==o?void 0:o.id)&&void 0!==i?i:null};S.MimeTypeHelper.isVideo(this.mimeType)?this.context.eventHandler.dispatchEvent(c.PlayerEvent.VideoDownloadQualityChange,s):S.MimeTypeHelper.isAudio(this.mimeType)&&this.context.eventHandler.dispatchEvent(c.PlayerEvent.AudioDownloadQualityChange,s)}},e.prototype.getSegmentInfo=function(e){var t,i=this,r=void 0!==(null===(t=this.lastSegmentInfo)||void 0===t?void 0:t.segmentNumber)?this.lastSegmentInfo.segmentNumber+1:0,o=this.selectRepresentation(r,e.recommendedRepresentationId),a=!o.equals(this.currentRepresentationId);return a&&(this.sourceStore.dispatch((0,x.setRepresentationIdAction)(o)),S.MimeTypeHelper.isAV(this.mimeType)&&this.fireQualityChangeEvent(this.currentRepresentationId,o)),this.invalidateOngoingSegmentInfoRequest=!1,this.pendingSegmentInfoRequest=this.loadRepresentationInfo(o).then((function(){return i.currentAdaptationSetId&&i.mpdHandler.setAdaptationSetId(i.currentAdaptationSetId,o),a&&i.switchRepresentation(o),i.findNextSegmentInfo(e,a,o)})).then((function(e){var t=i.currentRepresentationId||o;if(i.shouldInvalidateSegmentInfo(e))throw(0,m.isContextAvailable)(i.context)&&i.context.logger.debug("[SegmentController][".concat(i.mimeType,"] invalidating ongoing SegmentInfo request for"),n({},e)),"ongoing segment info request was invalidated";return i.addSegmentInfos(e,r,t),i.lastSegmentInfo=e,e})).catch((function(t){i.pendingSegmentInfoRequest=void 0;var r=i.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getRepresentationById(o)}),null,i.context.sourceContext.sourceIdentifier);if(r&&i.sourceStore.dispatch((0,B.setRepresentationFailedDownloadAction)(r._internalId)),t===l.M3u8Error.COULD_NOT_LOAD){i.logger.debug("HLS playlist loading failed for representation ".concat(o.representationId," (").concat(t,")"));var a=i.maybeGetAdaptationSet(i.currentAdaptationSetId),s=null==a?void 0:a.Representation.find((function(e){return!e.hasFailedToLoad}));if(s)return i.getSegmentInfo(n(n({},e),{recommendedRepresentationId:s._internalId}))}throw t})).finally((function(){i.expectedTargetTimeAfterSeek=void 0})),this.pendingSegmentInfoRequest},e.prototype.shouldInvalidateSegmentInfo=function(e){return this.invalidateOngoingSegmentInfoRequest&&e&&!e.isInitSegment&&!this.isSegmentInfoInExpectedTimeRange(e)},e.prototype.isSegmentInfoInExpectedTimeRange=function(e){return void 0!==this.expectedTargetTimeAfterSeek&&(0,v.isNumber)(e.startTime)&&(0,v.isNumber)(e.duration)&&this.expectedTargetTimeAfterSeek>=e.startTime&&this.expectedTargetTimeAfterSeek<=e.startTime+e.duration},e.prototype.getInitSegmentInfo=function(){var e={type:U.SegmentType.Init,periodId:this.currentPeriodId};return this.currentRepresentationId&&this.currentRepresentationId.periodId===this.getCurrentPeriodId()?this.getSegmentInfo(n(n({},e),{recommendedRepresentationId:this.currentRepresentationId})):this.getSegmentInfo(e)},e.prototype.getDataSegmentInfo=function(e){var t={type:U.SegmentType.Data,periodId:this.currentPeriodId,time:e};return this.currentRepresentationId&&this.currentRepresentationId.periodId===this.getCurrentPeriodId()?this.getSegmentInfo(n(n({},t),{recommendedRepresentationId:this.currentRepresentationId})):this.getSegmentInfo(t)},e.prototype.needToLoadInitSegment=function(e,t,i,n){var r=!this.isTransmuxerRequired()&&!this.maybeIsSmoothManifest()&&!this.isSubtitleSegmentController;return e&&(r=this.isInitSegmentNeeded(t,i,n))&&this.maybeIsHlsManifest()&&(r=Boolean(this.segmentManager&&!this.segmentManager.hasCachedSegment(e))),r&&t.type!==U.SegmentType.Data},e.prototype.findNextSegmentInfo=function(e,t,i){var r=this,o=this.mpdHandler.getInitSegmentInfo(i),a=this.needToLoadInitSegment(o,e,t,i);return a&&o?Promise.resolve(o):this.mpdHandler.getNextSegmentInfo(e.time).then((function(s){return o=s.init&&n(n({},s.init),{isInitSegment:!0}),(a=r.needToLoadInitSegment(o,e,t,i))&&o?(r.mpdHandler.rewindOneSegment(),o):s}))},e.prototype.addSegmentInfos=function(e,t,i){var n=this;if(e){var r=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getRepresentationById(i)}),null,this.context.sourceContext.sourceIdentifier);if(r)if(e.representationId=i.representationId,e.internalRepresentationId=i,e.mimeType=this.mimeType,e.bitrate=r._bandwidth,e.periodId=i.periodId,e.codecs=this.getCodecs(),S.MimeTypeHelper.isAudio(this.mimeType))e.sampleRate=r._audioSamplingRate,e.width=void 0,e.height=void 0;else if(S.MimeTypeHelper.isVideo(this.mimeType)&&(e.width=r._width,e.height=r._height,e.frameRate=r._frameRate,!e.dateTime&&this.settings.AKAMAI_DATETIME_PARSING&&this.HLSModule)){var o=null!=e.duration?this.HLSModule.PlaylistUtils.getProgramDateTimeFromSegmentUrl(e.url,e.duration):void 0;o&&(e.dateTime=o)}var a=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return n.currentAdaptationSetId&&e.getLowestBandwidthOfAdaptationSet(n.currentAdaptationSetId)}),null,this.context.sourceContext.sourceIdentifier);null!=e.bitrate&&isFinite(e.bitrate)&&e.bitrate===a&&(e.preventDownloadCanceling=!0);var s=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getAvailableBaseURLsForRepresentation(i)}),void 0,this.context.sourceContext.sourceIdentifier);e.availableBaseURLs=s,e.firstUsedBaseURLIndex=0,this.lastSegmentInfo&&this.lastSegmentInfo.lastUsedBaseURLIndex&&(e.firstUsedBaseURLIndex=this.lastSegmentInfo.lastUsedBaseURLIndex),e.lastUsedBaseURLIndex=e.firstUsedBaseURLIndex,e.duration||e.isInitSegment||(e.duration=this.mpdHandler.getSegmentDuration()),(void 0===e.segmentNumber||isNaN(e.segmentNumber))&&(e.segmentNumber=t),this.maybeIsHlsManifest()?(e.baseURL="",e.mediaURL||(e.mediaURL=e.url)):(e.baseURL=s[e.firstUsedBaseURLIndex],e.mediaURL=e.mediaURL||e.url,delete e.url),e.url=y.URLHelper.concatBaseUrlWithPartial(e.baseURL,e.mediaURL),e.discardData=this.hls.discardNextSegment,this.hls.discardNextSegment=!1,this.disableDownloadCancelingForNextSegment&&(e.preventDownloadCanceling=!0,this.disableDownloadCancelingForNextSegment=!1),e.isTransmuxingRequired=this.isTransmuxerRequired()}},e.prototype.loadRepresentationInfo=function(e){var t=this;return this.manifestUpdateScheduler?this.manifestUpdateScheduler.waitForRepUpdate(e).then((function(){return t.mpdHandler.updateRepresentation(e)})):Promise.reject("ManifestUpdateScheduler does not exist.")},e.prototype.isTransmuxing=function(){var e;return this.isTransmuxerRequired()&&Boolean(null===(e=this.hls.transmuxer)||void 0===e?void 0:e.isTransmuxing())},e.prototype.hasActiveTransmuxingJobs=function(){var e;return this.isTransmuxerRequired()&&Boolean(null===(e=this.hls.transmuxer)||void 0===e?void 0:e.hasActiveJobs())},e.prototype.cancelTransmuxing=function(){var e=this;this.hls.transmuxer&&this.isTransmuxing()&&this.hls.transmuxer.discardCurrentJobs().forEach((function(t){return J(t.mp2tsSegment,e.sourceStore)}))},e.prototype.cancelLoading=function(){var e;this.invalidateOngoingSegmentInfoRequest=!0,null===(e=this.segmentManager)||void 0===e||e.cancel().catch(this.handleCancelLoadingError)},e.prototype.seekTo=function(e){var t=this;null!==e&&this.currentAdaptationSetId&&(this.cancelLoading(),this.cancelTransmuxing(),this.loadingDataSegmentInfos=[],this.hasDownloadError=!1,this.isLastSegment=!1,this.hlsTimelineTracker&&this.hlsTimelineTracker.reset(),this.isTransmuxerRequired()&&this.hls.transmuxer&&this.hls.transmuxer.resetCaptionParser(),e>=0&&(this.hasValidSeekTarget=!0,this.expectedTargetTimeAfterSeek=e,this.mpdHandler.seekTo(e))),this.pendingSegmentInfoRequest&&(0,v.isNumber)(e)&&this.pendingSegmentInfoRequest.catch((function(e){return t.logger.debug("Error during getting a segment info",e)})).then((function(){return t.seekTo(e)}))},e.prototype.getNextSegmentOfType=function(e){var t=this;this.getSegmentInfo(e).then((function(e){return t.loadFromSegmentInfo(e)})).catch(this.onSegmentInfoError)},e.prototype.hasNextVod=function(e){var t,i,n=this;if(this.hasDownloadError)return this.currentRepresentationId!==(null===(t=this.adaptationService)||void 0===t?void 0:t.selectRepresentation(this.mimeType))&&(this.mpdHandler.rewindOneSegment(),this.hasDownloadError=!1,this.hasJustSwitched=!1,!0);var r=this.maybeFindPeriod(this.currentPeriodId),o=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getMediaPresentationDuration()}),0,this.context.sourceContext.sourceIdentifier);if(r&&r.hasOwnProperty("_duration"))i=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getPeriodDuration(n.currentPeriodId)}),void 0,this.context.sourceContext.sourceIdentifier);else{if(0===o)return!1;i=o}return this.mpdHandler.hasNext(i)},e.prototype.hasNextLive=function(e){var t,i=this;if(this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isAvailabilityEndTimeExceeded()}),!1,this.context.sourceContext.sourceIdentifier))return this.logger.log("Stream (".concat(this.mimeType,") availability end time reached, stopping download of further segments.")),this.isLastSegment=!0,!1;this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isLastPeriod(i.currentPeriodId)}),!1,this.context.sourceContext.sourceIdentifier)&&this.mpdHandler.resolvePendingSegmentInfoRequests(),this.hasDownloadError&&this.currentRepresentationId!==(null===(t=this.adaptationService)||void 0===t?void 0:t.selectRepresentation(this.mimeType))&&(this.mpdHandler.rewindOneSegment(),this.hasDownloadError=!1,this.hasJustSwitched=!1);var n=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getPeriodDuration(i.currentPeriodId)}),void 0,this.context.sourceContext.sourceIdentifier);return this.mpdHandler.hasNext(n)},e.prototype.hasNext=function(e){var t=this,i=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isLastPeriod(t.currentPeriodId)}),!1,this.context.sourceContext.sourceIdentifier);return!(this.isLastSegment&&i||!this.currentAdaptationSetId||!this.mpdHandler)&&(this.maybeIsLive()?this.hasNextLive(e):this.hasNextVod(e))},e.prototype.onTransmuxed=function(e){var t=this;if(e.transmuxedSegments.every((function(e){return null!==e.getCodec()}))){!this.hls.possiblyDependentSegments&&ee(e)&&(this.logger.debug("Encountered HLS segment not starting with a key frame"),this.hls.possiblyDependentSegments=!0);var i=e.transmuxedSegments.find((function(e){return"video/mp4"===e.getMimeType()})),n=e.transmuxedSegments.filter((function(e){return"audio/mp4"===e.getMimeType()})),r=[i,n[this.hls.muxedAudioTrackIndex]||n[0]].filter((function(e){return Boolean(e)}));r.forEach((function(e){return t.timestampOffsetService.maybeAdjustTimestampOffsetAtDiscontinuityChange(e,t.mpdHandler)})),this.segmentManager&&this.currentAdaptationSetId&&this.segmentPreProcessor.cacheOrCallOnSegmentAvailable(e,r,this.currentAdaptationSetId,this.segmentManager,this.hasJustSwitched,(function(e){return t.hasJustSwitched=e}));var o=r[r.length-1];o&&o.getMimeType().indexOf("mp4")>-1&&(this.isLastSegment=o.isLastSegment()),this.logger.debug("Transmuxing done",e.originalSegment.getUrl())}else{var a=e.originalSegment.getUrl();this.logger.debug("Discarding muxing because codecs were not available in the segment: ".concat(a))}},e.prototype.hasPendingSegments=function(e){var t,i;return e?(t=this.isTransmuxerRequired()&&this.hls.transmuxer&&this.hls.transmuxer.isTransmuxingSegmentsForPeriod(e),i=this.segmentManager.isLoading(e)):(t=this.isTransmuxing(),i=this.segmentManager.isLoading()),i||t||Boolean(this.pendingSegmentInfoRequest)},e.prototype.transmux=function(e){var t=this;if(this.hls.transmuxer){if(!this.hls.transmuxer.isInitialBaseMediaDecodeTimeSet()){void 0===e.getSegmentInfo().startTime&&this.sourceStore.dispatch(this.HLSModule.actions.dropSegmentStartTimes()),(0,O.initializeHlsSegmentStartTimes)(e,this.context,this.mpdHandler);var i=e.getSegmentInfo();if(null!=i.startTime){var n=Math.round(i.startTime*W);this.logger.debug("Setting initial BaseMediaDecodeTime at transmuxer to ".concat(n/W)+" (".concat(n,")")),this.hls.transmuxer.setBaseMediaDecodeTime(n)}}this.hls.transmuxer.transmuxSegment(e).then((function(e){return t.onTransmuxed(e)})).catch((function(i){J(e,t.sourceStore),t.eventHandler.dispatchEvent(c.PlayerEvent.Warning,new a.PlayerWarning(s.WarningCode.PLAYBACK_INVALID_DATA_SEGMENT_ENCOUNTERED,"Transmuxing failed: ".concat(i),{mimeType:e.getMimeType(),segmentUrl:e.getUrl()}))}))}},e.prototype.maybeUpdateContainerFormat=function(e){var t;if(!this.isContainerFormatKnown()){var i=(0,w.resolveContainerFormat)(this.mimeType,e,this.maybeIsHlsManifest());this.logger.debug("Container format for ".concat(this.mimeType," is ").concat(null==i?void 0:i.source)),i&&this.sourceStore.dispatch((0,x.setContainerFormatAction)(e.getRepresentationId(),i)),this.hls.isTransmuxingRequired=Boolean(i&&i.source!==i.target),!this.hls.isTransmuxingRequired&&S.MimeTypeHelper.isAV(this.mimeType)&&(null===(t=this.hls.transmuxer)||void 0===t||t.dispose(),this.context.serviceManager.maybeCall(u.ServiceName.SubtitleService,(function(e){e.setTransmuxer(void 0)})))}},e.prototype.isSegmentEmpty=function(e){var t=e.getData();return!!(t&&t.byteLength<1)},e.prototype.isInvalidMp4Segment=function(e){if(!T.ModuleManager.has(I.ModuleName.ContainerMP4))return!1;var t=T.ModuleManager.get(I.ModuleName.ContainerMP4,!1),i=t.isValidMp4,n=t.MP4Parser,r=this.segmentParser instanceof n;return this.context.settings.DROP_INVALID_SEGMENTS&&r&&!i(e)},e.prototype.getContainerFormat=function(){var e=this.sourceStore.getState();return e&&(0,k.getContainerFormat)(e,S.MimeTypeHelper.getMediaType(this.mimeType))},e.prototype.isContainerFormatKnown=function(){return Boolean(this.getContainerFormat())},e.prototype.loadFromSegmentInfo=function(e){return this.pendingSegmentInfoRequest=void 0,e?(e.isInitSegment||this.loadingDataSegmentInfos.push(e),this.lastSegmentInfoError=void 0,this.logger.debug("Loading ".concat(JSON.stringify(e))),this.loadSegment(e)):Promise.resolve()},e.prototype.loadSegment=function(e){var t=this;return this.segmentManager?this.segmentManager.getSegment(e).then((function(e){return t.extractSegmentFromStream(e)})).catch((function(i){return t.handleSegmentLoadingError(i,e)})):Promise.reject()},e.prototype.extractSegmentFromStream=function(e){var t=this;e.transform((function(e){Y(e.getSegmentInfo(),t.loadingDataSegmentInfos),t.onSegmentLoaded(e)}),(function(){}),(function(e){return t.logger.debug("Error loading segment",e),e.message}))},e.prototype.handleSegmentLoadingError=function(e,t){if(e.reason===V.SegmentLoadingErrorReason.CANCEL)this.onDownloadCancelled(t);else if(e.reason===V.SegmentLoadingErrorReason.ERROR_LOADING){var i=e.info?e.info.response.status:0;this.handleDownloadError(i,t)}else e.reason===V.SegmentLoadingErrorReason.ERROR_DECRYPTING?(this.logger.debug("Could not decrypt segment",t.url),this.eventHandler.dispatchEvent(c.PlayerEvent.Warning,new a.PlayerWarning(s.WarningCode.DRM_COULD_NOT_DECRYPT_SEGMENT))):this.logger.debug("Unexpected ERROR occurred when loading segment!",t.url)},e.prototype.switchToHlsBackupStream=function(e){var t=this;return this.HLSModule&&this.manifestLoader instanceof this.HLSModule.M3u8Loader&&this.manifestLoader.hasBackupStreams(e)?this.manifestLoader.switchToBackupStream(e).then((function(){return!0})).catch((function(e){return t.logger.debug("Switching to HLS backup stream failed",e),Promise.resolve(!1)})):Promise.resolve(!1)},e.prototype.getFailedSegmentIndex=function(){var e=this.settings.CHUNKED_CMAF_STREAMING?1:this.loadingDataSegmentInfos.length;return this.mpdHandler.getIndex()-e},e.prototype.handleDownloadError=function(e,t){this.segmentUnavailabilityHandler.shouldTryAlternatives(e)?this.tryToFindAValidSegment(t,e):(this.storeFailedDownloadRange(t),this.hasDownloadError=!0)},e.prototype.tryToFindAValidSegment=function(e,t){var i=this;if(this.currentRepresentationId&&this.currentRepresentationId.equals(e.internalRepresentationId)){var n=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return i.currentAdaptationSetId&&e.getRepresentation(i.currentAdaptationSetId,i.currentRepresentationId.representationId)}),null,this.context.sourceContext.sourceIdentifier);if(n){var r=!1;this.isBackupStreamSwitchOngoing=!0,this.switchToHlsBackupStream(n).then((function(e){return r=e})).finally((function(){return i.isBackupStreamSwitchOngoing=!1})).then((function(){var e;return null===(e=i.segmentManager)||void 0===e?void 0:e.cancel()})).then((function(){return i.tryToRecoverWithValidSegment(r,e,t)}))}}else this.logger.debug("Ignoring download error of previous representation.")},e.prototype.tryToRecoverWithValidSegment=function(e,t,i){var n,r,o,a=this,s=this.getFailedSegmentIndex();if(this.loadingDataSegmentInfos=[],e)this.mpdHandler.setIndex(Math.max(0,s));else if(o=this.segmentUnavailabilityHandler.switchBaseURL(t))this.loadFromSegmentInfo(o);else{var u=null;if(null===(n=this.adaptationService)||void 0===n?void 0:n.isAuto(this.mimeType)){var d=null===(r=this.maybeGetAdaptationSet(this.currentAdaptationSetId))||void 0===r?void 0:r.Representation;u=this.segmentUnavailabilityHandler.switchQuality(null!=d?d:[],this.currentRepresentationId)}if(u){if(this.streamTimeService){var c=this.streamTimeService.getTimeForNextSegment((0,D.getTrackIdentifier)(t));this.getSegmentInfo({type:U.SegmentType.Any,recommendedRepresentationId:u,time:c}).then((function(e){return a.loadFromSegmentInfo(e)}))}}else this.hasDownloadError=!0,this.handleFailedSegmentDownload(t,i)}},e.prototype.handleFailedSegmentDownload=function(e,t){this.storeFailedDownloadRange(e),this.maybeIsLive()?(this.logger.debug("Could not load current segment of any quality from any CDN (all retries failed), skipping it..."),this.continueWithNextSegment(e)):(0,j.throwDownloadError)(this.context,"Segment not available at any quality or location",t,e)},e.prototype.storeFailedDownloadRange=function(e){var t=(0,q.getSegmentInfoTimeRange)(e);t&&(0,m.isContextAvailable)(this.context)&&e.mimeType&&this.context.store.dispatch((0,_.addStreamTimeRange)((0,D.getTrackIdentifier)(e),t,D.StreamTimeRangeType.Failed))},e.prototype.continueWithNextSegment=function(e){this.segmentUnavailabilityHandler.downloadSuccess(!1),e.hasDownloadFailed=!0,null!=e.startTime&&null!=e.duration&&this.getNext(e.startTime+e.duration)},e.prototype.onDownloadCancelled=function(e){var t,i=this;(0,m.isContextAvailable)(this.context)&&(this.logger.debug("Download took too long, cancelled it."),this.hasJustSwitched=!1,!e.isInitSegment&&this.mpdHandler&&(null===(t=this.segmentManager)||void 0===t||t.cancel().then((function(){if(i.mpdHandler){var e=i.getFailedSegmentIndex();i.loadingDataSegmentInfos=[],i.logger.debug("Trying to get the same segment with a lower bitrate."),i.mpdHandler.setIndex(Math.max(0,e))}}))))},e.prototype.findAdaptationSetId=function(e,t,i){var n=this;if(void 0===i&&(i=!1),this.isSubtitleSegmentController&&!(null==t?void 0:t.id))return this.currentLangObj=t,void(this.segmentManager&&this.cancelLoading());var r=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(r){return r.findAdaptationSet(e,n.mimeType,t,i)}),null,this.context.sourceContext.sourceIdentifier);return r?(this.currentLangObj=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getLangObjectFromAdaptationSet(r,n.mimeType)}),void 0,this.context.sourceContext.sourceIdentifier),r._internalId):void 0},e.prototype.getCurrentAdaptationSet=function(){return this.maybeGetAdaptationSet(this.currentAdaptationSetId)},e.prototype.getAdaptationSetForPeriodId=function(e){return this.maybeGetAdaptationSet(this.loadedAdaptationSetIds[e])||this.getCurrentAdaptationSet()},e.prototype.updateMpd=function(){var e;this.logger.debug("Caught a MPD update event");var t=!this.maybeFindPeriod(this.currentPeriodId);for(var i in this.currentAdaptationSetId=this.findAdaptationSetId(this.currentPeriodId,this.currentLangObj,!1),!t&&this.currentAdaptationSetId&&(this.loadedAdaptationSetIds[this.currentPeriodId]=this.currentAdaptationSetId,null===(e=this.adaptationService)||void 0===e||e.setAdaptationSetId(this.mimeType,this.currentAdaptationSetId),this.mpdHandler.setAdaptationSetId(this.currentAdaptationSetId,this.currentRepresentationId,{isPeriodSwitch:!1,isManifestUpdate:!0})),this.loadedAdaptationSetIds){this.maybeFindPeriod(i)||delete this.loadedAdaptationSetIds[i]}},e.prototype.activateSubtitleSegmentController=function(e){var t;this.isSubtitleSegmentController&&(this.currentAdaptationSetId&&(this.mpdHandler.setAdaptationSetId(this.currentAdaptationSetId),null===(t=this.adaptationService)||void 0===t||t.setAdaptationSetId(this.mimeType,this.currentAdaptationSetId)),isNaN(this.mpdHandler.getTimestampOffset())&&this.mpdHandler.setTimestampOffset(0),this.seekTo(e))},e.prototype.setCurrentLangObj=function(e){var t;if(this.hls.isAvMuxedTogether&&S.MimeTypeHelper.isVideo(this.mimeType)){var i=this.maybeGetAdaptationSet(this.currentAdaptationSetId);if(null==i?void 0:i.ContentComponent){var n=i.ContentComponent.find((function(t){return"audio"===t._contentType&&t._id===e.id}));if(n)return this.hls.muxedAudioTrackIndex=i.ContentComponent.filter((function(e){return"audio"===e._contentType})).indexOf(n),void(this.currentLangObj=e)}}e.id!==(null===(t=this.currentLangObj)||void 0===t?void 0:t.id)&&this.switchAdaptationSetId(e)},e.prototype.switchAdaptationSetId=function(e){var t=this.currentAdaptationSetId;if(this.currentAdaptationSetId&&this.sourceStore.dispatch((0,x.removeActiveTrackAction)(this.currentAdaptationSetId)),this.currentAdaptationSetId=this.findAdaptationSetId(this.currentPeriodId,e),this.currentAdaptationSetId){var i=this.maybeGetAdaptationSet(this.currentAdaptationSetId);i&&this.sourceStore.dispatch((0,x.setMediaTypeAction)(i._internalId,(0,R.resolveMediaTypes)(i))),this.loadedAdaptationSetIds[this.currentPeriodId]=this.currentAdaptationSetId,t&&!this.currentAdaptationSetId.equals(t)&&this.switchDependentToNewLanguageObject(e)}},e.prototype.switchDependentToNewLanguageObject=function(e){var t;this.currentLangObj=e,this.previousExplicitlySetLangObj=e,this.logger.debug("".concat(G,"[").concat(this.mimeType,"]: Trying to set language to ID ").concat(this.currentLangObj.id)+" (lang: ".concat(this.currentLangObj.lang,") for mpd handler and adaption handler")),this.currentAdaptationSetId&&(this.mpdHandler.setAdaptationSetId(this.currentAdaptationSetId),null===(t=this.adaptationService)||void 0===t||t.setAdaptationSetId(this.mimeType,this.currentAdaptationSetId))},e.prototype.getCurrentLangObj=function(){return this.currentLangObj},e.prototype.stop=function(){var e,t;this.cancelLoading(),null===(e=this.segmentManager)||void 0===e||e.clearCache(),null===(t=this.adaptationService)||void 0===t||t.shutdown(this.mimeType)},e.prototype.init=function(){var e,t=this,i=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getFirstPeriod()}),void 0,this.context.sourceContext.sourceIdentifier);!this.currentPeriodId&&i&&(this.currentPeriodId=i._id);var n=F.MPDHandlerFactory.createInstance(this.context,this.mimeType,this.manifestLoader,this.currentPeriodId);if(n){this.mpdHandler=n;var a,s=$(this.mimeType);s&&(a=(0,A.createSegmentParser)(this.context,s)),a?this.segmentParser=a:this.logger.debug("Could not create segment parser for mime type ".concat(this.mimeType)),this.timestampOffsetService=new K.TimestampOffsetService(this.context,this.mimeType),this.segmentPreProcessor=new z.SegmentPreProcessor(this.context,this.mimeType,this.onDataAvailableCallback,this.hls,this.initSegmentStore,this.segmentUnavailabilityHandler,this.timestampOffsetService,this.segmentParser),this.segmentPreProcessor.setMpdHandler(this.mpdHandler),this.hasDownloadError=!1,this.currentAdaptationSetId=this.findAdaptationSetId(this.currentPeriodId,this.currentLangObj),this.currentAdaptationSetId&&(this.loadedAdaptationSetIds[this.currentPeriodId]=this.currentAdaptationSetId),this.context.serviceManager.maybeCall(u.ServiceName.SegmentService,(function(e){return e.add({mimeType:t.mimeType,shouldDownloadBeCancelledCallback:t.onShouldDownloadBeCancelled},t.segmentParser,t.currentLangObj)})),this.maybeIsHlsManifest()&&(this.hlsTimelineTracker=new this.HLSModule.HlsTimelineTracker(this.context,this.settings.GAP_TOLERANCE),this.segmentPreProcessor.setHlsTimelineTracker(this.hlsTimelineTracker)),S.MimeTypeHelper.isMP4(this.mimeType)&&this.context.serviceManager.maybeCall(u.ServiceName.SubtitleService,(function(e){e.setupCea608CaptionExtractor(t.context.logger)})),this.hasJustSwitched=!1,this.currentAdaptationSetId&&(null===(e=this.adaptationService)||void 0===e||e.setAdaptationSetId(this.mimeType,this.currentAdaptationSetId),this.mpdHandler.setAdaptationSetId(this.currentAdaptationSetId,void 0,{isPeriodSwitch:!0}),this.maybeIsLive()&&!this.settings.ENABLE_SEEK_FOR_LIVE&&this.mpdHandler.timeShift(0,this.currentPeriodId)),this.hasValidSeekTarget=!1,this.isLastSegment=!1}else this.eventHandler.fireError(new o.PlayerError(r.ErrorCode.SOURCE_MANIFEST_INVALID))},e.prototype.getSegmentInfos=function(){var e,t=this,i=null===(e=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.getAvailableBaseURLsForRepresentation(t.currentRepresentationId)}),null,this.context.sourceContext.sourceIdentifier))||void 0===e?void 0:e[0];return this.mpdHandler.getSegmentInfos(i)},e.prototype.getCurrentPeriodId=function(){return this.currentPeriodId},e.prototype.getTargetLanguageObject=function(e){var t=this;return this.previousExplicitlySetLangObj&&this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(i){return i.isLanguageAvailable(e,t.mimeType,t.previousExplicitlySetLangObj)}),!1,this.context.sourceContext.sourceIdentifier)?this.previousExplicitlySetLangObj:this.currentLangObj},e.prototype.switchPeriod=function(e){var t,i,n=this,a=this.getTargetLanguageObject(e);if(this.logger.debug("".concat(G,"[").concat(this.mimeType,"]: switching period from ").concat(this.currentPeriodId," to ").concat(e)),this.initSegmentStore.clear(),this.removeCachedSegmentsOfPrecedingPeriods(),this.currentPeriodId=e,this.currentAdaptationSetId=this.findAdaptationSetId(e,a,!0),this.currentAdaptationSetId&&(this.loadedAdaptationSetIds[e]=this.currentAdaptationSetId),this.currentAdaptationSetId){null===(t=this.adaptationService)||void 0===t||t.setAdaptationSetId(this.mimeType,this.currentAdaptationSetId);var s=this.mpdHandler.getPendingSegmentInfoRequest(),d=F.MPDHandlerFactory.createInstance(this.context,this.mimeType,this.manifestLoader,e,a);d?(this.mpdHandler.dispose(),this.mpdHandler=d):this.eventHandler.fireError(new o.PlayerError(r.ErrorCode.SOURCE_MANIFEST_INVALID)),this.segmentPreProcessor.setMpdHandler(this.mpdHandler),this.mpdHandler.setPendingSegmentInfoRequest(s),this.mpdHandler.setAdaptationSetId(this.currentAdaptationSetId,void 0,{isPeriodSwitch:!0})}if(this.isTransmuxerRequired()){var c=this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return n.currentAdaptationSetId&&e.findDownloadedHlsRepresentation(n.currentAdaptationSetId)}),null,this.context.sourceContext.sourceIdentifier);c&&this.mpdHandler.setRepresentationId(c._internalId),this.hlsTimelineTracker&&this.hlsTimelineTracker.reset(),null===(i=this.segmentManager)||void 0===i||i.clearCache(!1)}this.hasDownloadError=!1,this.isLastSegment=!1,this.periodSwitch=!0},e.prototype.getMPDHandler=function(){return this.mpdHandler},e.prototype.getIndex=function(){return this.mpdHandler&&this.mpdHandler.getIndex()||0},e.prototype.getSourceBufferTypes=function(){var e=[];return this.isTransmuxerRequired()&&this.hls.isAvMuxedTogether?(e.push("video/mp4"),e.push("audio/mp4")):e.push(this.mimeType),e},e.prototype.getCodecs=function(){var e,t=this.getCurrentAdaptationSet();return null!==(e=t&&(0,P.getCodecsFromAdaptationSet)(t))&&void 0!==e?e:void 0},e.prototype.getLiveEdgeTime=function(){return this.maybeIsLive()?this.mpdHandler.getLiveEdgeTime():-1},e.prototype.setAdaptionLogicStartupPhase=function(){var e;null===(e=this.adaptationService)||void 0===e||e.setStartupPhase(this.mimeType)},e.prototype.getMimeType=function(){return this.mimeType},e.prototype.removeCachedSegmentsOfPrecedingPeriods=function(){var e=this,t=this.context.store.getState(),i=t?(0,h.getMetricsState)(t):void 0;if(this.segmentManager&&i){var n=this.sourceStore.getState(),r=n?(0,L.getPlayingPeriodId)(n):void 0;this.segmentManager.removeCachedInitSegments((function(t){return e.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isPrecedingPeriod(r,t.getPeriodId())}),!1,e.context.sourceContext.sourceIdentifier)})),((0,h.getMetricsHistory)(i,this.mimeType,g.MetricType.CachedInitSegments)||[]).filter((function(t){var i=t.value.internalRepId.periodId;return e.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isPrecedingPeriod(r,i)}),!1,e.context.sourceContext.sourceIdentifier)})).forEach((function(t){return e.context.store.dispatch((0,f.removeMetricsValue)(e.mimeType,g.MetricType.CachedInitSegments,t))}))}},e.prototype.canLoad=function(){var e;return Boolean(null===(e=this.segmentManager)||void 0===e?void 0:e.canLoad())},e.prototype.isTransmuxerRequired=function(){return this.hls.isTransmuxingRequired},e.prototype.setTransmuxer=function(e){this.hls.transmuxer=e},e.prototype.getTransmuxer=function(){return this.hls.transmuxer},e.prototype.resetTransmuxer=function(){this.hls.transmuxer&&this.hls.transmuxer.reset()},e.prototype.maybeIsHlsManifest=function(){return this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isHlsManifest()}),!1,this.context.sourceContext.sourceIdentifier)},e.prototype.maybeIsSmoothManifest=function(){return this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isSmoothManifest()}),!1,this.context.sourceContext.sourceIdentifier)},e.prototype.maybeIsLive=function(){return this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(e){return e.isLive()}),!1,this.context.sourceContext.sourceIdentifier)},e.prototype.maybeFindPeriod=function(e){return this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(t){return t.findPeriod(e)}),null,this.context.sourceContext.sourceIdentifier)},e.prototype.maybeGetAdaptationSet=function(e){return this.context.serviceManager.maybeCall(u.ServiceName.ManifestService,(function(t){return t.getAdaptationSet(e)}),null,this.context.sourceContext.sourceIdentifier)},e.prototype.dispose=function(){var e,t;(0,d.dispose)(this.mpdHandler),(0,d.dispose)(this.timestampOffsetService),(0,d.dispose)(this.segmentPreProcessor),(0,d.dispose)(this.initSegmentStore),null===(e=this.adaptationService)||void 0===e||e.release(this.mimeType),this.hlsTimelineTracker&&this.hlsTimelineTracker.dispose(),(0,m.isContextAvailable)(this.context)&&(null===(t=this.context.serviceManager.get(u.ServiceName.SegmentService))||void 0===t||t.disposeOfType(this.mimeType,this.currentLangObj))},e}();function Y(e,t){var i=t.findIndex((function(t){return(0,H.areSegmentsIdentical)(t,e)}));i>-1&&t.splice(i,1)}function J(e,t){var i=(0,q.getSegmentInfoTimeRange)(e.getSegmentInfo());i&&t.dispatch((0,_.removeStreamTimeRange)((0,D.getTrackIdentifier)(e.getSegmentInfo()),i,D.StreamTimeRangeType.Loading))}function X(e,t){return!t.isAvMuxedTogether||S.MimeTypeHelper.isVideo(e.getMimeType())}function Z(e,t,i,n,r){var o=e.serviceManager.get(u.ServiceName.AdaptationService),a=e.serviceManager.get(u.ServiceName.ManifestService,e.sourceContext.sourceIdentifier),s=function(i,r){var s=Boolean(null==o?void 0:o.shouldDownloadBeCancelled(t,i,r));return(null==a?void 0:a.isHlsManifest())&&n.possiblyDependentSegments&&s?(e.logger.debug("Download should be cancelled, but this is disabled for segments not starting with key frames"),!1):s};return e.serviceManager.maybeCall(u.ServiceName.SegmentService,(function(e){return e.add({mimeType:t,shouldDownloadBeCancelledCallback:s},i,r)}))}function $(e){var t=e.split("/")[1].toLowerCase();return Object.values(b.ContainerFormat).find((function(e){return e===t}))}function ee(e){return e.transmuxedSegments.some((function(e){return S.MimeTypeHelper.isAV(e.getMimeType())&&!e.isIndependentlyDecodable()}))}t.SegmentController=Q,t.isSegmentOfMainStream=X,t.getSegmentManager=Z,t.extractContainerFormat=$},79568:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentType=void 0,function(e){e.Init="init",e.Data="data",e.Any="any"}(t.SegmentType||(t.SegmentType={}))},28910:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.throwDownloadError=void 0;var n=i(36166),r=i(85739),o=i(99538),a=i(55579),s=i(59574),u=i(49520);function d(e,t,i,n){e.eventHandler.dispatchEvent(s.PlayerEvent.Warning,new o.PlayerWarning(a.WarningCode.PLAYBACK_DECODE_RETRIES_EXCEEDED)),e.eventHandler.fireError(c(e,t,i,n))}function c(e,t,i,o){if(0===i)return t&&t===u.RequestError.TimedOut?new r.PlayerError(n.ErrorCode.NETWORK_SEGMENT_DOWNLOAD_TIMEOUT,{segmentUrl:o.url,mimeType:o.mimeType},"Failed to load the segment: the request timed out."):new r.PlayerError(n.ErrorCode.NETWORK_ERROR,{url:o.url,statusCode:i},t);e.logger.debug(t);var a={message:t};return o.url&&(a.segment=l(o)),new r.PlayerError(n.ErrorCode.NETWORK_ERROR,a,t)}function l(e){return{url:e.url,mimeType:e.mimeType,codecs:e.codecs}}t.throwDownloadError=d},18967:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentInfoProvider=void 0;var n=i(5793),r=function(){function e(){}return e.findSegmentInfoOfRepresentation=function(t,i){if(i.SegmentList){var n=i.SegmentList[0].SegmentURL,r=t.getUrl(),o=n.find((function(t){return e.getSegmentInfoUrl(t,i)===r}));if(o)return o}return null},e.findHlsRepresentationForSegment=function(t,i){for(var n=!1,r=0;r<i.Representation.length;r++){var o=i.Representation[r],a=o.SegmentList[0].SegmentURL,s=void 0;for(s=0;s<a.length;s++){var u=a[s];if(e.getSegmentInfoUrl(u,o)===t.getUrl()){n=!0;break}}if(n)return{representation:o,index:s}}return null},e.getSegmentInfoUrl=function(e,t){var i=e._media;return n.URLHelper.isUrlAbsolute(i)||(i=n.URLHelper.concatUrlParts(t.BaseURL[0],i)),i},e}();t.SegmentInfoProvider=r},88784:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getSegmentInfoId=t.SegmentInfoService=void 0;var n=i(59534),r=i(82072),o=function(){function e(){this.segmentControllers=[]}return e.prototype.updatePlayerContext=function(e){this.context=e},e.prototype.setSegmentControllers=function(e){this.segmentControllers=e},e.prototype.getSegmentControllerMimeTypes=function(){return this.segmentControllers.map((function(e){return e.getMimeType()}))},e.prototype.getSegmentInfos=function(e,t){if(!(0,r.isContextAvailable)(this.context))return Promise.resolve([]);var i=this.context.serviceManager.get(n.ServiceName.ManifestService,this.context.sourceContext.sourceIdentifier).getPeriodIdForTime(e),o=this.segmentControllers.map((function(n){return a(n,{startTime:e,duration:t,targetPeriodId:i})}));return Promise.all(o).then((function(e){return e.flatMap((function(e){return e}))}))},e.prototype.dispose=function(){this.segmentControllers=[]},e}();function a(e,t){return e.getCurrentPeriodId()!==t.targetPeriodId&&e.switchPeriod(t.targetPeriodId),e.seekTo(t.startTime),e.getCurrentAdaptationSet()?s(e,t):Promise.resolve([])}function s(e,t){return e.getInitSegmentInfo().then((function(i){return i.isInitSegment||(t.duration-=i.duration),u(e,t.duration).then((function(e){return[i].concat(e)}))}))}function u(e,t,i){void 0===i&&(i=[]);var n=i[i.length-1],r=n?n.startTime+n.duration:0;return t<=0||!e.hasNext(r)?Promise.resolve(i):e.getDataSegmentInfo(r).then((function(n){return t-=n.duration,i.push(n),u(e,t,i)}))}function d(e){return e.url+(e.byteRange?","+JSON.stringify(e.byteRange):"")}t.SegmentInfoService=o,t.getSegmentInfoId=d},70121:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.generateSegmentId=t.getSegmentInfoTimeRange=t.createInitSegmentInfoBase=t.findSegmentIndexForTime=t.findSegmentForTime=void 0;var n=i(89199),r=i(29079);function o(e,t,i){return e[a(e,t,i)]}function a(e,t,i){var n=!e||!e.length,r=t<e[0].startTime+e[0].duration;if(n||r)return 0;var o=e.length-1;if(t>=e[o].startTime)return o;var a=Math.max(t-e[0].startTime,0),d=Math.min(Math.floor(a/i),e.length-1);return s(e[0])&&s(e[d])?u(e,t,d):null}function s(e){return e&&(0,n.isNumber)(e.startTime)}function u(e,t,i){for(var n=e.length-1;e[i].startTime>t||t>=e[i].startTime+e[i].duration;){if(t<e[i].startTime?i--:i++,i<=0)return 0;if(i>=n)return n;if(!s(e[i]))return null}return i}function d(e){var t=e._internalId;return{internalRepresentationId:t,representationId:t.representationId,periodId:t.periodId,mimeType:e._mimeType,isInitSegment:!0,downloaded:!1}}function c(e){if((null==e?void 0:e.duration)&&void 0!==(null==e?void 0:e.startTime))return{start:e.startTime,end:e.startTime+e.duration}}function l(e){var t,i,n=null!==(i=null===(t=e.discontinuitySequenceNumber)||void 0===t?void 0:t.toString())&&void 0!==i?i:e.periodId,o=e.byteRange?"-".concat(e.byteRange.start,":").concat(e.byteRange.end):"";return r.Util.hashCode("".concat(n,":").concat(e.url).concat(o))}t.findSegmentForTime=o,t.findSegmentIndexForTime=a,t.createInitSegmentInfoBase=d,t.getSegmentInfoTimeRange=c,t.generateSegmentId=l},59266:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.assignSegmentStartTimesFromHlsPlaylist=t.SegmentListMPDHandler=void 0;var r=i(59534),o=i(43587),a=i(12391),s=i(22758),u=i(80815),d=i(89199),c=i(5793),l=i(43068),p=i(83024),f=i(44578),h=i(26147),g=i(35675),m=i(70121),S=function(){function e(e){this.context=e,this.sourceContext=e.sourceContext,this.settings=e.settings,this.logger=e.logger,this.manifestService=e.serviceManager.get(r.ServiceName.ManifestService,this.sourceContext.sourceIdentifier),this.distanceToListStartSeconds=0,this.segmentListMap={},this.timestampOffset=NaN}return e.prototype.createSegmentListEntry=function(e,t){if(!e)return null;var i={isInitSegment:!1,url:e._media,downloaded:!1,startTime:e._expectedPlaybackTime,periodId:t};return["_key","_duration","_dateTime","_metadata","_byteRange","_init","_discontinuitySequenceNumber"].filter((function(t){return e.hasOwnProperty(t)})).forEach((function(t){return i[t.substr(1)]=e[t]})),i.segmentId=(0,m.generateSegmentId)(i),i},e.prototype.removeDroppedOutSegmentsFromList=function(e,t,i){if(t.SegmentURL.length<1)return e.entries=[],void(e.totalDuration=0);for(var n=this.createSegmentListEntry(t.SegmentURL[0],i.periodId),r=0,o=0;o<e.entries.length;o++){var a=e.entries[o];if((0,f.isIdenticalSegmentInfo)(a,n))break;r+=a.duration,e.entries.splice(o,1),o--,this.manifestService.isLive()&&this.currentRepresentationId.equals(i)&&this.rewindOneSegment()}e.totalDuration-=r},e.prototype.addNewSegmentsToList=function(e,t,i){for(var n=[],r=e.entries[e.entries.length-1],o=0,a=t.SegmentURL.length-1;a>=0;a--){var s=this.createSegmentListEntry(t.SegmentURL[a],i);if(r&&(0,f.isIdenticalSegmentInfo)(r,s))break;isNaN(s.duration)&&(s.duration=e.maximumSegmentDuration),s.duration/=e.timescale,o+=s.duration,n.unshift(s)}e.totalDuration+=o,e.entries=e.entries.concat(n)},e.prototype.updateSegmentList=function(e,t){var i,n,r=t.SegmentList,o=t._internalId.representationId;e.timescale=1,e.maximumSegmentDuration=1,e.startNumber=1;for(var a=function(a){var u=r[a];u.hasOwnProperty("_duration")&&(e.maximumSegmentDuration=Number(u._duration)),["_timescale","_startNumber","_presentationTimeOffset"].filter((function(e){return u.hasOwnProperty(e)})).forEach((function(t){return e[t.substr(1)]=u[t]})),(null!==(n=null===(i=l.ModuleManager.get(p.ModuleName.DASH,!1))||void 0===i?void 0:i.initSegmentInfoSourceDetectors.isInitializationNode)&&void 0!==n?n:T)(u)?e.init=l.ModuleManager.get(p.ModuleName.DASH,!1).initSegmentInfoProviders.provideSegmentInfoFromInitializationNodeProperty(u,t):delete e.init,u.hasOwnProperty("SegmentURL")&&(s.removeDroppedOutSegmentsFromList(e,u,t._internalId),s.addNewSegmentsToList(e,u,t._internalId.periodId),s.manifestService.isHlsManifest()?I(e.entries,o,s.manifestService):s.assignSegmentStartTimesForDash(e,t._internalId))},s=this,u=0;u<r.length;u++)a(u)},e.prototype.assignSegmentStartTimesForDash=function(e,t){var i=this.getMinStartTime(t),n=0;e.entries.forEach((function(e){var t;e.startTime=i+n,n+=null!==(t=e.duration)&&void 0!==t?t:0}))},e.prototype.extrapolateStartTimesFromDiscontinuityStarts=function(e){var t=this.getSegmentListEntries(this.currentRepresentationId),i=l.ModuleManager.get(p.ModuleName.HLS).selectors,n=i.getHlsState,r=i.getDiscoSequenceTimings,o=i.getPlaylistStartTime,a=v(t,r(n(this.getSourceStateService().getState())));if(!a){var s=o(n(this.getSourceStateService().getState()),e.getRepresentationId().representationId);a={index:0,discontinuityStartTime:s},this.logger.debug("Could not find matching discontinuity start times for "+"".concat(e.getSegmentInfo().discontinuitySequenceNumber," using playlist startTime: ").concat(s))}this.logger.debug("Aligning segments of ".concat(e.getRepresentationId().representationId," to discontinuity start ")+"".concat(a.discontinuityStartTime," of ").concat(e.getSegmentInfo().discontinuitySequenceNumber)),t[a.index].startTime=a.discontinuityStartTime;for(var u=a.index-1;u>=0;u--)t[u].startTime=t[u+1].startTime-t[u+1].duration;for(u=a.index+1;u<t.length;u++)t[u].startTime=t[u-1].startTime+t[u-1].duration},e.prototype.getSourceStateService=function(){return this.context.serviceManager.get(r.ServiceName.SourceStoreService,this.context.sourceContext.sourceIdentifier)},e.prototype.getListIndexForSegmentByUrl=function(e,t){for(var i=-1,n=this.getSegmentListEntries(t),r=0;r<n.length;r++)if((0,f.isIdenticalSegmentInfo)(n[r],e)){i=r;break}return i},e.prototype.populateSegmentListMap=function(e){var t=this;this.manifestService.getAdaptationSet(e).Representation.forEach((function(e){var i=t.segmentListMap[e._internalId.key()];if(i||(i=t.initializeSegmentList(e._internalId.key())),e.hasOwnProperty("SegmentList")&&(t.updateSegmentList(i,e),l.ModuleManager.has(p.ModuleName.DASH))){var n=l.ModuleManager.get(p.ModuleName.DASH).initSegmentInfoSourceDetectors.isInitializationNode;if(!i.hasOwnProperty("init")&&e.hasOwnProperty("SegmentBase")&&e.SegmentBase&&n(e.SegmentBase[0])){var r=l.ModuleManager.get(p.ModuleName.DASH).initSegmentInfoProviders.provideSegmentInfoFromInitializationNodeProperty;i.init=r(e.SegmentBase[0],e)}}}))},e.prototype.selectNewRepresentationId=function(){var e,t,i=this,n=null===(e=this.context.serviceManager.get(r.ServiceName.SourceStoreService,this.sourceContext.sourceIdentifier).getState().activeTracks)||void 0===e?void 0:e[this.adaptationSetId.adaptationSetId];if((null===(t=null==n?void 0:n.selectedRepresentationId)||void 0===t?void 0:t.periodId)===this.adaptationSetId.periodId)return n.selectedRepresentationId;if(this.currentRepresentationId){var o=this.manifestService.getRepresentation(this.adaptationSetId,this.currentRepresentationId.representationId);if(o)return o._internalId}var a=function(e){return i.isSegmentInfoLoaded(e._internalId)};return(this.getMatchingRepresentationByBandwidth(a)||this.getMatchingRepresentationByBandwidth())._internalId},e.prototype.getMatchingRepresentationByBandwidth=function(e){return this.manifestService.getMatchingRepresentationByBandwidth(this.adaptationSetId,this.getCurrentBandwidth(),e)},e.prototype.shouldUpdateRepresentation=function(){var e=this.adaptationSetId.equals(this.currentRepresentationId),t=!this.currentRepresentationId||Boolean(this.manifestService.getRepresentationById(this.currentRepresentationId));return!this.currentRepresentationId||!e||!t},e.prototype.setAdaptationSetId=function(e){this.adaptationSetId=e,this.populateSegmentListMap(this.adaptationSetId);var t,i=this.manifestService.isLive(),n=0;this.shouldUpdateRepresentation()&&(this.currentRepresentationId=this.selectNewRepresentationId());var r=this.segmentListMap[this.currentRepresentationId.key()];if(r||(r=this.initializeSegmentList(this.currentRepresentationId.key())),r&&i&&r.entries&&r.entries.length>0){var o=r.entries.length-1;this.listIndex>o&&(n=this.listIndex-o),this.listIndex=Math.min(o,this.listIndex||0),this.listIndex=Math.max(0,this.listIndex),t=r.entries[this.listIndex]}if(this.listIndex=this.listIndex||0,i&&(this.distanceToListStartSeconds=this.getSegmentDuration()*this.settings.LIVE_SEGMENT_LIST_START_INDEX_OFFSET),i){if(t&&r){var a=this.getListIndexForSegmentByUrl(t,this.currentRepresentationId);a>=0?this.listIndex=a+n:this.reset()}else this.reset();var s=this.checkForSegmentInfoError();s?this.rejectPendingSegmentInfoRequest(s):this.resolvePendingSegmentInfoRequests()}else this.resolvePendingSegmentInfoRequests()},e.prototype.initializeSegmentList=function(e){var t={totalDuration:0,entries:[],startNumber:0,init:null,maximumSegmentDuration:1,timescale:1};return this.segmentListMap[e]=t,t},e.prototype.getCurrentBandwidth=function(){var e=0,t=this.getCurrentRepresentation();return t&&(e=t._bandwidth),e},e.prototype.checkForSegmentInfoError=function(){var e=this.manifestService.getPeriod(this.currentRepresentationId);if(Boolean(e)&&!this.hasNext()){if(e.droppedOut)return g.SegmentInfoErrors.PERIOD_DROPPED_OUT;if(!this.manifestService.isLastPeriod(this.currentRepresentationId.periodId))return g.SegmentInfoErrors.PERIOD_COMPLETE}return null},e.prototype.reset=function(){this.settings.ENABLE_SEEK_FOR_LIVE?this.listIndex=0:this.timeShift(0)},e.prototype.syncSegmentStartTimeUsingMediaSequenceNumber=function(e,t){var i,n,r,o,s=this.manifestService.getRepresentationById(e),u=this.manifestService.getRepresentationById(t),c=(0,d.isNumber)(null===(i=null==u?void 0:u._hls)||void 0===i?void 0:i.mediaSequence)&&(0,d.isNumber)(null===(n=null==s?void 0:s._hls)||void 0===n?void 0:n.mediaSequence);if(s&&u&&c){var l=(null===(r=null==u?void 0:u._hls)||void 0===r?void 0:r.mediaSequence)-(null===(o=null==s?void 0:s._hls)||void 0===o?void 0:o.mediaSequence),p=this.getSegmentListEntries(e),f=this.getSegmentListEntries(t);if(!(l>=p.length)){f[0].startTime=p[l].startTime;var h=function(e,t){(0,d.isNumber)(e.startTime)&&(0,d.isNumber)(e.duration)&&(t.startTime=e.startTime+e.duration)};(0,a.forEachFromIndex)(f,1,h)}}},e.prototype.setRepresentationId=function(e){var t=this.manifestService.getRepresentationById(e),i=this.getSegmentListEntries(this.currentRepresentationId)[this.listIndex];if(t){var n=void 0===this.currentRepresentationId,r=this.currentRepresentationId;if(this.currentRepresentationId=e,this.manifestService.isLive()&&t._hls)if(this.settings.HLS_SYNC_SEGMENT_PLAYBACK_TIME_VIA_MEDIA_SEQUENCE&&this.syncSegmentStartTimeUsingMediaSequenceNumber(r,this.currentRepresentationId),n)this.reset();else if(this.settings.HLS_SYNC_VIA_MEDIA_SEQUENCE){var o=this.manifestService.getRepresentationById(r)._hls.mediaSequence+this.listIndex;this.listIndex=o-t._hls.mediaSequence,this.listIndex=Math.max(this.listIndex,0)}else if(null!=(null==i?void 0:i.startTime)&&!isNaN(i.startTime)){var a=this.getIndexForTime(i.startTime);null===a||isNaN(a)||(this.listIndex=this.adaptListIndexToCorrectIndex(a,i.startTime))}return!0}return!1},e.prototype.adaptListIndexToCorrectIndex=function(e,t){var i=this.getSegmentListEntries(this.currentRepresentationId),n=[i[e],i[e+1]];if(e===i.length-1||n.some((function(e){return!e.startTime})))return e;var r=n.map((function(e){return Math.abs(e.startTime-t)})),o=Math.min.apply(this,r);return e+r.indexOf(o)},e.prototype.getInitSegmentInfo=function(){var e=this.getSegmentList(this.currentRepresentationId);if(null==e?void 0:e.init)return e.init.presentationTimeOffset=this.getTimestampOffset(),e.init;var t=this.getSegmentListEntries(this.currentRepresentationId);if(this.listIndex<t.length&&this.listIndex>-1){var i=n({},t[this.listIndex]);if(i.init){var r=i.init;return r.isInitSegment=!0,r}}return null},e.prototype.getNextSegmentInfo_=function(){var e=this.getSegmentListEntries(this.currentRepresentationId);if(e.length&&this.listIndex<e.length&&this.listIndex>-1){var t=e[this.listIndex];return t.isInitSegment=!1,t.presentationTimeOffset=this.getTimestampOffset(),this.listIndex++,t}return null},e.prototype.getNextSegmentInfo=function(e){var t=this.getNextSegmentInfo_();return t?Promise.resolve(t):this.queueSegmentInfoRequest()},e.prototype.getSegmentInfos=function(){var e=this,t=this.listIndex,i=this.manifestService.getTotalDuration(),n={},r=this.manifestService.getAdaptationSet(this.adaptationSetId);if(r){var o=this.getSeekableRange().end-this.getSeekableRange().start,a=r.Representation[0].BaseURL[0].url;r.Representation.forEach((function(r){var s,d,l=e.getSegmentListEntries(r._internalId),p=e.manifestService.isLive();p?(s=t-o/e.getSegmentDuration(),d=t):(s=0,d=parseInt(s+o/e.getSegmentDuration())-1);for(var f=0,h=[],g=s;g<=d;g++){var m=h.length;h[m]={};var S=void 0;if(l.length&&(S=l[m].url),"string"==typeof S){var v=c.URLHelper.concatBaseUrlWithPartial(a,S);h[m].url=c.URLHelper.appendQueryParametersToUrl(v,e.settings.QUERY_PARAMETERS)}h[m].duration=e.getSegmentDuration(),p?(f=e.settings.ENABLE_SEEK_FOR_LIVE?e.getExpectedPresentationTime(g):(0,u.toSeconds)(Date.now()-e.manifestService.getAvailabilityStartTime())-i,t++):(h[m].startTime=f,f+=h[m].duration),n[r._id]=h}}))}return n},e.prototype.getSubtitleUrl=function(){return this.manifestService.getAvailableSubtitles(this.adaptationSetId.periodId)[0].url},e.prototype.getStartNumber=function(){var e=this.getSegmentList(this.currentRepresentationId);return e?e.startNumber:1},e.prototype.getSegmentDuration=function(){var e=this,t=this.getSegmentList(this.currentRepresentationId),i=this.getSegmentListEntries(this.currentRepresentationId);if(t)return i.length>0&&(0,d.isNumber)(t.totalDuration)?t.totalDuration/i.length:t.maximumSegmentDuration;if(this.manifestService.getAdaptationSet(this.adaptationSetId)){var n=Object.keys(this.segmentListMap).map((function(t){return e.segmentListMap[t]})).find((function(e){return null!==e}));if(n)return n.maximumSegmentDuration}return 1},e.prototype.seekTo=function(e){e>-1&&(this.listIndex=this.getIndexForTime(e))},e.prototype.isSegmentInfoLoadable=function(){return!this.getCurrentPeriod().droppedOut},e.prototype.hasNext=function(){if(!this.isSegmentInfoLoaded(this.currentRepresentationId))return this.isSegmentInfoLoadable();if(this.currentRepresentationId){var e=this.listIndex<this.getSegmentListEntries(this.currentRepresentationId).length;if(this.manifestService.isHlsManifest()){if(this.manifestService.isLastPeriod(this.currentRepresentationId.periodId)){var t=l.ModuleManager.get(p.ModuleName.HLS).selectors,i=t.getHlsState,n=(0,t.getEndlist)(i(this.getSourceStateService().getState()));return!n||e&&n}return e}return e}return!0},e.prototype.setTimestampOffset=function(e,t){void 0===t&&(t=1),this.timestampOffset=e/t},e.prototype.getTimestampOffset=function(){if(!isNaN(this.timestampOffset))return this.timestampOffset;var e=this.getCurrentPeriod(),t=0;if(this.currentRepresentationId){var i=this.getSegmentList(this.currentRepresentationId);i&&!isNaN(i.presentationTimeOffset)&&(t=i.presentationTimeOffset/i.timescale)}return e&&!this.manifestService.isHlsManifest()&&(t-=e.start),t},e.prototype.getIndex=function(){return this.listIndex},e.prototype.setIndex=function(e){if("number"==typeof e)return e<0?(this.logger.debug("Tried to set index at MPDHandler to value smaller 0. Setting to 0."),void(this.listIndex=0)):void(this.listIndex=e);this.logger.debug("Tried to set index at MPDHandler with parameter not being a number!")},e.prototype.queueSegmentInfoRequest=function(){var e=this;return this.pendingSegmentInfoRequest?Promise.reject("fail"):new Promise((function(t,i){e.pendingSegmentInfoRequest={resolve:t,reject:i}}))},e.prototype.resolvePendingSegmentInfoRequests=function(){if(this.pendingSegmentInfoRequest){var e=this.getNextSegmentInfo_();e?(this.pendingSegmentInfoRequest.resolve(e),this.pendingSegmentInfoRequest=null):this.manifestService.isLive()||this.hasNext()||this.pendingSegmentInfoRequest.reject("eos")}},e.prototype.rejectPendingSegmentInfoRequest=function(e){this.pendingSegmentInfoRequest&&(this.pendingSegmentInfoRequest.reject(e),this.pendingSegmentInfoRequest=null)},e.prototype.getLiveEdgeIndex=function(){var e=this.getSegmentListEntries(this.currentRepresentationId);return e.length>0?e.length-1:0},e.prototype.getIndexForOffset=function(e){for(var t,i=Math.abs(e),n=this.getSegmentDuration(),r=this.getSegmentListEntries(this.currentRepresentationId),o=this.getLiveEdgeIndex(),a=0,s=r.length-1;s>=0&&!((a+=null!==(t=r[s].duration)&&void 0!==t?t:n)>=i);s--)o--;return Math.max(0,o)},e.prototype.timeShift=function(e,t,i){if(this.manifestService.isLive()){var n=this.listIndex;this.listIndex=i&&this.hasStartTimes()?this.getIndexForTime(i):this.getIndexForOffset(e),this.logger.debug("timeShift changes index from ".concat(n," to ").concat(this.listIndex,", based on")+" offset ".concat(e," and target time ").concat(i))}},e.prototype.hasStartTimes=function(){var e,t=null===(e=this.getSegmentListEntries(this.currentRepresentationId)[0])||void 0===e?void 0:e.startTime;return(0,d.isNumber)(t)&&t>=0},e.prototype.updateRepresentation=function(e){return Promise.resolve(e)},e.prototype.isSegmentInfoLoaded=function(e){if(void 0===e&&(e=this.currentRepresentationId),!e)return!1;var t=this.getSegmentListEntries(e),i=this.manifestService.getRepresentationById(e);return!(!t.length||!i)},e.prototype.rewindOneSegment=function(){return this.listIndex--,!(this.listIndex<0)||(this.logger.debug("List array index is smaller than 0, probably a discontinuity. Using 0."),this.listIndex=0,!1)},e.prototype.getCurrentPeriod=function(){return this.manifestService.getPeriod(this.currentRepresentationId)},e.prototype.getExpectedPresentationTime=function(e){var t=this.getCurrentPeriod().start;return(this.manifestService.hasSinglePeriod()?this.getSeekableRange().start:t)+this.getSegmentListEntries(this.currentRepresentationId).slice(0,e).reduce((function(e,t){return e+t.duration}),0)},e.prototype.getCurrentRepresentation=function(){return this.manifestService.getRepresentationById(this.currentRepresentationId)},e.prototype.getSegmentList=function(e){if(e)return this.segmentListMap[e.key()]},e.prototype.getSegmentListEntries=function(e){var t,i;return e?this.settings.ENABLE_SEGMENT_INFO_PROVIDER_FROM_STORE&&this.manifestService.isHlsManifest()?this.getStoreSegmentInfos(e):null!==(i=null===(t=this.getSegmentList(e))||void 0===t?void 0:t.entries)&&void 0!==i?i:[]:[]},e.prototype.getStoreSegmentInfos=function(e){var t,i=null===(t=this.getSourceStateService())||void 0===t?void 0:t.getState();return(0,h.getSegmentInfos)(i,e.key())},e.prototype.findListIndexWithoutSegmentStartTimes=function(e,t){var i,n;if(!this.adaptationSetId)return 0;for(var r=this.manifestService.getPeriod(this.adaptationSetId),o=null!==(i=null==r?void 0:r.start)&&void 0!==i?i:0,a=this.getSegmentListEntries(this.currentRepresentationId),s=0,u=o;u<=t&&s<a.length;s++)u+=null!==(n=a[s].duration)&&void 0!==n?n:0;return Math.max(s-1,0)},e.prototype.getIndexForTime=function(e){var t=this.getSegmentList(this.currentRepresentationId),i=this.getSegmentListEntries(this.currentRepresentationId);if(!t||0===i.length||!(0,d.isNumber)(t.totalDuration))return 0;var n=this.getMinStartTime(),r=Math.max(n,e),o=t.totalDuration/i.length,a=(0,m.findSegmentIndexForTime)(i,r,o);return null!==a?a:this.findListIndexWithoutSegmentStartTimes(t,r)},e.prototype.getMinStartTime=function(e){void 0===e&&(e=this.currentRepresentationId);var t=this.manifestService.hasSinglePeriod()?this.getSeekableRange().start:this.manifestService.getPeriod(e).start;return this.manifestService.isFirstPeriod(e.periodId)&&(t+=this.distanceToListStartSeconds),t},e.prototype.getLiveEdgeTime=function(){var e=this.manifestService.getLastPeriod();return e?e.start+s.DurationConverter.getDurationInSec(e._duration):1/0},e.prototype.getActualTimeShiftBufferDepth=function(){return this.manifestService.getTimeShiftBufferDepthSeconds()},e.prototype.getSeekableRange=function(){var e={start:0,end:0},t=this.manifestService.getTotalDuration();if(!this.manifestService.isLive())return e.start=(0,o.getStartTimeOffset)(this.getSourceStateService().getState()),e.end=t,e;var i=this.manifestService.getTimeShiftBufferDepthSeconds(),n=(0,u.toSeconds)(this.manifestService.getRequestTimestamp()-this.manifestService.getAvailabilityStartTime());if(e.start=Math.max(n+i,0),e.end=Math.max(n,0),l.ModuleManager.has(p.ModuleName.HLS)&&this.manifestService.isHlsManifest()){var r=l.ModuleManager.get(p.ModuleName.HLS).selectors,a=r.getHlsState;"EVENT"===(0,r.getPlaylistType)(a(this.getSourceStateService().getState()))?(e.start=0,e.end=t):e.start+=this.distanceToListStartSeconds}return e.end-=this.manifestService.getDesiredDistanceToLiveEdge(),e},e.prototype.getPendingSegmentInfoRequest=function(){return this.pendingSegmentInfoRequest},e.prototype.setPendingSegmentInfoRequest=function(e){this.pendingSegmentInfoRequest=e},e.prototype.preProcessAvailableSegment=function(e,t,i){return null},e.prototype.dispose=function(){this.settings=null,this.manifestService=null,this.adaptationSetId=null,this.currentRepresentationId=null,this.manifestService=null,this.pendingSegmentInfoRequest=null,this.segmentListMap=null},e}();function v(e,t){for(var i=e[0].discontinuitySequenceNumber,n=1;n<e.length;n++){var r=e[n].discontinuitySequenceNumber;if(r!==i){var o=y(t,r);if(null!=o)return{index:n,discontinuityStartTime:o}}}return null}function y(e,t){var i=e[String(t)];return i&&i.startTime>0?i.startTime:(i=e[String(t-1)])&&i.endTime>0?i.endTime:null}t.SegmentListMPDHandler=S;var T=function(){return!1};function I(e,t,i){if(e.length&&i.hasSegmentStartTimeForHlsRepresentation(t)){var n;null!=e[0].startTime?n=(0,a.findIndexFromEnd)(e,(function(e){return null!=e.startTime}))+1:(e[0].startTime=i.getStartTimeForHlsSegment(t,e[0]),n=1);var r=function(e,t){return t.startTime=e.startTime+e.duration};(0,a.forEachFromIndex)(e,n,r)}}t.assignSegmentStartTimesFromHlsPlaylist=I},89617:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentLoader=t.SegmentLoadingErrorReason=void 0;var r,o,a=i(14809),s=i(36166),u=i(85739),d=i(59574),c=i(49520),l=i(40237),p=i(79446),f=i(41609),h=i(22221),g=i(45366),m=i(11917),S=i(3988),v=i(50163),y=i(80815),T=i(43068),I=i(83024),M=i(46022),b=i(53140),P=i(49100),C=i(30733),R=i(27005);!function(e){e.CANCEL="CANCEL",e.ERROR_LOADING="ERROR_LOADING",e.ERROR_DECRYPTING="ERROR_DECRYPTING",e.BUSY="BUSY",e.UNKNOWN="UNKNOWN"}(r=t.SegmentLoadingErrorReason||(t.SegmentLoadingErrorReason={})),function(e){e[e.IDLE=1]="IDLE",e[e.LOADING=2]="LOADING",e[e.CANCELLING=3]="CANCELLING",e[e.TERMINATED=4]="TERMINATED"}(o||(o={}));var A=408,E=function(){function e(e,t,i,r){var a=this;if(void 0===r&&(r=!1),this.context=e,this.cancelLoading=function(){var e,t,i,n,r,s;if(clearTimeout(a.loadTimeoutID),clearInterval(a.progressCheckIntervalId),a.loadTimeoutID=null,a.isLoading()){if(delete a.currentSegmentInfo[a.loadingUrl],a.state=o.CANCELLING,a.loader.cancel(),void 0!==a.currentRequestProgress){var u=null!==(t=null===(e=a.currentRequestProgress.responseTiming)||void 0===e?void 0:e.headersReceivedTimestamp)&&void 0!==t?t:-1,d=null!==(n=null===(i=a.currentRequestProgress.responseTiming)||void 0===i?void 0:i.openedTimestamp)&&void 0!==n?n:-1,c=null!==(r=a.currentRequestProgress.elapsedTime)&&void 0!==r?r:-1,l=u-d;c>=0&&l>=0&&c>l&&a.context.store.dispatch((0,h.addMetricsValue)(a.mimeType,m.MetricType.DownloadInformation,{bytes:a.currentRequestProgress.loadedBytes,time:c,timeToFirstByte:l})),a.canceledSegmentRequestFinishedEvent={success:!1,httpStatus:A,downloadTime:c,size:a.currentRequestProgress.loadedBytes,duration:null!==(s=a.segmentDuration)&&void 0!==s?s:0,isInit:a.isInit,mimeType:a.mimeType,uid:void 0}}a.currentRequestProgress=void 0}},this.checkLoadingProgress=function(){var e,t,i,r=null!==(i=null===(t=null===(e=a.currentRequestProgress)||void 0===e?void 0:e.responseTiming)||void 0===t?void 0:t.sendTimestamp)&&void 0!==i?i:-1;void 0===a.currentRequestProgress||r<0||a.onProgress(n(n({},a.currentRequestProgress),{elapsedTime:l.TimingUtil.getHiResTimestamp()-r}))},this.onProgress=function(e){var t,i=.5,n=null!==(t=e.elapsedTime)&&void 0!==t?t:-1;if(a.currentRequestProgress=e,a.currentRequestProgress.segmentDuration=a.segmentDuration,a.currentRequestProgress.url=a.loadingUrl,!(a.isInit||n<=i||a.state!==o.LOADING)&&a.onDownloadShouldBeCancelledCallback(e)){var r=(8*e.loadedBytes/1e3/n).toFixed(2);a.logger.debug("cancel download ".concat(a.currentRequestProgress.url," (measured bandwidth: ").concat(r," kbps)")),a.cancelLoading()}},this.logger=e.logger,this.eventHandler=e.eventHandler,this.customLoaderArgs=e.config.tweaks.segmentLoaderArgs||null,this.customLoader=e.config.tweaks.segmentLoader||null,this.segmentDuration=1,this.segmentNumber=0,this.state=o.IDLE,this.mimeType=t,this.keyStore=new P.KeyStore,this.keyLoader=new b.KeyLoader(this.context),this.onDownloadShouldBeCancelledCallback=i,this.currentLoadPromise=null,this.currentSegmentInfo={},this.canceledSegmentRequestFinishedEvent=null,this.isFetchSupported="function"==typeof window.fetch,this.isPrefetchingLoader=r,T.ModuleManager.has(I.ModuleName.ContainerMP4)){var s=T.ModuleManager.get(I.ModuleName.ContainerMP4);this.cmafChunkParser=new s.CmafChunkParser(this.context)}this.setupContentLoader()}return e.prototype.isLoading=function(){var e=Boolean(this.keyLoader&&this.keyLoader.isLoading());return this.state===o.LOADING||this.state===o.CANCELLING||this.loader&&this.loader.isLoading()||e},e.prototype.isRetrying=function(){return this.loader&&this.loader.isRetrying()},e.prototype.load=function(e){var t=this;if(this.isLoading())return this.logger.debug("Error loading segment, loader is busy!"+this.loadingUrl),Promise.reject({reason:r.BUSY});this.loader&&this.loader.dispose(),this.canceledSegmentRequestFinishedEvent=null,this.loader=(0,C.getLoader)(this.context,this.defaultLoaderArgs),this.state=o.LOADING,this.currentSegmentInfo[e.url]=e,this.encryptionInfo=e.key;var i=Promise.resolve();if(this.encryptionInfo&&!this.encryptionInfo.buffer)if(this.encryptionInfo.method===a.HlsEncryptionMethod.AES_128)i=this.getKey(e).then((function(e){return t.encryptionInfo.buffer=e}));else if(this.encryptionInfo.method===a.HlsEncryptionMethod.SAMPLE_AES)return this.eventHandler.fireError(new u.PlayerError(s.ErrorCode.SOURCE_ENCRYPTION_METHOD_NOT_SUPPORTED,{"encryption-method":this.encryptionInfo.method,supported:"AES_128"},"The SAMPLE_AES encryption method is not supported.")),this.state=o.IDLE,Promise.reject({reason:r.ERROR_DECRYPTING});return this.currentLoadPromise=i.then((function(){return t.loadSegment(e).catch((function(e){throw t.state=o.IDLE,t.currentLoadPromise=null,e}))})),this.currentLoadPromise},e.prototype.getCurrentLoadPromise=function(){return this.currentLoadPromise},e.prototype.getKey=function(e){var t=this,i=e.key.uri,n=this.keyStore.get(i);return n?Promise.resolve(n):this.keyLoader.load(i).then((function(e){return t.keyStore.put(i,e),e})).catch((function(){throw{reason:r.ERROR_DECRYPTING}}))},e.prototype.getPreFetchedSegment=function(e,t){return this.isPrefetchingLoader||!this.context.adRestorationOptimizationService.hasPrefetchedSegment(t)?null:(this.currentSegmentInfo[e]&&(this.currentSegmentInfo[e].wasPrefetched=!0),this.context.adRestorationOptimizationService.getPrefetchedSegment(t,this.onDownloadShouldBeCancelledCallback))},e.prototype.setupLoadingProgressCheckInterval=function(){clearInterval(this.progressCheckIntervalId);var e=(0,y.toMilliSeconds)(this.context.settings.SEGMENT_LOADING_PROGRESS_CHECK_INTERVAL);e<=0||(this.progressCheckIntervalId=window.setInterval(this.checkLoadingProgress,e))},e.prototype.loadSegment=function(e){var t,i=this,n={};this.isInit=null!==(t=e.isInitSegment)&&void 0!==t&&t,this.segmentDuration=e.duration,this.segmentNumber=e.segmentNumber,this.loadingUrl=e.url,this.loadingUid=btoa(this.loadingUrl),this.currentRequestProgress=void 0,e.byteRange&&(n.Range=["bytes=",e.byteRange.start,"-",e.byteRange.end].join(""));var r=this.context.sourceContext.source&&this.context.sourceContext.source.hasOwnProperty("options")&&Boolean(this.context.sourceContext.source.options.withCredentials);clearTimeout(this.loadTimeoutID),clearInterval(this.progressCheckIntervalId),this.loadTimeoutID=void 0,this.isInit||e.preventDownloadCanceling||(this.loadTimeoutID=setTimeout(this.cancelLoading,(0,y.toMilliSeconds)(this.context.settings.XHR_TIMEOUT-1)));var o=this.getPreFetchedSegment(this.loadingUrl,e);if(o)return this.context.logger.debug("return prefetched segment for",this.loadingUrl),o.then((function(e){var t=new R.Stream;return i.loadingFinished(),t.add(e),e.getSegmentInfo().wasPrefetched=!0,t})).catch((function(e){throw e}));var a=Boolean(this.encryptionInfo)||Boolean(this.decrypter),s=e.mimeType.includes("mp4")&&v.MimeTypeHelper.isAV(e.mimeType)&&!e.isTransmuxingRequired,u=this.context.settings.CHUNKED_CMAF_STREAMING&&this.cmafChunkParser&&this.isFetchSupported&&s&&!e.isInitSegment&&!a;return this.setupLoadingProgressCheckInterval(),this.loader.load(this.loadingUrl,f.HttpRequestMethod.GET,f.HttpResponseType.ARRAYBUFFER,null,n,r,this.mimeType,u).then((function(e){return i.handleResponse(e.body)})).catch((function(e){throw i.createLoadingError(e)}))},e.prototype.createLoadingError=function(e){var t,i;return this.state===o.CANCELLING?(this.logger.debug("Cancelled "+this.mimeType+" download ["+this.loadingUrl+"]"),this.canceledSegmentRequestFinishedEvent&&(null===(t=this.eventHandler)||void 0===t||t.dispatchEvent(d.PlayerEvent.SegmentRequestFinished,this.canceledSegmentRequestFinishedEvent)),i={reason:r.CANCEL}):this.state===o.LOADING&&(i={reason:r.ERROR_LOADING,info:{response:e,isInit:this.isInit}}),i},e.prototype.getAllLoadingPeriodIds=function(){var e=this;return Object.keys(this.currentSegmentInfo).map((function(t){return e.currentSegmentInfo[t].periodId}))},e.prototype.getCurrentLoadingSegmentInfo=function(){return this.isLoading()&&this.currentSegmentInfo&&this.currentSegmentInfo[this.loadingUrl]?this.currentSegmentInfo[this.loadingUrl]:null},e.prototype.attachDecrypter=function(e){this.decrypter=this.decrypter||e},e.prototype.attachClearKeyLoader=function(e){this.clearKeyLoader=this.clearKeyLoader||e},e.prototype.terminate=function(){var e,t=this;this.isLoading()?(null===(e=this.currentLoadPromise)||void 0===e||e.catch((function(){t.state=o.TERMINATED})),this.cancelLoading()):this.state=o.TERMINATED},e.prototype.createSegment=function(e){var t,i;i=this.isInit?M.SegmentInitType.INIT:M.SegmentInitType.NONE;var n=this.currentSegmentInfo[this.loadingUrl],r=new M.Segment(e,this.mimeType,null!==(t=n.codecs)&&void 0!==t?t:null,n.periodId,this.segmentDuration,i,!0,e.byteLength,n.internalRepresentationId,n.startTime);return r.setUrl(this.loadingUrl),r.setSegmentInfo(n),r},e.prototype.maybeDecryptResponseData=function(e,t){return this.encryptionInfo&&this.encryptionInfo.method===a.HlsEncryptionMethod.AES_128&&!t?this.decryptAes128(e):this.decrypter?this.decryptClearKey(e):Promise.resolve(e)},e.prototype.decryptAes128=function(e){return this.logger.debug("Decrypting AES-128-encryped segment "+this.loadingUrl+", KEY: 0x"+S.FormatHelper.bytesToHex(this.encryptionInfo.buffer)+", IV: 0x"+S.FormatHelper.bytesToHex(this.encryptionInfo.iv)),new(0,T.ModuleManager.get(I.ModuleName.Crypto).CryptoApi)(this.context,"AES-CBC",this.encryptionInfo.buffer,this.encryptionInfo.iv,this.mimeType).decrypt(e).then((function(e){if(!e||0===e.byteLength)throw{reason:r.ERROR_DECRYPTING};return e})).catch((function(){throw{reason:r.ERROR_DECRYPTING}}))},e.prototype.decryptClearKey=function(e){var t=this,i=Promise.resolve(e);if(this.isInit)i=this.decrypter.parseInitSegment(e),this.clearKeyLoader&&(i=i.then((function(e){return t.clearKeyLoader.load(t.decrypter.getKeyIds()).then((function(i){return t.decrypter.addKeys(i),Promise.resolve(e)}))})));else if(this.decrypter.isEncrypted()){var n=S.FormatHelper.bytesToHex(this.decrypter.getKey());this.logger.debug("Decrypting SAMPLE-AES-encrypted segment ".concat(this.loadingUrl,", KEY: 0x").concat(n)),i=this.decrypter.decryptDataSegment(e)}return i.catch((function(){throw{reason:r.ERROR_DECRYPTING}}))},e.prototype.handleResponse=function(e,t){var i=this;return void 0===t&&(t=!1),e instanceof ArrayBuffer?(this.segmentStream=new R.Stream,this.maybeDecryptResponseData(e,t).then((function(e){i.state===o.TERMINATED||i.state===o.CANCELLING?i.segmentStream.abort(r.CANCEL):(i.segmentStream.add(i.createSegment(e)),i.segmentStream.end()),i.loadingFinished()}))):this.segmentStream=e.transform((function(e){return i.cmafChunkParser.appendData(e),i.cmafChunkParser.getCompleteChunks()})).transform((function(e){return i.createSegment(e)}),(function(){return i.loadingFinished()}),(function(e){return i.logger.debug("Error handling fetch segment request",e),i.loadingFinished(),e.message===c.RequestError.Canceled?r.CANCEL:r.ERROR_LOADING})),Promise.resolve(this.segmentStream)},e.prototype.loadingFinished=function(){this.state=o.IDLE,this.currentLoadPromise=null,this.cmafChunkParser&&this.cmafChunkParser.reset(),this.currentSegmentInfo&&delete this.currentSegmentInfo[this.loadingUrl]},e.prototype.dispose=function(){this.terminate(),clearTimeout(this.loadTimeoutID),clearInterval(this.progressCheckIntervalId),this.loader&&this.loader.dispose&&this.loader.dispose(),this.keyLoader&&this.keyLoader.dispose(),this.keyStore&&this.keyStore.dispose(),T.ModuleManager.has(I.ModuleName.Crypto)&&T.ModuleManager.get(I.ModuleName.Crypto).WebWorkerCrypto.dispose(),this.loader=null,this.customLoader=null,this.customLoaderArgs=null,this.keyLoader=null,this.loadingUrl=null,this.loadingUid=null,this.encryptionInfo=null,this.currentSegmentInfo=null,this.currentRequestProgress=void 0,this.decrypter=null,this.keyStore=null,this.eventHandler=null},e.prototype.setupContentLoader=function(){var e=this;this.defaultLoaderArgs=n(n({},(0,C.getLoaderConfig)(this.context,this.mimeType)),{onSuccess:function(t,i){var n=(0,g.getMetricsState)(e.context.store.getState());!e.isInit&&e.mimeType in n&&(e.context.store.dispatch((0,h.addMetricsValue)(e.mimeType,m.MetricType.DownloadTime,i)),e.context.store.dispatch((0,h.addMetricsValue)(e.mimeType,m.MetricType.DownloadSuccess,!0)),(0,p.isDownloadTimeInformationValid)(t)&&e.context.store.dispatch((0,h.addMetricsValue)(e.mimeType,m.MetricType.DownloadInformation,{bytes:t.length,time:t.elapsedTime,timeToFirstByte:t.timeToFirstByte}))),clearTimeout(e.loadTimeoutID),clearInterval(e.progressCheckIntervalId),e.loadTimeoutID=void 0;var r={success:!0,httpStatus:t.status,downloadTime:t.elapsedTime,size:t.length,duration:e.segmentDuration,isInit:e.isInit,mimeType:e.mimeType,uid:e.loadingUid};e.eventHandler.dispatchEvent(d.PlayerEvent.SegmentRequestFinished,r)},onProgress:this.onProgress,onFailure:function(t,i){e.context.store.dispatch((0,h.addMetricsValue)(e.mimeType,m.MetricType.DownloadSuccess,!1)),clearTimeout(e.loadTimeoutID),clearInterval(e.progressCheckIntervalId),e.loadTimeoutID=void 0,delete e.currentSegmentInfo[e.loadingUrl],e.eventHandler.dispatchEvent(d.PlayerEvent.SegmentRequestFinished,{success:!1,httpStatus:t&&t.status||0,downloadTime:-1,size:-1,duration:e.segmentDuration,isInit:e.isInit,mimeType:e.mimeType,uid:void 0})}})},e}();t.SegmentLoader=E},75182:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getLoaderPoolSize=t.SegmentLoaderPool=void 0;var n=i(22221),r=i(45366),o=i(11917),a=i(82072),s=i(50163),u=i(89199),d=i(43068),c=i(83024),l=i(45110),p=i(76060),f=i(70121),h=i(89617),g=1,m=function(){function e(e,t){this.context=e,this.mimeType=t.mimeType,this.loaders=[],this.shouldDownloadBeCancelledCallback=t.shouldDownloadBeCancelledCallback,this.createLoaders(S(this.mimeType,e.settings.SEGMENT_LOADER_POOL_SIZE)),this.attachDecrypter()}return e.prototype.createLoaders=function(e){for(var t=0;t<e;t++)this.loaders.push(new h.SegmentLoader(this.context,this.mimeType,this.shouldDownloadBeCancelledCallback))},e.prototype.getDecrypter=function(e){if(this.context.segmentPrefetchingService&&this.context.segmentPrefetchingService.hasMp4Decrypter(this.mimeType))return this.context.segmentPrefetchingService.getDecrypter(this.mimeType);var t=d.ModuleManager.get(c.ModuleName.Crypto).createDecrypter,i=T(e.drm.clearkey)?e.drm.clearkey:[];return t(this.context,this.mimeType,i)},e.prototype.getClearKeyLoader=function(e){return new(0,d.ModuleManager.get(c.ModuleName.Crypto).ClearKeyLoader)(this.context,e)},e.prototype.attachDecrypter=function(){var e=this.context.sourceContext.source,t=v(e)?this.getDecrypter(e):null;if(t&&(this.loaders.forEach((function(e){return e.attachDecrypter(t)})),this.context.segmentPrefetchingService&&this.context.segmentPrefetchingService.setDecrypter(t,this.mimeType),y(e.drm.clearkey))){var i=this.getClearKeyLoader(e.drm.clearkey);this.loaders.forEach((function(e){return e.attachClearKeyLoader(i)}))}},e.prototype.isLoading=function(){return this.loaders.some((function(e){return e.isLoading()}))},e.prototype.isFreeLoaderAvailable=function(){return this.loaders.some((function(e){return!e.isLoading()}))},e.prototype.updateRequestedRepresentationMetric=function(e){var t=(0,r.getMetricsHistoryFromInstanceState)(this.context.store.getState(),"default",o.MetricType.RequestedRepresentations);(t?t.map((function(e){return e.value})):[]).includes(e)||this.context.store.dispatch((0,n.addMetricsValue)("default",o.MetricType.RequestedRepresentations,e))},e.prototype.load=function(e){var t=this,i=this.loaders.find((function(e){return!e.isLoading()}));if(!i)return this.context.logger.debug("Failed to load segment. No free loader!",e.url),Promise.reject(null);this.updateRequestedRepresentationMetric(e.internalRepresentationId),this.context.logger.debug("[SegmentLoader][".concat(this.loaders.indexOf(i),"] Loading ").concat(e.url));var n=(0,f.getSegmentInfoTimeRange)(e);return n&&this.context.store.dispatch((0,l.addStreamTimeRange)((0,p.getTrackIdentifier)(e),n,p.StreamTimeRangeType.Loading)),i.load(e).catch((function(i){throw n&&t.context.store.dispatch((0,l.removeStreamTimeRange)((0,p.getTrackIdentifier)(e),n,p.StreamTimeRangeType.Loading)),i}))},e.prototype.cancelLoading=function(){var e=this;return Promise.all(this.loaders.map((function(e){return e.isLoading()&&e.cancelLoading(),Promise.resolve(e.getCurrentLoadPromise())}))).then((function(){})).catch((function(t){(0,a.isContextAvailable)(e.context)&&e.context.logger.debug("Error while loading a segment ",t)}))},e.prototype.getLoadingPeriodIds=function(){return this.loaders.flatMap((function(e){return e.getAllLoadingPeriodIds()}))},e.prototype.dispose=function(){this.cancelLoading(),this.loaders.forEach((function(e){return e.dispose()})),this.loaders=null},e}();function S(e,t){var i=s.MimeTypeHelper.extractContentType(e);return t&&(0,u.isNumber)(t[i])?Math.max(g,t[i]):g}function v(e){var t,i;return T(null===(t=null==e?void 0:e.drm)||void 0===t?void 0:t.clearkey)||y(null===(i=null==e?void 0:e.drm)||void 0===i?void 0:i.clearkey)}function y(e){var t;return Boolean(null===(t=e)||void 0===t?void 0:t.LA_URL)}function T(e){var t;return(null===(t=e)||void 0===t?void 0:t.length)>0}t.SegmentLoaderPool=m,t.getLoaderPoolSize=S},26495:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentPreProcessor=void 0;var n=i(59534),r=i(59574),o=i(22221),a=i(11917),s=i(50163),u=i(47273),d=i(43233),c=i(83576),l=i(45110),p=i(76060),f=i(12434),h=i(30790),g=i(92977),m=i(18967),S=i(70121),v=i(59266),y="SegmentPreProcessor",T=function(){function e(e,t,i,r,o,a,s,u){this.context=e,this.mimeType=t,this.onDataAvailableCallback=i,this.hls=r,this.initSegmentStore=o,this.segmentUnavailabilityHandler=a,this.timestampOffsetService=s,this.segmentParser=u,this.isKeyframeRecoveryOngoing=!1,this.downloadRepresentationId=null;var d=e.sourceContext.sourceIdentifier;this.manifestService=this.context.serviceManager.get(n.ServiceName.ManifestService,d),this.playerStateService=this.context.serviceManager.get(n.ServiceName.PlayerStateService)}return Object.defineProperty(e.prototype,"logger",{get:function(){return this.context.logger},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"eventHandler",{get:function(){return this.context.eventHandler},enumerable:!1,configurable:!0}),e.prototype.isSubtitleSegment=function(e){return s.MimeTypeHelper.isSubtitle(e.getMimeType())},e.prototype.setHlsTimelineTracker=function(e){this.hlsTimelineTracker=e},e.prototype.setMpdHandler=function(e){this.mpdHandler=e},e.prototype.cacheOrCallOnSegmentAvailable=function(e,t,i,r,o,a){var s,u=this,d=this.hasHlsTimelineGap(t.find((function(e){return(0,g.isSegmentOfMainStream)(e,u.hls)})),i);d.hasGap?d.couldHandle?s=!1:d.couldHandle||(s=!0,this.hlsTimelineTracker.reset()):s=!0;var c=function(e){o=e,a(e)};if(s)t.forEach((function(t){var n=e.metadata[e.transmuxedSegments.indexOf(t)];u.onSegmentAvailable(t,n,i,r,o,c)||r.cacheSegment(e.originalSegment)}));else if(d.hasGap){d.gapSizeSec>0&&r.cacheSegment(e.originalSegment);var f=e.originalSegment.getSegmentInfo(),h=(0,S.getSegmentInfoTimeRange)(f);h&&this.context.serviceManager.maybeCall(n.ServiceName.SourceStoreService,(function(e){e.dispatch((0,l.removeStreamTimeRange)((0,p.getTrackIdentifier)(f),h,p.StreamTimeRangeType.Loading))}),void 0,this.context.sourceContext.sourceIdentifier)}},e.prototype.onSegmentAvailable=function(e,t,i,r,o,a){var s=this,c=this.hls.isTransmuxingRequired,l=this.manifestService.getAdaptationSet(i),p=(0,d.getCodecsFromAdaptationSet)(l),h=this.mpdHandler.preProcessAvailableSegment(e,t,{codec:p,periodId:e.getPeriodId()});h&&h.additionalSegment&&this.onSegmentAvailable(h.additionalSegment,null,i,r,o,a),this.initSegmentStore.handleSegment(e);var m=!0,S="onSegmentAvailable "+e.getMimeType();if(this.segmentUnavailabilityHandler.downloadSuccess(e.isInit()),e.isInit()&&(S+=" init"),this.logger.debug(S+" segment ["+e.getUrl()+"]"),this.segmentParser&&!c&&!u.TextSegmentAnalyzer.isPlainTextPayload(e.getData())){var v=isNaN(this.mpdHandler.getTimestampOffset())||0===this.mpdHandler.getTimestampOffset();if(this.manifestService.isHlsManifest()&&!e.isInit()&&v&&(0,f.initializeHlsSegmentStartTimes)(e,this.context,this.mpdHandler),this.timestampOffsetService.maybeAdjustTimestampOffsetAtDiscontinuityChange(e,this.mpdHandler),this.segmentParser.parseSegment(e),this.manifestService.isHlsManifest()&&!this.isCorrectSegment(e,i,r))return!1}if(this.isSubtitleSegment(e)&&this.manifestService.isHlsManifest()&&this.timestampOffsetService.maybeAdjustTimestampOffsetAtDiscontinuityChange(e,this.mpdHandler),this.manifestService.isHlsManifest()&&!e.isInit()&&this.manifestService.initSegmentStartTimesFromReferenceSegment(e),this.manifestService.isHlsManifest()&&this.manifestService.markSegmentAsDownloaded(i,e),c&&this.hls.possiblyDependentSegments&&o&&(0,g.isSegmentOfMainStream)(e,this.hls)&&!this.isKeyframeRecoveryOngoing&&(this.logger.debug("Just switched playlists, isIndependentlyDecodable? ".concat(e.isIndependentlyDecodable()," ")+"(".concat(e.getMimeType(),", ").concat(e.getUrl(),")")),!e.isIndependentlyDecodable()&&this.mpdHandler.getIndex()>0&&(this.logger.debug("Started keyframe recovery"),this.mpdHandler.setIndex(this.mpdHandler.getIndex()-2),m=!1,this.hls.discardNextSegment=!0,this.isKeyframeRecoveryOngoing=!0)),!m)return!1;I(e,this.context.store),this.context.serviceManager.get(n.ServiceName.TimedMetadataService).onSegmentAvailable({segment:e,extractedMetadata:t,isSegmentOfMainStream:(0,g.isSegmentOfMainStream)(e,this.hls),presentationTimeOffset:this.mpdHandler.getTimestampOffset()}),this.context.serviceManager.maybeCall(n.ServiceName.SubtitleService,(function(i){i.handleClosedCaptions(s.mpdHandler,e,null==t?void 0:t.closedCaptions,c,p)})),e.isInit()?a(!0):(o&&(0,g.isSegmentOfMainStream)(e,this.hls)&&a(!1),this.logger.debug("[".concat(y,"][").concat(this.mimeType,"]: playbackTimeForSegment=").concat(e.getPlaybackTime()," ").concat(e.getUrl())));var T=e.getSegmentInfo(),M=T&&!T.internalRepresentationId.equals(this.downloadRepresentationId);return(0,g.isSegmentOfMainStream)(e,this.hls)&&M&&(this.triggerOnDownloadQualityChanged(this.mimeType,this.downloadRepresentationId,T.internalRepresentationId),this.updateDownloadedRepresentation(e),this.downloadRepresentationId=T.internalRepresentationId),(0,g.isSegmentOfMainStream)(e,this.hls)&&(this.hlsTimelineTracker&&!e.isInit()&&this.hlsTimelineTracker.trackPlaybackTime(e),this.isKeyframeRecoveryOngoing&&(this.isKeyframeRecoveryOngoing=!1)),e.isInit()||this.onDataAvailableCallback(e),m},e.prototype.updateDownloadedRepresentation=function(e){var t=e.getSegmentInfo(),i={id:t.representationId,bitrate:t.bitrate,width:t.width,height:t.height};this.context.store.dispatch((0,o.addMetricsValue)(this.mimeType,a.MetricType.DownloadedRepresentation,i))},e.prototype.triggerOnDownloadQualityChanged=function(e,t,i){var n;if(s.MimeTypeHelper.isVideo(e))n=r.PlayerEvent.VideoDownloadQualityChanged;else{if(!s.MimeTypeHelper.isAudio(e))return;n=r.PlayerEvent.AudioDownloadQualityChanged}var o=(0,c.representationToQuality)(this.manifestService.getRepresentationById(t),e),a=(0,c.representationToQuality)(this.manifestService.getRepresentationById(i),e);this.eventHandler.dispatchEvent(n,{targetQuality:a,targetQualityId:a.id,sourceQuality:o,sourceQualityId:o?o.id:null})},e.prototype.hasHlsTimelineGap=function(e,t){var i={hasGap:!1};if(e&&this.manifestService.isHlsManifest()&&!this.isSubtitleSegment(e)&&(0,g.isSegmentOfMainStream)(e,this.hls)&&this.hlsTimelineTracker){var n=m.SegmentInfoProvider.findHlsRepresentationForSegment(e,this.manifestService.getAdaptationSet(t));if(n&&(i=this.hlsTimelineTracker.checkForTimelineGap(e,n.representation,n.index)).hasGap&&void 0!==i.correctedIndex){this.logger.debug("Encountered timeline gap ("+i.gapSizeSec+"), just loaded "+e.getUrl());var r=n.representation._internalId,o=this.mpdHandler instanceof v.SegmentListMPDHandler&&this.mpdHandler.getSegmentListEntries(r)&&this.mpdHandler.getSegmentListEntries(r)[i.correctedIndex];if(o&&(0,h.areSegmentsIdentical)(e.getSegmentInfo(),o))return i.hasGap=!1,i;o&&o.hasDownloadFailed?i.couldHandle=!1:this.mpdHandler.setIndex(i.correctedIndex)}}return i},e.prototype.isCorrectSegment=function(e,t,i){var n=this.hasHlsTimelineGap(e,t);return!n.hasGap||(n.couldHandle?(this.isSegmentInTheFuture(n)&&i.cacheSegment(e),!1):(this.hlsTimelineTracker.reset(),!0))},e.prototype.isSegmentInTheFuture=function(e){return e.gapSizeSec>0},e.prototype.dispose=function(){this.downloadRepresentationId=null,this.hlsTimelineTracker=null,this.manifestService=null,this.playerStateService=null,this.onDataAvailableCallback=null,this.hls=null,this.initSegmentStore=null,this.segmentUnavailabilityHandler=null,this.timestampOffsetService=null,this.segmentParser=null,this.mpdHandler=null},e}();function I(e,t){var i=e.getSegmentInfo(),n=(0,S.getSegmentInfoTimeRange)(i),r=e.getPlaybackTimeRange();n&&r&&(t.dispatch((0,l.removeStreamTimeRange)((0,p.getTrackIdentifier)(i),n,p.StreamTimeRangeType.Loading)),t.dispatch((0,l.addStreamTimeRange)((0,p.getTrackIdentifier)(i),r,p.StreamTimeRangeType.Loading)))}t.SegmentPreProcessor=T},90770:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentPrefetcher=void 0;var n=i(82072),r=i(74294),o=i(89617),a=function(){function e(e){var t=this;this.processSegmentInfoQueue=function(e){var i=t.segmentInfoQueue.get(e);i&&0!==i.length&&t.chainSegmentPrefetch(i.shift()).then((function(){return t.processSegmentInfoQueue(e)}))},this.segmentInfoQueue=new r.ArrayMap,this.prefetchPromiseChainMap=new Map,this.decrypterMap=new Map,this.segmentLoaderMap=new Map,this.segmentPrefetchHandler=e,this.shouldDownloadBeCancelledCallbackMap=new Map}return e.prototype.updateContext=function(e){this.context=e},e.prototype.setShouldDownloadBeCancelledCallback=function(e,t){this.shouldDownloadBeCancelledCallbackMap.set(e,t)},e.prototype.removeShouldDownloadBeCancelledCallback=function(e){this.shouldDownloadBeCancelledCallbackMap.delete(e)},e.prototype.setDecrypter=function(e,t){this.decrypterMap.set(t,e),this.segmentLoaderMap.has(t)&&this.segmentLoaderMap.get(t).attachDecrypter(e)},e.prototype.removeDecrypter=function(e){this.decrypterMap.delete(e)},e.prototype.getDecrypter=function(e){return this.decrypterMap.get(e)},e.prototype.prefetchSegment=function(e){return this.chainSegmentPrefetch(e)},e.prototype.prefetchSegments=function(e){var t=this;e.forEach((function(e){return t.segmentInfoQueue.add(e.mimeType,e)})),this.segmentInfoQueue.keys.forEach((function(e){return t.processSegmentInfoQueue(e)}))},e.prototype.chainSegmentPrefetch=function(e){var t=this,i=this.getPrefetchPromiseChain(e.mimeType).then((function(){return t.fetchSegment(e)})).then((function(){})).catch((function(){}));return this.prefetchPromiseChainMap.set(e.mimeType,i),i},e.prototype.fetchSegment=function(e){var t=this;if(!(0,n.isContextAvailable)(this.context))return Promise.reject("PlayerContext not available");var i=this.getLoader(e).load(e).then((function(e){return e.read()})).then((function(e){return e.value}));return this.segmentPrefetchHandler.onPrefetch({segmentInfo:e,loadingPromise:i}),i.catch((function(i){(0,n.isContextAvailable)(t.context)&&t.context.logger.debug("segment prefetching failed for",e,"with",i)})),i},e.prototype.getPrefetchPromiseChain=function(e){return this.prefetchPromiseChainMap.has(e)||this.prefetchPromiseChainMap.set(e,Promise.resolve()),this.prefetchPromiseChainMap.get(e)},e.prototype.getLoader=function(e){return this.segmentLoaderMap.has(e.mimeType)||this.segmentLoaderMap.set(e.mimeType,this.createLoader(e)),this.segmentLoaderMap.get(e.mimeType)},e.prototype.createLoader=function(e){this.prefetchPromiseChainMap.set(e.mimeType,Promise.resolve());var t=new o.SegmentLoader(this.context,e.mimeType,this.createDownloadCancelCallbackFunction(e),!0);return t.attachDecrypter(this.decrypterMap.get(e.mimeType)),t},e.prototype.createDownloadCancelCallbackFunction=function(e){var t=this;return function(i){var n=e.mimeType,r=t.segmentLoaderMap.get(n),o=r?r.getCurrentLoadingSegmentInfo():null,a=void 0!==n?t.shouldDownloadBeCancelledCallbackMap.get(n):void 0,s=o?o.internalRepresentationId:e.internalRepresentationId;return void 0!==a&&a(i,s)}},e.prototype.clearPrefetchingQueue=function(e){this.segmentInfoQueue.delete(e)},e.prototype.reset=function(){this.segmentLoaderMap.forEach((function(e){return e.dispose()})),this.shouldDownloadBeCancelledCallbackMap.clear(),this.segmentLoaderMap.clear(),this.decrypterMap.clear()},e.prototype.dispose=function(){this.reset(),this.segmentLoaderMap=null,this.shouldDownloadBeCancelledCallbackMap=null},e}();t.SegmentPrefetcher=a},87384:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentPrefetchingService=void 0;var n=i(88784),r=i(90770),o=function(){function e(){this.segmentPrefetcher=new r.SegmentPrefetcher(this),this.prefetchedSegments=new Map}return e.prototype.updatePlayerContext=function(e){this.context=e,this.segmentPrefetcher.updateContext(this.context)},e.prototype.setDecrypter=function(e,t){this.segmentPrefetcher.setDecrypter(e,t)},e.prototype.removeDecrypter=function(e){this.segmentPrefetcher.removeDecrypter(e)},e.prototype.getDecrypter=function(e){return this.segmentPrefetcher.getDecrypter(e)},e.prototype.hasMp4Decrypter=function(e){return Boolean(this.getDecrypter(e))},e.prototype.setShouldDownloadBeCancelledCallback=function(e,t){this.segmentPrefetcher.setShouldDownloadBeCancelledCallback(e,t)},e.prototype.removeShouldDownloadBeCancelledCallback=function(e){this.segmentPrefetcher.removeShouldDownloadBeCancelledCallback(e)},e.prototype.fetch=function(e){var t=this;return this.segmentPrefetcher.prefetchSegment(e).then((function(){var i=t.prefetchedSegments.get(e.mimeType).get((0,n.getSegmentInfoId)(e));return i?Promise.resolve(i.loadingPromise):Promise.reject()}))},e.prototype.fetchAll=function(e){this.segmentPrefetcher.prefetchSegments(e)},e.prototype.onPrefetch=function(e){var t=e.segmentInfo.mimeType;this.prefetchedSegments.has(t)||this.prefetchedSegments.set(t,new Map),this.prefetchedSegments.get(t).set((0,n.getSegmentInfoId)(e.segmentInfo),e)},e.prototype.hasPrefetchedSegment=function(e){return Boolean(this.findPrefetchedSegment(e))},e.prototype.getPrefetchedSegment=function(e){var t=this.findPrefetchedSegment(e);return t?t.loadingPromise:null},e.prototype.findPrefetchedSegment=function(e){return this.prefetchedSegments.has(e.mimeType)&&this.prefetchedSegments.get(e.mimeType).get((0,n.getSegmentInfoId)(e))||null},e.prototype.getPrefetchedSegments=function(){return this.prefetchedSegments},e.prototype.removePrefetchedSegment=function(e){this.prefetchedSegments.has(e.mimeType)&&this.prefetchedSegments.get(e.mimeType).delete((0,n.getSegmentInfoId)(e))},e.prototype.clearPrefetchingQueue=function(e){this.segmentPrefetcher.clearPrefetchingQueue(e)},e.prototype.reset=function(){this.segmentPrefetcher.reset(),this.prefetchedSegments.clear()},e.prototype.dispose=function(){this.reset(),this.segmentPrefetcher.dispose(),this.segmentPrefetcher=null,this.prefetchedSegments=null},e}();t.SegmentPrefetchingService=o},48800:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentManager=t.SegmentService=void 0;var n=i(4529),r=i(50163),o=i(66173),a=i(30790),s=i(75182),u=i(27005),d=function(){function e(e){var t=this;this.context=e,this.disposeSegmentManager=function(e){t.segmentManagerMap.has(e)&&(t.segmentManagerMap.get(e).dispose(),t.segmentManagerMap.delete(e))},this.segmentManagerMap=new Map}return e.prototype.getSegmentManagerKey=function(e,t){var i=void 0===t?{}:t,n=i.id,o=i.lang;return r.MimeTypeHelper.isSubtitle(e)?[e,n,o].filter(Boolean).join("-"):e},e.prototype.add=function(e,t,i){var n=this.get(e.mimeType,i);return n||(n=this.createSegmentManager(e),this.segmentManagerMap.set(this.getSegmentManagerKey(e.mimeType,i),n)),n},e.prototype.createSegmentManager=function(e){return new c(this.context,e)},e.prototype.get=function(e,t){return this.segmentManagerMap.get(this.getSegmentManagerKey(e,t))},e.prototype.disposeOfType=function(e,t){this.disposeSegmentManager(this.getSegmentManagerKey(e,t))},e.prototype.dispose=function(){this.segmentManagerMap.forEach((function(e){return e.dispose()})),this.segmentManagerMap.clear()},e}();t.SegmentService=d;var c=function(){function e(e,t){this.context=e,this.loaderPool=new s.SegmentLoaderPool(e,t),this.initSegmentService=new o.InitSegmentService(e,this.loaderPool),this.cache=new a.SegmentCache(e.settings.MAX_NUM_CACHED_SEGMENTS),this.sequence=Promise.resolve(null)}return e.prototype.getSegment=function(e){var t=e.isInitSegment?this.getInitSegment(e):this.getDataSegment(e);return this.sequence=this.sequence.catch((function(){})).then((function(){return t})),this.sequence},e.prototype.getInitSegment=function(e){return this.initSegmentService.getSegment(e).then(l)},e.prototype.getDataSegment=function(e){return this.hasCachedSegment(e)?(this.context.logger.debug("Returning segment from cache for URL: ".concat(e.url)),Promise.resolve(l(this.getCachedSegment(e)))):this.loaderPool.load(e)},e.prototype.isLoading=function(e){return e?this.loaderPool.getLoadingPeriodIds().includes(e):this.loaderPool.getLoadingPeriodIds().length>0},e.prototype.canLoad=function(){return this.loaderPool.isFreeLoaderAvailable()},e.prototype.cacheSegment=function(e){this.cache.add(e)},e.prototype.hasCachedSegment=function(e){return Boolean(this.getCachedSegment(e))},e.prototype.getCachedSegment=function(e){return e.isInitSegment?this.initSegmentService.getCachedSegment(e):this.cache.get(e)},e.prototype.removeCachedInitSegments=function(e){this.initSegmentService.removeCachedSegments(e)},e.prototype.clearCache=function(e){void 0===e&&(e=!0),e&&this.initSegmentService.removeCachedSegments((function(){return!0})),this.cache.clear()},e.prototype.cancel=function(){return this.loaderPool.cancelLoading()},e.prototype.dispose=function(){this.cancel(),this.clearCache(!1),this.loaderPool=(0,n.dispose)(this.loaderPool),this.initSegmentService=(0,n.dispose)(this.initSegmentService)},e}();function l(e){var t=new u.Stream;return t.add(e),t.end(),t}t.SegmentManager=c},20931:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.TimestampOffsetService=void 0;var n=i(59534),r=i(43068),o=i(83024),a=function(){function e(e,t){this.context=e,this.mimeType=t,this.discontinuityNumbers=new Map;var i=e.sourceContext.sourceIdentifier;this.sourceStore=e.serviceManager.get(n.ServiceName.SourceStoreService,i)}return Object.defineProperty(e.prototype,"logger",{get:function(){return this.context.logger},enumerable:!1,configurable:!0}),e.prototype.maybeAdjustTimestampOffsetAtDiscontinuityChange=function(e,t){var i=e.getSegmentInfo().discontinuitySequenceNumber;if(null!=i&&!e.isInit()){var n=this.discontinuityNumbers.get(e.getMimeType())!==i,r=isNaN(t.getTimestampOffset());(n||r)&&this.adjustTimestampOffset(e,i,t),this.discontinuityNumbers.set(e.getMimeType(),i)}},e.prototype.adjustTimestampOffset=function(e,t,i){var n=r.ModuleManager.get(o.ModuleName.HLS).selectors,a=n.getHlsState,s=(0,n.getPresentationTimeOffset)(a(this.sourceStore.getState()),String(t)),u=this.calculateEncodedPlaybackTime(e),d=u.encodedPlaybackTime,c=u.shouldUpdatePlaybackTime;null==s&&(s=this.calculatePresentationTimeOffset(e,d,t,i)),this.logger.debug("[".concat(this.mimeType,"], discontinuity: ").concat(t," adjusting PTO to ").concat(s," on segment ").concat(e.getUrl())),i.setTimestampOffset(s),e.getSegmentInfo().presentationTimeOffset=s,e.setPresentationTimeOffset(s),c&&e.setPlaybackTime(d-s)},e.prototype.calculatePresentationTimeOffset=function(e,t,i,n){null==e.getSegmentInfo().startTime&&(this.logger.debug("[".concat(e.getMimeType(),"] no startTime when trying to calculate the PTO for ").concat(i)),n.extrapolateStartTimesFromDiscontinuityStarts(e));var a=t-e.getSegmentInfo().startTime,s=r.ModuleManager.get(o.ModuleName.HLS);return this.sourceStore.dispatch(s.actions.setPresentationTimeOffset(String(i),a)),this.logger.debug("[".concat(e.getMimeType(),"] set PTO for discontinuity ").concat(i," to ").concat(a)),a},e.prototype.calculateEncodedPlaybackTime=function(e){var t=r.ModuleManager.get(o.ModuleName.ContainerMP4,!1),i=!0,n=t?t.parsePlaybackTime(e,this.logger):e.getBaseMediaDecodeTime()/e.getTimescale();return isNaN(n)&&(n=e.getPlaybackTime(),i=!1),{encodedPlaybackTime:n,shouldUpdatePlaybackTime:i}},e.prototype.dispose=function(){this.discontinuityNumbers=null,this.sourceStore=null},e}();t.TimestampOffsetService=a},64061:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.UrlInitSegmentProvider=void 0;var n=i(22221),r=i(11917),o=i(30790),a=function(){function e(e,t){this.context=e,this.loaderPool=t,this.cache=new o.SegmentCache(1/0)}return e.prototype.getSegment=function(e){var t=this,i=this.cache.get(e);return(i?Promise.resolve(i):this.loadSegment(e)).then((function(e){return i||t.cacheSegment(e),e}))},e.prototype.loadSegment=function(e){return this.loaderPool.load(e).then((function(e){return e.read()})).then((function(t){if(!t.value)throw new Error("SegmentStream error ".concat(e.url));return t.value}))},e.prototype.cacheSegment=function(e){this.cache.add(e),this.context.store.dispatch((0,n.addMetricsValue)(e.getMimeType(),r.MetricType.CachedInitSegments,{internalRepId:e.getSegmentInfo().internalRepresentationId}))},e.prototype.getCachedSegment=function(e){return this.cache.get(e)},e.prototype.removeCachedSegments=function(e){this.cache.remove(e)},e.prototype.dispose=function(){this.cache.clear()},e}();t.UrlInitSegmentProvider=a},12434:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.initializeHlsSegmentStartTimes=void 0;var n=i(59534),r=i(43068),o=i(83024),a=i(59266);function s(e,t,i){var s=t.sourceContext.sourceIdentifier,u=t.serviceManager.get(n.ServiceName.ManifestService,s),d=r.ModuleManager.get(o.ModuleName.HLS).selectors,c=d.getHlsState,l=d.hasInitializedSegmentStartTimes,p=t.serviceManager.get(n.ServiceName.SourceStoreService,s),f=null==p?void 0:p.getState();if(u&&f&&!l(c(f))){var h=e.getRepresentationId().representationId;u.initializeSegmentStartTimesFromStart(h),(0,a.assignSegmentStartTimesFromHlsPlaylist)(i.getSegmentListEntries(e.getRepresentationId()),h,u)}}t.initializeHlsSegmentStartTimes=s},27005:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.Stream=void 0;var n=i(81028),r=i(84957),o=i(10032),a=function(){function e(){var e=this;this.resolveDeferredRead=function(){e.deferredRead&&!e.isEmpty()&&(e.deferredRead.resolve({done:!1,value:e.chunks.shift()}),e.deferredRead=null)},this.state=o.StreamState.Open,this.chunks=[],this.deferredEnded=new n.Deferred,this.deferredEnded.promise.catch((function(){}))}return e.prototype.add=function(e){this.state===o.StreamState.Open&&(this.chunks.push(e),this.resolveDeferredRead())},e.prototype.read=function(){if(this.deferredRead)return Promise.reject({name:r.StreamReadError.ParallelRead});if(this.state===o.StreamState.Ended&&this.isEmpty())return Promise.resolve({done:!0});if(this.state===o.StreamState.Aborted)return Promise.reject({name:r.StreamReadError.Aborted,message:this.getError()});this.deferredRead=new n.Deferred;var e=this.deferredRead.promise;return this.resolveDeferredRead(),e},e.prototype.end=function(){this.state===o.StreamState.Open&&(this.state=o.StreamState.Ended,this.deferredRead&&this.isEmpty()&&(this.deferredRead.resolve({done:!0}),this.deferredRead=null),this.deferredEnded.resolve())},e.prototype.abort=function(e){var t;if(this.state===o.StreamState.Open){this.state=o.StreamState.Aborted,this.error=e;var i={name:o.StreamState.Aborted,message:null!==(t=this.getError())&&void 0!==t?t:""};this.deferredRead&&(this.deferredRead.reject(i),this.deferredRead=null),this.deferredEnded.reject(i)}},e.prototype.transform=function(t,i,n){var r=this,o=new e,a=function(){r.read().then((function(e){var n=e.done,r=e.value;if(n)i&&i(),o.end();else{var s=null!=r&&t(r);s&&o.add(s),a()}})).catch((function(e){n?o.abort(n(e)):o.abort(e)}))};return a(),o},e.prototype.isEmpty=function(){return 0===this.chunks.length},e.prototype.getError=function(){return this.error||null},e}();t.Stream=a},84957:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.StreamReadError=void 0,function(e){e.Aborted="aborted",e.ParallelRead="parallelread"}(t.StreamReadError||(t.StreamReadError={}))},10032:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.StreamState=void 0,function(e){e.Open="open",e.Ended="ended",e.Aborted="aborted"}(t.StreamState||(t.StreamState={}))},32579:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.DiscontinuityMonitor=void 0;var n=i(59574),r=function(){function e(e){var t=this;this.context=e,this.onSeek=function(){t.seekStarted=!0},this.onSeeked=function(){var e=t.context.internalPlayer.getCurrentTime();Object.values(t.delayedSegmentPlaybackData).forEach((function(i){e>=i.playbackTime&&i.playbackTime+i.duration>=e&&t.maybeFirePeriodSwitchEvents(i)})),t.delayedSegmentPlaybackData={}},this.currentDiscontinuityNumbers={},this.delayedSegmentPlaybackData={},this.seekStarted=!1,this.context.eventHandler.on(n.PlayerEvent.Seek,this.onSeek,!0),this.context.eventHandler.on(n.PlayerEvent.Seeked,this.onSeeked,!0)}return e.prototype.onSegmentAvailable=function(e){if(!e.isInit()){var t=e.getMimeType(),i=e.getSegmentInfo();this.currentDiscontinuityNumbers[t]?this.seekStarted&&(this.delayedSegmentPlaybackData[e.getMimeType()]={mimeType:e.getMimeType(),discontinuitySequenceNumber:i.discontinuitySequenceNumber,playbackTime:i.startTime,duration:e.getDuration()},this.seekStarted=!1):this.currentDiscontinuityNumbers[t]={discontinuitySequenceNumber:i.discontinuitySequenceNumber,startTime:i.startTime||0}}},e.prototype.maybeFirePeriodSwitchEvents=function(e){var t=e.mimeType,i=e.discontinuitySequenceNumber,r=e.playbackTime;if(null!=i&&this.currentDiscontinuityNumbers[t]){var o=this.currentDiscontinuityNumbers[t].discontinuitySequenceNumber;o!==i&&(this.shouldFirePeriodSwitchEvent(t,i,r)&&(this.context.eventHandler.dispatchEvent(n.PlayerEvent.PeriodSwitch),this.context.eventHandler.dispatchEvent(n.PlayerEvent.PeriodSwitched,{sourcePeriod:{periodId:String(o)},targetPeriod:{periodId:String(i)}})),this.currentDiscontinuityNumbers[t]={discontinuitySequenceNumber:i,startTime:r})}},e.prototype.shouldFirePeriodSwitchEvent=function(e,t,i){var n=this,r=Object.keys(this.currentDiscontinuityNumbers).filter((function(t){return t!==e})),o=!0;return r.forEach((function(e){var r=n.currentDiscontinuityNumbers[e];r.discontinuitySequenceNumber===t&&(Math.abs(i-r.startTime)<1&&(o=!1))})),o},e.prototype.dispose=function(){this.context.eventHandler.off(n.PlayerEvent.Seek,this.onSeek),this.context.eventHandler.off(n.PlayerEvent.Seeked,this.onSeeked)},e}();t.DiscontinuityMonitor=r},46022:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentInitType=t.Segment=void 0;var r,o=i(12391),a=i(50163),s=i(70121),u=function(){function e(e,t,i,n,a,s,u,d,c,l){void 0===s&&(s=r.NONE),this.inbandEvents=[],this.data=e,this.mimeType=t,this.codec=i,this.periodId=n,this.duration=a,this.initType=s,this.isSegmentIndependentlyDecodable=u,this.encrypted=!1,this.metadata={subtitles:[]},this.networkRequestSize=d,this.representationId=c,this.playbackTime=l,this._isDirty=!1,this.drmInitData=null,e instanceof ArrayBuffer||"string"==typeof e&&(this.data=o.ArrayHelper.stringToArrayWithoutEncoding(e).buffer)}return e.prototype.setDrmKid=function(e){this.drmKid=e},e.prototype.hasDrmKid=function(){return Boolean(this.getDrmKid())},e.prototype.getDrmKid=function(){var e,t,i;return null!==(i=null!==(e=this.drmKid)&&void 0!==e?e:null===(t=this.initSegment)||void 0===t?void 0:t.getDrmKid())&&void 0!==i?i:void 0},e.prototype.setDrmInitData=function(e){this.drmInitData=e},e.prototype.hasDrmInitData=function(){var e;return(null===(e=this.drmInitData)||void 0===e?void 0:e.length)>0},e.prototype.getDrmInitData=function(){return this.hasDrmInitData()?this.drmInitData:[]},e.prototype.getMimeType=function(){return this.mimeType},e.prototype.isInit=function(){return this.initType===r.INIT},e.prototype.isSelfInit=function(){return this.initType===r.SELF_INIT},e.prototype.isEncrypted=function(){return this.encrypted},e.prototype.setEncrypted=function(e){this.encrypted=e},e.prototype.setUrl=function(e){this.loadedUrl=e},e.prototype.getUrl=function(){return this.loadedUrl},e.prototype.getData=function(){return this.data},e.prototype.setData=function(e){this.data=e},e.prototype.getMetadata=function(){return this.metadata},e.prototype.setMetadata=function(e){this.metadata=e},e.prototype.getPlaybackTime=function(){return this.playbackTime},e.prototype.setPlaybackTime=function(e){this.playbackTime=e},e.prototype.getPlaybackEndTime=function(){return this.playbackTime+this.duration},e.prototype.getPlaybackTimeRange=function(){return this.duration?{start:this.getPlaybackTime(),end:this.getPlaybackEndTime()}:(0,s.getSegmentInfoTimeRange)(this.getSegmentInfo())},e.prototype.getBaseMediaDecodeTime=function(){return this.baseMediaDecodeTime},e.prototype.setBaseMediaDecodeTime=function(e){this.baseMediaDecodeTime=e},e.prototype.getPresentationTimeOffset=function(){return this.presentationTimeOffset},e.prototype.setPresentationTimeOffset=function(e){this.presentationTimeOffset=e},e.prototype.getTFDTBoxOffset=function(){return this.tfdtBoxOffset},e.prototype.setTFDTBoxOffset=function(e){this.tfdtBoxOffset=e},e.prototype.getParserMetadataValue=function(e){var t;return this.getParserMetadata()&&this.getParserMetadata()[e]?this.getParserMetadata()[e]:(null===(t=this.getInitSegment())||void 0===t?void 0:t.getParserMetadata())?this.getInitSegment().getParserMetadata()[e]:void 0},e.prototype.getTimescale=function(){return this.getParserMetadataValue("timescale")},e.prototype.getIvSize=function(){return this.getParserMetadataValue("ivSize")},e.prototype.getDefaultSampleDuration=function(){return this.getParserMetadataValue("defaultSampleDuration")},e.prototype.getDefaultSampleSize=function(){return this.getParserMetadataValue("defaultSampleSize")},e.prototype.setTimescale=function(e){this.updateParserMetadata({timescale:e})},e.prototype.getPeriodId=function(){return this.periodId},e.prototype.getCodec=function(){return this.codec},e.prototype.setCodec=function(e){this.codec=e},e.prototype.getDuration=function(){return this.duration},e.prototype.setDuration=function(e){this.duration=e},e.prototype.getNetworkRequestSize=function(){return this.networkRequestSize},e.prototype.getRepresentationId=function(){return this.representationId},e.prototype.getParsedData=function(){return this.parsedData},e.prototype.setParsedData=function(e){this.parsedData=e},e.prototype.getSegmentInfo=function(){return this.segmentInfo},e.prototype.isIndependentlyDecodable=function(){return this.isSegmentIndependentlyDecodable},e.prototype.setSegmentInfo=function(e){this.segmentInfo=e},e.prototype.getMediaInfo=function(){var e={};return this.segmentInfo&&this.segmentInfo.bitrate&&(e.bitrate=this.segmentInfo.bitrate),a.MimeTypeHelper.isAudio(this.mimeType)?this.segmentInfo&&this.segmentInfo.sampleRate&&(e.sampleRate=this.segmentInfo.sampleRate):a.MimeTypeHelper.isVideo(this.mimeType)&&(this.segmentInfo&&this.segmentInfo.width&&(e.width=this.segmentInfo.width),this.segmentInfo&&this.segmentInfo.height&&(e.height=this.segmentInfo.height),this.segmentInfo&&this.segmentInfo.frameRate&&(e.frameRate=this.segmentInfo.frameRate)),e},e.prototype.isDirty=function(){return this._isDirty},e.prototype.setDirty=function(e){this._isDirty=e},e.prototype.setInbandEvents=function(e){this.inbandEvents=e},e.prototype.getInbandEvents=function(){return this.inbandEvents},e.prototype.setLastSegment=function(e){this.lastSegment=e},e.prototype.isLastSegment=function(){return this.lastSegment},e.prototype.wasLoadedFrom=function(e){return this.getUrl().includes(e)},e.prototype.getParserMetadata=function(){return this.parserMetadata},e.prototype.setParserMetadata=function(e){this.parserMetadata=e},e.prototype.updateParserMetadata=function(e){this.parserMetadata=n(n({},this.parserMetadata),e)},e.prototype.setBufferBlockId=function(e){this.bufferBlockId=e},e.prototype.getBufferBlockId=function(){return this.bufferBlockId},e.prototype.setInitSegment=function(e){this.initSegment=e},e.prototype.getInitSegment=function(){return this.initSegment},e}();t.Segment=u,function(e){e[e.NONE=0]="NONE",e[e.INIT=1]="INIT",e[e.SELF_INIT=2]="SELF_INIT"}(r=t.SegmentInitType||(t.SegmentInitType={}))},44578:function(e,t){function i(e,t){var i=n(e,t),r=o(e,t),a=e.discontinuitySequenceNumber===t.discontinuitySequenceNumber;return i&&r&&a}function n(e,t){var i=r(e),n=r(t);return i.some((function(e){return n.includes(e)}))}function r(e){return[e.url,e.mediaURL].filter(Boolean)}function o(e,t){var i=e.byteRange,n=t.byteRange;return null==i?null==n:null!=n&&i.start===n.start&&i.end===n.end}Object.defineProperty(t,"__esModule",{value:!0}),t.isIdenticalSegmentInfo=void 0,t.isIdenticalSegmentInfo=i},67013:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentUnavailabilityHandler=void 0;var n=i(5793),r=function(){function e(e){this.triedRepsForCurrentSegment={},this.wasQualitySwitched=!1,this.context=e}return e.prototype.downloadSuccess=function(e){this.wasQualitySwitched&&e?this.wasQualitySwitched=!1:this.triedRepsForCurrentSegment={}},e.prototype.getNextLowerNotTriedQuality=function(e,t){for(var i=[],n=0;n<e.length&&!e[n]._internalId.equals(t);n++)this.triedRepsForCurrentSegment[e[n]._id]||i.push(e[n]);return i.length>0?i[i.length-1]._internalId:null},e.prototype.getNextHigherNotTriedQuality=function(e,t){for(var i=!1,n=0;n<e.length;n++)if(e[n]._internalId.equals(t))i=!0;else if(i&&!this.triedRepsForCurrentSegment[e[n]._id])return e[n]._internalId;return null},e.prototype.switchQuality=function(e,t){this.triedRepsForCurrentSegment[t.representationId]=!0;var i=this.getNextLowerNotTriedQuality(e,t);return i||(i=this.getNextHigherNotTriedQuality(e,t)),i?(this.wasQualitySwitched=!0,i):(this.context.logger.log("no quality left, all tried"),null)},e.prototype.switchBaseURL=function(e){var t=e.availableBaseURLs,i=e.lastUsedBaseURLIndex+1;return(i%=t.length)===e.firstUsedBaseURLIndex?(this.context.logger.log("no base url left, all tried"),null):(e.lastUsedBaseURLIndex=i,e.baseURL=t[i],e.url=n.URLHelper.concatBaseUrlWithPartial(e.baseURL,e.mediaURL),e)},e.prototype.shouldTryAlternatives=function(e){return e>=400&&e<=599||0===e},e}();t.SegmentUnavailabilityHandler=r},85303:function(e,t,i){var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},n.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.TimedMetadataService=void 0;var r=i(59534),o=i(4529),a=i(59574),s=i(31049),u=i(25423),d=i(22221),c=i(45366),l=i(11917),p=i(50163),f=i(63080),h=i(32579),g=function(){function e(e){var t,i=this;this.context=e,this.onGenericMetadataAvailable=function(e){if(e.hasOwnProperty("metadata")){var t={metadataType:e.metadataType.toUpperCase(),metadata:e.metadata};(e.start||0===e.start)&&(t.start=e.start),e.end&&(t.end=e.end),i.context.eventHandler.dispatchEvent(a.PlayerEvent.Metadata,t)}},this.inbandMetadataCallback=function(e){e&&e.hasOwnProperty("metadataType")&&i.context.eventHandler.dispatchEvent(a.PlayerEvent.Metadata,{metadataType:e.metadataType,metadata:e.metadata})},this.onSegmentPlayback=function(e){var t=e.metadata.event;i.currentlyPlayedSegment[t.mimeType]=t,i.playbackRepresentationId[t.mimeType]=f.RepresentationId.from(e.metadata.representationId),i.discontinuityMonitor.maybeFirePeriodSwitchEvents(t),i.previousRepresentationIds[t.mimeType]&&i.previousRepresentationIds[t.mimeType].id===t.representationId||i.handlePlaybackInfo(t),i.context.eventHandler.dispatchEvent(a.PlayerEvent.SegmentPlayback,t)},this.previousRepresentationIds={},this.playbackRepresentationId={},this.currentlyPlayedSegment={},this.manifestService=this.context.serviceManager.get(r.ServiceName.ManifestService,e.sourceContext.sourceIdentifier);var n=((t={})[u.TimedMetadataType.InBand]=this.inbandMetadataCallback,t[u.TimedMetadataType.SegmentPlayback]=this.onSegmentPlayback,t[u.TimedMetadataType.Manifest]=this.onGenericMetadataAvailable,t[u.TimedMetadataType.EventStream]=this.onGenericMetadataAvailable,t[u.TimedMetadataType.DateRange]=this.onGenericMetadataAvailable,t[u.TimedMetadataType.CustomTag]=this.onGenericMetadataAvailable,t);this.metadataService=new s.MetadataService(e,n),this.discontinuityMonitor=new h.DiscontinuityMonitor(e)}return e.prototype.onSegmentAvailable=function(e){var t,i=this,n=e.segment,r=e.extractedMetadata,o=e.isSegmentOfMainStream,a=e.presentationTimeOffset;if(o){t=y(n);var s=n.getSegmentInfo();s.metadata&&s.metadata.forEach((function(e){i.processSegmentInfoMetadata(e,t,n.getPeriodId())})),S(s)&&this.handleCustomMetadata(s),this.handleId3Metadata(r,a,n.getPeriodId())}else t=v(n);this.registerSegmentPlaybackEvent(n,t),n.getInbandEvents().forEach((function(e){i.processInbandEvent(e,n.getPeriodId())})),this.discontinuityMonitor.onSegmentAvailable(n)},e.prototype.registerSegmentPlaybackEvent=function(e,t){if(!e.isInit()){var i=e.getSegmentInfo(),n=e.getMimeType(),r={metadata:{event:t,representationId:{_periodId:i.internalRepresentationId.periodId,_adaptationSetId:i.internalRepresentationId.adaptationSetId,_representationId:i.internalRepresentationId.representationId},mimeType:n}};this.metadataService.addToTimeline(u.TimedMetadataType.SegmentPlayback,t.playbackTime,r),(0,c.getMetricsState)(this.context.store.getState())[n]||this.context.store.dispatch((0,d.initializeMetricsForMimeType)(n,this.context.settings)),this.context.store.dispatch((0,d.addMetricsValue)(n,l.MetricType.SegmentInformation,{bitrate:8*e.getNetworkRequestSize()/e.getDuration(),duration:e.getDuration(),playbackTime:i.startTime||e.getPlaybackTime(),representationId:e.getRepresentationId()}))}},e.prototype.parseEventStream=function(){var e=this;this.manifestService.getAllPeriods().forEach((function(t){e.manifestService.getEventStreamEvents(t).forEach((function(i){e.processEventStreamEvent(i,t)}))}))},e.prototype.processEventStreamEvent=function(e,t){var i={metadataType:a.MetadataType.EVENT_STREAM,metadata:e.data,start:e.startTime,end:e.endTime};this.metadataService.addToMetadataParsedService(u.TimedMetadataType.EventStream,e.startTime,n(n({},i),{data:e.data}),t._id)&&this.metadataService.addToTimeline(u.TimedMetadataType.EventStream,e.startTime,i)},e.prototype.getPlaybackRepresentation=function(e){var t=this.context.serviceManager.get(r.ServiceName.ManifestService,this.context.sourceContext.sourceIdentifier),i=n({},t.getRepresentationById(this.playbackRepresentationId[e]));return i&&this.currentlyPlayedSegment[e]&&(i.uid=this.currentlyPlayedSegment[e].uid),i},e.prototype.handlePlaybackInfo=function(e){var t,i;p.MimeTypeHelper.isAudio(e.mimeType)?(t=a.PlayerEvent.AudioPlaybackQualityChanged,i={id:e.representationId,bitrate:parseFloat(e.mediaInfo.bitrate)}):p.MimeTypeHelper.isVideo(e.mimeType)&&(t=a.PlayerEvent.VideoPlaybackQualityChanged,i={id:e.representationId,bitrate:parseFloat(e.mediaInfo.bitrate),width:parseFloat(e.mediaInfo.width),height:parseFloat(e.mediaInfo.height)}),t&&this.context.eventHandler.dispatchEvent(t,{targetQuality:i,sourceQuality:this.previousRepresentationIds[e.mimeType]||null}),this.previousRepresentationIds[e.mimeType]=i},e.prototype.processDateRangeEvent=function(e,t){var i={metadataType:a.MetadataType.DATERANGE,metadata:e.data,start:e.startTime,end:e.endTime};this.metadataService.addToMetadataParsedService(u.TimedMetadataType.DateRange,e.startTime,n(n({},i),{data:e.data}),t)&&this.metadataService.addToTimeline(u.TimedMetadataType.DateRange,e.startTime,i)},e.prototype.addSegmentToMetadataParsedService=function(e,t){var i=this;e.forEach((function(e){if(e._metadata&&e._metadata.length>0&&e._playbackTime){var n={metadataType:a.MetadataType.CUSTOM,metadata:e._metadata,data:e._metadata,start:e._playbackTime,end:e._playbackTime+e._duration};i.metadataService.addToMetadataParsedService(u.TimedMetadataType.CustomTag,e._playbackTime,n,t)}}))},e.prototype.handleId3Metadata=function(e,t,i){var n=this;e&&Array.isArray(e.id3)&&e.id3.length>0&&e.id3.forEach((function(e){n.publishId3Metadata(e,t,i)}))},e.prototype.publishId3Metadata=function(e,t,i){var r=e.presentationTime-t,o={metadataType:a.MetadataType.ID3,metadata:e.data,start:r};this.metadataService.addToMetadataParsedService(u.TimedMetadataType.InBand,r,n(n({},o),{data:e.data}),i)&&this.metadataService.addToTimeline(u.TimedMetadataType.InBand,r,o)},e.prototype.handleCustomMetadata=function(e){var t=this,i=this.manifestService.getRepresentationById(e.internalRepresentationId);i.SegmentList[0].SegmentURL.forEach((function(n,r){n._media===e.url&&(n._playbackTime||m(i.SegmentList[0].SegmentURL,r,e.startTime),t.metadataService.addToTimeline(u.TimedMetadataType.CustomTag,e.startTime,{metadataType:a.MetadataType.CUSTOM,metadata:n._metadata,start:e.startTime,end:e.startTime+e.duration}))})),this.addSegmentToMetadataParsedService(i.SegmentList[0].SegmentURL,e.periodId)},e.prototype.processInbandEvent=function(e,t){var i=e.presentationTime,r={metadataType:a.MetadataType.EMSG,metadata:e,start:i};this.metadataService.addToMetadataParsedService(u.TimedMetadataType.InBand,i,n(n({},r),{data:e}),t)&&this.metadataService.addToTimeline(u.TimedMetadataType.InBand,i,r)},e.prototype.processSegmentInfoMetadata=function(e,t,i){var r=e.type;if(r===a.MetadataType.CUSTOM)t.EXPERIMENTAL=t.EXPERIMENTAL||{},t.EXPERIMENTAL.hlsAttributes=t.EXPERIMENTAL.hlsAttributes||[],t.EXPERIMENTAL.hlsAttributes=t.EXPERIMENTAL.hlsAttributes.concat(e.attributes);else{var o={metadataType:/^CUE-(IN|OUT(-CONT)?)$/.test(r)?a.MetadataType.CUETAG:a.MetadataType[e.type],metadata:e,start:t.playbackTime};this.metadataService.addToMetadataParsedService(u.TimedMetadataType.Manifest,t.playbackTime,n(n({},o),{data:e}),i)&&this.metadataService.addToTimeline(u.TimedMetadataType.Manifest,t.playbackTime,o)}},e.prototype.dispose=function(){this.metadataService=(0,o.dispose)(this.metadataService),this.manifestService=null,this.discontinuityMonitor=(0,o.dispose)(this.discontinuityMonitor)},e}();function m(e,t,i){for(var n=t,r=i;n>=0;)e[n]._playbackTime=r,r-=e[n]._duration,n--;for(n=t+1,r=i+e[t]._duration;n<e.length;)e[n]._playbackTime=r,r+=e[n]._duration,n++}function S(e){return e.metadata&&e.metadata.length>0&&e.metadata[0].type===a.MetadataType.CUSTOM}function v(e){var t=e.getSegmentInfo();return{uid:btoa(e.getUrl()),url:e.getUrl(),mimeType:e.getMimeType(),playbackTime:e.getPlaybackTime(),presentationTimestamp:e.getBaseMediaDecodeTime()/e.getTimescale(),duration:e.getDuration(),mediaInfo:e.getMediaInfo(),wallClockTime:t.wallClockTime,discontinuitySequenceNumber:t.discontinuitySequenceNumber}}function y(e){var t=v(e),i=e.getSegmentInfo();return i.dateTime&&(t.dateTime=i.dateTime),i.representationId&&(t.representationId=i.representationId),t}t.TimedMetadataService=g},31998:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.clearActiveTracksAction=t.removeActiveTrackAction=t.setContainerFormatAction=t.setMediaTypeAction=t.setRepresentationIdAction=void 0;var n=i(32696),r=i(12391),o=i(77478);function a(e){return(0,n.createAction)(o.ActiveTracksActionType.SetSelectedRepresentationId,{selectedRepresentationId:e})}function s(e,t){var i=(0,r.forceArray)(t);return(0,n.createAction)(o.ActiveTracksActionType.SetMediaType,{trackId:e,mediaTypes:i})}function u(e,t){return(0,n.createAction)(o.ActiveTracksActionType.SetContainerFormat,{trackId:e,containerFormat:t})}function d(e){return(0,n.createAction)(o.ActiveTracksActionType.RemoveActiveTrack,{adaptationSetId:e})}function c(){return(0,n.createAction)(o.ActiveTracksActionType.ClearActiveTracks)}t.setRepresentationIdAction=a,t.setMediaTypeAction=s,t.setContainerFormatAction=u,t.removeActiveTrackAction=d,t.clearActiveTracksAction=c},77478:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ActiveTracksActionType=void 0,function(e){e.SetSelectedRepresentationId="@instance/sources/@source/activetracks/setselectedrepresentationid",e.SetMediaType="@instance/sources/@source/activetracks/setmediatype",e.SetContainerFormat="@instance/sources/@source/activetracks/setcontainerformat",e.RemoveActiveTrack="@instance/sources/@source/activetracks/remove",e.ClearActiveTracks="@instance/sources/@source/activetracks/clear"}(t.ActiveTracksActionType||(t.ActiveTracksActionType={}))},51017:function(e,t,i){var n,r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)},o=this&&this.__rest||function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var r=0;for(n=Object.getOwnPropertySymbols(e);r<n.length;r++)t.indexOf(n[r])<0&&Object.prototype.propertyIsEnumerable.call(e,n[r])&&(i[n[r]]=e[n[r]])}return i};Object.defineProperty(t,"__esModule",{value:!0}),t.ActiveTracksReducer=t.getMediaTypes=t.getContainerFormat=void 0;var a=i(89464),s=i(77478),u={};function d(e,t){var i;if(e.activeTracks)return null===(i=Object.values(e.activeTracks).find((function(e){var i;return null===(i=e.mediaTypes)||void 0===i?void 0:i.includes(t)})))||void 0===i?void 0:i.containerFormat}function c(e,t){var i;return e.activeTracks&&(null===(i=e.activeTracks[t.adaptationSetId])||void 0===i?void 0:i.mediaTypes)||[]}function l(e,t){var i,n=t.selectedRepresentationId,o=e[n.adaptationSetId];return r(r({},e),((i={})[n.adaptationSetId]=r(r({},o),{selectedRepresentationId:n}),i))}function p(e,t){var i,n=t.trackId,o=t.mediaTypes,a=e[n.adaptationSetId];return r(r({},e),((i={})[n.adaptationSetId]=r(r({},a),{mediaTypes:o}),i))}function f(e,t){var i,n=t.trackId,o=t.containerFormat,a=e[n.adaptationSetId];return r(r({},e),((i={})[n.adaptationSetId]=r(r({},a),{containerFormat:o}),i))}t.getContainerFormat=d,t.getMediaTypes=c;var h=function(e,t){var i=e,n=t.adaptationSetId.adaptationSetId,a=(i[n],o(i,["symbol"==typeof n?n:n+""]));return r({},a)};t.ActiveTracksReducer=(0,a.default)({},((n={})[s.ActiveTracksActionType.SetSelectedRepresentationId]=function(e,t){return l(e,t.payload)},n[s.ActiveTracksActionType.SetMediaType]=function(e,t){return p(e,t.payload)},n[s.ActiveTracksActionType.SetContainerFormat]=function(e,t){return f(e,t.payload)},n[s.ActiveTracksActionType.RemoveActiveTrack]=function(e,t){var i=t.payload;return h(e,i)},n[s.ActiveTracksActionType.ClearActiveTracks]=function(){return u},n))},66772:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.engineBitmovinSourceReducers=void 0;var n=i(51017),r=i(3531),o=i(53088),a=i(87726),s=i(48141),u=i(81040);t.engineBitmovinSourceReducers={manifest:r.ManifestReducer,activeTracks:n.ActiveTracksReducer,playingTracks:o.PlayingTracksReducer,buffer:s.BufferReducer,streamTimeline:u.StreamTimelineReducer,segmentInfoMap:a.SegmentInfoMapReducer}},52038:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.periodSwitchStarted=t.periodSwitchFinished=t.setPlayingPeriodId=void 0;var n=i(32696),r=i(65455),o=function(e){return(0,n.createAction)(r.PlayingTracksActionKey.SetPlayingPeriodId,e)};t.setPlayingPeriodId=o;var a=function(e){return(0,n.createAction)(r.PlayingTracksActionKey.FinishedPeriodSwitch,e)};t.periodSwitchFinished=a;var s=function(e){return(0,n.createAction)(r.PlayingTracksActionKey.StartedPeriodSwitch,e)};t.periodSwitchStarted=s},53088:function(e,t,i){var n,r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0}),t.PlayingTracksReducer=t.wasSwitchingToPeriodIdReset=t.getPlayingTracksState=t.getPlayingPeriodId=void 0;var o=i(89464),a=i(65455),s={},u=function(e){var t;return null===(t=e.playingTracks)||void 0===t?void 0:t.playingPeriodId};t.getPlayingPeriodId=u;var d=function(e){return e.playingTracks};t.getPlayingTracksState=d;var c=function(e,t){return void 0!==(null==t?void 0:t.switchingToPeriodId)&&void 0===(null==e?void 0:e.switchingToPeriodId)};t.wasSwitchingToPeriodIdReset=c,t.PlayingTracksReducer=(0,o.default)(s,((n={})[a.PlayingTracksActionKey.SetPlayingPeriodId]=function(e,t){var i=t.payload;return r(r({},e),{playingPeriodId:i})},n[a.PlayingTracksActionKey.FinishedPeriodSwitch]=function(e,t){var i=t.payload;return r(r({},e),{switchingToPeriodId:e.switchingToPeriodId===i?void 0:e.switchingToPeriodId})},n[a.PlayingTracksActionKey.StartedPeriodSwitch]=function(e,t){var i=t.payload;return r(r({},e),{switchingToPeriodId:i})},n))},65455:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.PlayingTracksActionKey=void 0,function(e){e.SetPlayingPeriodId="@instance/sources/@source/playingTracks/setPlayingPeriodId",e.FinishedPeriodSwitch="@instance/sources/@source/playingTracks/periodSwitchFinished",e.StartedPeriodSwitch="@instance/sources/@source/playingTracks/periodSwitchStarted"}(t.PlayingTracksActionKey||(t.PlayingTracksActionKey={}))},71705:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.sourceIdentifiersSelector=t.hasASourceStoreIdentifierChanged=void 0;var i=function(e,t){return e.length!==t.length||e.some((function(e){return!t.includes(e)}))};t.hasASourceStoreIdentifierChanged=i;var n=function(e){var t;return Object.keys(null!==(t=e.sources)&&void 0!==t?t:{})};t.sourceIdentifiersSelector=n},10559:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.setRepresentationAnchorPointAction=t.setRepresentationSegmentIndexParsingErrorAction=t.setRepresentationIsLoadingAction=t.setRepresentationSegmentIndexAction=t.setRepresentationFailedDownloadAction=t.markSegmentAsDownloadedAction=t.setRepresentationDrmKidAction=t.adjustPeriodStartTimes=t.updatePeriodTimingAction=t.updateRepresentationAction=t.updateManifestAction=t.removeRepresentationsAction=t.setManifestInitializedAction=t.setManifestAction=void 0;var n=i(32696),r=i(6821);function o(e){return(0,n.createAction)(r.ManifestActionType.SetManifest,{manifest:e})}function a(e){return(0,n.createAction)(r.ManifestActionType.SetManifestInitialized,{isInitialized:e})}function s(e){return(0,n.createAction)(r.ManifestActionType.RemoveRepresentations,{representationIds:e})}function u(e){return(0,n.createAction)(r.ManifestActionType.UpdateManifest,e)}function d(e){return(0,n.createAction)(r.ManifestActionType.UpdateRepresentation,e)}function c(e,t){return(0,n.createAction)(r.ManifestActionType.UpdatePeriodTiming,{periodId:e,timing:t})}function l(e){return(0,n.createAction)(r.ManifestActionType.AdjustPeriodStartTimes,{offset:e})}function p(e,t){return(0,n.createAction)(r.ManifestActionType.SetRepresentationDrmKid,{representationId:e,associatedKid:t})}function f(e,t){return(0,n.createAction)(r.ManifestActionType.MarkSegmentAsDownloaded,{adaptationSetId:e,segment:t})}function h(e){return(0,n.createAction)(r.ManifestActionType.SetRepresentationFailedDownload,{representationId:e})}function g(e,t){return(0,n.createAction)(r.ManifestActionType.SetRepresentationSegmentIndex,{representationId:e,segmentIndex:t})}function m(e,t){return(0,n.createAction)(r.ManifestActionType.SetRepresentationIsLoading,{representationId:e,isLoading:t})}function S(e,t){return(0,n.createAction)(r.ManifestActionType.SetRepresentationSegmentIndexParsingError,{representationId:e,segmentIndexParsingError:t})}function v(e,t){return(0,n.createAction)(r.ManifestActionType.SetRepresentationAnchorPoint,{representationId:e,anchorPoint:t})}t.setManifestAction=o,t.setManifestInitializedAction=a,t.removeRepresentationsAction=s,t.updateManifestAction=u,t.updateRepresentationAction=d,t.updatePeriodTimingAction=c,t.adjustPeriodStartTimes=l,t.setRepresentationDrmKidAction=p,t.markSegmentAsDownloadedAction=f,t.setRepresentationFailedDownloadAction=h,t.setRepresentationSegmentIndexAction=g,t.setRepresentationIsLoadingAction=m,t.setRepresentationSegmentIndexParsingErrorAction=S,t.setRepresentationAnchorPointAction=v},3531:function(e,t,i){var n,r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)},o=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestReducer=void 0;var a=i(89464),s=i(5793),u=i(43233),d=i(93638),c=i(6821);function l(e,t){return t.payload.manifest||e}function p(e,t){return r(r({},e),{isInitialized:t.payload.isInitialized})}function f(e,t){return 0===t.payload.representationIds.length?e:(0,u.removeRepresentations)(e,t.payload.representationIds)}function h(e,t){return t.payload.offset?r(r({},e),{Period:e.Period.map((function(e){return r(r({},e),{start:e.start+t.payload.offset})}))}):e}function g(e,t){if(!e.Period)return e;var i=t.periodId,n=t.timing,a=e.Period.findIndex((function(e){return e._id===i}));if(a<0)return e;var s=o([],e.Period,!0);return s[a]=r(r({},s[a]),n),r(r({},e),{Period:s})}function m(e,t){return r(r({},e),t)}function S(e,t){var i,n,a,s=t,u=s._internalId;if(!e.Period)return e;var d=e.Period.findIndex((function(e){return e._id===u.periodId})),c=null===(i=e.Period[d])||void 0===i?void 0:i.AdaptationSet.findIndex((function(e){return e._internalId.equals(u)})),l=null===(a=null===(n=e.Period[d])||void 0===n?void 0:n.AdaptationSet[c])||void 0===a?void 0:a.Representation.findIndex((function(e){return e._internalId.equals(u)})),p=r({},e);p.Period=o([],p.Period,!0),p.Period[d]=r({},p.Period[d]);var f=p.Period[d];f.AdaptationSet=o([],f.AdaptationSet,!0),f.AdaptationSet[c]=r({},f.AdaptationSet[c]);var h=f.AdaptationSet[c];return h.Representation=o([],h.Representation,!0),h.Representation[l]=s,p}function v(e,t){var i,n=t.payload,o=n.representationId,a=n.associatedKid,s=function(e){return e._internalId.equals(o)&&!e.associatedKid?a:e.associatedKid};return r(r({},e),{Period:null===(i=e.Period)||void 0===i?void 0:i.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{Representation:null===(t=e.Representation)||void 0===t?void 0:t.map((function(e){return r(r({},e),{associatedKid:s(e)})}))})}))})}))})}function y(e,t){var i,n,a,u=t.payload,c=u.adaptationSetId,l=u.segment,p=function(e,t){var i=e._media;return s.URLHelper.isUrlAbsolute(i)||(i=s.URLHelper.concatUrlParts(t.BaseURL[0],i)),i===l.getUrl()},f=l.getPeriodId(),h=l.getRepresentationId(),g=e.Period.findIndex((function(e){return e._id===f})),m=null===(i=e.Period[g])||void 0===i?void 0:i.AdaptationSet.findIndex((function(e){return e._internalId.equals(c)})),S=null===(a=null===(n=e.Period[g])||void 0===n?void 0:n.AdaptationSet[m])||void 0===a?void 0:a.Representation.findIndex((function(e){return e._internalId.equals(h)}));if(-1===g||-1===m||-1===S)return e;var v=r({},e);v.Period=o([],v.Period,!0),v.Period[g]=r({},v.Period[g]);var y=v.Period[g];y.AdaptationSet=o([],y.AdaptationSet,!0),y.AdaptationSet[m]=r({},y.AdaptationSet[m]);var T=y.AdaptationSet[m];T.Representation=o([],T.Representation,!0),T.Representation[S]=r({},T.Representation[S]);var I=T.Representation[S];if(!I.SegmentList)return e;I.SegmentList=o([],I.SegmentList,!0);for(var M=0;M<I.SegmentList.length;M++){var b=(0,d.findSegmentUrlIndexWithinSegmentList)(l,I.SegmentList[M].SegmentURL);if(-1!==b){I.SegmentList[M]=r({},I.SegmentList[M]);var P=I.SegmentList[M];P.SegmentURL=o([],P.SegmentURL,!0),P.SegmentURL[b]=r(r({},P.SegmentURL[b]),{downloaded:p(P.SegmentURL[b],I)})}}return v}function T(e,t){var i,n=t.payload.representationId,o=function(e){return!!e._internalId.equals(n)||e.hasFailedToLoad};return r(r({},e),{Period:null===(i=e.Period)||void 0===i?void 0:i.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{Representation:null===(t=e.Representation)||void 0===t?void 0:t.map((function(e){return r(r({},e),{hasFailedToLoad:o(e)})}))})}))})}))})}function I(e,t){var i,n=t.payload,o=n.representationId,a=n.isLoading,s=function(e){return e._internalId.equals(o)?a:e.isLoading};return r(r({},e),{Period:null===(i=e.Period)||void 0===i?void 0:i.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{Representation:null===(t=e.Representation)||void 0===t?void 0:t.map((function(e){return r(r({},e),{isLoading:s(e)})}))})}))})}))})}function M(e,t){var i,n=t.payload,o=n.representationId,a=n.segmentIndex,s=function(e){return e._internalId.equals(o)?a:e.segmentIndex};return r(r({},e),{Period:null===(i=e.Period)||void 0===i?void 0:i.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{Representation:null===(t=e.Representation)||void 0===t?void 0:t.map((function(e){return r(r({},e),{segmentIndex:s(e)})}))})}))})}))})}function b(e,t){var i,n=t.payload,o=n.representationId,a=n.segmentIndexParsingError,s=function(e){return e._internalId.equals(o)?a:e.segmentIndexParsingError};return r(r({},e),{Period:null===(i=e.Period)||void 0===i?void 0:i.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{Representation:null===(t=e.Representation)||void 0===t?void 0:t.map((function(e){return r(r({},e),{segmentIndexParsingError:s(e)})}))})}))})}))})}function P(e,t){var i,n=t.payload,o=n.representationId,a=n.anchorPoint,s=function(e){return e._internalId.equals(o)?a:e.anchorPoint};return r(r({},e),{Period:null===(i=e.Period)||void 0===i?void 0:i.map((function(e){var t;return r(r({},e),{AdaptationSet:null===(t=e.AdaptationSet)||void 0===t?void 0:t.map((function(e){var t;return r(r({},e),{Representation:null===(t=e.Representation)||void 0===t?void 0:t.map((function(e){return r(r({},e),{anchorPoint:s(e)})}))})}))})}))})}t.ManifestReducer=(0,a.default)({},((n={})[c.ManifestActionType.SetManifest]=l,n[c.ManifestActionType.SetManifestInitialized]=p,n[c.ManifestActionType.RemoveRepresentations]=f,n[c.ManifestActionType.UpdateManifest]=function(e,t){return m(e,t.payload)},n[c.ManifestActionType.UpdateRepresentation]=function(e,t){return S(e,t.payload)},n[c.ManifestActionType.AdjustPeriodStartTimes]=h,n[c.ManifestActionType.UpdatePeriodTiming]=function(e,t){return g(e,t.payload)},n[c.ManifestActionType.SetRepresentationDrmKid]=v,n[c.ManifestActionType.MarkSegmentAsDownloaded]=y,n[c.ManifestActionType.SetRepresentationFailedDownload]=T,n[c.ManifestActionType.SetRepresentationIsLoading]=I,n[c.ManifestActionType.SetRepresentationSegmentIndex]=M,n[c.ManifestActionType.SetRepresentationSegmentIndexParsingError]=b,n[c.ManifestActionType.SetRepresentationAnchorPoint]=P,n))},96400:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getManifest=void 0;var i=function(e){return null==e?void 0:e.manifest};t.getManifest=i},6821:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.ManifestActionType=void 0,function(e){e.SetManifest="@instance/manifest/setmanifest",e.SetManifestInitialized="@instance/manifest/setmanifestinitialized",e.RemoveRepresentations="@instance/manifest/removerepresentations",e.UpdateManifest="@instance/manifest/updatemanifest",e.UpdateRepresentation="@instance/manifest/updaterepresentation",e.UpdatePeriodTiming="@instance/manifest/updateperiodtiming",e.AdjustPeriodStartTimes="@instance/manifest/adjustperiodstarttimes",e.SetRepresentationDrmKid="@instance/manifest/setrepresentationdrmkid",e.MarkSegmentAsDownloaded="@instance/manifest/marksegmentasdownloaded",e.SetRepresentationFailedDownload="@instance/manifest/setrepresentationfaileddownload",e.SetRepresentationSegmentIndex="@instance/manifest/setrepresentationsegmentindex",e.SetRepresentationIsLoading="@instance/manifest/setrepresentationisloading",e.SetRepresentationSegmentIndexParsingError="@instance/manifest/setrepresentationsegmentindexparsingerror",e.SetRepresentationAnchorPoint="@instance/manifest/setrepresentationacnhorpoint"}(t.ManifestActionType||(t.ManifestActionType={}))},87726:function(e,t,i){var n,r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)},o=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentInfoMapReducer=void 0;var a=i(89464),s=i(30790),u=i(13561),d={};function c(e,t,i){var n;return r(r({},e),((n={})[t]=i,n))}function l(e,t,i){var n;if(!e[t]||0===i.segmentInfos.length)return c(e,t,i);var a=e[t].segmentInfos,u=a.findIndex((function(e){return(0,s.areSegmentsIdentical)(e,i.segmentInfos[0])}));if(-1===u)return c(e,t,i);var d,l=a.length-u,p=i.segmentInfos.length-l;if(0!==u||0!==p){var f=p>0?i.segmentInfos.slice(-p):[];d=o(o([],a.slice(u),!0),f,!0)}else d=a;var h=r(r(r({},e[t]),i),{segmentInfos:d});return r(r({},e),((n={})[t]=h,n))}t.SegmentInfoMapReducer=(0,a.default)(d,((n={})[u.SegmentInfoMapActionType.SetSegmentInfos]=function(e,t){return c(e,t.payload.qualityPath,t.payload.updatedEntry)},n[u.SegmentInfoMapActionType.UpdateSegmentInfos]=function(e,t){return l(e,t.payload.qualityPath,t.payload.updatedEntry)},n))},26147:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getMostRecentlyRefreshedQuality=t.getSegmentInfos=t.getSegmentMapEntry=void 0;var i=function(e,t){return null==e?void 0:e.segmentInfoMap[t]};t.getSegmentMapEntry=i;var n=function(e,i){var n,r;return null!==(r=null===(n=(0,t.getSegmentMapEntry)(e,i))||void 0===n?void 0:n.segmentInfos)&&void 0!==r?r:[]};t.getSegmentInfos=n;var r=function(e){if(e)return Object.values(e.segmentInfoMap).filter((function(e){return null!=e.qualityInfo.lastUpdateTimestamp})).sort((function(e,t){var i=e.qualityInfo.lastUpdateTimestamp;return t.qualityInfo.lastUpdateTimestamp-i}))[0]};t.getMostRecentlyRefreshedQuality=r},13561:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.SegmentInfoMapActionType=void 0,function(e){e.SetSegmentInfos="@instance/sources/@source/playback/setSegmentInfos",e.UpdateSegmentInfos="@instance/sources/@source/playback/updateSegmentInfos"}(t.SegmentInfoMapActionType||(t.SegmentInfoMapActionType={}))},94800:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.segmentToBufferBlockTimeRange=t.excludeBufferBlockTimeRange=t.mergeBufferBlockTimeRanges=void 0;var n=i(45659),r=.1;function o(e,t,i){return{start:(0,n.rangeFixedValue)(e),end:(0,n.rangeFixedValue)(t),bufferBlockId:i}}function a(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];var i=p(e);return Object.keys(i).flatMap((function(e){return n.BufferRangeHelper.mergeRanges(i[e],r)}))}function s(e,t){return[o(e.start,t.start,e.bufferBlockId),o(t.end,e.end,e.bufferBlockId)]}function u(e,t){return o(e.start>=t.start?t.end:e.start,e.end>t.end?e.end:t.start,e.bufferBlockId)}function d(e,t){var i=[];return e.forEach((function(e){(0,n.areDisjoint)(e,t)?i.push(e):(0,n.isSurrounding)(e,t)?i.push.apply(i,s(e,t)):(0,n.isFullyIncluded)(e,t)||i.push(u(e,t))})),i}function c(e,t){var i=t.bufferBlockId,a=p(e.map((function(e){return o(e.start,e.end,e.bufferBlockId)}))),s=a[i];if(!(null==s?void 0:s.length))return e;var u=d(s,t);return a[i]=n.BufferRangeHelper.mergeRanges(u,r),Object.keys(a).flatMap((function(e){return a[e]}))}function l(e){var t=e.getBufferBlockId(),i=e.getPlaybackTime();return o(i,i+e.getDuration(),t)}function p(e){var t={};return e.forEach((function(e){t[e.bufferBlockId]||(t[e.bufferBlockId]=[]),t[e.bufferBlockId].push(e)})),t}t.mergeBufferBlockTimeRanges=a,t.excludeBufferBlockTimeRange=c,t.segmentToBufferBlockTimeRange=l},48141:function(e,t,i){var n,r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)},o=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.BufferReducer=void 0;var a=i(45659),s=i(89464),u=i(89352),d=i(94800),c={};function l(e,t){var i,n=t.payload;return r(r({},e),((i={})[n.mimeType]=r(r({},e[n.mimeType]),{rendererRanges:n.ranges}),i))}function p(e,t){var i,n=t.payload;return r(r({},e),((i={})[n.mimeType]=r(r({},e[n.mimeType]),{maxBufferSize:n.maxBufferSize}),i))}function f(e,t){var i,n,s,u=t.payload,c=u.mimeType,l=u.range,p=null!==(s=null===(n=e[c])||void 0===n?void 0:n.loadedRanges)&&void 0!==s?s:[];return p.some((function(e){return(0,a.isFullyIncluded)(l,e)}))?e:r(r({},e),((i={})[c]=r(r({},e[c]),{loadedRanges:d.mergeBufferBlockTimeRanges.apply(void 0,o(o([],p,!1),[l],!1))}),i))}function h(e,t){var i,n,o,s=t.payload,u=s.mimeType,c=s.range,l=null!==(o=null===(n=e[u])||void 0===n?void 0:n.loadedRanges)&&void 0!==o?o:[];return l.every((function(e){return!(0,a.isOverlapping)(c,e)}))?e:r(r({},e),((i={})[u]=r(r({},e[u]),{loadedRanges:(0,d.excludeBufferBlockTimeRange)(l,c)}),i))}function g(e,t){var i,n,o,a=t.payload.mimeType;if(void 0===a){if(void 0===e)return{};var s=r({},e);return Object.keys(s).forEach((function(e){s[e]=r(r({},s[e]),{loadedRanges:[]})})),s}return(null!==(o=null===(n=e[a])||void 0===n?void 0:n.loadedRanges)&&void 0!==o?o:[]).length>0?r(r({},e),((i={})[a]=r(r({},e[a]),{loadedRanges:[]}),i)):e}t.BufferReducer=(0,s.default)(c,((n={})[u.BufferActionType.SetBufferMaxSize]=p,n[u.BufferActionType.SetRendererRanges]=l,n[u.BufferActionType.AddLoadedRange]=f,n[u.BufferActionType.RemoveLoadedRange]=h,n[u.BufferActionType.ResetLoadedRanges]=g,n))},4157:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.getDrmUsedKeySystem=t.getDrmKeyIdsWithErrors=t.getDrmState=void 0;var i=function(e){return null==e?void 0:e.drm};t.getDrmState=i;var n=function(e){var t,i;return null!==(i=null===(t=e.drm)||void 0===t?void 0:t.keyIdsWithErrors)&&void 0!==i?i:[]};t.getDrmKeyIdsWithErrors=n;var r=function(e){var i;return(null===(i=(0,t.getDrmState)(e))||void 0===i?void 0:i.usedKeySystem)||{kind:null,uid:null}};t.getDrmUsedKeySystem=r},45110:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.resetStreamTimeline=t.removeStreamTimeRange=t.addStreamTimeRange=void 0;var n=i(32696),r=i(6717);function o(e,t,i){var o={start:t.start,end:t.end,type:i};return(0,n.createAction)(r.StreamTimelineActionType.StreamTimeRangeAdd,{mimeType:e,streamTimeRange:o})}function a(e,t,i){return(0,n.createAction)(r.StreamTimelineActionType.StreamTimeRangeRemove,{mimeType:e,range:t,type:i})}function s(e){return(0,n.createAction)(r.StreamTimelineActionType.StreamTimelineReset,e)}t.addStreamTimeRange=o,t.removeStreamTimeRange=a,t.resetStreamTimeline=s},81040:function(e,t,i){var n,r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,i=1,n=arguments.length;i<n;i++)for(var r in t=arguments[i])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},r.apply(this,arguments)},o=this&&this.__spreadArray||function(e,t,i){if(i||2===arguments.length)for(var n,r=0,o=t.length;r<o;r++)!n&&r in t||(n||(n=Array.prototype.slice.call(t,0,r)),n[r]=t[r]);return e.concat(n||Array.prototype.slice.call(t))};Object.defineProperty(t,"__esModule",{value:!0}),t.getStreamTimeline=t.StreamTimelineReducer=void 0;var a=i(45659),s=i(89464),u=i(76060),d=i(6717),c={};function l(e,t,i){var n,a=e[t]?o([],e[t],!0):[];return r(r({},e),((n={})[t]=(0,u.addStreamTimeRangeToTimeline)(a,i),n))}function p(e,t,i,n){var s;if(!e[t])return e;var d=o([],e[t],!0);if(n){var c=r(r({},i),{type:n});d=(0,u.removeStreamTimeRangeFromTimeline)(d,c)}else d=a.BufferRangeHelper.excludeTimeRange(d,i);return r(r({},e),((s={})[t]=d,s))}function f(e,t){var i;return t?r(r({},e),((i={})[t]=[],i)):c}t.StreamTimelineReducer=(0,s.default)(c,((n={})[d.StreamTimelineActionType.StreamTimeRangeAdd]=function(e,t){return l(e,t.payload.mimeType,t.payload.streamTimeRange)},n[d.StreamTimelineActionType.StreamTimeRangeRemove]=function(e,t){return p(e,t.payload.mimeType,t.payload.range,t.payload.type)},n[d.StreamTimelineActionType.StreamTimelineReset]=function(e,t){return f(e,t.payload)},n));var h=function(e){var t;return null!==(t=null==e?void 0:e.streamTimeline)&&void 0!==t?t:{}};t.getStreamTimeline=h},6717:function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.StreamTimelineActionType=void 0,function(e){e.StreamTimelineReset="@instance/source/stream/streamtimelinereset",e.StreamTimeRangeRemove="@instance/source/stream/streamtimerangeremove",e.StreamTimeRangeAdd="@instance/source/stream/streamtimerangeadd"}(t.StreamTimelineActionType||(t.StreamTimelineActionType={}))},76060:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.getTrackIdentifier=t.removeStreamTimeRangeFromTimeline=t.addStreamTimeRangeToTimeline=t.StreamTimeRangeType=void 0;var n=i(45659),r=i(63634),o=i(50163);function a(e,t){var i=e.filter((function(e){return e.type===t.type})).concat(t),o=n.BufferRangeHelper.mergeRanges(i,r.DefaultSettings.GAP_TOLERANCE);return e=e.filter((function(e){return e.type!==t.type})),o.forEach((function(t){e=u(e,t,(function(e){return e.start>t.start}))})),e}function s(e,t){var i=e.filter((function(e){return e.type===t.type})),r=n.BufferRangeHelper.excludeTimeRange(i,t);return e=e.filter((function(e){return e.type!==t.type})),r.forEach((function(t){e=u(e,t,(function(e){return e.start>t.start}))})),e}function u(e,t,i){var n=e.findIndex(i);return n<0?e.push(t):e.splice(n,0,t),e}function d(e){var t=e.mimeType,i=e.internalRepresentationId;return o.MimeTypeHelper.isSubtitle(t)?"".concat(t,"/").concat(i.adaptationSetId):t}!function(e){e.Loading="loading",e.Failed="failed"}(t.StreamTimeRangeType||(t.StreamTimeRangeType={})),t.addStreamTimeRangeToTimeline=a,t.removeStreamTimeRangeFromTimeline=s,t.getTrackIdentifier=d},45933:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.hasContentProtection=t.areAudioMimeCodecsCompatible=void 0;var n=i(46381);function r(e,t){return e.mimeType===t.mimeType&&n.CodecStringHelper.canSwitchBetweenAudioCodecs(e.codec,t.codec)}function o(e,t){return void 0===e&&(e=[]),void 0===t&&(t=[]),0===e.length&&0===t.length||e.length>0&&t.length>0}t.areAudioMimeCodecsCompatible=r,t.hasContentProtection=o},93842:function(e,t){function i(e,t,i){return!e&&!t||!(e&&!t||!e&&t)&&(i||Object.keys(e)).every((function(i){return e[i]===t[i]}))}Object.defineProperty(t,"__esModule",{value:!0}),t.compareValues=void 0,t.compareValues=i},93638:function(e,t,i){Object.defineProperty(t,"__esModule",{value:!0}),t.findSegmentUrlIndexWithinSegmentList=void 0;var n=i(81349),r=i(93842);function o(e,t){var i=e.getSegmentInfo();return t.findIndex((function(e){var t=i.discontinuitySequenceNumber===e._discontinuitySequenceNumber,n=a(i.url,e._media),o=(0,r.compareValues)(i.byteRange,e._byteRange);return t&&n&&o}))}function a(e,t){return(0,n.endsWith)(e,t)||(0,n.endsWith)(e.split("?")[0],t)}t.findSegmentUrlIndexWithinSegmentList=o},11629:function(e,t){function i(e){var t=[];return e.forEach((function(e){t.push(e)})),t}function n(e){var t=[];return e.forEach((function(e,i){t.push(i)})),t}Object.defineProperty(t,"__esModule",{value:!0}),t.getKeys=t.getValues=void 0,t.getValues=i,t.getKeys=n}},function(e){return function(t){return e(e.s=t)}(81201)}])}));
})();
